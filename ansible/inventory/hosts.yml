# Copyright (c) 2025 MikeT LLC. All rights reserved.

# Ansible Inventory for Infrastructure Devices
# Uses Tailscale hostnames for secure connectivity
# Tailnet: pangolin-vega.ts.net

all:
  children:
    linux:
      hosts:
        motoko:
          ansible_host: motoko.pangolin-vega.ts.net
          ansible_user: mdt
          ansible_become: true
          ansible_become_password: "{{ lookup('pipe', '/usr/bin/az keyvault secret show --vault-name kv-miket-ops --name motoko-smb-password --query value -o tsv') | trim }}"
          ansible_python_interpreter: /usr/bin/python3
          # Uses Tailscale SSH - no password needed for connection
          # GPU specification for motoko
          gpu:
            vendor: NVIDIA
            model: GeForce RTX 2080
            vram_gb: 8
        
        akira:
          ansible_host: akira.pangolin-vega.ts.net
          ansible_user: mdt
          ansible_become: true
          ansible_python_interpreter: /usr/bin/python3
          # Strix Point APU with unified memory
          gpu:
            vendor: AMD
            model: Radeon 890M (RDNA 3.5)
            arch: gfx1150
            vram_gb: 2
            unified_memory_gb: 62
        
        atom:
          ansible_host: atom.pangolin-vega.ts.net
          ansible_user: mdt
          ansible_become: true
          ansible_python_interpreter: /usr/bin/python3
          ansible_password: "{{ lookup('pipe', '/usr/bin/az keyvault secret show --vault-name kv-miket-ops --name atom-ansible-password --query value -o tsv') | trim }}"
          # Resilience node - no GPU compute
          gpu:
            vendor: Intel
            model: HD Graphics 4000
            vram_gb: 0
        
        # Armitage - Fedora KDE Workstation + Ollama LLM Node
        # Migrated from Windows to Fedora KDE as of 2025-12
        # See ADR-004 (KDE Plasma standard) and ADR-005 (LLM runtime pattern)
        armitage:
          ansible_host: armitage.pangolin-vega.ts.net
          ansible_user: mdt
          ansible_become: true
          ansible_python_interpreter: /usr/bin/python3
          # SSH key authentication via Tailscale (no password needed)
          gpu:
            vendor: NVIDIA
            model: GeForce RTX 4070
            vram_gb: 8
            cuda_capable: true
          
    windows:
      children:
        windows_workstations:
          hosts:
            wintermute:
              ansible_host: wintermute.pangolin-vega.ts.net
              ansible_connection: winrm
              ansible_user: mdt
              ansible_password: "{{ lookup('pipe', '/usr/bin/az keyvault secret show --vault-name kv-miket-ops --name wintermute-ansible-password --query value -o tsv') | trim }}"
              ansible_port: 5985
              ansible_winrm_transport: ntlm
              ansible_winrm_server_cert_validation: ignore
              gpu:
                vendor: NVIDIA
                model: GeForce RTX 4070 Super
                vram_gb: 12
              
    macos:
      hosts:
        count-zero:
          ansible_host: count-zero
          ansible_user: mdt
          ansible_become: false  # Explicitly disable global sudo for this host
          ansible_become_password: "{{ lookup('pipe', '/usr/bin/az keyvault secret show --vault-name kv-miket-ops --name count-zero-ansible-password --query value -o tsv') | trim }}"
          ansible_python_interpreter: /usr/bin/python3
          ansible_ssh_executable: /home/mdt/dev/miket-infra-devices/scripts/tailscale-ssh-wrapper.sh
          # Uses Tailscale SSH via ACL - no keys needed

    # ========================================
    # Capability-based Groups
    # ========================================
    
    # GPU capability groups (by VRAM)
    gpu_8gb:
      hosts:
        motoko:
        armitage:

    gpu_12gb:
      hosts:
        wintermute:
    
    # GPU nodes (all hosts with capable GPUs)
    gpu_nodes:
      hosts:
        motoko:
        wintermute:
        armitage:
        akira:

    # Unified memory GPU (APU with large system RAM)
    gpu_unified_memory:
      hosts:
        akira:

    # AMD ROCm capable nodes
    rocm_nodes:
      hosts:
        akira:

    # NVIDIA CUDA capable nodes
    cuda_nodes:
      hosts:
        motoko:
        armitage:
        wintermute:

    # Wake-on-LAN enabled hosts
    wol_enabled:
      hosts:
        motoko:
        armitage:
        wintermute:

    # ========================================
    # Workstation Groups (have window managers)
    # ========================================
    # These hosts get GUI tools (Cursor, Warp, VS Code)

    linux_workstations:
      hosts:
        # Linux desktops/workstations with GUI
        akira:      # Strix Point AI/Dev workstation (KDE Plasma)
        armitage:   # Fedora KDE workstation + Ollama LLM node

    # ========================================
    # Basecamp Nodes (lightweight tiling WM)
    # ========================================
    # Portable hacker/field nodes with Sway/i3
    # Uses lightweight UI, not full KDE/GNOME
    basecamp_nodes:
      hosts:
        atom:       # Battery-backed basecamp node with Sway/i3

    # ========================================
    # Headless Servers (no GUI/display manager)
    # ========================================
    # Headless Fedora nodes: no GUI, multi-user.target, SSH-only access
    headless_servers:
      hosts:
        # atom removed - now basecamp node with lightweight GUI
        motoko:     # Headless server with GPU

    # ========================================
    # Lab Servers (compute nodes)
    # ========================================
    # Nodes for experimentation, automation, resilience
    lab_servers:
      hosts:
        atom:       # Battery-backed basecamp/lab node

    windows_workstations:
      hosts:
        wintermute:
        # armitage removed - now Linux

    macos_workstations:
      hosts:
        count-zero:

    # Composite group: all workstations (for GUI tools)
    all_workstations:
      children:
        linux_workstations:
        windows_workstations:
        macos_workstations:

    # ========================================
    # LLM Nodes (AI Fabric v2.0)
    # ========================================
    # Nodes running LLM inference - split by runtime pattern
    # See ADR-005: workstations use Ollama, servers use vLLM
    llm_nodes:
      hosts:
        armitage:   # Ollama workstation pattern
        akira:      # vLLM server pattern

    # Ollama-based LLM workstations
    llm_workstations_ollama:
      hosts:
        armitage:

    # vLLM-based LLM servers
    llm_servers_vllm:
      hosts:
        akira:

    # ========================================
    # Fedora Headless GPU Nodes
    # ========================================
    # Nodes running headless Fedora Server with GPU
    # Configuration: no GUI, lid-closed operation, GPU drivers, containers
    fedora_headless_gpu_nodes:
      hosts:
        motoko:

    # ========================================
    # Fedora KDE Workstations
    # ========================================
    # Nodes running Fedora with KDE Plasma desktop
    # ADR-004: KDE Plasma is the standard Linux UI baseline
    fedora_kde_workstations:
      hosts:
        armitage:
        akira:   # Migrated from GNOME 2025-12

    # ========================================
    # PSBI Core Infrastructure Nodes
    # ========================================
    # Primary nodes providing PSBI (PHC Storage + Base Infrastructure)
    psbi_core_nodes:
      hosts:
        motoko:

    # ========================================
    # Storage Nodes
    # ========================================
    # Nodes with PHC storage mounts (/space, /flux, /time)
    storage_nodes:
      hosts:
        motoko:

    # ========================================
    # Container Hosts
    # ========================================
    # Nodes running containerized services (Podman or Docker)
    container_hosts:
      hosts:
        motoko:
        akira:
        wintermute:
        armitage:

    # ========================================
    # AI Nodes (Legacy group - see llm_nodes for v2.0)
    # ========================================
    # Nodes capable of running AI workloads
    ai_nodes:
      hosts:
        motoko:
        akira:
        wintermute:
        armitage:

    # ========================================
    # Monitoring Infrastructure
    # ========================================
    # Prometheus/Grafana-based monitoring (replaces Netdata)
    # node_exporter on Linux servers, stack on akira

    # Hosts running node_exporter (metrics collection)
    monitoring_exporters:
      hosts:
        motoko:
        akira:
        atom:
        armitage:
        count-zero:
        wintermute:

    # Host running the observability stack (Prometheus + Grafana + Blackbox)
    monitoring_stack:
      hosts:
        akira:

    # ========================================
    # Resilience Nodes
    # ========================================
    # Battery-backed devices that stay alive during power failures
    # Purpose: Network presence proof, SSH foothold, alert origin
    resilience_nodes:
      hosts:
        atom:

    # ========================================
    # Linux Servers (SSH/systemd managed)
    # ========================================
    linux_servers:
      hosts:
        motoko:
        akira:
        atom:
        armitage:

    # ========================================
    # Windows Servers (WinRM managed)
    # ========================================
    windows_servers:
      hosts:
        wintermute:

    # ========================================
    # Tailnet All (all devices on tailnet)
    # ========================================
    tailnet_all:
      children:
        linux_servers:
        windows_servers:
        macos_workstations:

  vars:
    # Global variables for all hosts
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
    backup_server: motoko
    docker_registry: ""
