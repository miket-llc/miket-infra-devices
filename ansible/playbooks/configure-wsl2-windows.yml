# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# Configure WSL2 on Windows Workstations
# Installs and configures WSL2 with Ubuntu for consistent Docker Desktop backend
# Works for: armitage, wintermute, and any Windows workstation
# Usage: 
#   ansible-playbook -i inventory/hosts.yml playbooks/configure-wsl2-windows.yml --limit windows_workstations
#   ansible-playbook -i inventory/hosts.yml playbooks/configure-wsl2-windows.yml --limit wintermute

- name: Configure WSL2 on Windows Workstations
  hosts: "{{ target_hosts | default('windows_workstations') }}"
  gather_facts: false
  vars:
    wsl_distro: "{{ wsl2.default_distro | default('Ubuntu') }}"
    wsl_version: "{{ wsl2.version | default('24.04') }}"
  
  tasks:
    - name: Check current WSL status
      win_shell: |
        $distros = wsl --list --verbose 2>&1
        if ($LASTEXITCODE -eq 0 -and $distros -match '\S') {
          Write-Output "INSTALLED"
          $distros
        } else {
          Write-Output "NOT_INSTALLED"
        }
      register: wsl_current_status
      changed_when: false
      failed_when: false
    
    - name: Display current WSL status
      debug:
        msg:
          - "Current WSL status for {{ inventory_hostname }}:"
          - "{{ wsl_current_status.stdout_lines | default(['Not installed']) | join('\n') }}"
    
    - name: Enable WSL feature
      win_shell: |
        $feature = Get-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux -ErrorAction SilentlyContinue
        if ($feature.State -ne "Enabled") {
          Write-Host "Enabling WSL feature..." -ForegroundColor Yellow
          Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux -All -NoRestart -ErrorAction Stop | Out-Null
          Write-Output "ENABLED"
        } else {
          Write-Output "ALREADY_ENABLED"
        }
      register: wsl_feature
      changed_when: "'ENABLED' in wsl_feature.stdout"
      failed_when: false
      when: "'NOT_INSTALLED' in wsl_current_status.stdout"
    
    - name: Enable Virtual Machine Platform feature
      win_shell: |
        $feature = Get-WindowsOptionalFeature -Online -FeatureName VirtualMachinePlatform -ErrorAction SilentlyContinue
        if ($feature.State -ne "Enabled") {
          Write-Host "Enabling Virtual Machine Platform..." -ForegroundColor Yellow
          Enable-WindowsOptionalFeature -Online -FeatureName VirtualMachinePlatform -All -NoRestart -ErrorAction Stop | Out-Null
          Write-Output "ENABLED"
        } else {
          Write-Output "ALREADY_ENABLED"
        }
      register: vm_feature
      changed_when: "'ENABLED' in vm_feature.stdout"
      failed_when: false
      when: "'NOT_INSTALLED' in wsl_current_status.stdout"
    
    - name: Set WSL2 as default version
      win_shell: |
        wsl --set-default-version 2 2>&1
      register: wsl_default_version
      changed_when: "'is already set' not in wsl_default_version.stdout"
      failed_when: false
      when: 
        - "'NOT_INSTALLED' in wsl_current_status.stdout"
        - wsl_feature.changed or vm_feature.changed or wsl_feature.stdout is not defined
    
    - name: Check WSL distributions
      win_shell: |
        $distros = wsl --list --verbose 2>&1
        $hasUbuntu2404 = $distros -match "Ubuntu-24\.04"
        $hasUbuntu2204 = $distros -match "Ubuntu-22\.04"
        
        if ($hasUbuntu2404) {
          Write-Output "UBUNTU_24_04_INSTALLED"
        } elseif ($hasUbuntu2204) {
          Write-Output "UBUNTU_22_04_INSTALLED"
        } elseif ($distros -match "Ubuntu") {
          Write-Output "UBUNTU_OTHER_INSTALLED"
        } else {
          Write-Output "NO_UBUNTU"
        }
        $distros
      register: ubuntu_status
      changed_when: false
      failed_when: false
      when: "'INSTALLED' in wsl_current_status.stdout"
    
    - name: Remove Ubuntu 22.04 if present
      win_shell: |
        Write-Host "Removing Ubuntu 22.04..." -ForegroundColor Yellow
        wsl --shutdown 2>&1 | Out-Null
        Start-Sleep -Seconds 2
        wsl --unregister Ubuntu-22.04 2>&1
        Write-Output "REMOVED"
      register: ubuntu22_remove
      changed_when: "'REMOVED' in ubuntu22_remove.stdout"
      failed_when: false
      when: 
        - "'INSTALLED' in wsl_current_status.stdout"
        - "'UBUNTU_22_04_INSTALLED' in ubuntu_status.stdout"
    
    - name: Install Ubuntu 24.04
      win_shell: |
        Write-Host "Installing Ubuntu {{ wsl_version }}..." -ForegroundColor Yellow
        wsl --install -d Ubuntu-{{ wsl_version }} --no-launch 2>&1
      register: ubuntu_install
      changed_when: "'is already installed' not in ubuntu_install.stdout"
      failed_when: false
      when: 
        - "'NO_UBUNTU' in ubuntu_status.stdout or 'UBUNTU_22_04_INSTALLED' in ubuntu_status.stdout or 'UBUNTU_OTHER_INSTALLED' in ubuntu_status.stdout or 'NOT_INSTALLED' in wsl_current_status.stdout"
    
    - name: Check if Ubuntu 24.04 requires first-run setup
      win_shell: |
        $testOutput = wsl -d Ubuntu-{{ wsl_version }} -- echo "test" 2>&1
        if ($LASTEXITCODE -eq 0) {
          Write-Output "CONFIGURED"
        } else {
          Write-Output "NEEDS_SETUP"
        }
      register: ubuntu_setup_status
      changed_when: false
      failed_when: false
      when: "'UBUNTU_24_04_INSTALLED' in ubuntu_status.stdout or ubuntu_install.changed"
    
    - name: Warn about Ubuntu first-run setup requirement
      debug:
        msg:
          - "⚠️  Ubuntu {{ wsl_version }} requires interactive first-run setup"
          - "Run manually: wsl -d Ubuntu-{{ wsl_version }}"
          - "When prompted, create username 'mdt' and set password"
          - "This is a one-time setup requirement"
      when: 
        - "'NEEDS_SETUP' in ubuntu_setup_status.stdout"
        - ubuntu_setup_status.stdout is defined
    
    - name: Ensure Ubuntu 24.04 is WSL2
      win_shell: |
        wsl --set-version Ubuntu-{{ wsl_version }} 2 2>&1
      register: wsl2_version
      changed_when: "'is already version 2' not in wsl2_version.stdout"
      failed_when: false
      when: "'UBUNTU_24_04_INSTALLED' in ubuntu_status.stdout or ubuntu_install.changed"
    
    - name: Set Ubuntu 24.04 as default
      win_shell: |
        wsl --set-default Ubuntu-{{ wsl_version }} 2>&1
      register: wsl_default
      changed_when: true
      failed_when: false
      when: "'UBUNTU_24_04_INSTALLED' in ubuntu_status.stdout or ubuntu_install.changed"
    
    - name: Wait for WSL to be ready
      win_shell: |
        Start-Sleep -Seconds 10
        Write-Output "WSL ready check complete"
      when: ubuntu_install.changed
    
    - name: Verify WSL2 installation
      win_shell: |
        wsl --list --verbose 2>&1
      register: wsl_final_status
      changed_when: false
      failed_when: false
    
    - name: Configure Docker Desktop to use WSL2 backend
      win_shell: |
        $dockerConfigPath = "$env:USERPROFILE\.docker\settings.json"
        $dockerConfigDir = Split-Path $dockerConfigPath -Parent
        
        # Ensure directory exists
        if (-not (Test-Path $dockerConfigDir)) {
          New-Item -ItemType Directory -Path $dockerConfigDir -Force | Out-Null
        }
        
        # Backup existing config
        if (Test-Path $dockerConfigPath) {
          $backupPath = "$dockerConfigPath.backup-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
          Copy-Item $dockerConfigPath $backupPath -ErrorAction SilentlyContinue
        }
        
        # Read existing config or create new
        if (Test-Path $dockerConfigPath) {
          try {
            $config = Get-Content $dockerConfigPath | ConvertFrom-Json
          } catch {
            $config = @{}
          }
        } else {
          $config = @{}
        }
        
        # Set WSL2 backend
        $needsUpdate = (-not $config.wslEngineEnabled)
        $config.wslEngineEnabled = $true
        
        # Save config
        $config | ConvertTo-Json -Depth 10 | Set-Content $dockerConfigPath -Encoding UTF8
        if ($needsUpdate) {
          Write-Output "Docker Desktop configured to use WSL2 backend"
        } else {
          Write-Output "Docker Desktop already configured for WSL2"
        }
      register: docker_config
      changed_when: "'configured' in docker_config.stdout"
    
    - name: Display configuration summary
      debug:
        msg:
          - "================================================================"
          - "  WSL2 Configuration Complete for {{ inventory_hostname }}"
          - "================================================================"
          - "WSL Status:"
          - "{{ wsl_final_status.stdout_lines | default(['Not available']) | join('\n') }}"
          - ""
          - "Docker Desktop: Configured to use WSL2 backend"
          - ""
          - "{{ '⚠️  REBOOT REQUIRED' if (wsl_feature.changed | default(false) or vm_feature.changed | default(false)) else '✅ No reboot required' }}"
          - "{{ 'Please reboot ' + inventory_hostname + ' to complete WSL2 installation' if (wsl_feature.changed | default(false) or vm_feature.changed | default(false)) else '' }}"
          - ""
          - "{{ '⚠️  MANUAL STEP REQUIRED: Ubuntu first-run setup' if (ubuntu_setup_status.stdout is defined and 'NEEDS_SETUP' in ubuntu_setup_status.stdout) else '' }}"
          - "{{ 'Run: wsl -d Ubuntu-' + wsl_version + ' and create mdt user' if (ubuntu_setup_status.stdout is defined and 'NEEDS_SETUP' in ubuntu_setup_status.stdout) else '' }}"
          - "================================================================"
