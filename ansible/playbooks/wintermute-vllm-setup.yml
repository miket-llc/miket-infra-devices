---
# Ansible playbook for setting up vLLM on Wintermute Windows workstation
# Run from Linux control node (motoko):
#   ansible-playbook -i inventory/hosts.yml playbooks/wintermute-vllm-setup.yml --limit wintermute --ask-vault-pass
#
# Progress tracking: This playbook has ~12 tasks. Use -v or -vv for detailed output.

- name: Setup vLLM on Wintermute
  hosts: wintermute
  gather_facts: yes
  
  vars:
    vllm_model: "{{ vllm_model_name | default('mistralai/Mistral-7B-Instruct-v0.2') }}"
    vllm_port: "{{ vllm_api_port | default(8000) }}"
    vllm_container_name: "vllm-wintermute"
    vllm_image: "vllm/vllm-openai:latest"
    auto_switch_enabled: true
    check_interval_minutes: 5
  
  tasks:
    - name: Display setup progress header
      debug:
        msg:
          - "================================================================"
          - "  Wintermute vLLM Setup - Progress Tracker"
          - "================================================================"
          - "Total tasks: 12"
          - "Starting setup..."
          - ""
      tags: [always]
    
    - name: "[1/12] Ensure WSL2 is installed and configured"
      win_shell: |
        Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Checking WSL2 installation..." -ForegroundColor Yellow
        
        # Check if WSL2 is installed
        $wslStatus = wsl --status 2>&1
        Write-Host $wslStatus
        
        # Check if WSL feature is enabled
        $wslFeature = Get-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux -ErrorAction SilentlyContinue
        if ($wslFeature.State -ne "Enabled") {
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] WSL feature not enabled - enabling..." -ForegroundColor Yellow
          Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux -All -NoRestart -ErrorAction Stop
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] WSL feature enabled" -ForegroundColor Green
        }
        
        # Check if Virtual Machine Platform is enabled (required for WSL2)
        $vmFeature = Get-WindowsOptionalFeature -Online -FeatureName VirtualMachinePlatform -ErrorAction SilentlyContinue
        if ($vmFeature.State -ne "Enabled") {
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Virtual Machine Platform not enabled - enabling..." -ForegroundColor Yellow
          Enable-WindowsOptionalFeature -Online -FeatureName VirtualMachinePlatform -All -NoRestart -ErrorAction Stop
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Virtual Machine Platform enabled" -ForegroundColor Green
        }
        
        # Set WSL2 as default version
        Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Setting WSL2 as default version..." -ForegroundColor Yellow
        wsl --set-default-version 2 2>&1 | Out-Null
        
        Write-Host "[$(Get-Date -Format 'HH:mm:ss')] WSL2 is configured" -ForegroundColor Green
      register: wsl_setup
      tags: [docker, wsl]
      failed_when: false
    
    - name: "[2/12] Ensure Docker Desktop is installed"
      win_chocolatey:
        name: docker-desktop
        state: present
      tags: [docker]
    
    - name: "[3/12] Ensure Docker Desktop service is running"
      win_service:
        name: com.docker.service
        state: started
        start_mode: auto
      tags: [docker]
    
    - name: "[4/12] Ensure Docker Desktop GUI is running (headless mode)"
      win_shell: |
        Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Checking Docker Desktop status..." -ForegroundColor Yellow
        
        $dockerDesktopPath = "C:\Program Files\Docker\Docker\Docker Desktop.exe"
        if (-not (Test-Path $dockerDesktopPath)) {
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Docker Desktop executable not found" -ForegroundColor Red
          exit 1
        }
        
        # Check if Docker Desktop process is running
        $process = Get-Process "Docker Desktop" -ErrorAction SilentlyContinue
        if (-not $process) {
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Starting Docker Desktop (headless)..." -ForegroundColor Yellow
          # Start Docker Desktop minimized/headless for service account
          Start-Process $dockerDesktopPath -WindowStyle Hidden
          Start-Sleep -Seconds 10
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Docker Desktop started" -ForegroundColor Green
        } else {
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Docker Desktop is already running" -ForegroundColor Cyan
        }
      register: docker_gui_start
      changed_when: "'Starting' in docker_gui_start.stdout"
      tags: [docker]
    
    - name: "[5/12] Ensure WSL2 docker-desktop distro is running"
      win_shell: |
        Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Checking WSL2 docker-desktop distro..." -ForegroundColor Yellow
        
        $wslList = wsl --list --verbose 2>&1
        Write-Host $wslList
        
        if ($wslList -match "docker-desktop.*Running") {
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] WSL2 docker-desktop is running" -ForegroundColor Green
          exit 0
        } elseif ($wslList -match "docker-desktop.*Stopped") {
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Starting WSL2 docker-desktop distro..." -ForegroundColor Yellow
          wsl -d docker-desktop -- echo "Starting" 2>&1 | Out-Null
          Start-Sleep -Seconds 5
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] WSL2 docker-desktop started" -ForegroundColor Green
          exit 0
        } else {
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] WSL2 docker-desktop distro not found - Docker Desktop may still be initializing" -ForegroundColor Yellow
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] This is normal for first-time setup" -ForegroundColor Cyan
          exit 0
        }
      register: wsl_check
      tags: [docker]
      failed_when: false
    
    - name: "[6/12] Wait for Docker to be ready (with progress output)"
      win_shell: |
        $timeout = 300
        $elapsed = 0
        $checkInterval = 10
        Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Waiting for Docker to be ready (timeout: ${timeout}s)..." -ForegroundColor Yellow
        Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Note: Docker Desktop can take 2-3 minutes to fully initialize" -ForegroundColor Cyan
        while ($elapsed -lt $timeout) {
          try {
            $dockerVersion = docker version 2>&1
            if ($LASTEXITCODE -eq 0) {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ✅ Docker is ready!" -ForegroundColor Green
              Write-Host $dockerVersion
              exit 0
            } else {
              $percent = [math]::Round(($elapsed / $timeout) * 100, 1)
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ⏳ Docker not ready yet (${elapsed}s/${timeout}s - ${percent}%)..." -ForegroundColor Cyan
            }
          } catch {
            $percent = [math]::Round(($elapsed / $timeout) * 100, 1)
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ⏳ Docker not ready yet (${elapsed}s/${timeout}s - ${percent}%)..." -ForegroundColor Cyan
          }
          Start-Sleep -Seconds $checkInterval
          $elapsed += $checkInterval
        }
        Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ❌ Docker did not become ready within ${timeout}s" -ForegroundColor Red
        Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Check Docker Desktop GUI for errors or try restarting Docker Desktop manually" -ForegroundColor Yellow
        exit 1
      register: docker_ready
      until: docker_ready.rc == 0
      retries: 1
      delay: 0
      async: 320
      poll: 10
      tags: [docker]
    
    - name: "[7/12] Create scripts directory"
      win_file:
        path: C:\Users\{{ ansible_user }}\dev\wintermute\scripts
        state: directory
      tags: [scripts]
    
    - name: "[8/12] Deploy vLLM management script"
      win_copy:
        src: "{{ playbook_dir }}/../devices/wintermute/scripts/Start-VLLM.ps1"
        dest: C:\Users\{{ ansible_user }}\dev\wintermute\scripts\Start-VLLM.ps1
      tags: [scripts]
    
    - name: "[9/12] Deploy auto mode switcher script"
      win_copy:
        src: "{{ playbook_dir }}/../devices/wintermute/scripts/Auto-ModeSwitcher.ps1"
        dest: C:\Users\{{ ansible_user }}\dev\wintermute\scripts\Auto-ModeSwitcher.ps1
      tags: [scripts]
    
    - name: "[10/12] Deploy mode switcher script"
      win_copy:
        src: "{{ playbook_dir }}/../devices/wintermute/scripts/Set-WorkstationMode.ps1"
        dest: C:\Users\{{ ansible_user }}\dev\wintermute\scripts\Set-WorkstationMode.ps1
      tags: [scripts]
    
    - name: "[11/12] Create vLLM configuration directory"
      win_file:
        path: C:\ProgramData\WintermuteMode
        state: directory
      tags: [config]
    
    - name: "[11/12] Create vLLM config file"
      win_copy:
        content: |
          {
            "model": "{{ vllm_model }}",
            "port": {{ vllm_port }},
            "container_name": "{{ vllm_container_name }}",
            "image": "{{ vllm_image }}",
            "auto_switch": {{ auto_switch_enabled | lower }}
          }
        dest: C:\ProgramData\WintermuteMode\vllm_config.json
      tags: [config]
    
    - name: "[12/12] Create scheduled task for auto mode switching"
      win_scheduled_task:
        name: Wintermute Auto Mode Switcher
        description: Automatically switches between workstation and LLM serving modes
        actions:
          - path: powershell.exe
            arguments: >
              -ExecutionPolicy Bypass -NoProfile -File
              "C:\Users\{{ ansible_user }}\dev\wintermute\scripts\Auto-ModeSwitcher.ps1"
        triggers:
          - type: boot
          - type: logon
          - type: daily
            start_time: "00:00"
          - type: time
            minutes_interval: "{{ check_interval_minutes }}"
            repetition_interval: "PT{{ check_interval_minutes }}M"
            repetition_duration: "PT24H"
        state: present
        enabled: "{{ auto_switch_enabled }}"
        run_level: highest
        username: SYSTEM
      tags: [scheduled_task]
    
    - name: Test vLLM script availability
      win_shell: |
        if (Test-Path "C:\Users\{{ ansible_user }}\dev\wintermute\scripts\Start-VLLM.ps1") {
          Write-Host "✅ vLLM scripts deployed successfully"
          exit 0
        } else {
          Write-Host "❌ vLLM scripts not found"
          exit 1
        }
      register: script_test
      tags: [scripts, test]
    
    - name: Display setup summary
      debug:
        msg:
          - ""
          - "================================================================"
          - "  ✅ vLLM Setup Complete for Wintermute"
          - "================================================================"
          - "Model: {{ vllm_model }}"
          - "Port: {{ vllm_port }}"
          - "Auto-switching: {{ auto_switch_enabled }}"
          - "Check interval: {{ check_interval_minutes }} minutes"
          - ""
          - "Next Steps:"
          - "  1. Manual: Install NVIDIA Container Toolkit in WSL2 Ubuntu 24.04"
          - "     See: docs/runbooks/wintermute-setup.md"
          - ""
          - "  2. Manually start vLLM:"
          - "     powershell -ExecutionPolicy Bypass -File C:\\Users\\{{ ansible_user }}\\dev\\wintermute\\scripts\\Start-VLLM.ps1 -Action Start"
          - ""
          - "  3. Check status:"
          - "     powershell -ExecutionPolicy Bypass -File C:\\Users\\{{ ansible_user }}\\dev\\wintermute\\scripts\\Start-VLLM.ps1 -Action Status"
          - ""
          - "  4. API will be available at:"
          - "     http://wintermute.pangolin-vega.ts.net:{{ vllm_port }}"
          - ""

