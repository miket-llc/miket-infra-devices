---
# Comprehensive Docker and AI Configuration Test for Armitage
# Tests: Docker Desktop, NVIDIA Container Toolkit, vLLM container, and AI model functionality
# Usage: ansible-playbook -i inventory/hosts.yml playbooks/test-armitage-docker-ai.yml --limit armitage

- name: Test Armitage Docker and AI Configuration
  hosts: armitage
  gather_facts: false
  vars:
    ansible_password: "{{ lookup('env', 'ARMITAGE_ANSIBLE_PASSWORD') }}"
  
  tasks:
    - name: Test Docker Desktop Service
      win_shell: |
        $service = Get-Service -Name "com.docker.service" -ErrorAction SilentlyContinue
        if ($service -and $service.Status -eq 'Running') {
          Write-Output "RUNNING"
          exit 0
        } else {
          Write-Output "STOPPED"
          exit 1
        }
      register: docker_service
      changed_when: false
    
    - name: Test Docker CLI availability
      win_shell: |
        docker --version 2>&1
      register: docker_version
      changed_when: false
      failed_when: false
    
    - name: Test Docker container status
      win_shell: |
        docker ps -a --filter "name=vllm-armitage" 2>&1
      register: container_status
      changed_when: false
      failed_when: false
    
    - name: Test NVIDIA Container Toolkit in WSL2
      win_shell: |
        wsl -d Ubuntu -- bash -c "dpkg -l | grep nvidia-container-toolkit && echo 'INSTALLED' || echo 'NOT_INSTALLED'" 2>&1
      register: nvidia_toolkit_status
      changed_when: false
      failed_when: false
    
    - name: Test NVIDIA repository configuration in WSL2
      win_shell: |
        wsl -d Ubuntu -- bash -c "
          if [ -f /etc/apt/sources.list.d/nvidia-container-toolkit.list ]; then
            if grep -q '<!doctype\|<html\|404' /etc/apt/sources.list.d/nvidia-container-toolkit.list 2>/dev/null; then
              echo 'BROKEN_HTML'
            elif grep -q '\$(ARCH)' /etc/apt/sources.list.d/nvidia-container-toolkit.list 2>/dev/null; then
              echo 'HAS_PLACEHOLDER'
              cat /etc/apt/sources.list.d/nvidia-container-toolkit.list
            else
              echo 'VALID'
              cat /etc/apt/sources.list.d/nvidia-container-toolkit.list
            fi
          else
            echo 'NOT_FOUND'
          fi
        " 2>&1
      register: nvidia_repo_status
      changed_when: false
      failed_when: false
    
    - name: Test GPU access from Docker container
      win_shell: |
        docker run --rm --gpus all nvidia/cuda:12.0.0-base-ubuntu22.04 nvidia-smi --query-gpu=name,driver_version --format=csv,noheader 2>&1 | Select-Object -First 5
      register: gpu_test
      changed_when: false
      failed_when: false
    
    - name: Check if vLLM container is running
      win_shell: |
        $containers = docker ps --filter "name=vllm-armitage" --format "{{ '{{' }}.Names{{ '}}' }}" 2>&1
        if ($containers -match "vllm-armitage") {
          Write-Output "RUNNING"
        } else {
          Write-Output "NOT_RUNNING"
        }
      register: container_running_check
      changed_when: false
      failed_when: false
    
    - name: Test vLLM container health
      win_shell: |
        docker exec vllm-armitage curl -s http://localhost:8000/health 2>&1
      register: vllm_health
      changed_when: false
      failed_when: false
      when: "'RUNNING' in container_running_check.stdout"
    
    - name: Test vLLM API endpoint (from container)
      win_shell: |
        docker exec vllm-armitage curl -s http://localhost:8000/v1/models 2>&1
      register: vllm_models
      changed_when: false
      failed_when: false
      when: "'RUNNING' in container_running_check.stdout"
    
    - name: Test port 8000 accessibility
      win_shell: |
        $listening = netstat -an | Select-String ":8000" | Select-String "LISTENING"
        if ($listening) {
          Write-Output "LISTENING"
          $listening
        } else {
          Write-Output "NOT_LISTENING"
        }
      register: port_8000_status
      changed_when: false
      failed_when: false
    
    - name: Get container logs (last 30 lines)
      win_shell: |
        docker logs --tail 30 vllm-armitage 2>&1
      register: container_logs
      changed_when: false
      failed_when: false
      when: "'vllm-armitage' in container_status.stdout"
    
    - name: Display comprehensive test results
      debug:
        msg:
          - "================================================================"
          - "  Armitage Docker and AI Configuration Test Results"
          - "================================================================"
          - ""
          - "Docker Desktop Service: {{ docker_service.stdout }}"
          - "Docker Version: {{ docker_version.stdout | default('N/A') }}"
          - ""
          - "vLLM Container Status:"
          - "  {{ container_status.stdout_lines | default(['Not found']) | join('\n') }}"
          - "  Running: {{ container_running_check.stdout | default('Unknown') }}"
          - ""
          - "Port 8000 Status: {{ port_8000_status.stdout_lines[0] | default('N/A') }}"
          - ""
          - "NVIDIA Container Toolkit:"
          - "  Status: {{ nvidia_toolkit_status.stdout | default('N/A') }}"
          - "  Repository: {{ nvidia_repo_status.stdout_lines[0] | default('N/A') if nvidia_repo_status.stdout_lines is defined else 'N/A' }}"
          - "  {{ nvidia_repo_status.stdout_lines[1:] | default([]) | join('\n') if (nvidia_repo_status.stdout_lines is defined and nvidia_repo_status.stdout_lines | length > 1) else '' }}"
          - ""
          - "GPU Access Test:"
          - "  {{ gpu_test.stdout_lines | default(['N/A']) | join('\n') }}"
          - ""
          - "vLLM Health Check:"
          - "  {{ vllm_health.stdout_lines | default(['Container not running or health check failed']) | join('\n') if vllm_health.stdout_lines is defined else 'Container not running' }}"
          - ""
          - "vLLM Models API:"
          - "  {{ vllm_models.stdout_lines | default(['Container not running or API check failed']) | join('\n') if vllm_models.stdout_lines is defined else 'Container not running' }}"
          - ""
          - "{{ 'Container Logs (last 30 lines):' if container_logs.stdout is defined else '' }}"
          - "{{ container_logs.stdout_lines | default([]) | join('\n') if container_logs.stdout_lines is defined else '' }}"
          - "================================================================"
      tags: [always]

- name: Test AI Model via LiteLLM Proxy
  hosts: localhost
  connection: local
  gather_facts: false
  
  tasks:
    - name: Test Armitage model via LiteLLM
      uri:
        url: "http://motoko.pangolin-vega.ts.net:8000/v1/chat/completions"
        method: POST
        headers:
          Content-Type: "application/json"
          Authorization: "Bearer mkt-test"
        body_format: json
        body:
          model: "qwen2.5-7b-armitage"
          messages:
            - role: "user"
              content: "Say hello and confirm you are working"
          max_tokens: 20
        status_code: [200, 500, 503]
        timeout: 15
      register: ai_test
      failed_when: false
    
    - name: Display AI model test results
      debug:
        msg:
          - "================================================================"
          - "  AI Model Test via LiteLLM Proxy"
          - "================================================================"
          - "Status Code: {{ ai_test.status | default('N/A') }}"
          - "{{ 'Response:' if ai_test.json is defined else 'Error:' }}"
          - "{{ ai_test.json.choices[0].message.content if (ai_test.json is defined and ai_test.json.choices is defined) else ai_test.msg | default('N/A') }}"
          - "================================================================"
      tags: [always]

