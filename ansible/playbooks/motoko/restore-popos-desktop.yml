---
# Restore Pop!_OS Desktop Features
# Re-enables Pop Shell tiling and other Pop!_OS extensions
# Usage: ansible-playbook -i ansible/inventory/hosts.yml ansible/playbooks/motoko/restore-popos-desktop.yml --connection=local

- name: Restore Pop!_OS Desktop Features
  hosts: motoko
  become: true
  
  vars:
    ansible_python_interpreter: /usr/bin/python3

  tasks:
    - name: Gather system facts
      ansible.builtin.setup:
        gather_subset:
          - 'all'

    - name: Check current extension status
      ansible.builtin.shell: |
        DISPLAY=:0 XAUTHORITY=/run/user/1000/gdm/Xauthority gnome-extensions list
      register: extension_list
      changed_when: false
      failed_when: false

    - name: Display current extension status
      ansible.builtin.debug:
        msg: "{{ extension_list.stdout_lines }}"

    - name: Enable Pop Shell (tiling window manager)
      ansible.builtin.shell: |
        DISPLAY=:0 XAUTHORITY=/run/user/1000/gdm/Xauthority gnome-extensions enable pop-shell@system76.com
      register: enable_pop_shell
      failed_when: false

    - name: Enable System76 Power extension
      ansible.builtin.shell: |
        DISPLAY=:0 XAUTHORITY=/run/user/1000/gdm/Xauthority gnome-extensions enable system76-power@system76.com
      register: enable_system76_power
      failed_when: false

    - name: Enable Pop!_OS COSMIC extensions (if available)
      ansible.builtin.shell: |
        DISPLAY=:0 XAUTHORITY=/run/user/1000/gdm/Xauthority gnome-extensions enable {{ item }}
      loop:
        - pop-cosmic@system76.com
        - cosmic-workspaces@system76.com
        - cosmic-dock@system76.com
      register: enable_cosmic
      failed_when: false
      ignore_errors: true

    - name: Enable other useful Pop!_OS extensions
      ansible.builtin.shell: |
        DISPLAY=:0 XAUTHORITY=/run/user/1000/gdm/Xauthority gnome-extensions enable {{ item }}
      loop:
        - ding@rastersoft.com
        - ubuntu-appindicators@ubuntu.com
        - caffeine@patapon.info
        - extension-list@tu.berry
      register: enable_other
      failed_when: false
      ignore_errors: true

    - name: Configure Pop Shell settings for tiling mode
      ansible.builtin.shell: |
        DISPLAY=:0 XAUTHORITY=/run/user/1000/gdm/Xauthority gsettings set org.gnome.shell.extensions.pop-shell tile-by-default true || true
        DISPLAY=:0 XAUTHORITY=/run/user/1000/gdm/Xauthority gsettings set org.gnome.shell.extensions.pop-shell management-orientation "['t']" || true
        DISPLAY=:0 XAUTHORITY=/run/user/1000/gdm/Xauthority gsettings set org.gnome.shell.extensions.pop-shell active-hint true || true
        DISPLAY=:0 XAUTHORITY=/run/user/1000/gdm/Xauthority gsettings set org.gnome.shell.extensions.pop-shell active-hint-border-radius 4 || true
        DISPLAY=:0 XAUTHORITY=/run/user/1000/gdm/Xauthority gsettings set org.gnome.shell.extensions.pop-shell gap-inner 0 || true
        DISPLAY=:0 XAUTHORITY=/run/user/1000/gdm/Xauthority gsettings set org.gnome.shell.extensions.pop-shell gap-outer 0 || true
      register: configure_pop_shell
      failed_when: false
      become_user: mdt

    - name: Restart GNOME Shell to apply extension changes
      ansible.builtin.shell: |
        DISPLAY=:0 XAUTHORITY=/run/user/1000/gdm/Xauthority killall -SIGQUIT gnome-shell || true
      register: restart_gnome
      failed_when: false

    - name: Wait for GNOME Shell to restart
      ansible.builtin.wait_for:
        timeout: 10

    - name: Verify extensions are enabled
      ansible.builtin.shell: |
        DISPLAY=:0 XAUTHORITY=/run/user/1000/gdm/Xauthority gnome-extensions list --enabled | grep -E "(pop-shell|system76)" || echo "No Pop!_OS extensions found"
      register: enabled_extensions
      changed_when: false

    - name: Display enabled Pop!_OS extensions
      ansible.builtin.debug:
        msg: "{{ enabled_extensions.stdout_lines }}"

    - name: Verify GNOME Shell is responsive
      ansible.builtin.shell: |
        DISPLAY=:0 XAUTHORITY=/run/user/1000/gdm/Xauthority timeout 3 bash -c 'dbus-send --session --type=method_call --dest=org.gnome.Shell /org/gnome/Shell org.gnome.Shell.Eval string:"Main.overview.visible" 2>&1' || echo "D-Bus check failed"
      register: dbus_check
      changed_when: false
      failed_when: false

    - name: Display D-Bus responsiveness check
      ansible.builtin.debug:
        msg: "{{ dbus_check.stdout }}"

    - name: Summary
      ansible.builtin.debug:
        msg:
          - "✅ Pop!_OS desktop features restored"
          - "✅ Pop Shell tiling enabled"
          - "✅ System76 extensions enabled"
          - "⚠️  Monitor system for stability - Pop Shell may have issues with VNC clients"
          - "If freezes occur, see: devices/motoko/COMPLETE_ROOT_CAUSE_ANALYSIS.md"

