---
# Playbook: setup-macos-tailscale.yml
# Ensures macOS devices have Tailscale properly configured with MagicDNS
# Run AFTER bootstrap-macos.sh has been executed locally on the macOS device
#
# Usage:
#   ansible-playbook -i inventory/hosts.yml playbooks/setup-macos-tailscale.yml
#   ansible-playbook -i inventory/hosts.yml playbooks/setup-macos-tailscale.yml -l count-zero

- name: Configure Tailscale on macOS devices
  hosts: macos
  gather_facts: true
  tasks:
    - name: Apply Tailscale macOS configuration
      ansible.builtin.include_role:
        name: tailscale_macos

    - name: Verify MagicDNS resolution
      ansible.builtin.command: ping -c 1 motoko.pangolin-vega.ts.net
      register: magicdns_test
      changed_when: false
      failed_when: false

    - name: Display MagicDNS test result
      ansible.builtin.debug:
        msg: "{{ 'MagicDNS is working' if magicdns_test.rc == 0 else 'MagicDNS resolution failed - may need manual tailscale up --accept-dns' }}"

    - name: Display connection information
      ansible.builtin.debug:
        msg:
          - "âœ… Tailscale configured on {{ inventory_hostname }}"
          - "SSH via Tailscale: ssh {{ ansible_user }}@{{ inventory_hostname }}.pangolin-vega.ts.net"
          - "If MagicDNS not working, run manually: sudo tailscale up --accept-dns --ssh"

