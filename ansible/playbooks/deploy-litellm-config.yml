---
# Deploy LiteLLM configuration with updated throttling and model aliases
- name: Deploy LiteLLM Proxy Configuration
  hosts: motoko
  become: yes
  vars_files:
    - ../group_vars/motoko.yml
    - ../group_vars/linux/vault.yml
  tasks:
    - name: Deploy updated LiteLLM config
      template:
        src: ../roles/litellm_proxy/templates/litellm.config.yaml.j2
        dest: /opt/litellm/litellm.config.yaml
        mode: '0644'
      register: config_deployed
      
    - name: Restart LiteLLM service
      systemd:
        name: litellm
        state: restarted
        daemon_reload: yes
      when: config_deployed.changed
      
    - name: Wait for LiteLLM to be ready
      wait_for:
        port: 8000
        host: 127.0.0.1
        delay: 5
        timeout: 30
        
    - name: Verify LiteLLM models
      uri:
        url: "http://127.0.0.1:8000/v1/models"
        method: GET
        return_content: yes
      register: models_response
      
    - name: Show available models
      debug:
        msg: "{{ models_response.json.data | map(attribute='id') | list }}"

