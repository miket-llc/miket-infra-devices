---
# Deploy RDP to Armitage
- name: Configure RDP on Armitage
  hosts: armitage
  gather_facts: yes
  vars:
    ansible_become: no  # Windows doesn't use become like Linux
  tasks:
    - name: Enable Remote Desktop
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server
        name: fDenyTSConnections
        data: 0
        type: dword

    - name: Enable Network Level Authentication (NLA)
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp
        name: UserAuthentication
        data: 1
        type: dword

    - name: Ensure Remote Desktop service is running
      win_service:
        name: TermService
        state: started
        start_mode: auto

    - name: Remove existing RDP firewall rules
      win_shell: |
        $rules = Get-NetFirewallRule | Where-Object { $_.DisplayName -like "*Remote Desktop*" -or $_.DisplayName -like "*RDP*" }
        if ($rules) {
          $rules | Remove-NetFirewallRule -ErrorAction SilentlyContinue
        }
      changed_when: false
      failed_when: false

    - name: Create RDP firewall rule restricted to Tailscale subnet
      win_shell: |
        New-NetFirewallRule -DisplayName "Remote Desktop (RDP) - Tailscale" `
          -Name "RDP-Tailscale" `
          -Direction Inbound `
          -Protocol TCP `
          -LocalPort 3389 `
          -RemoteAddress 100.64.0.0/10 `
          -Action Allow `
          -Enabled True `
          -ErrorAction SilentlyContinue
      register: firewall_rule_result
      changed_when: firewall_rule_result.rc == 0

    - name: Verify RDP is accessible
      win_shell: |
        $listener = Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue
        if ($listener) {
          Write-Output "RDP is listening on port 3389"
        } else {
          Write-Output "RDP is not listening"
          exit 1
        }
      register: rdp_verify
      changed_when: false

    - name: Display connection information
      debug:
        msg:
          - "âœ… RDP is enabled with Network Level Authentication"
          - "Connect via RDP to: armitage.pangolin-vega.ts.net:3389"
          - "Firewall rule created for Tailscale subnet (100.64.0.0/10)"

