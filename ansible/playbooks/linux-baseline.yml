# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# =============================================================================
# LINUX BASELINE PLAYBOOK
# =============================================================================
#
# Applies the standard container runtime to all Linux hosts (servers + workstations)
# This ensures Podman is the standard, Docker CLI compatibility works everywhere
#
# USAGE:
#   Apply to all Linux hosts:
#     ansible-playbook -i inventory/hosts.yml playbooks/linux-baseline.yml
#
#   Apply Podman standard only:
#     ansible-playbook -i inventory/hosts.yml playbooks/linux-baseline.yml --tags podman_standard
#
#   Apply to specific group:
#     ansible-playbook -i inventory/hosts.yml playbooks/linux-baseline.yml --limit linux_workstations
#
#   Verify only (no changes):
#     ansible-playbook -i inventory/hosts.yml playbooks/linux-baseline.yml --tags verify --check
#
# =============================================================================

- name: Apply Linux Baseline Configuration
  hosts: linux:!motoko
  become: true
  gather_facts: true

  pre_tasks:
    - name: Display deployment banner
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════════
          LINUX BASELINE DEPLOYMENT
          ═══════════════════════════════════════════════════════════════
          
          Host:           {{ inventory_hostname }}
          Distribution:   {{ ansible_distribution }} {{ ansible_distribution_version }}
          Kernel:         {{ ansible_kernel }}
          
          Applying:
            - Podman as standard container runtime
            - Docker CLI compatibility
            - Standard container configurations
          
          ═══════════════════════════════════════════════════════════════
      tags: [always]

  roles:
    # ========================================
    # Container Runtime Standard
    # ========================================
    # Podman with Docker CLI compatibility
    # Applies to all Linux hosts except motoko (has custom setup)
    - role: podman_standard_linux
      tags: [podman_standard, containers]

  post_tasks:
    - name: Verify Podman installation
      ansible.builtin.command: podman --version
      register: podman_version_check
      changed_when: false
      failed_when: false
      tags: [verify]

    - name: Verify Docker CLI compatibility
      ansible.builtin.command: docker --version
      register: docker_cli_check
      changed_when: false
      failed_when: false
      tags: [verify]

    - name: Test container run
      ansible.builtin.command: podman run --rm docker.io/library/alpine:latest echo "Container runtime works"
      register: container_test
      changed_when: false
      failed_when: false
      tags: [verify]

    - name: Display completion summary
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════════
          LINUX BASELINE DEPLOYMENT COMPLETE
          ═══════════════════════════════════════════════════════════════
          
          ✅ Container Runtime
             Podman:     {{ podman_version_check.stdout | default('Not installed') }}
             Docker CLI: {{ 'Working ✓' if docker_cli_check.rc == 0 else 'Not configured ✗' }}
          
          ✅ Container Test
             Result:     {{ 'Passed ✓' if container_test.rc == 0 else 'Failed ✗' }}
          
          Usage:
            docker ps
            docker run nginx:alpine
            podman-compose up -d
          
          Documentation: docs/CONTAINERS_RUNTIME_STANDARD.md
          ═══════════════════════════════════════════════════════════════
      tags: [always]

