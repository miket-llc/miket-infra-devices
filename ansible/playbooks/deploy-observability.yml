# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# =============================================================================
# OBSERVABILITY STACK DEPLOYMENT PLAYBOOK
# =============================================================================
#
# Deploys Prometheus + Grafana monitoring infrastructure:
#   1. node_exporter on all Linux servers (lightweight metrics collection)
#   2. Prometheus + Grafana + Blackbox on Akira (monitoring hub)
#
# Usage:
#   # Full deployment (exporters + stack)
#   ansible-playbook -i ansible/inventory/hosts.yml ansible/playbooks/deploy-observability.yml
#
#   # Just exporters
#   ansible-playbook -i ansible/inventory/hosts.yml ansible/playbooks/deploy-observability.yml --tags exporters
#
#   # Just stack (Akira only)
#   ansible-playbook -i ansible/inventory/hosts.yml ansible/playbooks/deploy-observability.yml --tags stack --limit akira
#
#   # Verify deployment
#   ansible-playbook -i ansible/inventory/hosts.yml ansible/playbooks/deploy-observability.yml --tags verify
#
# =============================================================================

# ========================================
# Phase 1: Deploy exporters to all monitored hosts
# ========================================
- name: Deploy exporters to monitored hosts
  hosts: monitoring_exporters
  gather_facts: true
  tags: [observability, exporters]

  roles:
    - role: observability_exporters
      vars:
        node_exporter_enabled: true
        windows_exporter_enabled: true

# ========================================
# Phase 2: Deploy Observability Stack to Akira
# ========================================
- name: Deploy Observability Stack to Akira
  hosts: akira
  become: true
  gather_facts: true
  tags: [observability, stack]

  pre_tasks:
    - name: Verify this is running on Akira only
      ansible.builtin.assert:
        that:
          - inventory_hostname == 'akira'
        fail_msg: "Observability stack should only be deployed to Akira"
        success_msg: "Deploying observability stack to Akira"

    - name: Ensure Grafana secrets env file exists
      ansible.builtin.file:
        path: /flux/runtime/secrets
        state: directory
        owner: root
        group: root
        mode: '0750'

    - name: Check for Grafana admin password
      ansible.builtin.stat:
        path: /flux/runtime/secrets/grafana.env
      register: grafana_env_file

    - name: Generate default Grafana admin password if not exists
      ansible.builtin.copy:
        content: |
          # Grafana admin credentials
          # Generated by Ansible - replace with AKV-synced value for production
          GRAFANA_ADMIN_PASSWORD=phc-admin-{{ lookup('password', '/dev/null length=12 chars=ascii_letters,digits') }}
        dest: /flux/runtime/secrets/grafana.env
        owner: root
        group: root
        mode: '0600'
      when: not grafana_env_file.stat.exists

  roles:
    - role: observability_stack
      vars:
        observability_enabled: true
        prometheus_node_exporter_targets:
          - name: motoko
            address: "motoko.pangolin-vega.ts.net:9100"
          - name: akira
            address: "localhost:9100"
          - name: atom
            address: "atom.pangolin-vega.ts.net:9100"
          - name: armitage
            address: "armitage.pangolin-vega.ts.net:9100"
        blackbox_http_targets:
          - name: nextcloud_status
            url: "https://nextcloud.miket.io/status.php"
            module: http_2xx
          - name: nextcloud_webdav
            url: "https://nextcloud.miket.io/remote.php/dav/"
            module: http_2xx

# ========================================
# Phase 3: Verification
# ========================================
- name: Verify Observability Deployment
  hosts: monitoring_exporters
  become: "{{ ansible_os_family != 'Darwin' }}"
  gather_facts: true
  tags: [observability, verify]

  tasks:
    - name: Check exporter is running (Linux/macOS)
      ansible.builtin.uri:
        url: "http://127.0.0.1:9100/metrics"
        method: GET
        status_code: 200
      register: node_exporter_check
      failed_when: false
      when: ansible_os_family != 'Windows'

    - name: Check exporter is running (Windows)
      ansible.windows.win_uri:
        url: "http://127.0.0.1:9182/metrics"
        method: GET
        status_code: 200
      register: windows_exporter_check
      failed_when: false
      when: ansible_os_family == 'Windows'

    - name: Report exporter status
      ansible.builtin.debug:
        msg: "Exporter on {{ inventory_hostname }}: {{ 'UP' if (node_exporter_check.status | default(0) == 200) or (windows_exporter_check.status_code | default(0) == 200) else 'DOWN' }}"

- name: Verify Observability Stack on Akira
  hosts: akira
  become: true
  gather_facts: false
  tags: [observability, verify]

  tasks:
    - name: Check Prometheus is running
      ansible.builtin.uri:
        url: "http://127.0.0.1:9090/-/ready"
        method: GET
        status_code: 200
      register: prometheus_check
      failed_when: false

    - name: Check Grafana is running
      ansible.builtin.uri:
        url: "http://127.0.0.1:3000/api/health"
        method: GET
        status_code: 200
      register: grafana_check
      failed_when: false

    - name: Check Blackbox Exporter is running
      ansible.builtin.uri:
        url: "http://127.0.0.1:9115/metrics"
        method: GET
        status_code: 200
      register: blackbox_check
      failed_when: false

    - name: Get Prometheus targets
      ansible.builtin.uri:
        url: "http://127.0.0.1:9090/api/v1/targets"
        method: GET
        return_content: true
      register: prometheus_targets
      failed_when: false

    - name: Display verification results
      ansible.builtin.debug:
        msg: |
          ========================================
          OBSERVABILITY STACK VERIFICATION
          ========================================

          Prometheus: {{ 'UP' if prometheus_check.status | default(0) == 200 else 'DOWN' }}
            URL: http://akira.pangolin-vega.ts.net:9090
            Targets: http://akira.pangolin-vega.ts.net:9090/targets

          Grafana: {{ 'UP' if grafana_check.status | default(0) == 200 else 'DOWN' }}
            URL: http://akira.pangolin-vega.ts.net:3000
            Login: admin / (check /flux/runtime/secrets/grafana.env)

          Blackbox Exporter: {{ 'UP' if blackbox_check.status | default(0) == 200 else 'DOWN' }}
            URL: http://akira.pangolin-vega.ts.net:9115

          ========================================
          ACCESS (Tailnet only):
          ========================================
          Dashboards: http://akira.pangolin-vega.ts.net:3000
          Prometheus: http://akira.pangolin-vega.ts.net:9090

          ========================================

# ========================================
# Summary
# ========================================
- name: Deployment Summary
  hosts: localhost
  gather_facts: false
  tags: [observability, summary]

  tasks:
    - name: Display deployment summary
      ansible.builtin.debug:
        msg: |
          ========================================
          OBSERVABILITY DEPLOYMENT COMPLETE
          ========================================

          node_exporter deployed to:
            - motoko
            - akira
            - atom
            - armitage

          Observability stack on Akira:
            - Prometheus (http://akira.pangolin-vega.ts.net:9090)
            - Grafana (http://akira.pangolin-vega.ts.net:3000)
            - Blackbox Exporter (http://akira.pangolin-vega.ts.net:9115)

          Dashboards provisioned:
            - PHC Node Exporter (CPU, memory, disk, network)
            - PHC HTTP Endpoints (uptime, latency, SSL)
            - PHC Prometheus Stats (scrape targets, TSDB)

          HTTP probes configured:
            - https://nextcloud.miket.io/status.php
            - https://nextcloud.miket.io/remote.php/dav/

          ========================================
          MANUAL STEP REQUIRED:
          ========================================
          Add tag:monitoring to akira in Tailscale admin console

          ========================================
