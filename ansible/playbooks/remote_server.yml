---
# Playbook: remote_server.yml
# Configures remote desktop servers per host OS
# ALL PLATFORMS NOW USE NOMACHINE (replacing VNC on Linux, RDP on Windows)

- name: Configure Linux remote desktop servers (NoMachine replaces VNC)
  hosts: workstations:&linux
  gather_facts: true
  become: true
  tags:
    - remote
    - remote:server
  tasks:
    - name: Install and configure NoMachine for Linux (includes VNC removal)
      ansible.builtin.include_role:
        name: remote_server_linux_nomachine

    - name: Configure firewall for NoMachine
      ansible.builtin.include_role:
        name: remote_firewall
      vars:
        remote_protocol: nomachine
        remote_port: "{{ nomachine_port | default(4000) }}"
        remote_detection:
          firewall:
            type: "{{ 'ufw' if (ansible_facts.pkg_mgr == 'apt') else 'none' }}"

- name: Configure Windows remote desktop servers (NoMachine replaces RDP)
  hosts: workstations:&windows
  gather_facts: true
  become: false
  tags:
    - remote
    - remote:server
  vars:
    ansible_become: false
  tasks:
    - name: Install and configure NoMachine for Windows
      ansible.builtin.include_role:
        name: remote_server_windows_nomachine

    - name: Disable RDP server (NoMachine replaces it)
      ansible.builtin.include_role:
        name: disable_windows_rdp
      vars:
        rdp_disable_completely: true

- name: Configure macOS remote desktop servers (NoMachine replaces VNC)
  hosts: macos
  gather_facts: true
  tags:
    - remote
    - remote:server
  tasks:
    - name: Install and configure NoMachine for macOS
      ansible.builtin.include_role:
        name: remote_server_macos_nomachine
