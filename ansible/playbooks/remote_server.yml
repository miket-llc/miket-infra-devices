# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# Playbook: remote_server.yml
# Configures NoMachine remote desktop servers per host OS
# NoMachine is the sole remote desktop solution (RDP/VNC architecturally retired 2025-11-22)

- name: Configure Linux remote desktop servers (NoMachine only)
  hosts: workstations:&linux
  gather_facts: true
  become: true
  tags:
    - remote
    - remote:server
  tasks:
    - name: Install and configure NoMachine for Linux
      ansible.builtin.include_role:
        name: remote_server_linux_nomachine

    - name: Configure firewall for NoMachine
      ansible.builtin.include_role:
        name: remote_firewall
      vars:
        remote_protocol: nomachine
        remote_port: "{{ nomachine_port | default(4000) }}"
        remote_detection:
          firewall:
            type: "{{ 'ufw' if (ansible_facts.pkg_mgr == 'apt') else 'none' }}"

- name: Configure Windows remote desktop servers (NoMachine only)
  hosts: workstations:&windows
  gather_facts: true
  become: false
  tags:
    - remote
    - remote:server
  vars:
    ansible_become: false
  tasks:
    - name: Install and configure NoMachine for Windows
      ansible.builtin.include_role:
        name: remote_server_windows_nomachine

    - name: Disable deprecated RDP server (architectural compliance)
      ansible.builtin.include_role:
        name: disable_windows_rdp
      vars:
        rdp_disable_completely: true

- name: Configure macOS remote desktop servers (NoMachine only)
  hosts: macos
  gather_facts: true
  tags:
    - remote
    - remote:server
  tasks:
    - name: Install and configure NoMachine for macOS
      ansible.builtin.include_role:
        name: remote_server_macos_nomachine
