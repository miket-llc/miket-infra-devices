---
# Playbook: remote_server.yml
# Configures remote desktop servers per host OS
# Every workstation serves its protocol: Linux=VNC, Windows=RDP, macOS=VNC

- name: Configure Linux VNC servers (session sharing)
  hosts: workstations:&linux
  gather_facts: yes
  become: yes
  tags:
    - remote
    - remote:server
  tasks:
    - name: Install and configure VNC for session sharing
      ansible.builtin.include_role:
        name: remote_server_linux_vnc
      when: remote_protocol | default('vnc') == 'vnc'

    - name: Configure firewall for VNC
      ansible.builtin.include_role:
        name: remote_firewall
      vars:
        remote_protocol: vnc
        remote_port: "{{ remote_port | default(5900) }}"
        remote_detection:
          firewall:
            type: "{{ 'ufw' if (ansible_facts.pkg_mgr == 'apt') else 'none' }}"

- name: Configure Windows RDP servers
  hosts: workstations:&windows
  gather_facts: yes
  become: no
  tags:
    - remote
    - remote:server
  vars:
    ansible_become: no  # Explicitly disable become for Windows
  tasks:
    - name: Enable and configure RDP
      ansible.builtin.include_role:
        name: remote_server_windows_rdp

    - name: Note firewall is configured by RDP role
      ansible.builtin.debug:
        msg: "Firewall rules are configured by remote_server_windows_rdp role"

- name: Configure macOS remote desktop (documentation only)
  hosts: macos
  gather_facts: yes
  tags:
    - remote
    - remote:server
  tasks:
    - name: Display macOS remote desktop setup instructions
      ansible.builtin.debug:
        msg:
          - "macOS Remote Desktop Configuration:"
          - "  For Screen Sharing (VNC):"
          - "    1. System Settings > Sharing > Screen Sharing"
          - "    2. Enable Screen Sharing"
          - "    3. Configure access permissions"
          - "  For Remote Management (VNC + SSH):"
          - "    1. System Settings > Sharing > Remote Management"
          - "    2. Enable Remote Management"
          - "  Note: RDP is not natively supported on macOS"
          - "  Use VNC (port 5900) or Apple Remote Desktop"

