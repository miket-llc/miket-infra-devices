---
# Playbook: remote_server.yml
# Configures remote desktop servers per host OS
# Linux and macOS use NoMachine (replacing VNC), Windows uses RDP

- name: Configure Linux remote desktop servers (NoMachine replaces VNC)
  hosts: workstations:&linux
  gather_facts: true
  become: true
  tags:
    - remote
    - remote:server
  tasks:
    - name: Stop and disable VNC service (removing VNC in favor of NoMachine)
      ansible.builtin.systemd:
        name: tigervnc.service
        state: stopped
        enabled: false
      become: true
      failed_when: false

    - name: Remove VNC firewall rules
      ansible.builtin.shell: |
        while sudo ufw status numbered 2>/dev/null | grep -q "5900"; do
          RULE_NUM=$(sudo ufw status numbered 2>/dev/null | grep "5900" | head -1 | sed -n 's/\[ *\([0-9]*\)\].*/\1/p')
          if [ -n "$RULE_NUM" ]; then
            echo "y" | sudo ufw delete "$RULE_NUM" 2>/dev/null || break
          else
            break
          fi
        done
      become: true
      changed_when: false
      failed_when: false

    - name: Install and configure NoMachine for Linux
      ansible.builtin.include_role:
        name: remote_server_linux_nomachine

    - name: Configure firewall for NoMachine
      ansible.builtin.include_role:
        name: remote_firewall
      vars:
        remote_protocol: nomachine
        remote_port: "{{ nomachine_port | default(4000) }}"
        remote_detection:
          firewall:
            type: "{{ 'ufw' if (ansible_facts.pkg_mgr == 'apt') else 'none' }}"

- name: Configure Windows RDP servers
  hosts: workstations:&windows
  gather_facts: true
  become: false
  tags:
    - remote
    - remote:server
  vars:
    ansible_become: false
  tasks:
    - name: Enable and configure RDP
      ansible.builtin.include_role:
        name: remote_server_windows_rdp

- name: Configure macOS remote desktop servers (NoMachine replaces VNC)
  hosts: macos
  gather_facts: true
  tags:
    - remote
    - remote:server
  tasks:
    - name: Install and configure NoMachine for macOS
      ansible.builtin.include_role:
        name: remote_server_macos_nomachine
