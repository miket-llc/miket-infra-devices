---
# Simple RDP enablement playbook
- name: Enable RDP on Windows devices
  hosts: windows_workstations
  gather_facts: false
  vars:
    ansible_become: false
  tasks:
    - name: Enable Remote Desktop
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server
        name: fDenyTSConnections
        data: 0
        type: dword

    - name: Enable Network Level Authentication (NLA)
      win_regedit:
        path: HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp
        name: UserAuthentication
        data: 1
        type: dword

    - name: Ensure Remote Desktop service is running
      win_service:
        name: TermService
        state: started
        start_mode: auto

    - name: Create RDP firewall rule for Tailscale
      win_shell: |
        New-NetFirewallRule -DisplayName "Remote Desktop (RDP) - Tailscale" `
          -Name "RDP-Tailscale" `
          -Direction Inbound `
          -Protocol TCP `
          -LocalPort 3389 `
          -RemoteAddress 100.64.0.0/10 `
          -Action Allow `
          -Enabled True `
          -Force `
          -ErrorAction SilentlyContinue
      changed_when: false
      failed_when: false

    - name: Display success message
      debug:
        msg: "âœ… RDP enabled on {{ inventory_hostname }}"


