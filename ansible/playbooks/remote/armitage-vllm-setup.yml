---
# Ansible playbook for setting up vLLM on Armitage Windows workstation
# Run from Linux control node (motoko):
#   ansible-playbook -i inventory/hosts.yml playbooks/armitage-vllm-setup.yml --limit armitage --ask-vault-pass

- name: Setup vLLM on Armitage
  hosts: armitage
  gather_facts: true
  
  vars:
    vllm_model: "{{ vllm_model_name | default('mistralai/Mistral-7B-Instruct-v0.2') }}"
    vllm_port: "{{ vllm_api_port | default(8000) }}"
    vllm_container_name: "vllm-armitage"
    vllm_image: "vllm/vllm-openai:latest"
    auto_switch_enabled: true
    check_interval_minutes: 5
  
  tasks:
    - name: Record playbook start time
      set_fact:
        playbook_start_time: "{{ ansible_date_time.epoch }}"
      tags: [always]
    
    - name: "[1/11] Ensure WSL2 is installed and configured"
      win_shell: |
        $ErrorActionPreference = "Continue"
        
        # Enable WSL feature if needed
        $wslFeature = Get-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux -ErrorAction SilentlyContinue
        if ($wslFeature.State -ne "Enabled") {
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Enabling WSL feature..." -ForegroundColor Yellow
          Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux -All -NoRestart -ErrorAction Stop | Out-Null
        }
        
        # Enable Virtual Machine Platform if needed
        $vmFeature = Get-WindowsOptionalFeature -Online -FeatureName VirtualMachinePlatform -ErrorAction SilentlyContinue
        if ($vmFeature.State -ne "Enabled") {
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Enabling Virtual Machine Platform..." -ForegroundColor Yellow
          Enable-WindowsOptionalFeature -Online -FeatureName VirtualMachinePlatform -All -NoRestart -ErrorAction Stop | Out-Null
        }
        
        # Set WSL2 as default
        wsl --set-default-version 2 2>&1 | Out-Null
        
        # Check for existing WSL distributions
        $wslList = wsl --list --verbose 2>&1
        $hasDistro = $false
        
        if ($wslList -match "^\s+\w+") {
          $distros = $wslList | Select-String -Pattern "^\s+(\w+)" | ForEach-Object { $_.Matches.Groups[1].Value }
          foreach ($distro in $distros) {
            if ($distro -notmatch "docker-desktop|NAME") {
              $hasDistro = $true
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Found WSL distribution: $distro" -ForegroundColor Green
              break
            }
          }
        }
        
        # Install Ubuntu if no distribution exists
        if (-not $hasDistro) {
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Installing Ubuntu WSL distribution..." -ForegroundColor Yellow
          wsl --install -d Ubuntu --no-launch 2>&1 | Out-Null
          if ($LASTEXITCODE -eq 0) {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Ubuntu installation initiated" -ForegroundColor Green
          }
        }
        
        Write-Host "[$(Get-Date -Format 'HH:mm:ss')] WSL2 configured" -ForegroundColor Green
      register: wsl_setup
      tags: [docker, wsl]
      failed_when: false
    
    - name: "[2/11] Check if Docker Desktop is installed"
      win_stat:
        path: 'C:\Program Files\Docker\Docker\Docker Desktop.exe'
      register: docker_desktop_exe
      tags: [docker]
    
    - name: "[3/11] Install Docker Desktop if needed"
      win_chocolatey:
        name: docker-desktop
        state: present
      when: not docker_desktop_exe.stat.exists
      tags: [docker]
      register: docker_install
    
    - name: "[4/11] Ensure Docker Desktop service is running"
      win_service:
        name: com.docker.service
        state: started
        start_mode: auto
      tags: [docker]
    
    - name: "[5/11] Start Docker Desktop GUI"
      win_shell: |
        $dockerDesktopPath = 'C:\Program Files\Docker\Docker\Docker Desktop.exe'
        if (-not (Test-Path $dockerDesktopPath)) {
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Docker Desktop not found" -ForegroundColor Red
          exit 1
        }
        
        # Ensure WSL distribution is running (Docker Desktop needs this)
        $wslList = wsl --list --verbose 2>&1
        if ($wslList -match "Ubuntu.*Stopped") {
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Starting Ubuntu WSL distribution..." -ForegroundColor Yellow
          wsl -d Ubuntu -- echo "Starting Ubuntu" 2>&1 | Out-Null
          Start-Sleep -Seconds 5
        }
        
        $process = Get-Process "Docker Desktop" -ErrorAction SilentlyContinue
        if (-not $process) {
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Starting Docker Desktop..." -ForegroundColor Yellow
          Start-Process $dockerDesktopPath -WindowStyle Hidden
          Start-Sleep -Seconds 15
          
          # Verify it started
          $process = Get-Process "Docker Desktop" -ErrorAction SilentlyContinue
          if ($process) {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Docker Desktop started successfully" -ForegroundColor Green
          } else {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Warning: Docker Desktop process not found after start attempt" -ForegroundColor Yellow
          }
        } else {
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Docker Desktop is already running" -ForegroundColor Green
        }
      register: docker_gui_start
      changed_when: "'Starting' in docker_gui_start.stdout"
      tags: [docker]
    
    - name: "[6/11] Wait for Docker daemon to be ready"
      win_shell: |
        $timeout = 600
        $elapsed = 0
        $checkInterval = 15
        $startTime = Get-Date
        
        Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Waiting for Docker daemon (timeout: ${timeout}s)..." -ForegroundColor Yellow
        
        while ($elapsed -lt $timeout) {
          try {
            $dockerOutput = docker version 2>&1
            $dockerExitCode = $LASTEXITCODE
            
            if ($dockerExitCode -eq 0 -and $dockerOutput -match "Server:" -and $dockerOutput -match "Version:") {
              $duration = (Get-Date) - $startTime
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ✅ Docker ready! (took $([math]::Round($duration.TotalSeconds, 1))s)" -ForegroundColor Green
              exit 0
            }
            
            $percent = [math]::Round(($elapsed / $timeout) * 100, 1)
            $remaining = $timeout - $elapsed
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ⏳ Waiting... (${elapsed}s/${timeout}s - ${percent}% - ${remaining}s remaining)" -ForegroundColor Cyan
          } catch {
            $percent = [math]::Round(($elapsed / $timeout) * 100, 1)
            $remaining = $timeout - $elapsed
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ⏳ Error checking Docker (${elapsed}s/${timeout}s)" -ForegroundColor Yellow
          }
          
          Start-Sleep -Seconds $checkInterval
          $elapsed += $checkInterval
        }
        
        Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ❌ Docker did not become ready within ${timeout}s" -ForegroundColor Red
        exit 1
      register: docker_ready
      async: 660
      poll: 20
      tags: [docker]
      timeout: 660
    
    - name: "[7/11] Create scripts directory"
      win_file:
        path: C:\Users\{{ ansible_user }}\dev\armitage\scripts
        state: directory
      tags: [scripts]
    
    - name: "[8/11] Deploy vLLM scripts"
      win_copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
      loop:
        - { src: "{{ playbook_dir }}/../devices/armitage/scripts/Start-VLLM.ps1", dest: "C:\\Users\\{{ ansible_user }}\\dev\\armitage\\scripts\\Start-VLLM.ps1" }
        - { src: "{{ playbook_dir }}/../devices/armitage/scripts/Set-WorkstationMode.ps1", dest: "C:\\Users\\{{ ansible_user }}\\dev\\armitage\\scripts\\Set-WorkstationMode.ps1" }
      tags: [scripts]
    
    - name: "[9/11] Create vLLM configuration"
      win_file:
        path: C:\ProgramData\ArmitageMode
        state: directory
      tags: [config]
    
    - name: "[9/11] Write vLLM config file"
      win_copy:
        content: |
          {
            "model": "{{ vllm_model }}",
            "port": {{ vllm_port }},
            "container_name": "{{ vllm_container_name }}",
            "image": "{{ vllm_image }}",
            "auto_switch": {{ auto_switch_enabled | lower }}
          }
        dest: C:\ProgramData\ArmitageMode\vllm_config.json
      tags: [config]
    
    # Auto-switcher scheduled task removed per CEO directive - energy wasting code
    
    - name: "[11/11] Verify deployment"
      win_shell: |
        $scriptsOk = Test-Path "C:\Users\{{ ansible_user }}\dev\armitage\scripts\Start-VLLM.ps1"
        $configOk = Test-Path "C:\ProgramData\ArmitageMode\vllm_config.json"
        
        if ($scriptsOk -and $configOk) {
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ✅ All files deployed successfully" -ForegroundColor Green
          exit 0
        } else {
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ❌ Deployment verification failed" -ForegroundColor Red
          exit 1
        }
      tags: [verify]
    
    - name: Display deployment summary
      debug:
        msg:
          - ""
          - "================================================================"
          - "  ✅ vLLM Setup Complete"
          - "================================================================"
          - "Duration: {{ ((ansible_date_time.epoch | int) - (playbook_start_time | int)) // 60 }}m {{ ((ansible_date_time.epoch | int) - (playbook_start_time | int)) % 60 }}s"
          - "Model: {{ vllm_model }}"
          - "Port: {{ vllm_port }}"
          - "API: http://armitage.pangolin-vega.ts.net:{{ vllm_port }}"
          - ""
      tags: [always]
