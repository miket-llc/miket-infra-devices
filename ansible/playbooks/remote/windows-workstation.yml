# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# =============================================================================
# WINDOWS WORKSTATION PLAYBOOK
# =============================================================================
#
# Configures Windows workstations (Armitage, Wintermute) with:
# - Common dev tools (git, gh, jq, etc.)
# - Workstation GUI tools (Cursor, VS Code, Windows Terminal)
# - NVIDIA/CUDA, Docker, WSL2, etc.
#
# USAGE:
#   Full deployment:
#     ansible-playbook -i inventory/hosts.yml playbooks/remote/windows-workstation.yml
#
#   Dev tools only:
#     ansible-playbook -i inventory/hosts.yml playbooks/remote/windows-workstation.yml --tags dev_tools
#
#   GUI tools only:
#     ansible-playbook -i inventory/hosts.yml playbooks/remote/windows-workstation.yml --tags workstation_gui
#
# =============================================================================

- name: Configure Windows Workstations
  hosts: windows_workstations
  gather_facts: true
  # Note: ansible_password is set in inventory/hosts.yml using AKV lookup
  # Do NOT override it here with env vars

  pre_tasks:
    - name: Display deployment banner
      ansible.builtin.debug:
        msg: |
          ═══════════════════════════════════════════════════════════════
          WINDOWS WORKSTATION DEPLOYMENT
          ═══════════════════════════════════════════════════════════════
          
          Host: {{ inventory_hostname }}
          
          Deployment Phases:
            1. common_dev_tools      - Baseline dev tooling (git, gh, jq, etc.)
            2. workstation_gui_tools - GUI apps (Cursor, VS Code, Windows Terminal)
            3. Windows-specific      - WSL2, Docker, NVIDIA, gaming optimizations
          
          ═══════════════════════════════════════════════════════════════
      tags: [always]

  roles:
    # ========================================
    # Phase 1: Common Dev Tools
    # ========================================
    - role: common_dev_tools
      tags: [dev_tools]

    # ========================================
    # Phase 2: Workstation GUI Tools
    # ========================================
    - role: workstation_gui_tools
      tags: [workstation_gui]

  tasks:
    # ========================================
    # Phase 3: Windows-Specific Configuration
    # ========================================
    - name: Ensure WinRM is configured
      win_service:
        name: WinRM
        state: started
        start_mode: auto
      tags: [winrm]

    - name: Install Windows-specific development tools via Chocolatey
      win_chocolatey:
        name: "{{ item }}"
        state: present
      loop:
        - docker-desktop
        - nvidia-display-driver
        - cuda
        - python3
        - nodejs
        - tailscale
      tags: [packages, windows_dev]
    
    - name: Ensure automation user is in docker-users group
      win_group_membership:
        name: docker-users
        members: "{{ ansible_user }}"
        state: present
      when: docker_desktop.enabled | default(true)
      tags: [docker, groups]

    - name: Enable WSL2 feature
      win_feature:
        name: 
          - Microsoft-Windows-Subsystem-Linux
          - VirtualMachinePlatform
        state: present
      register: wsl_feature
      tags: [wsl]

    - name: Set WSL2 as default
      win_command: wsl --set-default-version 2
      when: wsl_feature.changed
      tags: [wsl]

    - name: Configure Windows power plan for gaming
      win_power_plan:
        name: high performance
      when: workstation_mode is defined and workstation_mode == 'gaming'
      tags: [power]

    - name: Manage Windows services based on mode
      win_service:
        name: "{{ item.name }}"
        state: "{{ item.state }}"
        start_mode: "{{ item.start_mode | default('manual') }}"
      loop: "{{ windows_services }}"
      when: windows_services is defined
      tags: [services]

    - name: Configure NVIDIA GPU settings
      win_shell: |
        & "${env:ProgramFiles}\NVIDIA Corporation\NVSMI\nvidia-smi.exe" -pm {{ gpu_persistence_mode | default('0') }}
      when: 
        - ansible_facts['ansible_video_cards'] is defined
        - "'NVIDIA' in ansible_facts['ansible_video_cards'][0]['name']"
      tags: [nvidia]

    - name: Set registry values for gaming optimizations
      win_regedit:
        path: "{{ item.path }}"
        name: "{{ item.name }}"
        data: "{{ item.data }}"
        type: "{{ item.type }}"
      loop:
        - path: HKLM:\SYSTEM\CurrentControlSet\Control\GraphicsDrivers
          name: HwSchMode
          data: 2
          type: dword
        - path: HKCU:\Software\Microsoft\GameBar
          name: AutoGameModeEnabled
          data: "{{ (workstation_mode == 'gaming') | ternary(1, 0) }}"
          type: dword
      when: workstation_mode is defined
      tags: [registry, gaming]

    - name: Deploy PowerShell profile scripts
      win_copy:
        src: "{{ item }}"
        dest: C:\Users\{{ ansible_user }}\Documents\WindowsPowerShell\
      loop:
        - files/Microsoft.PowerShell_profile.ps1
      tags: [powershell]

    - name: Configure Windows Defender exclusions for development and automation
      win_shell: |
        Write-Host "Configuring Windows Defender exclusions for Ansible automation..." -ForegroundColor Yellow
        
        # Path exclusions
        $exclusionPaths = @(
          "C:\Users\{{ ansible_user }}\dev",
          "C:\ProgramData\Docker",
          "C:\Windows\Temp",
          "C:\ProgramData\ArmitageMode"
        )
        
        foreach ($path in $exclusionPaths) {
          if (Test-Path $path) {
            try {
              Add-MpPreference -ExclusionPath $path -ErrorAction SilentlyContinue
              Write-Host "  Added exclusion: $path" -ForegroundColor Green
            } catch {
              # May already exist
            }
          }
        }
        
        # Process exclusions (for performance)
        $exclusionProcesses = @(
          "powershell.exe",
          "wsl.exe",
          "docker.exe"
        )
        
        foreach ($process in $exclusionProcesses) {
          try {
            Add-MpPreference -ExclusionProcess $process -ErrorAction SilentlyContinue
            Write-Host "  Added process exclusion: $process" -ForegroundColor Green
          } catch {
            # May already exist
          }
        }
        
        Write-Host "Windows Defender exclusions configured" -ForegroundColor Green
      tags: [defender]

    - name: Ensure Tailscale is running
      win_service:
        name: Tailscale
        state: started
        start_mode: auto
      tags: [tailscale]

# Separate playbook section for mode switching
- name: Switch Workstation Mode
  hosts: "{{ target_host | default('armitage') }}"
  gather_facts: false
  vars_prompt:
    - name: target_mode
      prompt: "Enter mode (gaming/productivity/development)"
      private: false
      default: productivity
  
  tasks:
    - name: Apply workstation mode
      include_role:
        name: windows-workstation-mode
      vars:
        workstation_mode: "{{ target_mode }}"