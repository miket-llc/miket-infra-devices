---
# Diagnostic playbook for RDP configuration
- name: Diagnose RDP Configuration
  hosts: windows
  gather_facts: true
  vars:
    ansible_become: false
    ansible_password: >-
      {{ lookup('env', 'WINTERMUTE_ANSIBLE_PASSWORD') if inventory_hostname == 'wintermute'
         else lookup('env', 'ARMITAGE_ANSIBLE_PASSWORD') }}
  tasks:
    - name: Check Group Policy fDenyTSConnections
      win_shell: |
        $gp = Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" -Name "fDenyTSConnections" -ErrorAction SilentlyContinue
        if ($gp) {
          Write-Output "Group Policy fDenyTSConnections: $($gp.fDenyTSConnections)"
        } else {
          Write-Output "Group Policy fDenyTSConnections: NOT SET"
        }
      register: gp_check

    - name: Check Registry fDenyTSConnections
      win_shell: |
        $reg = Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -ErrorAction SilentlyContinue
        if ($reg) {
          Write-Output "Registry fDenyTSConnections: $($reg.fDenyTSConnections)"
        } else {
          Write-Output "Registry fDenyTSConnections: NOT SET"
        }
      register: reg_check

    - name: Check for conflicting Group Policies
      win_shell: |
        $policies = @()
        # Check for Allow users to connect remotely policy
        $allowRemote = Get-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" -Name "fDenyTSConnections" -ErrorAction SilentlyContinue
        if ($allowRemote) {
          $policies += "fDenyTSConnections: $($allowRemote.fDenyTSConnections)"
        }
        # Check for other RDP-related policies
        $rdpPolicies = Get-ChildItem -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.PSChildName -like "*RDP*" -or $_.PSChildName -like "*Remote*" }
        if ($rdpPolicies) {
          foreach ($policy in $rdpPolicies) {
            $policies += "$($policy.PSPath): $($policy.PSChildName)"
          }
        }
        if ($policies.Count -eq 0) {
          Write-Output "No additional RDP policies found"
        } else {
          $policies | ForEach-Object { Write-Output $_ }
        }
      register: policy_check

    - name: Check RDP Service Status
      win_shell: |
        $svc = Get-Service TermService -ErrorAction SilentlyContinue
        if ($svc) {
          Write-Output "Service Status: $($svc.Status)"
          Write-Output "Startup Type: $($svc.StartType)"
        } else {
          Write-Output "Service: NOT FOUND"
        }
      register: service_check

    - name: Check RDP Listener
      win_shell: |
        $listener = Get-NetTCPConnection -LocalPort 3389 -ErrorAction SilentlyContinue
        if ($listener) {
          Write-Output "RDP is LISTENING on port 3389"
          $listener | Select-Object LocalAddress, LocalPort, State | Format-Table
        } else {
          Write-Output "RDP is NOT listening on port 3389"
        }
      register: listener_check

    - name: Check Firewall Rules
      win_shell: |
        $rules = Get-NetFirewallRule | Where-Object { $_.DisplayName -like "*Remote Desktop*" -or $_.DisplayName -like "*RDP*" } | Select-Object DisplayName, Enabled, Direction, Action, Profile
        if ($rules) {
          $rules | Format-Table -AutoSize
        } else {
          Write-Output "No RDP firewall rules found"
        }
      register: firewall_check

    - name: Display Diagnostic Results
      debug:
        msg:
          - "=== RDP Diagnostic Results for {{ inventory_hostname }} ==="
          - "Group Policy: {{ gp_check.stdout }}"
          - "Registry: {{ reg_check.stdout }}"
          - "Service: {{ service_check.stdout }}"
          - "Listener: {{ listener_check.stdout }}"
          - ""
          - "Policies: {{ policy_check.stdout }}"
          - ""
          - "Firewall: {{ firewall_check.stdout }}"




