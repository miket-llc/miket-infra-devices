---
# Deploy updated mount configuration to Windows clients
# Maps network drives X:, S:, T: with proper labels

- name: Deploy Windows Mount Configuration
  hosts: windows
  gather_facts: no
  vars:
    smb_server_override: "192.168.1.195"  # Override for LAN connectivity
  
  pre_tasks:
    - name: Load windows group vault vars
      include_vars:
        file: "{{ playbook_dir }}/../group_vars/windows/vault.yml"
      no_log: true
    
    - name: Load host vault vars
      include_vars:
        file: "{{ playbook_dir }}/../host_vars/{{ inventory_hostname }}/vault.yml"
      no_log: true
    
    - name: Fetch SMB password from Azure Key Vault
      shell: /usr/bin/az keyvault secret show --vault-name kv-miket-ops --name motoko-smb-password --query value -o tsv
      register: smb_password_result
      delegate_to: localhost
      run_once: true
      no_log: true
      connection: local
    
    - name: Set SMB password fact
      set_fact:
        smb_password: "{{ smb_password_result.stdout | trim }}"
        smb_server: "{{ smb_server_override | default(smb_server) }}"
      no_log: true

    - name: Set WinRM password for wintermute
      set_fact:
        ansible_password: "{{ vault_wintermute_password }}"
      no_log: true
      when: inventory_hostname == "wintermute"

    - name: Set WinRM password for armitage
      set_fact:
        ansible_password: "{{ vault_armitage_password }}"
      no_log: true
      when: inventory_hostname == "armitage"
    
    - name: Include mount_shares_windows role
      include_role:
        name: mount_shares_windows
  
  tasks:
    - name: Create scheduled task for drive mapping at logon
      win_shell: |
        $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-ExecutionPolicy Bypass -WindowStyle Hidden -File C:\Scripts\Map-MikeTDrives.ps1"
        $trigger = New-ScheduledTaskTrigger -AtLogon -User "{{ ansible_user }}"
        $principal = New-ScheduledTaskPrincipal -UserId "{{ ansible_user }}" -LogonType Interactive -RunLevel Limited
        $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries
        
        $existingTask = Get-ScheduledTask -TaskName "MikeT Map Network Drives" -ErrorAction SilentlyContinue
        if ($existingTask) {
            Unregister-ScheduledTask -TaskName "MikeT Map Network Drives" -Confirm:$false
        }
        
        Register-ScheduledTask -TaskName "MikeT Map Network Drives" -Action $action -Trigger $trigger -Principal $principal -Settings $settings -Force
        Write-Host "Scheduled task created for drive mapping at logon"
    
    - name: Run mapping script to create initial mappings
      win_shell: C:\Scripts\Map-MikeTDrives.ps1
      register: map_result
    
    - name: Display mapping results
      debug:
        var: map_result.stdout_lines
  
    - name: Deployment complete
      debug:
        msg: |
          Mount configuration deployed successfully!
          
          Drives will be fully accessible after next logon.
          Scheduled task "MikeT Map Network Drives" will run at every logon.
          
          Next steps:
          1. User should log off and log back on
          2. Verify drives: Open File Explorer, check X:, S:, T:
          3. Run loop check: C:\Scripts\Check-OneDriveLoops.ps1
          4. Verify OneDrive settings exclude network drives
