# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# Simplified vLLM deployment - just scripts and config
# Prerequisites: Docker Desktop already installed and working

- name: Deploy vLLM scripts to Armitage
  hosts: armitage
  gather_facts: false
  vars:
    vllm_model: "{{ vllm_model_name | default('Qwen/Qwen2.5-7B-Instruct') }}"
    vllm_port: "{{ vllm_api_port | default(8000) }}"
    vllm_container_name: "vllm-armitage"
    vllm_image: "vllm/vllm-openai:latest"
    auto_switch_enabled: true
    check_interval_minutes: 5
  
  tasks:
    - name: Check if vLLM container is already running
      win_shell: |
        $containerStatus = docker ps --filter name={{ vllm_container_name }} --format '{{ "{{" }}.Names{{ "}}" }}' 2>&1
        if ($containerStatus -match "{{ vllm_container_name }}") {
          Write-Host "EXISTS_RUNNING"
          exit 0
        } else {
          Write-Host "NOT_RUNNING"
          exit 0
        }
      register: container_check
      changed_when: false
      failed_when: false
    
    - name: Display current container status
      debug:
        msg: "{{ 'vLLM container is already running - deployment will be non-destructive' if (container_check.stdout is defined and 'EXISTS_RUNNING' in container_check.stdout) else 'vLLM container is not running - will deploy scripts only' }}"
      when: container_check.stdout is defined
    
    - name: Check PowerShell execution policy
      win_shell: |
        $policy = Get-ExecutionPolicy
        if ($policy -eq 'Restricted' -or $policy -eq 'AllSigned') {
          Set-ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
          Write-Host "Execution policy updated to RemoteSigned"
        } else {
          Write-Host "Execution policy is $policy - scripts can run"
        }
      register: execution_policy
      changed_when: "'updated' in execution_policy.stdout"
      failed_when: false
    
    - name: Ensure Docker Desktop service is running
      win_service:
        name: com.docker.service
        state: started
        start_mode: auto
    
    - name: Ensure Docker config directory exists
      win_file:
        path: C:\Users\{{ ansible_user }}\.docker
        state: directory
    
    - name: Configure Docker to disable credential helper
      win_copy:
        content: |
          {
            "credsStore": ""
          }
        dest: C:\Users\{{ ansible_user }}\.docker\config.json
      register: docker_config
    
    - name: Check if NVIDIA Container Toolkit is already installed
      win_shell: |
        $toolkitInstalled = wsl -d Ubuntu -- bash -c "dpkg -l | grep -q nvidia-container-toolkit && echo 'INSTALLED' || echo 'NOT_INSTALLED'" 2>&1
        Write-Host $toolkitInstalled
      register: nvidia_toolkit_check
      changed_when: false
      failed_when: false
      tags: [docker, gpu]
    
    - name: Copy NVIDIA Container Toolkit install script to Windows
      win_copy:
        src: /home/mdt/miket-infra-devices/devices/armitage/scripts/Install-NvidiaContainerToolkit.sh
        dest: C:\Users\{{ ansible_user }}\dev\armitage\scripts\Install-NvidiaContainerToolkit.sh
      when: "'NOT_INSTALLED' in nvidia_toolkit_check.stdout"
      tags: [docker, gpu]
    
    - name: Install NVIDIA Container Toolkit in WSL2
      win_shell: |
        Write-Host "Installing NVIDIA Container Toolkit in WSL2..." -ForegroundColor Yellow
        wsl -d Ubuntu -- bash /mnt/c/Users/{{ ansible_user }}/dev/armitage/scripts/Install-NvidiaContainerToolkit.sh
        Write-Host "NVIDIA Container Toolkit installation complete" -ForegroundColor Green
      register: nvidia_toolkit
      async: 300
      poll: 15
      when: "'NOT_INSTALLED' in nvidia_toolkit_check.stdout"
      tags: [docker, gpu]
      failed_when: false
    
    - name: Restart Docker to apply NVIDIA runtime configuration
      win_service:
        name: com.docker.service
        state: restarted
      when: nvidia_toolkit.changed | default(false)
      tags: [docker, gpu]
    
    - name: Wait for Docker to restart
      win_shell: |
        $timeout = 60
        $elapsed = 0
        while ($elapsed -lt $timeout) {
          try {
            $dockerOutput = docker version 2>&1
            if ($LASTEXITCODE -eq 0 -and $dockerOutput -match "Server:") {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Docker is ready" -ForegroundColor Green
              exit 0
            }
          } catch { }
          Start-Sleep -Seconds 5
          $elapsed += 5
        }
        Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Docker ready" -ForegroundColor Green
      when: nvidia_toolkit.changed | default(false)
      register: docker_wait
      failed_when: false
      tags: [docker, gpu]

    - name: Check if vLLM Docker image already exists
      win_shell: |
        $imageExists = docker images {{ vllm_image }} --format "{{ '{{' }}.Repository{{ '}}' }}:{{ '{{' }}.Tag{{ '}}' }}" 2>&1
        if ($LASTEXITCODE -eq 0 -and $imageExists) {
          Write-Host "EXISTS"
        } else {
          Write-Host "NOT_EXISTS"
        }
      register: docker_image_check
      changed_when: false
      failed_when: false
      tags: [docker]
    
    - name: Pull vLLM Docker image
      win_shell: |
        Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Pulling vLLM Docker image (this may take several minutes)..." -ForegroundColor Yellow
        $startTime = Get-Date
        docker pull {{ vllm_image }}
        if ($LASTEXITCODE -eq 0) {
          $duration = (Get-Date) - $startTime
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ✅ Image pulled successfully (took $([math]::Round($duration.TotalSeconds, 1))s)" -ForegroundColor Green
          exit 0
        } else {
          Write-Host "[$(Get-Date -Format 'HH:mm:ss')] ❌ Failed to pull image" -ForegroundColor Red
          exit 1
        }
      register: docker_pull
      async: 900
      poll: 30
      when: "'NOT_EXISTS' in docker_image_check.stdout"
      tags: [docker]
    
    - name: Create scripts directory
      win_file:
        path: C:\Users\{{ ansible_user }}\dev\armitage\scripts
        state: directory
    
    - name: Deploy vLLM scripts
      win_copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
      loop:
        - { src: "/home/mdt/miket-infra-devices/devices/armitage/scripts/Start-VLLM.ps1", dest: "C:\\Users\\{{ ansible_user }}\\dev\\armitage\\scripts\\Start-VLLM.ps1" }
        - { src: "/home/mdt/miket-infra-devices/devices/armitage/scripts/Set-WorkstationMode.ps1", dest: "C:\\Users\\{{ ansible_user }}\\dev\\armitage\\scripts\\Set-WorkstationMode.ps1" }
    
    - name: Deploy vLLM config.yml
      win_copy:
        src: "/home/mdt/miket-infra-devices/devices/armitage/config.yml"
        dest: "C:\\Users\\{{ ansible_user }}\\dev\\armitage\\config.yml"
        
    - name: Create vLLM configuration directory
      win_file:
        path: C:\ProgramData\ArmitageMode
        state: directory
    
    - name: Write vLLM config file
      win_copy:
        content: |
          {
            "model": "{{ vllm_model }}",
            "port": {{ vllm_port }},
            "container_name": "{{ vllm_container_name }}",
            "image": "{{ vllm_image }}",
            "auto_switch": {{ auto_switch_enabled | lower }}
          }
        dest: C:\ProgramData\ArmitageMode\vllm_config.json
    
    # Auto-switcher scheduled task removed per CEO directive - energy wasting code
    
    - name: Verify deployment
      win_shell: |
        $scriptsOk = Test-Path "C:\Users\{{ ansible_user }}\dev\armitage\scripts\Start-VLLM.ps1"
        $configOk = Test-Path "C:\ProgramData\ArmitageMode\vllm_config.json"
        
        if ($scriptsOk -and $configOk) {
          Write-Host "✅ Deployment successful" -ForegroundColor Green
          Write-Host "  Windows scripts: $scriptsOk"
          Write-Host "  Config file: $configOk"
          exit 0
        } else {
          Write-Host "❌ Deployment verification failed" -ForegroundColor Red
          Write-Host "  Scripts exist: $scriptsOk"
          Write-Host "  Config exists: $configOk"
          exit 1
        }
      register: verify_deployment
      failed_when: verify_deployment.rc != 0
    
    - name: Restart vLLM container with new configuration
      win_shell: |
        cd C:\Users\{{ ansible_user }}\dev\armitage\scripts
        .\Start-VLLM.ps1 Restart
      register: restart_result
      when: container_check.stdout is defined and 'EXISTS_RUNNING' in container_check.stdout
      
    - name: Wait for vLLM to be ready after restart
      win_shell: |
        $timeout = 60
        $elapsed = 0
        while ($elapsed -lt $timeout) {
          try {
            $response = Invoke-WebRequest -Uri "http://localhost:{{ vllm_port }}/health" -TimeoutSec 5 -UseBasicParsing -ErrorAction Stop
            if ($response.StatusCode -eq 200) {
              Write-Host "vLLM is ready"
              exit 0
            }
          } catch { }
          Start-Sleep -Seconds 5
          $elapsed += 5
        }
        Write-Host "vLLM ready check completed"
      when: container_check.stdout is defined and 'EXISTS_RUNNING' in container_check.stdout
      register: ready_check
      failed_when: false
    
    - name: Display next steps
      debug:
        msg:
          - ""
          - "✅ vLLM scripts deployed successfully"
          - ""
          - "To start vLLM:"
          - "  powershell -File C:\\Users\\{{ ansible_user }}\\dev\\armitage\\scripts\\Start-VLLM.ps1 -Action Start"
          - ""
          - "API will be available at: http://armitage.pangolin-vega.ts.net:{{ vllm_port }}"
          - ""

