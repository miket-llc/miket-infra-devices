# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# Playbook: remote_detect.yml
# Detects NoMachine server status on Linux hosts (primarily Motoko)
# RDP/VNC detection removed - NoMachine is the sole remote desktop solution

- name: Detect NoMachine server
  hosts: motoko
  gather_facts: true
  tags:
    - remote
    - remote:detect
  tasks:
    - name: Check NoMachine server is installed
      ansible.builtin.stat:
        path: /usr/NX/bin/nxserver
      register: nomachine_binary

    - name: Check NoMachine service status
      ansible.builtin.systemd:
        name: nxserver
      register: nomachine_service

    - name: Check NoMachine port 4000 is listening
      ansible.builtin.wait_for:
        host: localhost
        port: 4000
        timeout: 5
      register: nomachine_port
      failed_when: false

    - name: Set facts for Ansible inventory
      ansible.builtin.set_fact:
        remote_server_type: "nomachine"
        remote_server_active: "{{ nomachine_service.status.ActiveState == 'active' and nomachine_port is succeeded }}"
        remote_port: 4000

    - name: Display detection summary
      ansible.builtin.debug:
        msg:
          - "Detection Summary:"
          - "  Server Type: {{ remote_server_type }}"
          - "  Active: {{ remote_server_active }}"
          - "  Port: {{ remote_port }}"
          - "  Service Status: {{ nomachine_service.status.ActiveState }}"
          - "  Port Listening: {{ 'YES' if nomachine_port is succeeded else 'NO' }}"

