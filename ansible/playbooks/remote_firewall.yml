---
# Playbook: remote_firewall.yml
# Configures firewall rules for NoMachine remote desktop access (idempotent)
# NoMachine is the sole remote desktop solution (RDP/VNC retired 2025-11-22)

- name: Configure Linux firewall rules for NoMachine
  hosts: linux_servers
  gather_facts: true
  become: yes
  tags:
    - remote
    - remote:firewall
  tasks:
    - name: Configure firewall for NoMachine
      ansible.builtin.include_role:
        name: remote_firewall
      vars:
        remote_protocol: nomachine
        remote_port: "{{ nomachine_port | default(4000) }}"

- name: Verify Windows firewall rules for NoMachine
  hosts: windows_servers
  gather_facts: true
  tags:
    - remote
    - remote:firewall
  tasks:
    - name: Check NoMachine firewall rule
      win_shell: |
        $rule = Get-NetFirewallRule -Name "NoMachine-Tailscale" -ErrorAction SilentlyContinue
        if ($rule) {
          Write-Output "NoMachine firewall rule exists"
          $rule | Select-Object DisplayName, Enabled, Direction, Action
        } else {
          Write-Output "NoMachine firewall rule not found - run remote_server.yml"
          exit 1
        }
      register: firewall_check
      changed_when: false

    - name: Display firewall status
      ansible.builtin.debug:
        var: firewall_check.stdout_lines

