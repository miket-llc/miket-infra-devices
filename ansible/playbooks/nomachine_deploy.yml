---
# Playbook: nomachine_deploy.yml
# Deploys NoMachine server and client across all Tailnet nodes
# Provides point-to-point remote desktop access via Tailscale

- name: Deploy NoMachine servers
  hosts: tailnet_all
  gather_facts: yes
  tags:
    - nomachine
    - nomachine:server
  tasks:
    - name: Set become based on OS
      ansible.builtin.set_fact:
        ansible_become: "{{ 'yes' if ansible_facts.system != 'Win32NT' else 'no' }}"
      when: ansible_facts.system is defined
    - name: Install and configure NoMachine server
      ansible.builtin.include_role:
        name: nomachine_server

    - name: Configure NoMachine firewall
      ansible.builtin.include_role:
        name: nomachine_firewall
      vars:
        remote_detection:
          firewall:
            type: "{{ 'ufw' if (ansible_facts.pkg_mgr | default('apt')) == 'apt' else ('firewalld' if (ansible_facts.pkg_mgr | default('')) == 'yum' else 'none') }}"

- name: Deploy NoMachine clients
  hosts: workstations
  gather_facts: yes
  tags:
    - nomachine
    - nomachine:client
  tasks:
    - name: Set become based on OS
      ansible.builtin.set_fact:
        ansible_become: "{{ 'yes' if ansible_facts.system != 'Win32NT' else 'no' }}"
      when: ansible_facts.system is defined
    - name: Install NoMachine client
      ansible.builtin.include_role:
        name: nomachine_client

- name: Display deployment summary
  hosts: localhost
  gather_facts: no
  tags:
    - nomachine
    - nomachine:summary
  tasks:
    - name: Generate connection summary
      ansible.builtin.debug:
        msg:
          - "âœ… NoMachine deployment complete"
          - ""
          - "Servers configured on all Tailnet nodes:"
          - "  - motoko.pangolin-vega.ts.net:4000"
          - "  - wintermute.pangolin-vega.ts.net:4000"
          - "  - armitage.pangolin-vega.ts.net:4000"
          - "  - count-zero.pangolin-vega.ts.net:4000"
          - ""
          - "Clients installed on all workstations"
          - ""
          - "Connect using: nomachine HOSTNAME"
          - "Example: nomachine motoko"

