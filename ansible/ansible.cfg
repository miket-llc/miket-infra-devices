# Ansible configuration for miket-infra-devices
# Optimized for speed, parallelism, and observability
# Control node: Motoko | Managed nodes: Armitage (Windows), Wintermute (Linux)

[defaults]
# Use the inventory file
inventory = inventory/hosts.yml

# Use the vault password file if it exists, otherwise prompt
# Priority: age-encrypted (SSH keys) > Azure Key Vault > 1Password > Local file
# Age encryption is most automation-friendly - no external services or logins needed
vault_password_file = /home/mdt/miket-infra-devices/scripts/ansible-vault-password.sh

# ============================================================================
# OBSERVABILITY & OUTPUT
# ============================================================================
# Enable callback plugins for better output and performance tracking
# Multiple callbacks can be enabled via comma-separated list
callback_plugins = /usr/share/ansible/plugins/callback:~/.ansible/plugins/callback:plugins/callback
stdout_callback = profile_tasks
# Options: 'default', 'yaml', 'minimal', 'profile_tasks', 'json', 'logstash'
# profile_tasks shows timing for each task - excellent for performance analysis

# Display settings
display_skipped_hosts = True
display_ok_hosts = True
show_task_path_on_failure = True
display_failed_stderr = True

# ============================================================================
# PERFORMANCE OPTIMIZATIONS
# ============================================================================
# Parallelism: Increase forks for concurrent task execution
# Set to 2x-3x the number of managed nodes (currently 3-4 nodes)
forks = 10
# Higher forks = more parallelism, but watch CPU/memory on control node

# SSH pipelining: Reduces SSH round-trips by executing multiple commands in one connection
# Can improve performance by 2-5x for tasks with many small commands
pipelining = True
# Requires requiretty to be disabled on managed nodes (already standard)

# Fact gathering optimization
gathering = smart
# 'smart' = gather facts once per playbook, cache them, reuse across plays
# Set gather_facts: no in playbooks when facts aren't needed

# Fact caching: Store facts on disk to avoid re-gathering
fact_caching = jsonfile
fact_caching_connection = /tmp/ansible_facts
fact_caching_timeout = 86400
# 24 hour cache - facts rarely change, reduces gather_facts time significantly
# Clear cache manually: rm -rf /tmp/ansible_facts/*

# Alternative: Redis fact caching (faster, shared across runs)
# Requires: pip install redis
# fact_caching = redis
# fact_caching_connection = localhost:6379:0
# fact_caching_timeout = 86400

# ============================================================================
# SSH CONNECTION OPTIMIZATION
# ============================================================================
# ControlPersist: Keep SSH connections alive for reuse
# Dramatically reduces connection overhead for multiple tasks
ssh_args = -o ControlMaster=auto -o ControlPersist=60s -o ControlPath=/tmp/ansible-ssh-%%h-%%p-%%r -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
# ControlPersist=60s keeps connection alive for 60 seconds after last use
# ControlPath ensures unique socket per host/port/user combination

[ssh_connection]
# SSH pipelining: Reduces SSH round-trips by executing multiple commands in one connection
# Can improve performance by 2-5x for tasks with many small commands
pipelining = True
# Requires requiretty to be disabled on managed nodes (already standard)
# Note: Also set in [defaults] for compatibility, but [ssh_connection] takes precedence

# Connection retries and timeouts
timeout = 600
command_timeout = 600
host_key_checking = False
# Retry connection failures
retry_files_enabled = False
# Connection retry logic handled in playbooks with retries/until

# ============================================================================
# WINRM OPTIMIZATION (Windows hosts)
# ============================================================================
[winrm]
# These are defaults, but group_vars/windows/main.yml takes precedence
read_timeout = 600
operation_timeout = 600
connection_timeout = 60
# WinRM connection pooling (reuse connections)
# Set via ansible_winrm_max_connections in group_vars (already configured)

# ============================================================================
# LOGGING & PERSISTENCE
# ============================================================================
[logging]
# Enable structured logging for troubleshooting and analysis
log_path = /tmp/ansible.log
# Log rotation handled by system (logrotate) or manual cleanup

# ============================================================================
# STRATEGY & EXECUTION
# ============================================================================
# Default strategy: 'linear' (one host at a time per task)
# Override in playbooks with: strategy: free (for independent tasks)
# 'free' allows hosts to proceed independently - great for parallel execution
# Example: strategy: free in playbooks with independent GPU setup tasks

# ============================================================================
# CALLBACK PLUGIN CONFIGURATION
# ============================================================================
# Profile tasks callback (built-in, shows timing)
# Automatically enabled via stdout_callback = profile_tasks

# JSON callback (for structured output)
# Enable with: ANSIBLE_STDOUT_CALLBACK=json ansible-playbook ...
# Or add to callback_whitelist for parallel execution

# Logstash callback (for centralized logging)
# Requires: pip install logstash-formatter
# Configure via environment: ANSIBLE_LOGSTASH_HOST, ANSIBLE_LOGSTASH_PORT

# ARA callback (for persistent run history and web UI)
# Requires: pip install ara[server]
# Enable with: callback_plugins = /path/to/ara/plugins/callback
# Access web UI: ara-manage runserver (default: http://localhost:8000)

