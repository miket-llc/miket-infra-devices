# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# =============================================================================
# ATOM HOST CONFIGURATION
# =============================================================================
#
# Fedora Server - Headless Resilience/Lab Node (Battery-Backed)
#
# OS:       Fedora Server 43 (Headless - multi-user.target)
# Hardware: Lenovo ThinkPad X1 Carbon (2012)
# CPU:      Intel Core i7-3667U
# RAM:      8GB
# Storage:  224GB SSD
# GPU:      Intel HD Graphics 4000 (integrated, unused)
#
# Role:     Headless Resilience Node / Lab Server
#           Last device standing when power fails
#           Battery-backed = implicit UPS
#           100% managed via IaC - no manual commands allowed
#
# Purpose:
#   - Prove the network still exists (node_exporter metrics)
#   - Maintain SSH foothold for recovery operations
#   - Lab/automation node for testing and experimentation
#   - Optionally: send alerts when infrastructure is down
#
# Design:   Simplicity and reliability over features
#           Minimal services = fewer failure points
#           Headless operation = no GUI, no display manager
#           All management via Tailscale SSH
#
# Migration: Converted from Fedora Workstation 2025-12
#            See playbooks/atom/convert-to-headless.yml
#
# =============================================================================

# ========================================
# Device Identity
# ========================================
device_role: lab_server
device_description: "Battery-backed headless resilience/lab node for infrastructure continuity"

# Headless operation flag - triggers headless_fedora_server role
headless: true
headless_desktop: true  # Was a desktop, now headless

# Tailscale identity (from miket-infra)
tailscale_ip: 100.120.122.13
tailscale_hostname: atom.pangolin-vega.ts.net

# ========================================
# Ansible Connection
# ========================================
# Uses Tailscale SSH - password from AKV
ansible_host: atom.pangolin-vega.ts.net
ansible_user: mdt
ansible_become: true
ansible_python_interpreter: /usr/bin/python3

# Password lookup from Azure Key Vault (per miket-infra invariants)
ansible_password: "{{ lookup('pipe', '/usr/bin/az keyvault secret show --vault-name kv-miket-ops --name atom-ansible-password --query value -o tsv') | trim }}"

# ========================================
# Headless Server Configuration
# ========================================
# Power management - critical for resilience role

# Battery thresholds
resilience_node_low_battery_warning: 5
resilience_node_critical_battery_percent: 2
resilience_node_critical_battery_action: shutdown

# Boot target - headless server (no GUI)
resilience_node_boot_target: multi-user.target

# Headless role configuration
headless_fedora_server_install_cockpit: false  # Not needed for this minimal node

# ========================================
# Monitoring Configuration
# ========================================
resilience_node_exporter_enabled: true
resilience_node_exporter_port: 9100

# ========================================
# Hardware Constraints
# ========================================
# Document what this device CANNOT do

# No GPU compute - Intel integrated only
gpu:
  vendor: Intel
  model: HD Graphics 4000
  compute_capable: false

# Low memory - not suited for heavy workloads
memory_gb: 8

# ========================================
# Services (Minimal by Design)
# ========================================
# Only essential services for resilience role

atom_services:
  - prometheus-node-exporter   # Metrics for Prometheus
  - tailscaled                 # Tailscale daemon
  - firewalld                  # Firewall

# ========================================
# Workstation GUI Tools (DISABLED - Headless)
# ========================================
# atom is now headless - no GUI tools needed
workstation_gui_tools_enabled: false
vscode_enabled: false
cursor_enabled: false
warp_enabled: false

# ========================================
# Network Shares - REMOVED (Resilience Hardening)
# ========================================
# CIFS mounts were removed on 2024-12-01 after a kernel bug caused a desktop freeze.
#
# INCIDENT: The CIFS kernel module (cfids_invalidation_worker) hit a
# "scheduling while atomic" bug when the network to motoko hiccupped.
# This cascaded to dbus failures and froze GNOME for hours.
#
# DECISION: Resilience nodes should have ZERO dependencies on other servers.
# - Core function (node_exporter, SSH) doesn't need mounts
# - Health reporting now uses SSH-based push (resilience-health.timer)
# - If motoko is down, atom keeps working (that's the point!)
#
# To apply this change: ansible-playbook playbooks/atom/remove-cifs-mounts.yml
#
# smb_server: motoko.pangolin-vega.ts.net  # REMOVED
# smb_username: mdt                         # REMOVED
# smb_password: "..."                       # REMOVED

# ========================================
# Services NOT Running (by design)
# ========================================
# Document what we intentionally don't run

# NOT a container host
podman_enabled: false
docker_enabled: false

# NOT running AI workloads
vllm_enabled: false
litellm_enabled: false

# NOT providing storage
smb_enabled: false
nfs_enabled: false

# ========================================
# Firewall Configuration
# ========================================
resilience_node_firewall_ports:
  - 9100/tcp    # node_exporter (Prometheus)

# ========================================
# SELinux Technical Debt
# ========================================
# Document the workaround for Tailscale SSH
selinux_notes: |
  sshd_t domain is in permissive mode for Tailscale SSH.
  This is accepted technical debt - Tailscale SSH uses a non-standard
  mechanism that SELinux's sshd_t policy doesn't anticipate.
  
  Risk: Low - only accessible via tailnet
  Future: Create custom policy module if AVC denials cause issues

# ========================================
# Tags (defined in miket-infra)
# ========================================
# Reference only - tags applied via Tailscale API in miket-infra
# Initial enrollment uses tag:server,tag:linux (from auth key)
# Post-enrollment, miket-infra applies tag:lab-server,tag:headless
tailscale_tags:
  - tag:server
  - tag:linux
  - tag:lab-server
  - tag:headless

# Tailscale join configuration (for automated enrollment)
tailscale_auth_key_akv_secret: tailscale-auth-key-atom
tailscale_join_tags: "tag:server,tag:linux"  # Initial tags from auth key

# ========================================
# Netdata Monitoring Configuration
# ========================================
# Cloud-centric model: standalone agent claimed to Netdata Cloud

# Use pre-defined Tailscale IP from above
netdata_tailscale_ip: "{{ tailscale_ip }}"

# LIGHTWEIGHT MODE: Reduce resource usage on this constrained node
# Disables heavy plugins (apps, cgroups, tc, idlejitter, perf)
netdata_lightweight_mode: true

# Collector settings for atom (minimal - resilience node)
# - Containers: Disabled (no Podman on this node)
# - LiteLLM: Disabled (not running on this node)
# - Nvidia GPU: Disabled (Intel integrated only)
# - Linux Sensors: Enabled (battery monitoring is important!)
netdata_enable_containers: false
netdata_enable_litellm_prometheus: false
netdata_enable_nvidia_gpu: false
netdata_enable_linux_sensors: true
