# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# =============================================================================
# MOTOKO HOST CONFIGURATION
# =============================================================================
#
# Fedora Server - Headless GPU + Storage + Container Host
#
# OS:       Fedora Server (headless)
# GPU:      NVIDIA GeForce RTX 2080 (8GB)
# Storage:  /space (SoR), /flux (runtime), /time (backups)
# Access:   Tailscale SSH only
#
# =============================================================================

# ========================================
# Remote Desktop Configuration
# ========================================
# Uses NoMachine for session sharing (X11 required for NVIDIA)
remote_protocol: nomachine
remote_port: 4000
restrict_to_tailscale: true

# NoMachine settings
nomachine_version: "9.2.18"
nomachine_port: 4000

# ========================================
# PHC Storage Configuration
# ========================================
# Mount paths (per PHC invariants)
usb_space_mount: /space
usb_flux_mount: /flux
usb_timemachine_mount: /time

# PSBI Mount Configuration with UUIDs
# Run: blkid -o value -s UUID /dev/sdXY to get UUIDs
#
# Storage Layout:
#   /space (nvme1n1p3) - Primary container + app data volume (951GB btrfs)
#     /space/containers/engine/podman - Podman graphroot
#     /space/apps/nextcloud - Nextcloud data
#     /space/apps/litellm - LiteLLM configuration
#     /space/apps/vllm - vLLM models and cache
#     /space/services - Service configs
#   /flux - Runtime/volatile data (optional, on OS disk if not set)
#   /time - Time Machine backups (optional external)
#
# PSBI mounts disabled - using /podman mount directly for container data
# Second internal NVMe (nvme1n1p3, UUID=03d5ff5b-3f93-4f6f-93ed-20aa1d04e0df) 
# is mounted at /podman via fstab
psbi_mounts: []

# Mount ownership
psbi_mount_owner: mdt
psbi_mount_group: mdt

# ========================================
# Fedora Headless Base Configuration
# ========================================
# These are defaults; override here if needed
fedora_headless_boot_target: multi-user.target
fedora_headless_lid_switch: ignore

# ========================================
# Ansible Control Node Configuration
# ========================================
# Motoko is the primary Ansible control node
common_dev_tools_install_ansible: true
common_dev_tools_install_pywinrm: true  # For managing Windows hosts

# ========================================
# Tailscale Node Configuration
# ========================================
tailscale_node_verify_connection: true
tailscale_node_expose_facts: true

# ========================================
# NVIDIA GPU Configuration
# ========================================
nvidia_gpu_auto_detect: true
nvidia_gpu_skip_if_absent: false  # motoko always has GPU
nvidia_gpu_install_cuda: true
nvidia_gpu_verify: true

# ========================================
# Podman Container Configuration
# ========================================
podman_user: mdt
podman_enable_linger: true
podman_nvidia_enabled: true
podman_configure_storage: true
podman_create_storage_dirs: true

# ========================================
# Motoko Services (Containers)
# ========================================
# All container data on /podman (second internal NVMe - 952GB)
motoko_services_config_dir: /podman/services
motoko_services_gpu_enabled: true
motoko_services: []

# ========================================
# Container Storage Configuration
# ========================================
# Podman uses /podman directly as graphroot (second NVMe)
podman_graphroot: /podman
podman_runroot: /run/containers/storage

# ========================================
# LiteLLM Configuration
# ========================================
litellm_enabled: true
litellm_workdir: /podman/apps/litellm
litellm_config_path: /podman/apps/litellm/config.yaml
litellm_env_path: /podman/apps/litellm/.env
litellm_compose_path: /podman/apps/litellm/docker-compose.yml
litellm_port: 8000
litellm_image: ghcr.io/berriai/litellm:main-v1.55.4

# ========================================
# vLLM Configuration
# ========================================
# RTX 2080 Max-Q (8GB VRAM) - optimized for lightweight workloads
# Focus on embeddings for GraphDB, NLP, etc. Not suited for large LLMs.
vllm_enabled: true
vllm_compose_dir: /podman/apps/vllm
vllm_compose_file: /podman/apps/vllm/docker-compose.yml
vllm_cache_dir: /podman/apps/vllm/cache

# Reasoning model DISABLED - RTX 2080 Max-Q not suited for large models
vllm_reasoning_enabled: false

# Embeddings model (BGE Base - lightweight, fast)
vllm_embeddings_enabled: true
vllm_embeddings_model: "BAAI/bge-base-en-v1.5"
vllm_embeddings_port: 8200
vllm_embeddings_gpu_util: 0.50

# AI Fabric Role Assignment (aligns with miket-infra platform contract)
# This node serves: embeddings-general
ai_node_roles:
  - embeddings-general

# ========================================
# Nextcloud Configuration
# ========================================
# Disabled for now - requires secrets from Azure Key Vault
nextcloud_enabled: false
nextcloud_workdir: /podman/apps/nextcloud
nextcloud_data_path: /podman/apps/nextcloud/data
nextcloud_db_path: /podman/apps/nextcloud/db
nextcloud_config_path: /podman/apps/nextcloud/config
nextcloud_compose_path: /podman/apps/nextcloud/docker-compose.yml
nextcloud_port: 8080

# ========================================
# Console UX Configuration
# ========================================
# Improves Linux virtual console (TTY) for local monitor use
# - Default system font size (not oversized)
# - Visible boot text (removes rhgb/quiet)
# - Ensures getty login prompt on tty1
console_ux_enabled: true

# Font: Use Fedora default eurlatgr - smaller, crisper, proper box-drawing
# No extra packages needed - built into kbd
console_font_enabled: true
console_font_name: "eurlatgr"
console_font_packages: []

# Verbose boot: DISABLED - removing rhgb breaks framebuffer resolution
# The system needs rhgb for proper 1920x1080 console, not 800x600
console_verbose_boot_enabled: false

# ========================================
# Firewall Ports (firewalld)
# ========================================
# Additional ports to open (beyond defaults)
firewall_extra_ports:
  - 4000/tcp   # NoMachine
  - 8000/tcp   # LiteLLM
  - 8001/tcp   # vLLM reasoning
  - 8200/tcp   # Embeddings API
  - 19999/tcp  # Netdata Web UI

# ========================================
# Netdata Monitoring Configuration
# ========================================
# Cloud-centric model: standalone agent claimed to Netdata Cloud

# Tailscale IP for binding (get via: tailscale ip -4)
# Will be auto-detected if not set
# netdata_tailscale_ip: 100.x.x.x

# Collector settings for motoko
# - Containers: Podman containers on this host
# - LiteLLM: Prometheus metrics DISABLED (requires LiteLLM Enterprise)
# - Nvidia GPU: RTX 2080 monitoring
# - Linux Sensors: CPU temps, fans, voltages
netdata_enable_containers: true
netdata_enable_litellm_prometheus: false  # LiteLLM prometheus callback requires Enterprise license
netdata_litellm_metrics_url: "http://127.0.0.1:8000/metrics"
netdata_enable_nvidia_gpu: true
netdata_enable_linux_sensors: true

# Data Estate dashboard
netdata_enable_data_estate: true
netdata_data_estate_device_status: "/space/devices/motoko/mdt/_status.json"
netdata_data_estate_mount_group: "flux_time_grp"
netdata_data_estate_mount_gid: 1003

# ========================================
# Data Estate Status Configuration
# ========================================
data_estate_role: "nextcloud_server"
data_estate_restic_enabled: true
data_estate_nextcloud_db_enabled: true
data_estate_m365_enabled: true
data_estate_space_mirror_enabled: true

# ========================================
# Disk Maintenance Configuration
# ========================================
podman_cleanup_remove_stopped_containers: true
podman_cleanup_remove_unused_images: true
podman_cleanup_remove_unused_volumes: false
podman_cleanup_remove_unused_networks: true
podman_cleanup_remove_build_cache: true
disk_maintenance_clean_podman: true
disk_maintenance_clean_journal: true
disk_maintenance_clean_tmp: true
disk_maintenance_clean_package_cache: true
disk_maintenance_clean_old_logs: true
disk_maintenance_journal_max_size: "500M"
disk_maintenance_journal_max_days: 7
disk_maintenance_dnf_clean_all: true
disk_maintenance_log_max_age_days: 30
