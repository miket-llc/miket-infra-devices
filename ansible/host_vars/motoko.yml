# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# =============================================================================
# MOTOKO HOST CONFIGURATION
# =============================================================================
#
# Fedora Server - Headless GPU + Storage + Container Host
#
# OS:       Fedora Server (headless)
# GPU:      NVIDIA GeForce RTX 2080 (8GB)
# Storage:  /space (SoR), /flux (runtime), /time (backups)
# Access:   Tailscale SSH only
#
# =============================================================================

# ========================================
# Remote Desktop Configuration
# ========================================
# Uses NoMachine for session sharing (X11 required for NVIDIA)
remote_protocol: nomachine
remote_port: 4000
restrict_to_tailscale: true

# NoMachine settings
nomachine_version: "9.2.18"
nomachine_port: 4000

# ========================================
# PHC Storage Configuration
# ========================================
# Mount paths (per PHC invariants)
usb_space_mount: /space
usb_flux_mount: /flux
usb_timemachine_mount: /time

# PSBI Mount Configuration with UUIDs
# Run: blkid -o value -s UUID /dev/sdXY to get UUIDs
#
# Storage Layout:
#   /space (nvme1n1p3) - Primary container + app data volume (951GB btrfs)
#     /space/containers/engine/podman - Podman graphroot
#     /space/apps/nextcloud - Nextcloud data
#     /space/apps/litellm - LiteLLM configuration
#     /space/apps/vllm - vLLM models and cache
#     /space/services - Service configs
#   /flux - Runtime/volatile data (optional, on OS disk if not set)
#   /time - Time Machine backups (optional external)
#
psbi_mounts:
  - path: /space
    uuid: "03d5ff5b-3f93-4f6f-93ed-20aa1d04e0df"  # nvme1n1p3 (951GB btrfs)
    fstype: btrfs
    opts: defaults,noatime,compress=zstd
    enabled: true
    
  - path: /flux
    uuid: ""  # Optional: set if separate runtime disk available
    fstype: ext4
    opts: defaults,noatime
    enabled: false  # Disabled - use /space for now
    
  - path: /time
    uuid: ""  # Optional: set for Time Machine backup disk
    fstype: auto
    opts: ro,noatime
    enabled: false  # Disabled - no backup disk connected

# Mount ownership
psbi_mount_owner: mdt
psbi_mount_group: mdt

# ========================================
# Fedora Headless Base Configuration
# ========================================
# These are defaults; override here if needed
fedora_headless_boot_target: multi-user.target
fedora_headless_lid_switch: ignore

# ========================================
# Ansible Control Node Configuration
# ========================================
# Motoko is the primary Ansible control node
common_dev_tools_install_ansible: true
common_dev_tools_install_pywinrm: true  # For managing Windows hosts

# ========================================
# Tailscale Node Configuration
# ========================================
tailscale_node_verify_connection: true
tailscale_node_expose_facts: true

# ========================================
# NVIDIA GPU Configuration
# ========================================
nvidia_gpu_auto_detect: true
nvidia_gpu_skip_if_absent: false  # motoko always has GPU
nvidia_gpu_install_cuda: true
nvidia_gpu_verify: true

# ========================================
# Podman Container Configuration
# ========================================
podman_user: mdt
podman_enable_linger: true
podman_nvidia_enabled: true
podman_configure_storage: true
podman_create_storage_dirs: true

# ========================================
# Motoko Services (Containers)
# ========================================
# Define container services to run on motoko
# These are managed by the motoko_services role
# All data stored on /space (second internal NVMe)

# Service configuration directory (on /space)
motoko_services_config_dir: /space/services
motoko_services_gpu_enabled: true

# Container service definitions
# Note: LiteLLM, vLLM, and Nextcloud have dedicated roles
# Use motoko_services for additional lightweight containers
motoko_services: []

# ========================================
# Container Storage Configuration
# ========================================
# Podman graphroot on second drive for container images/layers
podman_graphroot: /space/containers/engine/podman
podman_runroot: /run/containers/storage

# ========================================
# LiteLLM Configuration
# ========================================
litellm_enabled: true
litellm_workdir: /space/apps/litellm
litellm_config_path: /space/apps/litellm/config.yaml
litellm_env_path: /space/apps/litellm/.env
litellm_compose_path: /space/apps/litellm/docker-compose.yml
litellm_port: 8000
litellm_image: ghcr.io/berriai/litellm:main-v1.55.4

# ========================================
# vLLM Configuration
# ========================================
vllm_enabled: true
vllm_compose_dir: /space/apps/vllm
vllm_compose_file: /space/apps/vllm/docker-compose.yml
vllm_models_dir: /space/apps/vllm/models
vllm_cache_dir: /space/apps/vllm/cache

# Reasoning model (Mistral 7B AWQ - fits in 8GB VRAM with embeddings)
vllm_reasoning_enabled: true
vllm_reasoning_model: "TheBloke/Mistral-7B-Instruct-v0.2-AWQ"
vllm_reasoning_port: 8001
vllm_reasoning_gpu_util: 0.45
vllm_reasoning_max_len: 4096

# Embeddings model (BGE Base - lightweight)
vllm_embeddings_enabled: true
vllm_embeddings_model: "BAAI/bge-base-en-v1.5"
vllm_embeddings_port: 8200
vllm_embeddings_gpu_util: 0.25

# ========================================
# Nextcloud Configuration
# ========================================
# Disabled for now - requires secrets from Azure Key Vault
# Enable once secrets-sync is run
nextcloud_enabled: false
nextcloud_workdir: /space/apps/nextcloud
nextcloud_data_path: /space/apps/nextcloud/data
nextcloud_db_path: /space/apps/nextcloud/db
nextcloud_config_path: /space/apps/nextcloud/config
nextcloud_compose_path: /space/apps/nextcloud/docker-compose.yml
nextcloud_port: 8080

# ========================================
# Console UX Configuration
# ========================================
# Improves Linux virtual console (TTY) for local monitor use
# - Default system font size (not oversized)
# - Visible boot text (removes rhgb/quiet)
# - Ensures getty login prompt on tty1
console_ux_enabled: true

# Font: Use Fedora default eurlatgr - smaller, crisper, proper box-drawing
# No extra packages needed - built into kbd
console_font_enabled: true
console_font_name: "eurlatgr"
console_font_packages: []

# Verbose boot: DISABLED - removing rhgb breaks framebuffer resolution
# The system needs rhgb for proper 1920x1080 console, not 800x600
console_verbose_boot_enabled: false

# ========================================
# Firewall Ports (firewalld)
# ========================================
# Additional ports to open (beyond defaults)
firewall_extra_ports:
  - 4000/tcp   # NoMachine
  - 8000/tcp   # LiteLLM
  - 8001/tcp   # vLLM reasoning
  - 8200/tcp   # Embeddings API
