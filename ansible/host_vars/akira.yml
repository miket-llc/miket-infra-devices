# Copyright (c) 2025 MikeT LLC. All rights reserved.
# ansible/host_vars/akira.yml
# Host-specific variables for akira
#
# Architecture References:
#   - ADR-004: KDE Plasma is the standard desktop for all Linux UI nodes
#   - ADR-005: akira uses vLLM server pattern (armitage uses Ollama)
#   - AI_FABRIC_SERVICE.md: akira is the vLLM server node
#
# Migration History:
#   - 2025-12: Migrated from GNOME to KDE Plasma
#   - See docs/runbooks/AKIRA_GNOME_TO_KDE_CONVERSION.md for details

# =============================================================================
# OS & Desktop Configuration
# =============================================================================
os_family: linux
distro: fedora
distro_version: "43"
# Desktop environment: KDE Plasma per ADR-004
# Migrated from GNOME as of 2025-12 after armitage proved the pattern
desktop_environment: kde

# =============================================================================
# Identity & Network
# =============================================================================
hostname: akira
tailscale_hostname: akira
tailscale_tags:
  - "tag:linux"
  - "tag:ai-node"
  - "tag:workstation"
  - "tag:rocm"
  - "tag:llm_node"
tailscale_auth_key_akv_secret: "akira-tailscale-authkey"
tailscale_auth_key_env_file: "/flux/runtime/secrets/tailscale.env"

# =============================================================================
# GPU / AI Configuration
# =============================================================================
gpu_vendor: AMD
gpu_model: "Radeon 890M"
gpu_arch: gfx1150
gpu_driver: ROCm
rocm_version: "7.1"
enable_rocm: true
enable_nvidia: false  # Explicitly disabled - this is AMD

# ROCm-specific paths (Fedora layout)
rocm_path: /usr/lib64/rocm
hip_device_lib_path: /usr/lib64/rocm/llvm/lib/clang/19/amdgcn/bitcode
hip_clang_path: /usr/lib64/rocm/llvm/bin

# AI inference configuration
ai_inference_engine: llama-cpp-python
ai_model_storage: /flux/ai/models
ai_venv_path: /home/mdt/rocm-test
ai_api_port: 8080

# =============================================================================
# Container Runtime
# =============================================================================
container_runtime: podman
# ROCm device passthrough for containers
container_gpu_args: "--device=/dev/kfd --device=/dev/dri --security-opt seccomp=unconfined"

# =============================================================================
# Filesystem Layout (optimized 2025-12-05)
# =============================================================================
# /flux - Samsung 990 PRO 4TB (x4 PCIe slot) - fast active storage
flux_mount: /flux
flux_device: /dev/nvme2n1p1
flux_uuid: "1e5c92a7-c2fc-4b0e-833d-b852d64ea331"
flux_filesystem: ext4
flux_mount_options: "noatime,discard"

# /time - Crucial P310 4TB (x1 PCIe slot) - backups, snapshots
time_mount: /time
time_device: /dev/nvme1n1p1
time_uuid: "9f55fc05-8375-4694-8067-c431fa1a9325"
time_filesystem: ext4
time_mount_options: "noatime,discard"
time_local: true

# /space - WD Red 18TB HDD - LOCAL cold storage (NOT NFS!)
space_mount: /space
space_device: /dev/sda1
space_uuid: "9f387c92-613e-44fb-a6c4-3878b95905f3"
space_filesystem: btrfs
space_mount_options: "compress=zstd:3,noatime"
space_is_local: true  # NOT remote NFS
space_is_sor: true    # This IS the SoR for akira's /space

# User symlinks
user_symlinks:
  - user: mdt
    links:
      - src: /flux/users/mdt
        dest: "{{ ansible_env.HOME }}/flux"
      - src: /space
        dest: "{{ ansible_env.HOME }}/space"
      - src: /time
        dest: "{{ ansible_env.HOME }}/time"
  - user: miket
    links:
      - src: /flux/users/miket
        dest: "/home/miket/flux"
      - src: /space
        dest: "/home/miket/space"
      - src: /time
        dest: "/home/miket/time"

# =============================================================================
# Firewall Configuration
# =============================================================================
firewall_backend: firewalld
# Tailnet IP range for trusted access
tailnet_cidr: "100.64.0.0/10"
# Services exposed only to tailnet
tailnet_services:
  - ssh
  - llama-api  # Custom service for AI API
# Public services (none for now)
public_services: []

# =============================================================================
# Workstation Configuration
# =============================================================================
workstation_packages:
  # KDE specific tools (per ADR-004)
  - konsole
  - dolphin
  - kate
  - ark
  - spectacle
  - gwenview
  - okular
  - kcalc
  - kcharselect
  - kwalletmanager
  - filelight
  - plasma-systemmonitor
  - plasma-discover
  - plasma-discover-flatpak
  - kde-connect
  # Clipboard integration
  - wl-clipboard
  - xclip
  # Flatpak support
  - flatpak
  # Dev essentials
  - git
  - git-lfs
  - vim-enhanced
  - neovim
  - tmux
  - htop
  - btop
  - ripgrep
  - fd-find
  - jq
  - yq
  - fzf
  - curl
  - wget
  - tree
  - bat
  - eza
  # Build tools
  - gcc
  - gcc-c++
  - make
  - cmake
  - ninja-build
  # Python
  - python3.12
  - python3.12-devel
  - python3-pip
  # Container tools
  - podman
  - podman-compose
  - buildah

# Flatpaks for workstation
flatpak_apps:
  - com.visualstudio.code
  - dev.warp.Warp
  - io.github.ArcticFox-Dev.ArcticFox.Cursor

# =============================================================================
# KDE Plasma Desktop Configuration
# =============================================================================
# Per ADR-004: KDE Plasma is the standard desktop for Linux UI nodes
kde_config:
  # Power management for desktop (different from laptop)
  power_management:
    suspend_on_lid_close: false   # N/A for desktop
    dim_screen_timeout: 600       # 10 minutes
    blank_screen_timeout: 900     # 15 minutes
  # Basic UX settings (not personal dotfiles)
  theme: breeze-dark
  single_click_activation: false

# =============================================================================
# GNOME Migration Configuration
# =============================================================================
# Users whose GNOME configs should be archived before KDE migration
gnome_archive_users:
  - miket

# =============================================================================
# Container Runtime
# =============================================================================
# Docker is BANNED - see docker_prevention role
docker_prevention_enabled: true

# =============================================================================
# Remote Desktop Configuration
# =============================================================================
# NoMachine is the standardized remote access protocol
remote_protocol: nomachine
remote_port: 4000
restrict_to_tailscale: true

# =============================================================================
# SELinux
# =============================================================================
selinux_mode: enforcing
selinux_custom_modules: []

# =============================================================================
# Accounts
# =============================================================================
automation_user: mdt
interactive_users:
  - miket

# =============================================================================
# Monitoring
# =============================================================================
netdata_enabled: true
netdata_cloud_claim: true

# =============================================================================
# Power Management (Wake-on-LAN)
# =============================================================================
# Enable WOL on these interfaces
wol_interfaces:
  - enp196s0   # Primary - 38:05:25:30:42:84

# MAC addresses for documentation/relay config
wol_macs:
  enp196s0: "38:05:25:30:42:84"
  enp197s0: "38:05:25:30:42:85"

# WOL relay host (always-on, same LAN segment)
wol_relay_host: motoko

