# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# Mapping of Azure Key Vault secrets to device-local .env files
# Extend by adding new services; no code changes needed.

akv_vault_name: kv-miket-ops

services:
  litellm:
    hosts: [motoko]
    env_file: /podman/apps/litellm/.env
    owner: root
    group: root
    mode: "0600"
    run_as: mdt               # user with AKV access via az login / managed identity
    # restart:
    #   - litellm
    secrets:
      OPENAI_API_KEY: openai-api-key
      LITELLM_TOKEN: litellm-bearer-token

  data_lifecycle:
    hosts: [motoko]
    env_file: /etc/miket/storage-credentials.env
    owner: root
    group: root
    mode: "0600"
    run_as: mdt
    # NOTE: Do NOT restart backup services here - they are Type=oneshot and would
    # block until complete (hours). The timers will pick up new credentials on next run.
    # restart:
    #   - flux-backup.service
    #   - space-mirror.service
    secrets:
      B2_APPLICATION_KEY_ID: b2-space-mirror-id
      B2_APPLICATION_KEY: b2-space-mirror-key
      B2_ACCOUNT_ID: b2-restic-id
      B2_ACCOUNT_KEY: b2-restic-key
      RESTIC_PASSWORD: restic-password

  windows_automation:
    hosts: [motoko]
    env_file: /etc/ansible/windows-automation.env
    owner: mdt
    group: mdt
    mode: "0600"
    run_as: mdt
    secrets:
      ARMITAGE_ANSIBLE_PASSWORD: armitage-ansible-password
      WINTERMUTE_ANSIBLE_PASSWORD: wintermute-ansible-password

  mount_shares_macos:
    groups: [macos]
    env_file: "~/.mkt/mounts.env"
    owner: "{{ ansible_user | default('miket') }}"
    group: "{{ ansible_user | default('miket') }}"
    mode: "0600"
    become: false
    run_as: "{{ ansible_user | default('miket') }}"
    secrets:
      SMB_PASSWORD: motoko-smb-password

  nextcloud:
    hosts: [motoko]
    env_file: /flux/runtime/secrets/nextcloud.env
    owner: root
    group: root
    mode: "0600"
    run_as: mdt
    # restart:
    #   - nextcloud
    #   - nextcloud-m365-sync.timer
    secrets:
      # Database credentials
      NEXTCLOUD_DB_USER: nextcloud-db-user
      NEXTCLOUD_DB_PASSWORD: nextcloud-db-password
      POSTGRES_USER: nextcloud-db-user
      POSTGRES_PASSWORD: nextcloud-db-password
      # Admin credentials
      NEXTCLOUD_ADMIN_USER: nextcloud-admin-user
      NEXTCLOUD_ADMIN_PASSWORD: nextcloud-admin-bootstrap-password
      # OIDC/SSO integration (Entra ID login)
      NEXTCLOUD_OIDC_CLIENT_ID: nextcloud-oidc-client-id
      NEXTCLOUD_OIDC_CLIENT_SECRET: nextcloud-oidc-client-secret
      # Tenant ID is a known value, not a secret: cd6aed39-39c7-44ec-9eeb-6eb23f6dcad0
      # M365 integration (for rclone ingestion)
      # M365_CLIENT_ID: m365-nextcloud-client-id
      # M365_CLIENT_SECRET: m365-nextcloud-client-secret
      # Redis password (generated)
      REDIS_PASSWORD: nextcloud-redis-password

  # ========================================
  # Netdata Cloud (Homelab)
  # ========================================
  # Tokens for claiming agents to Netdata Cloud (Homelab subscription)
  # Cloud is the primary monitoring UI; local dashboards are secondary
  netdata:
    groups: [netdata_nodes]
    env_file: /flux/runtime/secrets/netdata.env
    owner: root
    group: root
    mode: "0600"
    run_as: mdt
    secrets:
      # Claim token from app.netdata.cloud -> Space Settings -> Nodes -> Add nodes
      NETDATA_CLOUD_CLAIM_TOKEN: netdata-cloud-claim-token
      # Rooms ID for the default room (from Add nodes dialog)
      NETDATA_CLOUD_ROOMS: netdata-cloud-rooms
