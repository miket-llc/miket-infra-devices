# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# Mapping of Azure Key Vault secrets to device-local .env files
# Extend by adding new services; no code changes needed.

akv_vault_name: kv-miket-ops

services:
  # ========================================
  # LiteLLM Proxy (Akira - Primary)
  # ========================================
  # LiteLLM on akira routes to local vLLM backend
  # Port 4000 for proxy, port 8000 for vLLM backend
  litellm:
    hosts: [akira]
    env_file: /flux/apps/litellm/.env
    owner: root
    group: root
    mode: "0600"
    run_as: mdt
    restart:
      - litellm
    secrets:
      LITELLM_MASTER_KEY: litellm-master-key
      # Optional: OpenAI fallback (disabled by default)
      # OPENAI_API_KEY: openai-api-key

  # ========================================
  # LiteLLM Proxy (Motoko - Legacy/Backup)
  # ========================================
  # Retained for backwards compatibility; disable if not needed
  litellm_motoko:
    hosts: [motoko]
    env_file: /podman/apps/litellm/.env
    owner: root
    group: root
    mode: "0600"
    run_as: mdt
    enabled: false  # Disabled - akira is now primary
    secrets:
      OPENAI_API_KEY: openai-api-key
      LITELLM_TOKEN: litellm-bearer-token

  # ========================================
  # Data Lifecycle (Backups & Mirrors)
  # ========================================
  # Per ADR-0010: space-mirror runs on akira (primary), motoko (retained for flux-backup)
  # space-mirror syncs /space → B2:miket-space-mirror
  # flux-backup syncs /flux → B2:miket-backups-restic
  data_lifecycle:
    hosts: [akira, motoko]  # akira for space-mirror, motoko for flux-backup
    env_file: /etc/miket/storage-credentials.env
    owner: root
    group: root
    mode: "0600"
    run_as: mdt
    # NOTE: Do NOT restart backup services here - they are Type=oneshot and would
    # block until complete (hours). The timers will pick up new credentials on next run.
    secrets:
      B2_APPLICATION_KEY_ID: b2-space-mirror-id
      B2_APPLICATION_KEY: b2-space-mirror-key
      B2_ACCOUNT_ID: b2-restic-id
      B2_ACCOUNT_KEY: b2-restic-key
      RESTIC_PASSWORD: restic-password

  windows_automation:
    hosts: [motoko]
    env_file: /etc/ansible/windows-automation.env
    owner: mdt
    group: mdt
    mode: "0600"
    run_as: mdt
    # NOTE: armitage is now Linux with SSH key auth - no Windows password needed
    secrets:
      WINTERMUTE_ANSIBLE_PASSWORD: wintermute-ansible-password

  mount_shares_macos:
    groups: [macos]
    env_file: "~/.mkt/mounts.env"
    owner: "{{ ansible_user | default('miket') }}"
    group: "{{ ansible_user | default('miket') }}"
    mode: "0600"
    become: false
    run_as: "{{ ansible_user | default('miket') }}"
    secrets:
      SMB_PASSWORD: motoko-smb-password

  # ========================================
  # Nextcloud PHC Service
  # ========================================
  # Per ADR-0010: Nextcloud migrated from motoko to akira (2025-12)
  # Runtime on akira, secrets synced from AKV
  nextcloud:
    hosts: [akira]  # Changed from [motoko] per ADR-0010
    env_file: /flux/runtime/secrets/nextcloud.env
    owner: root
    group: root
    mode: "0600"
    run_as: mdt
    # restart:
    #   - nextcloud
    #   - nextcloud-m365-sync.timer
    secrets:
      # Database credentials
      NEXTCLOUD_DB_USER: nextcloud-db-user
      NEXTCLOUD_DB_PASSWORD: nextcloud-db-password
      POSTGRES_USER: nextcloud-db-user
      POSTGRES_PASSWORD: nextcloud-db-password
      # Admin credentials
      NEXTCLOUD_ADMIN_USER: nextcloud-admin-user
      NEXTCLOUD_ADMIN_PASSWORD: nextcloud-admin-bootstrap-password
      # OIDC/SSO integration (Entra ID login)
      NEXTCLOUD_OIDC_CLIENT_ID: nextcloud-oidc-client-id
      NEXTCLOUD_OIDC_CLIENT_SECRET: nextcloud-oidc-client-secret
      # Tenant ID is a known value, not a secret: cd6aed39-39c7-44ec-9eeb-6eb23f6dcad0
      # M365 integration (for rclone ingestion)
      # M365_CLIENT_ID: m365-nextcloud-client-id
      # M365_CLIENT_SECRET: m365-nextcloud-client-secret
      # Redis password (generated)
      REDIS_PASSWORD: nextcloud-redis-password

  # ========================================
  # Nextcloud (motoko) - ROLLBACK ONLY
  # ========================================
  # Retained for rollback during migration window (7 days post-cutover)
  # After rollback window expires, remove this entry
  nextcloud_motoko_rollback:
    hosts: [motoko]
    env_file: /flux/runtime/secrets/nextcloud.env
    owner: root
    group: root
    mode: "0600"
    run_as: mdt
    enabled: false  # Disabled post-cutover; enable for rollback
    secrets:
      NEXTCLOUD_DB_USER: nextcloud-db-user
      NEXTCLOUD_DB_PASSWORD: nextcloud-db-password
      POSTGRES_USER: nextcloud-db-user
      POSTGRES_PASSWORD: nextcloud-db-password
      NEXTCLOUD_ADMIN_USER: nextcloud-admin-user
      NEXTCLOUD_ADMIN_PASSWORD: nextcloud-admin-bootstrap-password
      NEXTCLOUD_OIDC_CLIENT_ID: nextcloud-oidc-client-id
      NEXTCLOUD_OIDC_CLIENT_SECRET: nextcloud-oidc-client-secret
      REDIS_PASSWORD: nextcloud-redis-password

  # ========================================
  # Observability Stack (Grafana)
  # ========================================
  # Grafana admin credentials for Prometheus/Grafana stack on akira
  grafana:
    hosts: [akira]
    env_file: /flux/runtime/secrets/grafana.env
    owner: root
    group: root
    mode: "0600"
    run_as: mdt
    secrets:
      # Grafana admin password (stored in AKV)
      GRAFANA_ADMIN_PASSWORD: grafana-admin-password

  # ========================================
  # Akira Tailscale (Phase 0 Bootstrap)
  # ========================================
  # Tailscale auth key for joining the tailnet
  akira_tailscale:
    hosts: [akira]
    env_file: /etc/tailscale/auth.env
    owner: root
    group: root
    mode: "0600"
    run_as: mdt
    secrets:
      TAILSCALE_AUTH_KEY: akira-tailscale-auth-key

  # ========================================
  # Akira Filesystem Mounts (SMB)
  # ========================================
  # NOTE: Post ADR-0010 migration, akira has LOCAL /space storage
  # These credentials retained for mounting /time from motoko if needed
  akira_mounts:
    hosts: [akira]
    env_file: /home/miket/.mkt/smb-credentials
    owner: miket
    group: miket
    mode: "0600"
    run_as: miket
    enabled: false  # /space is now local on akira; re-enable if mounting from motoko
    secrets:
      SMB_USERNAME: motoko-smb-username
      SMB_PASSWORD: motoko-smb-password

  # ========================================
  # AI Fabric LLM Workstation (armitage)
  # ========================================
  # Secrets for Ollama workstation + optional LLM gateway
  # Per AI Fabric Platform Contract and ADR-005
  ai_fabric_workstation:
    hosts: [armitage]
    env_file: /flux/runtime/secrets/ai-fabric.env
    owner: root
    group: ollama
    mode: "0640"
    run_as: mdt
    secrets:
      # OpenAI API key for LLM gateway upstream calls
      OPENAI_API_KEY: openai-api-key
      # Azure OpenAI credentials (if using Azure as upstream)
      # AZURE_OPENAI_API_KEY: azure-openai-api-key
      # AZURE_OPENAI_ENDPOINT: azure-openai-endpoint

  # ========================================
  # Armitage Tailscale (Bootstrap) - DISABLED
  # ========================================
  # Tailscale auth key not needed - armitage is already on tailnet
  # Uncomment if fresh join is needed:
  # armitage_tailscale:
  #   hosts: [armitage]
  #   env_file: /flux/runtime/secrets/tailscale.env
  #   owner: root
  #   group: root
  #   mode: "0600"
  #   run_as: mdt
  #   secrets:
  #     TAILSCALE_AUTH_KEY: armitage-tailscale-auth-key

  # ========================================
  # Atom Tailscale (Headless Server Enrollment)
  # ========================================
  # Tailscale auth key for atom headless server
  # Created in miket-infra with tags: tag:server,tag:linux
  # AKV secret: tailscale-auth-key-atom (ephemeral, reusable)
  atom_tailscale:
    hosts: [atom]
    env_file: /etc/tailscale/auth.env
    owner: root
    group: root
    mode: "0600"
    run_as: mdt
    secrets:
      TAILSCALE_AUTH_KEY: tailscale-auth-key-atom
