---
# Mapping of Azure Key Vault secrets to device-local .env files
# Extend by adding new services; no code changes needed.

akv_vault_name: kv-miket-ops

services:
  litellm:
    hosts: [motoko]
    env_file: /opt/litellm/.env
    owner: root
    group: root
    mode: "0600"
    run_as: mdt               # user with AKV access via az login / managed identity
    restart:
      - litellm
    secrets:
      OPENAI_API_KEY: openai-api-key
      LITELLM_TOKEN: litellm-bearer-token

  data_lifecycle:
    hosts: [motoko]
    env_file: /etc/miket/storage-credentials.env
    owner: root
    group: root
    mode: "0600"
    run_as: mdt
    restart:
      - flux-backup.service
      - space-mirror.service
    secrets:
      B2_APPLICATION_KEY_ID: b2-space-mirror-id
      B2_APPLICATION_KEY: b2-space-mirror-key
      B2_ACCOUNT_ID: b2-restic-id
      B2_ACCOUNT_KEY: b2-restic-key
      RESTIC_PASSWORD: restic-password

  windows_automation:
    hosts: [motoko]
    env_file: /etc/ansible/windows-automation.env
    owner: mdt
    group: mdt
    mode: "0600"
    run_as: mdt
    secrets:
      ARMITAGE_ANSIBLE_PASSWORD: armitage-ansible-password
      WINTERMUTE_ANSIBLE_PASSWORD: wintermute-ansible-password

  mount_shares_macos:
    groups: [macos]
    env_file: "~/.mkt/mounts.env"
    owner: "{{ ansible_user | default('miket') }}"
    group: "{{ ansible_user | default('miket') }}"
    mode: "0600"
    become: false
    run_as: "{{ ansible_user | default('miket') }}"
    secrets:
      SMB_PASSWORD: motoko-smb-password
