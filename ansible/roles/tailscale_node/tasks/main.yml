# Copyright (c) 2025 MikeT LLC. All rights reserved.
# roles/tailscale_node/tasks/main.yml
---
- name: Check if Tailscale is already installed
  ansible.builtin.command: rpm -q tailscale
  register: tailscale_installed
  changed_when: false
  failed_when: false

- name: Add Tailscale repository
  ansible.builtin.get_url:
    url: "{{ tailscale_repo_url }}"
    dest: /etc/yum.repos.d/tailscale.repo
    mode: "0644"
  when: tailscale_installed.rc != 0

- name: Install Tailscale
  ansible.builtin.dnf:
    name: tailscale
    state: present
  when: tailscale_installed.rc != 0

- name: Enable and start tailscaled service
  ansible.builtin.systemd:
    name: tailscaled
    enabled: true
    state: started

- name: Check current Tailscale status
  ansible.builtin.command: tailscale status --json
  register: tailscale_status
  changed_when: false
  failed_when: false

- name: Display Tailscale status
  ansible.builtin.debug:
    msg: |
      Tailscale Status:
      - Service: Running
      - To authenticate (if not already):
        1. Ensure auth key is in {{ tailscale_auth_key_env_file }}
           (sourced from AKV secret: {{ tailscale_auth_key_akv_secret }})
        2. Run: sudo tailscale up --hostname={{ tailscale_hostname }} --authkey=$(cat {{ tailscale_auth_key_env_file }} | grep TAILSCALE_AUTHKEY | cut -d= -f2)
      - Or use interactive auth: sudo tailscale up --hostname={{ tailscale_hostname }}

# Auth key join: When tailscale_join_enabled is true (and secrets-sync has run),
# this role can perform a non-interactive join using the auth key from AKV.
# This eliminates manual 'tailscale up' commands.

- name: Include non-interactive join tasks (if enabled)
  ansible.builtin.include_tasks: join.yml
  when: tailscale_join_enabled | default(false)
  tags: [tailscale, join]

- name: Create secrets directory for tailscale auth key
  ansible.builtin.file:
    path: "{{ tailscale_auth_key_env_file | dirname }}"
    state: directory
    owner: root
    group: root
    mode: "0700"

- name: Create placeholder for tailscale auth key env file
  ansible.builtin.copy:
    content: |
      # Tailscale auth key - sourced from Azure Key Vault
      # AKV Secret: {{ tailscale_auth_key_akv_secret }}
      # This file should be populated by secrets-sync or manual AKV lookup
      # Format: TAILSCALE_AUTHKEY=tskey-auth-xxxxx
      # TAILSCALE_AUTHKEY=
    dest: "{{ tailscale_auth_key_env_file }}"
    owner: root
    group: root
    mode: "0600"
    force: false  # Don't overwrite if exists
