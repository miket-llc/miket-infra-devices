# Copyright (c) 2025 MikeT LLC. All rights reserved.
---
# power_wol role tasks
# Enable Wake-on-LAN on specified network interfaces

- name: Install ethtool
  package:
    name: ethtool
    state: present
  when: wol_install_ethtool | bool

- name: Check WOL support on interfaces
  command: ethtool {{ item }}
  register: ethtool_check
  changed_when: false
  failed_when: false
  loop: "{{ wol_interfaces }}"
  when: wol_interfaces | length > 0

- name: Display WOL support status
  debug:
    msg: "{{ item.item }}: {{ 'WOL supported' if 'Supports Wake-on' in item.stdout else 'WOL NOT supported' }}"
  loop: "{{ ethtool_check.results }}"
  when: 
    - wol_interfaces | length > 0
    - ethtool_check.results is defined

- name: Deploy WOL systemd service template
  template:
    src: wol@.service.j2
    dest: /etc/systemd/system/wol@.service
    owner: root
    group: root
    mode: '0644'
  notify: Reload systemd
  when: wol_interfaces | length > 0

- name: Flush handlers to reload systemd
  meta: flush_handlers

- name: Enable and start WOL service for each interface
  systemd:
    name: "wol@{{ item }}.service"
    state: started
    enabled: true
    daemon_reload: true
  loop: "{{ wol_interfaces }}"
  when: wol_interfaces | length > 0

- name: Verify WOL is enabled
  command: ethtool {{ item }}
  register: wol_verify
  changed_when: false
  loop: "{{ wol_interfaces }}"
  when: wol_interfaces | length > 0

- name: Display WOL verification
  debug:
    msg: "{{ item.item }}: Wake-on={{ item.stdout | regex_search('Wake-on: (.)', '\\1') | first | default('unknown') }}"
  loop: "{{ wol_verify.results }}"
  when:
    - wol_interfaces | length > 0
    - wol_verify.results is defined

