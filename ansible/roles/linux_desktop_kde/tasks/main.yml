# Copyright (c) 2025 MikeT LLC. All rights reserved.
# roles/linux_desktop_kde/tasks/main.yml
#
# KDE Plasma desktop installation and configuration
# Per ADR-004: KDE Plasma is the standard desktop for all Linux UI nodes
---

- name: Install KDE Plasma desktop environment
  ansible.builtin.dnf:
    name: "{{ kde_packages }}"
    state: present
  tags: [kde, packages]

- name: Enable SDDM display manager
  ansible.builtin.systemd:
    name: "{{ kde_display_manager }}"
    enabled: true
  tags: [kde, display-manager]

- name: Set SDDM as default display manager
  ansible.builtin.file:
    src: /usr/lib/systemd/system/sddm.service
    dest: /etc/systemd/system/display-manager.service
    state: link
    force: true
  tags: [kde, display-manager]

- name: Set graphical target as default
  ansible.builtin.command: systemctl set-default graphical.target
  changed_when: false
  tags: [kde, target]

- name: Configure SDDM for Wayland session
  ansible.builtin.copy:
    content: |
      [General]
      DisplayServer=wayland

      [Wayland]
      SessionDir=/usr/share/wayland-sessions

      [X11]
      SessionDir=/usr/share/xsessions
    dest: /etc/sddm.conf.d/10-wayland.conf
    mode: "0644"
  tags: [kde, sddm]

- name: Ensure logind.conf.d directory exists
  ansible.builtin.file:
    path: /etc/systemd/logind.conf.d
    state: directory
    mode: "0755"
  tags: [kde, power]

- name: Configure power management for lid close
  ansible.builtin.copy:
    content: |
      # Laptop lid close behavior
      # HandleLidSwitch=ignore prevents suspend on lid close (for docked operation)
      [Login]
      HandleLidSwitch=ignore
      HandleLidSwitchExternalPower=ignore
      HandleLidSwitchDocked=ignore
    dest: /etc/systemd/logind.conf.d/10-lid-behavior.conf
    mode: "0644"
  notify: Restart systemd-logind
  when: kde_power_management.lid_close_action == "nothing"
  tags: [kde, power]

- name: Create Plasma autostart directory
  ansible.builtin.file:
    path: /etc/xdg/autostart
    state: directory
    mode: "0755"
  tags: [kde]

- name: Enable Flatpak integration in Discover
  ansible.builtin.command: flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
  changed_when: false
  tags: [kde, flatpak]

- name: Display KDE setup summary
  ansible.builtin.debug:
    msg: |
      KDE Plasma Desktop Setup Complete:
      - Display Manager: {{ kde_display_manager }}
      - Session Type: {{ kde_session.session_type }}
      - Theme: {{ kde_theme }}
      - Lid Close Action: {{ kde_power_management.lid_close_action }}
      
      ADR-004: KDE Plasma is the standard Linux UI baseline
      
      To complete first-time setup:
      1. Reboot the system
      2. Log in via SDDM
      3. Plasma session will start automatically

