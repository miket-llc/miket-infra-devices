# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# Linux tasks for nodejs_nvm role
# Installs nvm and Node.js in user space - no sudo required for npm global packages

- name: Get user home directory
  ansible.builtin.shell: "echo ~{{ nodejs_nvm_user }}"
  register: nvm_user_home
  changed_when: false
  check_mode: false

- name: Set nvm paths
  ansible.builtin.set_fact:
    nvm_home: "{{ nvm_user_home.stdout }}"
    nvm_dir: "{{ nvm_user_home.stdout }}/{{ nodejs_nvm_dir }}"

# ========================================
# Optional: Remove system Node.js
# ========================================
- name: Remove system nodejs packages (Fedora/RHEL)
  ansible.builtin.dnf:
    name:
      - nodejs
      - npm
    state: absent
  become: true
  when:
    - nodejs_remove_system_packages | bool
    - ansible_os_family == 'RedHat'

- name: Remove system nodejs packages (Debian/Ubuntu)
  ansible.builtin.apt:
    name:
      - nodejs
      - npm
    state: absent
  become: true
  when:
    - nodejs_remove_system_packages | bool
    - ansible_os_family == 'Debian'

# ========================================
# Install nvm
# ========================================
- name: Check if nvm is already installed
  ansible.builtin.stat:
    path: "{{ nvm_dir }}/nvm.sh"
  register: nvm_installed

- name: Download and install nvm
  ansible.builtin.shell: |
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v{{ nodejs_nvm_version }}/install.sh | bash
  args:
    creates: "{{ nvm_dir }}/nvm.sh"
  become: true
  become_user: "{{ nodejs_nvm_user }}"
  environment:
    HOME: "{{ nvm_home }}"
    NVM_DIR: "{{ nvm_dir }}"
  when: not nvm_installed.stat.exists

- name: Verify nvm installation
  ansible.builtin.stat:
    path: "{{ nvm_dir }}/nvm.sh"
  register: nvm_verify
  failed_when:
    - not nvm_verify.stat.exists
    - not ansible_check_mode

# ========================================
# Shell integration
# ========================================
- name: Ensure nvm is sourced in shell profiles
  ansible.builtin.blockinfile:
    path: "{{ nvm_home }}/{{ item }}"
    block: |
      # nvm (Node Version Manager)
      export NVM_DIR="{{ nvm_dir }}"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
      [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - nvm"
    create: true
    mode: '0644'
    owner: "{{ nodejs_nvm_user }}"
    group: "{{ nodejs_nvm_user }}"
  loop: "{{ nodejs_shell_profiles }}"
  ignore_errors: true  # Some profiles may not exist

# ========================================
# Install Node.js via nvm
# ========================================
- name: Check installed node versions
  ansible.builtin.shell: |
    export NVM_DIR="{{ nvm_dir }}"
    source "$NVM_DIR/nvm.sh"
    nvm ls --no-colors 2>/dev/null || echo "none"
  args:
    executable: /bin/bash
  become: true
  become_user: "{{ nodejs_nvm_user }}"
  register: nvm_versions
  changed_when: false

- name: Install Node.js via nvm
  ansible.builtin.shell: |
    export NVM_DIR="{{ nvm_dir }}"
    source "$NVM_DIR/nvm.sh"
    {% if nodejs_version == 'lts' %}
    nvm install --lts
    {% else %}
    nvm install {{ nodejs_version }}
    {% endif %}
  args:
    executable: /bin/bash
  become: true
  become_user: "{{ nodejs_nvm_user }}"
  register: node_install
  changed_when: "'is already installed' not in node_install.stderr"

- name: Set default Node.js version
  ansible.builtin.shell: |
    export NVM_DIR="{{ nvm_dir }}"
    source "$NVM_DIR/nvm.sh"
    {% if nodejs_version == 'lts' %}
    nvm alias default lts/*
    {% else %}
    nvm alias default {{ nodejs_version }}
    {% endif %}
  args:
    executable: /bin/bash
  become: true
  become_user: "{{ nodejs_nvm_user }}"
  when: nodejs_set_default | bool
  changed_when: false

# ========================================
# Install global npm packages (no sudo!)
# ========================================
- name: Install global npm packages via nvm
  ansible.builtin.shell: |
    export NVM_DIR="{{ nvm_dir }}"
    source "$NVM_DIR/nvm.sh"
    npm install -g {{ item }}
  args:
    executable: /bin/bash
  become: true
  become_user: "{{ nodejs_nvm_user }}"
  loop: "{{ nodejs_global_packages }}"
  register: npm_install
  changed_when: "'added' in npm_install.stdout or 'up to date' not in npm_install.stderr"
  when: nodejs_global_packages | length > 0

# ========================================
# Verification
# ========================================
- name: Get installed Node.js version
  ansible.builtin.shell: |
    export NVM_DIR="{{ nvm_dir }}"
    source "$NVM_DIR/nvm.sh"
    node --version
  args:
    executable: /bin/bash
  become: true
  become_user: "{{ nodejs_nvm_user }}"
  register: node_version
  changed_when: false

- name: Get installed npm version
  ansible.builtin.shell: |
    export NVM_DIR="{{ nvm_dir }}"
    source "$NVM_DIR/nvm.sh"
    npm --version
  args:
    executable: /bin/bash
  become: true
  become_user: "{{ nodejs_nvm_user }}"
  register: npm_version
  changed_when: false

- name: List global packages
  ansible.builtin.shell: |
    export NVM_DIR="{{ nvm_dir }}"
    source "$NVM_DIR/nvm.sh"
    npm list -g --depth=0 2>/dev/null || true
  args:
    executable: /bin/bash
  become: true
  become_user: "{{ nodejs_nvm_user }}"
  register: npm_global_list
  changed_when: false

- name: Display installation summary
  ansible.builtin.debug:
    msg:
      - "============================================"
      - "Node.js (nvm) installed on {{ inventory_hostname }}"
      - "============================================"
      - "nvm directory: {{ nvm_dir }}"
      - "Node.js: {{ node_version.stdout }}"
      - "npm: {{ npm_version.stdout }}"
      - "Global packages:"
      - "{{ npm_global_list.stdout_lines }}"
      - ""
      - "No sudo required for: npm install -g <package>"
      - "============================================"
