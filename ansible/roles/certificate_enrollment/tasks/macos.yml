# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# Certificate Enrollment - macOS (Cloudflare WARP)

- name: Check if Cloudflare WARP is installed (macOS)
  command: /usr/local/bin/warp-cli --version
  register: warp_version_check
  failed_when: false
  changed_when: false
  tags:
    - certificate_enrollment
    - cloudflare_access
    - macos

- name: Install Cloudflare WARP (macOS)
  homebrew:
    name: cloudflare-warp
    state: present
  when:
    - certificate_enrollment_macos_enabled | bool
    - warp_version_check.rc != 0
  tags:
    - certificate_enrollment
    - cloudflare_access
    - macos

- name: Register Cloudflare WARP (macOS)
  command: /usr/local/bin/warp-cli register
  register: warp_register_result
  changed_when: "'Successfully registered' in warp_register_result.stdout"
  when:
    - certificate_enrollment_macos_enabled | bool
    - cloudflare_warp_enabled | bool
  tags:
    - certificate_enrollment
    - cloudflare_access
    - macos

- name: Set Cloudflare WARP organization (macOS)
  command: /usr/local/bin/warp-cli set-mode warp
  when:
    - certificate_enrollment_macos_enabled | bool
    - cloudflare_warp_enabled | bool
    - cloudflare_warp_organization | length > 0
  tags:
    - certificate_enrollment
    - cloudflare_access
    - macos

- name: Connect Cloudflare WARP (macOS)
  command: /usr/local/bin/warp-cli connect
  when:
    - certificate_enrollment_macos_enabled | bool
    - cloudflare_warp_enabled | bool
  tags:
    - certificate_enrollment
    - cloudflare_access
    - macos

- name: Verify Cloudflare WARP status (macOS)
  command: /usr/local/bin/warp-cli status
  register: warp_status
  changed_when: false
  when:
    - certificate_enrollment_macos_enabled | bool
    - cloudflare_warp_enabled | bool
  tags:
    - certificate_enrollment
    - cloudflare_access
    - macos
    - validation

- name: Display Cloudflare WARP status (macOS)
  debug:
    msg: "{{ warp_status.stdout }}"
  when:
    - certificate_enrollment_macos_enabled | bool
    - cloudflare_warp_enabled | bool
    - warp_status is defined
  tags:
    - certificate_enrollment
    - cloudflare_access
    - macos

