---
# Ansible role: remote_server_linux_xrdp
# Installs and configures xrdp for RDP access on Linux hosts

- name: Install xrdp and dependencies
  ansible.builtin.apt:
    name:
      - xrdp
      - xorgxrdp
    state: present
    update_cache: yes
  become: true
  tags: [updates, packages]

- name: Add user to ssl-cert group (required for xrdp)
  ansible.builtin.user:
    name: "{{ ansible_user }}"
    groups: ssl-cert
    append: yes
  become: true

- name: Ensure xrdp user exists
  ansible.builtin.user:
    name: xrdp
    system: yes
    shell: /bin/false
    create_home: false
  become: true

- name: Configure xrdp to use Xorg session
  ansible.builtin.lineinfile:
    path: /etc/xrdp/xrdp.ini
    regexp: '^new_cursors='
    line: 'new_cursors=true'
    backup: yes
  become: true

- name: Ensure Xorg session is available
  ansible.builtin.stat:
    path: /usr/share/xsessions
  register: xsessions_dir

- name: Create Xorg session file if needed
  ansible.builtin.copy:
    dest: /usr/share/xsessions/Xorg.desktop
    content: |
      [Desktop Entry]
      Name=Xorg
      Comment=Xorg Session
      Exec=/usr/lib/xorg/Xorg
      Type=Application
      DesktopNames=Xorg
    mode: '0644'
  become: true
  when: xsessions_dir.stat.exists

- name: Configure xrdp to start Xorg session
  ansible.builtin.lineinfile:
    path: /etc/xrdp/startwm.sh
    regexp: '^\. /etc/X11/Xsession'
    line: '. /etc/X11/Xsession'
    backup: yes
  become: true

- name: Enable and start xrdp service
  ansible.builtin.systemd:
    name: xrdp
    enabled: true
    state: started
    daemon_reload: yes
  become: true

- name: Enable and start xrdp-sesman service
  ansible.builtin.systemd:
    name: xrdp-sesman
    enabled: true
    state: started
    daemon_reload: yes
  become: true

- name: Verify xrdp is listening on port 3389
  ansible.builtin.wait_for:
    host: localhost
    port: 3389
    delay: 2
    timeout: 10
  register: xrdp_port_check

- name: Display connection information
  ansible.builtin.debug:
    msg:
      - "âœ… xrdp is installed and running"
      - "Connect via RDP to: {{ inventory_hostname }}.pangolin-vega.ts.net:3389"

