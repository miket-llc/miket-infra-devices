# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# Podman Standard Linux Role
# Installs and configures Podman as the ONLY container runtime on Linux
#
# POLICY: Docker is BANNED from all PHC systems
#   - No podman-docker package
#   - No docker CLI wrappers  
#   - Docker packages are explicitly removed
#   - docker0 network artifacts are cleaned up
#
# Features:
# - Podman as the ONLY runtime (no Docker)
# - Native podman/podman-compose commands
# - Rootless container support
# - Systemd integration for container services
# - NVIDIA Container Toolkit integration
#
# Supports: Fedora, Ubuntu, Debian, and other major Linux distributions

- name: Validate running on Linux
  ansible.builtin.assert:
    that:
      - ansible_system == 'Linux'
    fail_msg: "This role is designed for Linux systems only"
    quiet: true
  tags: [podman_standard, containers, validate]

- name: Display runtime standard banner
  ansible.builtin.debug:
    msg:
      - "═══════════════════════════════════════════════════════════"
      - "PODMAN STANDARD LINUX - Container Runtime Installation"
      - "═══════════════════════════════════════════════════════════"
      - "Distribution: {{ ansible_distribution }} {{ ansible_distribution_version }}"
      - "Runtime: Podman ONLY (Docker is BANNED)"
      - "Commands: podman, podman-compose (NO docker aliases)"
      - "═══════════════════════════════════════════════════════════"
  tags: [podman_standard, containers, always]

# ========================================
# Install Podman and Tools
# ========================================
- name: Install Podman and container tools (Fedora/RHEL/CentOS)
  ansible.builtin.dnf:
    name: "{{ podman_packages }}"
    state: present
  when: ansible_os_family == "RedHat"
  tags: [podman_standard, containers, install]

- name: Install Podman and container tools (Ubuntu/Debian)
  ansible.builtin.apt:
    name: "{{ podman_packages_debian }}"
    state: present
    update_cache: true
  when: ansible_os_family == "Debian"
  tags: [podman_standard, containers, install]

# ========================================
# DOCKER PREVENTION - Purge All Docker Artifacts
# ========================================
- name: Check if Docker/moby-engine is installed (RedHat family)
  ansible.builtin.command: rpm -q moby-engine docker-ce podman-docker
  register: docker_check_rpm
  changed_when: false
  failed_when: false
  check_mode: false
  when: ansible_os_family == "RedHat"
  tags: [podman_standard, containers, docker_prevention]

- name: Check if Docker is installed (Debian family)
  ansible.builtin.command: dpkg -l docker.io docker-ce
  register: docker_check_deb
  changed_when: false
  failed_when: false
  check_mode: false
  when: ansible_os_family == "Debian"
  tags: [podman_standard, containers, docker_prevention]

- name: Remove Docker packages (RedHat family)
  ansible.builtin.dnf:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - moby-engine
      - docker-compose
      - podman-docker  # NO Docker CLI emulation
    state: absent
  when: ansible_os_family == "RedHat"
  tags: [podman_standard, containers, docker_prevention]

- name: Remove Docker packages (Debian family)
  ansible.builtin.apt:
    name:
      - docker.io
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-compose-plugin
      - docker-compose
    state: absent
    purge: true
  when: ansible_os_family == "Debian"
  tags: [podman_standard, containers, docker_prevention]

- name: Remove Docker CLI wrapper if present
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /usr/local/bin/docker
    - /usr/local/bin/docker-compose
  tags: [podman_standard, containers, docker_prevention]

- name: Check for docker0 network interface
  ansible.builtin.command: ip link show docker0
  register: docker0_check
  changed_when: false
  failed_when: false
  tags: [podman_standard, containers, docker_prevention]

- name: Remove docker0 from NetworkManager
  ansible.builtin.command: nmcli connection delete docker0
  when: docker0_check.rc == 0
  failed_when: false
  tags: [podman_standard, containers, docker_prevention]

- name: Delete docker0 network interface
  ansible.builtin.command: ip link delete docker0
  when: docker0_check.rc == 0
  failed_when: false
  tags: [podman_standard, containers, docker_prevention]

- name: Remove Docker data directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /var/lib/docker
    - /var/lib/containerd
    - /etc/docker
  tags: [podman_standard, containers, docker_prevention]

- name: Set docker_purged fact
  ansible.builtin.set_fact:
    docker_purged: true
  tags: [podman_standard, containers, docker_prevention]

- name: Install cockpit-podman for web UI (Fedora/RHEL)
  ansible.builtin.dnf:
    name: cockpit-podman
    state: present
  when:
    - podman_install_cockpit | bool
    - ansible_os_family == "RedHat"
  tags: [podman_standard, containers, install]

- name: Note cockpit-podman not available on Debian/Ubuntu
  ansible.builtin.debug:
    msg: "ℹ️  cockpit-podman is not available in standard Ubuntu/Debian repos (Fedora/RHEL only)"
  when:
    - podman_install_cockpit | bool
    - ansible_os_family == "Debian"
  tags: [podman_standard, containers, install]

# ========================================
# Configure Container Registries
# ========================================
- name: Ensure containers.conf.d directory exists
  ansible.builtin.file:
    path: /etc/containers/registries.conf.d
    state: directory
    mode: '0755'
  tags: [podman_standard, containers, config]

- name: Configure unqualified search registries
  ansible.builtin.copy:
    dest: /etc/containers/registries.conf.d/00-search.conf
    content: |
      # Configured by Ansible podman_standard_linux role
      # Unqualified image search registries
      unqualified-search-registries = {{ podman_registries_search | to_json }}
    mode: '0644'
  tags: [podman_standard, containers, config]

# ========================================
# Configure Custom Storage Paths
# ========================================
- name: Ensure storage.conf.d directory exists
  ansible.builtin.file:
    path: /etc/containers/storage.conf.d
    state: directory
    mode: '0755'
  when: podman_configure_storage | bool
  tags: [podman_standard, containers, storage]

- name: Create custom graphroot directory
  ansible.builtin.file:
    path: "{{ podman_graphroot }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  when:
    - podman_create_storage_dirs | bool
    - podman_graphroot | length > 0
  tags: [podman_standard, containers, storage]

- name: Configure Podman storage.conf for custom paths
  ansible.builtin.copy:
    dest: /etc/containers/storage.conf.d/00-custom-storage.conf
    content: |
      # Configured by Ansible podman_standard_linux role
      # Custom storage paths for container images and runtime data
      [storage]
      driver = "{{ podman_storage_driver }}"
      {% if podman_graphroot | length > 0 %}
      graphroot = "{{ podman_graphroot }}"
      {% endif %}
      {% if podman_runroot | length > 0 %}
      runroot = "{{ podman_runroot }}"
      {% endif %}
      
      [storage.options]
      # Use native overlay diff for better performance
      mount_program = "/usr/bin/fuse-overlayfs"
      
      [storage.options.overlay]
      # Enable metacopy for faster container creation
      mountopt = "nodev,metacopy=on"
    mode: '0644'
  when:
    - podman_configure_storage | bool
    - podman_graphroot | length > 0 or podman_runroot | length > 0
  notify: restart podman
  tags: [podman_standard, containers, storage]

# ========================================
# Enable Podman Socket (API)
# ========================================
- name: Enable podman socket (system-wide)
  ansible.builtin.systemd:
    name: podman.socket
    enabled: true
    state: started
  when: podman_enable_socket | bool
  tags: [podman_standard, containers, socket]

# ========================================
# Rootless Podman Setup
# ========================================
- name: Enable linger for rootless containers
  ansible.builtin.command: loginctl enable-linger {{ podman_user }}
  register: linger_result
  changed_when: false
  failed_when: linger_result.rc != 0
  when: podman_enable_linger | bool
  tags: [podman_standard, containers, rootless]

- name: Check linger status
  ansible.builtin.command: loginctl show-user {{ podman_user }} --property=Linger
  register: linger_check
  changed_when: false
  failed_when: false
  tags: [podman_standard, containers, rootless]

- name: Create user systemd directory
  ansible.builtin.file:
    path: "/home/{{ podman_user }}/.config/systemd/user"
    state: directory
    mode: '0755'
    owner: "{{ podman_user }}"
    group: "{{ podman_user }}"
  tags: [podman_standard, containers, rootless]

# ========================================
# NVIDIA Container Toolkit Integration
# ========================================
- name: Check if NVIDIA drivers are installed
  ansible.builtin.command: nvidia-smi
  register: nvidia_check
  changed_when: false
  failed_when: false
  when: podman_nvidia_enabled | bool
  tags: [podman_standard, containers, nvidia]

- name: Add NVIDIA container toolkit repository (RHEL/Fedora)
  ansible.builtin.get_url:
    url: "https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo"
    dest: /etc/yum.repos.d/nvidia-container-toolkit.repo
    mode: '0644'
  when:
    - podman_nvidia_enabled | bool
    - nvidia_check.rc == 0
    - ansible_os_family == "RedHat"
  tags: [podman_standard, containers, nvidia]

- name: Install NVIDIA Container Toolkit (RHEL/Fedora)
  ansible.builtin.dnf:
    name: nvidia-container-toolkit
    state: present
  when:
    - podman_nvidia_enabled | bool
    - nvidia_check.rc == 0
    - ansible_os_family == "RedHat"
  tags: [podman_standard, containers, nvidia]

- name: Add NVIDIA container toolkit GPG key (Ubuntu/Debian)
  ansible.builtin.apt_key:
    url: https://nvidia.github.io/libnvidia-container/gpgkey
    state: present
  when:
    - podman_nvidia_enabled | bool
    - nvidia_check.rc == 0
    - ansible_os_family == "Debian"
  tags: [podman_standard, containers, nvidia]

- name: Add NVIDIA container toolkit repository (Ubuntu/Debian)
  ansible.builtin.apt_repository:
    repo: "deb https://nvidia.github.io/libnvidia-container/stable/deb/$(ARCH) /"
    state: present
    filename: nvidia-container-toolkit
  when:
    - podman_nvidia_enabled | bool
    - nvidia_check.rc == 0
    - ansible_os_family == "Debian"
  tags: [podman_standard, containers, nvidia]

- name: Install NVIDIA Container Toolkit (Ubuntu/Debian)
  ansible.builtin.apt:
    name: nvidia-container-toolkit
    state: present
    update_cache: true
  when:
    - podman_nvidia_enabled | bool
    - nvidia_check.rc == 0
    - ansible_os_family == "Debian"
  tags: [podman_standard, containers, nvidia]

- name: Configure Podman for NVIDIA runtime
  ansible.builtin.command: nvidia-ctk cdi generate --output=/etc/cdi/nvidia.yaml
  register: nvidia_cdi
  changed_when: "'Generated' in nvidia_cdi.stdout or nvidia_cdi.rc == 0"
  failed_when: false
  when:
    - podman_nvidia_enabled | bool
    - nvidia_check.rc == 0
  tags: [podman_standard, containers, nvidia]

# ========================================
# Verification
# ========================================
- name: Verify Podman installation
  ansible.builtin.command: podman --version
  register: podman_version
  changed_when: false
  tags: [podman_standard, containers, verify]

- name: Verify Podman can run containers
  ansible.builtin.command: podman run --rm docker.io/library/alpine:latest echo "Podman works!"
  register: podman_test
  changed_when: false
  failed_when: false
  tags: [podman_standard, containers, verify]

# ========================================
# Summary
# ========================================
- name: Display Podman configuration summary
  ansible.builtin.debug:
    msg:
      - "═══════════════════════════════════════════════════════════"
      - "PODMAN STANDARD LINUX - CONFIGURATION COMPLETE"
      - "═══════════════════════════════════════════════════════════"
      - ""
      - "Distribution:       {{ ansible_distribution }} {{ ansible_distribution_version }}"
      - "Podman Version:     {{ podman_version.stdout }}"
      - "Docker Status:      BANNED & PURGED ☠️"
      - "Rootless User:      {{ podman_user }}"
      - "Linger Enabled:     {{ linger_check.stdout | default('unknown') }}"
      - "NVIDIA Support:     {{ 'Yes' if (nvidia_check.rc | default(1)) == 0 else 'No' }}"
      - "Container Test:     {{ 'Passed ✓' if (podman_test.rc | default(1)) == 0 else 'Failed ✗' }}"
      - ""
      - "Registries:"
      - "{% for reg in podman_registries_search %}  - {{ reg }}\n{% endfor %}"
      - ""
      - "Usage (native Podman commands ONLY):"
      - "  podman ps              # List containers"
      - "  podman run nginx       # Run container"
      - "  podman-compose up -d   # Start compose stack"
      - "  podman logs <name>     # View logs"
      - ""
      - "⛔ BANNED: docker, docker-compose, Docker Desktop"
      - ""
      - "Documentation: docs/reference/CONTAINERS_RUNTIME_STANDARD.md"
      - "═══════════════════════════════════════════════════════════"
  tags: [podman_standard, containers]

