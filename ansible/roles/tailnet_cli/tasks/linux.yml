---
# Linux-specific tasks for tailnet_cli role

- name: Check if Python 3.11+ is available
  command: python3.11 --version
  register: python_check
  changed_when: false
  failed_when: false
  ignore_errors: yes

- name: Install Python 3.11 and venv if not available
  apt:
    name:
      - python3.11
      - python3.11-venv
    state: present
    update_cache: yes
  when: python_check is failed or (python_check.rc is defined and python_check.rc != 0)

- name: Ensure base directory exists
  file:
    path: "{{ tailnet_cli_base_dir }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Check if repository is already cloned
  stat:
    path: "{{ tailnet_cli_repo_path }}/.git"
  register: repo_exists
  changed_when: false

- name: Clone repository if not present
  git:
    repo: "{{ tailnet_cli_repo_url }}"
    dest: "{{ tailnet_cli_repo_path }}"
    version: "{{ tailnet_cli_repo_branch }}"
    update: yes
  when: not repo_exists.stat.exists
  ignore_errors: yes
  register: git_clone_result

- name: Update repository if already cloned
  git:
    repo: "{{ tailnet_cli_repo_url }}"
    dest: "{{ tailnet_cli_repo_path }}"
    version: "{{ tailnet_cli_repo_branch }}"
    update: yes
  when: repo_exists.stat.exists
  ignore_errors: yes
  register: git_update_result

- name: Ensure tools directory structure exists (fallback if git fails)
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  loop:
    - "{{ tailnet_cli_repo_path }}/tools"
    - "{{ tailnet_cli_repo_path }}/tools/cli"
  when: (git_clone_result is defined and git_clone_result.failed) or (git_update_result is defined and git_update_result.failed)

- name: Get absolute path to repo root
  set_fact:
    repo_root_abs: "{{ lookup('pipe', 'cd {{ playbook_dir }}/../.. && pwd') }}"

- name: Copy CLI files from control node (fallback if git fails)
  copy:
    src: "{{ repo_root_abs }}/{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode | default('0644') }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  loop:
    - { src: "tools/cli/tailnet.py", dest: "{{ tailnet_cli_repo_path }}/tools/cli/tailnet.py", mode: '0644' }
    - { src: "tools/cli/requirements.txt", dest: "{{ tailnet_cli_repo_path }}/tools/cli/requirements.txt", mode: '0644' }
    - { src: "tools/__init__.py", dest: "{{ tailnet_cli_repo_path }}/tools/__init__.py", mode: '0644' }
    - { src: "tools/cli/__init__.py", dest: "{{ tailnet_cli_repo_path }}/tools/cli/__init__.py", mode: '0644' }
  when: (git_clone_result is defined and git_clone_result.failed) or (git_update_result is defined and git_update_result.failed)

- name: Ensure virtual environment directory exists
  file:
    path: "{{ tailnet_cli_venv_path }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Create virtual environment
  command: python3.11 -m venv "{{ tailnet_cli_venv_path }}"
  args:
    creates: "{{ tailnet_cli_venv_path }}/bin/activate"
  become: false

- name: Upgrade pip in virtual environment
  pip:
    name: pip
    state: latest
    virtualenv: "{{ tailnet_cli_venv_path }}"
    virtualenv_python: python3.11
  become: false

- name: Install CLI requirements
  pip:
    requirements: "{{ tailnet_cli_repo_path }}/tools/cli/requirements.txt"
    virtualenv: "{{ tailnet_cli_venv_path }}"
    virtualenv_python: python3.11
  become: false

- name: Ensure wrapper script directory exists
  file:
    path: "{{ tailnet_cli_wrapper_path_linux | dirname }}"
    state: directory
    mode: '0755'
  when: tailnet_cli_create_wrapper | bool

- name: Create wrapper script
  template:
    src: tailnet_wrapper.sh.j2
    dest: "{{ tailnet_cli_wrapper_path_linux }}"
    mode: '0755'
  when: tailnet_cli_create_wrapper | bool

- name: Verify CLI installation
  command: "{{ tailnet_cli_venv_path }}/bin/python -m tools.cli.tailnet --help"
  environment:
    PYTHONPATH: "{{ tailnet_cli_repo_path }}:{{ ansible_env.PYTHONPATH | default('') }}"
  register: cli_verify
  changed_when: false
  become: false

- name: Display CLI verification result
  debug:
    msg: "CLI tools installed successfully. Run 'tailnet --help' or '{{ tailnet_cli_venv_path }}/bin/python -m tools.cli.tailnet --help'"

