# {{ ansible_managed }}
# miket-infra-devices SSH Configuration
# Location: ~/.ssh/config.d/miket-infra.conf
#
# MANAGED BY ANSIBLE - Do not edit manually
# To customize: add entries to ~/.ssh/config (they take precedence)
# To remove: delete this file
#
# Deployed via: make deploy-ssh-config
# Role: ansible/roles/ssh_client_config
# Docs: docs/runbooks/ssh-user-mapping.md
#
# ARCHITECTURE:
#   Linux/macOS: Tailscale SSH (no keys - ACLs handle auth via Entra ID)
#   Windows: OpenSSH Server (keys required - Tailscale SSH not supported)

# ============================================================================
# Global Defaults for Tailscale Mesh
# ============================================================================
Host *.{{ tailnet_domain }}
    StrictHostKeyChecking {{ ssh_strict_host_key_checking }}
    ServerAliveInterval 60
    ServerAliveCountMax 3

# ============================================================================
# Linux Servers - Tailscale SSH (NO keys needed)
# Auth handled by Tailscale ACLs, identity from Entra ID
# ============================================================================
{% for host in ssh_user_mapping.linux_hosts %}
Host {{ host }} {{ host }}.{{ tailnet_domain }}
    User {{ ssh_user_mapping.linux_user }}
    HostName {{ host }}.{{ tailnet_domain }}
    # Tailscale SSH - no IdentityFile needed

{% endfor %}
# ============================================================================
# macOS Devices - Tailscale SSH (NO keys needed)
# Auth handled by Tailscale ACLs, identity from Entra ID
# ============================================================================
{% for host in ssh_user_mapping.macos_hosts %}
Host {{ host }} {{ host }}.{{ tailnet_domain }}
    User {{ ssh_user_mapping.macos_user }}
    HostName {{ host }}.{{ tailnet_domain }}
    # Tailscale SSH - no IdentityFile needed

{% endfor %}
# ============================================================================
# Windows Devices - OpenSSH Server (keys REQUIRED)
# Tailscale SSH not supported on Windows
# Uses 1Password SSH agent on macOS, filesystem key on Linux
# ============================================================================
{% for host in ssh_user_mapping.windows_hosts %}
Host {{ host }} {{ host }}.{{ tailnet_domain }}
    User {{ ssh_user_mapping.windows_user }}
    HostName {{ host }}.{{ tailnet_domain }}
{% if ansible_system == 'Darwin' %}
    IdentityAgent "{{ onepassword_agent_sock }}"
{% endif %}

{% endfor %}
# ============================================================================
# Tailscale IP fallback
# ============================================================================
Host 100.*
    User {{ ssh_user_mapping.linux_user }}
