# {{ ansible_managed }}
# miket-infra-devices SSH Configuration
# Location: ~/.ssh/config.d/miket-infra.conf
#
# MANAGED BY ANSIBLE - Do not edit manually
# To customize: add entries to ~/.ssh/config (they take precedence)
# To remove: delete this file
#
# Deployed via: make deploy-ssh-config
# Role: ansible/roles/ssh_client_config
# Docs: docs/runbooks/ssh-user-mapping.md

# ============================================================================
# Global Defaults for Tailscale Mesh
# ============================================================================
Host *.{{ tailnet_domain }}
    StrictHostKeyChecking {{ ssh_strict_host_key_checking }}
    ServerAliveInterval 60
    ServerAliveCountMax 3
{% if ssh_forward_agent %}
    ForwardAgent yes
{% endif %}

{% if ansible_system == 'Darwin' %}
# ============================================================================
# 1Password SSH Agent (macOS only)
# ============================================================================
Host *.{{ tailnet_domain }} 100.*
    IdentityAgent "{{ onepassword_agent_sock }}"

{% endif %}
# ============================================================================
# Linux Servers - use mdt (automation account)
# ============================================================================
{% for host in ssh_user_mapping.linux_hosts %}
Host {{ host }} {{ host }}.{{ tailnet_domain }}
    User {{ ssh_user_mapping.linux_user }}
    HostName {{ host }}.{{ tailnet_domain }}

{% endfor %}
# ============================================================================
# macOS Devices - use primary user
# ============================================================================
{% for host in ssh_user_mapping.macos_hosts %}
Host {{ host }} {{ host }}.{{ tailnet_domain }}
    User {{ ssh_user_mapping.macos_user }}
    HostName {{ host }}.{{ tailnet_domain }}

{% endfor %}
# ============================================================================
# Windows Devices - SSH available but WinRM preferred for Ansible
# ============================================================================
{% for host in ssh_user_mapping.windows_hosts %}
Host {{ host }} {{ host }}.{{ tailnet_domain }}
    User {{ ssh_user_mapping.windows_user }}
    HostName {{ host }}.{{ tailnet_domain }}

{% endfor %}
# ============================================================================
# Tailscale IP fallback - use mdt for direct IP access
# ============================================================================
Host 100.*
    User {{ ssh_user_mapping.linux_user }}

