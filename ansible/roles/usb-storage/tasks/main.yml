# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# USB Storage Management Tasks
# Handles 20TB USB drive - Reformat to ext4 for Time Machine and Space

- name: Install Samba and utilities
  apt:
    name:
      - samba
      - parted
      - xfsprogs
    state: present
    update_cache: yes

- name: Get all block devices (JSON in bytes)
  command: lsblk -o NAME,SIZE,TYPE,MOUNTPOINT,FSTYPE,LABEL,UUID,MODEL -J -b
  register: lsblk_json
  changed_when: false

- name: Find 20TB Drive (size > 15TB in bytes)
  set_fact:
    target_disk: "/dev/{{ item.name }}"
  loop: "{{ (lsblk_json.stdout | from_json).blockdevices }}"
  when: 
    - item.size | int > 15000000000000
    - item.type == 'disk'
  loop_control:
    label: "{{ item.name }} ({{ item.size }})"

- name: Fail if target disk not found
  fail:
    msg: "Could not find a disk larger than 15TB. Check connection."
  when: target_disk is not defined

- name: Unmount existing partitions on target disk
  mount:
    path: "{{ item }}"
    state: unmounted
  loop:
    - "{{ usb_timemachine_mount }}"
    - "{{ usb_space_mount }}"
  ignore_errors: true

- name: Check mounted partitions on target disk
  shell: "mount | grep {{ target_disk }} | awk '{print $3}'"
  register: mounted_parts
  changed_when: false

- name: Unmount any other mounts on target disk
  mount:
    path: "{{ item }}"
    state: unmounted
  loop: "{{ mounted_parts.stdout_lines }}"
  when: mounted_parts.stdout_lines | length > 0

# Note: parted module behavior: To create a new label (table), use 'device' and 'label'. 'number' is NOT required for creating the table itself, 
# but apparently Ansible 2.9+ or some versions complain if state=present without number? No, state=present implies creating a partition usually.
# To create a TABLE, we just need label: gpt. But maybe the module checks for existing partitions and gets confused?
# Actually, to wipe the disk and create a new label, we should probably verify if we need to.
# But to force a new label:
- name: Create partition table (GPT)
  command: parted -s {{ target_disk }} mklabel gpt
  # using raw command because the parted module can be finicky about creating just the label without a partition
  
- name: Create Time partition (8TB)
  parted:
    device: "{{ target_disk }}"
    number: 1
    label: gpt
    part_end: "8TB"
    state: present
    name: time

- name: Create Space partition (Remaining ~12TB)
  parted:
    device: "{{ target_disk }}"
    number: 2
    label: gpt
    part_start: "8TB"
    state: present
    name: space

- name: Format Time partition (ext4)
  filesystem:
    fstype: ext4
    dev: "{{ target_disk }}1"
    force: yes
    opts: "-L time"

- name: Format Space partition (ext4)
  filesystem:
    fstype: ext4
    dev: "{{ target_disk }}2"
    force: yes
    opts: "-L space"

- name: Create mount points
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  loop:
    - "{{ usb_timemachine_mount }}"
    - "{{ usb_space_mount }}"

- name: Mount Time
  mount:
    path: "{{ usb_timemachine_mount }}"
    src: "{{ target_disk }}1"
    fstype: ext4
    opts: "{{ usb_timemachine_fstab_options }}"
    state: mounted

- name: Mount Space
  mount:
    path: "{{ usb_space_mount }}"
    src: "{{ target_disk }}2"
    fstype: ext4
    opts: "defaults"
    state: mounted

- name: Set ownership for Space
  file:
    path: "{{ usb_space_mount }}"
    owner: "{{ ansible_user | default('mdt') }}"
    group: "{{ ansible_user | default('mdt') }}"
    mode: "0755"
    recurse: no

- name: Create Space directories
  file:
    path: "{{ usb_space_mount }}/{{ item }}"
    state: directory
    owner: "{{ ansible_user | default('mdt') }}"
    group: "{{ ansible_user | default('mdt') }}"
    mode: "0755"
  loop:
    - cache
    - files
    - temp

- name: Configure Samba
  template:
    src: smb.conf.j2
    dest: /etc/samba/smb.conf
    mode: "0644"
  notify: Restart Samba

- name: Ensure Samba is running
  service:
    name: smbd
    state: started
    enabled: yes

- name: Set Samba password for user
  # Requires ansible_password to be set in vault or host_vars
  # SECURITY: No default password - fails if not provided
  shell: "(echo '{{ ansible_password }}'; echo '{{ ansible_password }}') | smbpasswd -s -a {{ ansible_user | default('mdt') }}"
  register: smbpasswd_result
  changed_when: "'Added user' in smbpasswd_result.stdout"
  when: ansible_password is defined and ansible_password != ''
