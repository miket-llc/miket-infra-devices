# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# =============================================================================
# AUTOFS-BASED LINUX MOUNTS
# =============================================================================
#
# This role configures autofs for on-demand CIFS mounts. Unlike static fstab
# mounts, autofs:
#   - Only mounts when accessed
#   - Automatically unmounts after idle timeout
#   - Won't hang the system if the server is unreachable
#   - Avoids CIFS kernel bugs that can crash the desktop
#
# USE THIS ROLE FOR:
#   - Linux workstations that need occasional file access
#   - Any Linux client that should NOT freeze if motoko is down
#
# DO NOT USE FOR:
#   - Resilience nodes (they should have zero mount dependencies)
#   - Servers (motoko uses bind mounts, not CIFS)
#
# =============================================================================

- name: Install autofs and cifs-utils
  ansible.builtin.package:
    name:
      - autofs
      - cifs-utils
    state: present

- name: Create SMB credentials file
  ansible.builtin.copy:
    content: |
      username={{ smb_username }}
      password={{ smb_password }}
    dest: "{{ smb_credentials_file }}"
    owner: root
    group: root
    mode: '0600'
  no_log: true
  when: smb_password is defined

- name: Ensure base mount point exists
  ansible.builtin.file:
    path: "{{ autofs_mount_base }}"
    state: directory
    mode: '0755'

- name: Configure autofs master map
  ansible.builtin.lineinfile:
    path: /etc/auto.master
    line: "{{ autofs_mount_base }} /etc/auto.motoko --timeout={{ autofs_timeout }}"
    regexp: "^{{ autofs_mount_base | regex_escape }}"
    state: present
  notify: Restart autofs

- name: Create autofs map for motoko shares
  ansible.builtin.copy:
    content: |
      # Autofs map for motoko CIFS shares
      # Auto-generated by Ansible - do not edit manually
      #
      # Shares are mounted on-demand when accessed, unmounted after {{ autofs_timeout }}s idle
      # This avoids CIFS kernel bugs that can crash the desktop on network hiccups
      #
      {% for share in smb_shares %}
      {{ share.name }} -fstype=cifs,credentials={{ smb_credentials_file }},uid={{ ansible_user_uid | default(1000) }},gid={{ ansible_user_gid | default(1000) }},iocharset=utf8,vers=3.0,soft,timeo=30 ://{{ smb_server }}{{ share.path }}
      {% endfor %}
    dest: /etc/auto.motoko
    owner: root
    group: root
    mode: '0644'
  notify: Restart autofs

- name: Create user symlinks to autofs mount points
  ansible.builtin.file:
    src: "{{ autofs_mount_base }}/{{ item.name }}"
    dest: "{{ item.link }}"
    state: link
    force: yes
  loop: "{{ user_symlinks }}"
  become: false

- name: Enable and start autofs
  ansible.builtin.systemd:
    name: autofs
    state: started
    enabled: true
    daemon_reload: true

- name: Display autofs configuration summary
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════════
      AUTOFS CONFIGURED FOR CIFS MOUNTS
      ═══════════════════════════════════════════════════════════════
      
      Mount base: {{ autofs_mount_base }}
      Idle timeout: {{ autofs_timeout }} seconds
      
      Shares configured:
      {% for share in smb_shares %}
        - {{ autofs_mount_base }}/{{ share.name }} → //{{ smb_server }}{{ share.path }}
      {% endfor %}
      
      User symlinks:
      {% for link in user_symlinks %}
        - {{ link.link }} → {{ autofs_mount_base }}/{{ link.name }}
      {% endfor %}
      
      Benefits over static fstab mounts:
        ✓ Mounts only when accessed
        ✓ Unmounts automatically after idle
        ✓ Won't freeze desktop if server unreachable
        ✓ Avoids CIFS kernel bugs (cfids_invalidation_worker)
      
      ═══════════════════════════════════════════════════════════════

