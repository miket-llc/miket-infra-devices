---
- name: Ensure Scripts directory exists
  file:
    path: "{{ ansible_env.HOME }}/.scripts"
    state: directory
    mode: '0755'

- name: Check for Azure CLI
  command: which az
  register: az_check
  ignore_errors: yes
  changed_when: false

- name: Install Azure CLI via Homebrew (if missing)
  community.general.homebrew:
    name: azure-cli
    state: present
  when: az_check.rc != 0

- name: Deploy mount script
  template:
    src: mount_shares.sh.j2
    dest: "{{ ansible_env.HOME }}/.scripts/mount_shares.sh"
    mode: '0700'

- name: Deploy LaunchAgent for persistence
  template:
    src: com.miket.mountshares.plist.j2
    dest: "{{ ansible_env.HOME }}/Library/LaunchAgents/com.miket.mountshares.plist"
    mode: '0644'

- name: Unload existing LaunchAgent
  command: launchctl unload -w "{{ ansible_env.HOME }}/Library/LaunchAgents/com.miket.mountshares.plist"
  ignore_errors: yes
  changed_when: false

- name: Load LaunchAgent
  command: launchctl load -w "{{ ansible_env.HOME }}/Library/LaunchAgents/com.miket.mountshares.plist"
  
- name: Run mount script immediately
  command: "{{ ansible_env.HOME }}/.scripts/mount_shares.sh"
  ignore_errors: yes
