#!/bin/bash
# Auto-generated by Ansible
# Mounts Samba shares from Motoko using Azure Key Vault for credentials

# Log function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

log "Starting mount script..."

# Ensure Azure CLI is available
if ! command -v az &> /dev/null; then
    log "ERROR: Azure CLI (az) is not installed or not in PATH."
    exit 1
fi

# Wait for network (simple check)
count=0
while ! ping -c 1 {{ smb_server }} &> /dev/null; do
    sleep 5
    ((count++))
    if [ $count -gt 12 ]; then 
        log "Timeout waiting for network connectivity to {{ smb_server }}."
        exit 0 # Exit gracefully, maybe we are offline
    fi
done

log "Network is up. Fetching credentials from Azure Key Vault '{{ akv_vault_name }}'..."

# Fetch password from Azure Key Vault
# Note: Requires active 'az login' session or Service Principal environment variables
SMB_PASSWORD=$(az keyvault secret show --vault-name "{{ akv_vault_name }}" --name "{{ akv_secret_name }}" --query value -o tsv 2>/dev/null)

if [ -z "$SMB_PASSWORD" ]; then
    log "ERROR: Failed to retrieve secret '{{ akv_secret_name }}' from Key Vault. Check 'az login' status."
    exit 1
fi

{% for share in smb_shares %}
# Mount {{ share.name }}
mkdir -p "{{ share.mount_point }}"
if ! mount | grep -q "{{ share.mount_point }}"; then
    log "Mounting {{ share.name }} to {{ share.mount_point }}..."
    # URL encode the password effectively by passing it in the connection string format
    # mount_smbfs takes the password via the URL: //user:password@server/share
    
    # Safety: We avoid printing the password in logs.
    mount_smbfs "//{{ ansible_user }}:${SMB_PASSWORD}@{{ smb_server }}{{ share.path }}" "{{ share.mount_point }}"
    
    if [ $? -eq 0 ]; then
        log "Successfully mounted {{ share.name }}."
    else
        log "Failed to mount {{ share.name }}."
    fi
else
    log "{{ share.name }} is already mounted."
fi
{% endfor %}
