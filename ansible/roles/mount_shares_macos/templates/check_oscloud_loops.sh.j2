#!/bin/bash
# Auto-generated by Ansible
# Verifies that OS cloud services don't sync /mkt or user symlinks
# Guards against infinite loops in sync/backup

# Log function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a ~/.scripts/oscloud_loop_check.log
}

log "Checking OS cloud configuration for loop prevention..."

# Check iCloud Drive settings
ICLOUD_DRIVE="${HOME}/Library/Mobile Documents/com~apple~CloudDocs"
if [ -d "$ICLOUD_DRIVE" ]; then
    log "iCloud Drive found at: $ICLOUD_DRIVE"
    
    # Check if symlinks exist in iCloud paths
    if [ -L "${HOME}/Documents" ] && [[ "$(readlink "${HOME}/Documents")" == /mkt/* ]]; then
        log "WARNING: Documents folder is symlinked to /mkt. iCloud may try to sync this!"
    fi
    
    if [ -L "${HOME}/Desktop" ] && [[ "$(readlink "${HOME}/Desktop")" == /mkt/* ]]; then
        log "WARNING: Desktop folder is symlinked to /mkt. iCloud may try to sync this!"
    fi
    
    # Check if /mkt or symlinks are inside iCloud
    for link in flux space time; do
        if [ -e "${ICLOUD_DRIVE}/${link}" ] || [ -L "${ICLOUD_DRIVE}/${link}" ]; then
            log "ERROR: Found ${link} in iCloud Drive! This will cause sync loops. Remove it."
        fi
    done
else
    log "iCloud Drive not found or not enabled."
fi

# Check OneDrive settings (multiple possible locations)
ONEDRIVE_PERSONAL="${HOME}/OneDrive"
ONEDRIVE_BUSINESS=$(find "${HOME}/Library/CloudStorage" -maxdepth 1 -name "OneDrive-*" 2>/dev/null | head -n 1)

for ONEDRIVE_PATH in "$ONEDRIVE_PERSONAL" "$ONEDRIVE_BUSINESS"; do
    if [ -d "$ONEDRIVE_PATH" ]; then
        log "OneDrive found at: $ONEDRIVE_PATH"
        
        # Check if symlinks exist inside OneDrive
        for link in flux space time; do
            if [ -e "${ONEDRIVE_PATH}/${link}" ] || [ -L "${ONEDRIVE_PATH}/${link}" ]; then
                log "ERROR: Found ${link} in OneDrive! This will cause sync loops. Remove it."
            fi
        done
    fi
done

# Verify that our symlinks point outside of cloud roots
for link in flux space time; do
    LINK_PATH="${HOME}/${link}"
    if [ -L "$LINK_PATH" ]; then
        TARGET=$(readlink "$LINK_PATH")
        
        # Verify target doesn't point to cloud storage
        if [[ "$TARGET" == *"CloudDocs"* ]] || [[ "$TARGET" == *"OneDrive"* ]]; then
            log "ERROR: Symlink ${link} points to cloud storage: $TARGET"
        else
            log "OK: Symlink ${link} correctly points to: $TARGET"
        fi
    fi
done

log "OS cloud loop check completed."
log ""
log "IMPORTANT: Ensure iCloud Desktop/Documents sync does NOT include:"
log "  - ~/.mkt directory"
log "  - ~/flux, ~/space, ~/time symlinks"
log ""
log "Configure this in System Settings > Apple ID > iCloud > iCloud Drive > Options"

