#!/bin/bash
# Auto-generated by Ansible
# Creates user-level symlinks to system-level /mkt/* mounts
# Idempotent and resilient to temporarily missing mounts

# Log function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a ~/.scripts/create_user_symlinks.log
}

log "Creating user symlinks for: $USER..."

{% for symlink in user_symlinks %}
# Create symlink: {{ symlink.link }} -> {{ symlink.target }}
LINK_PATH="${HOME}/{{ symlink.name }}"
TARGET_PATH="{{ symlink.target | replace('~', '$HOME') }}"

# Remove if it's a broken symlink
if [ -L "$LINK_PATH" ] && [ ! -e "$LINK_PATH" ]; then
    log "Removing broken symlink: $LINK_PATH"
    rm -f "$LINK_PATH"
fi

# Create symlink if it doesn't exist
if [ ! -e "$LINK_PATH" ]; then
    # Only create if target exists (mount is up) OR if creating anyway
    if [ -d "$TARGET_PATH" ]; then
        ln -s "$TARGET_PATH" "$LINK_PATH"
        if [ $? -eq 0 ]; then
            log "Created symlink: $LINK_PATH -> $TARGET_PATH"
        else
            log "ERROR: Failed to create symlink: $LINK_PATH"
        fi
    else
        log "WARN: Target $TARGET_PATH not available yet. Will retry on next run."
    fi
elif [ -L "$LINK_PATH" ]; then
    # Already a symlink, verify it points to the right place
    CURRENT_TARGET=$(readlink "$LINK_PATH")
    if [ "$CURRENT_TARGET" != "$TARGET_PATH" ]; then
        log "Updating symlink $LINK_PATH: $CURRENT_TARGET -> $TARGET_PATH"
        rm -f "$LINK_PATH"
        ln -s "$TARGET_PATH" "$LINK_PATH"
    else
        log "Symlink $LINK_PATH already correct."
    fi
elif [ -d "$LINK_PATH" ] || [ -f "$LINK_PATH" ]; then
    log "ERROR: $LINK_PATH exists but is not a symlink. Manual intervention required."
fi
{% endfor %}

log "User symlink creation completed."

