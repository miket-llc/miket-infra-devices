# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# Main entry point for Data Lifecycle role

- name: Setup Credentials
  include_tasks: credentials.yml

# =============================================================================
# Tool Installation
# =============================================================================

- name: Install restic for encrypted backups
  ansible.builtin.package:
    name: restic
    state: present
  when: data_lifecycle_install_restic | default(true) | bool

- name: Install rclone for cloud sync
  ansible.builtin.package:
    name: rclone
    state: present
  when: data_lifecycle_install_rclone | default(true) | bool

# =============================================================================
# Directory Structure
# =============================================================================

- name: Ensure Flux directory structure exists
  file:
    path: "{{ item }}"
    state: directory
    owner: mdt
    group: mdt
    mode: '0755'
  loop:
    - /flux/active
    - /flux/scratch
    - /flux/models
    - /flux/.policy

- name: Ensure Space directory structure exists
  file:
    path: "{{ item }}"
    state: directory
    owner: mdt
    group: mdt
    mode: '0755'
  loop:
    - /space/projects
    - /space/media
    - /space/datasets
    - /space/archives
    - "{{ data_lifecycle_restic_local_repo | default('/space/snapshots/flux-local') }}"

- name: Ensure data estate markers directory exists
  ansible.builtin.file:
    path: "{{ data_lifecycle_markers_dir | default('/space/_ops/data-estate/markers') }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Ensure data lifecycle logs directory exists
  ansible.builtin.file:
    path: "{{ data_lifecycle_logs_dir | default('/space/_ops/logs/data-lifecycle') }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Check if local Restic password file exists
  stat:
    path: /root/.restic-local-pass
  register: restic_pass_file
  changed_when: false

- name: Generate local Restic password file if missing
  command: openssl rand -base64 32
  register: restic_local_password
  changed_when: false
  when: not restic_pass_file.stat.exists

- name: Create local Restic password file
  copy:
    content: "{{ restic_local_password.stdout }}"
    dest: /root/.restic-local-pass
    mode: '0600'
    owner: root
    group: root
  when: restic_pass_file.stat.exists == false and restic_local_password is defined and restic_local_password.stdout is defined

- name: Check if backup exclude file exists
  ansible.builtin.stat:
    path: /flux/.backup-exclude
  register: backup_exclude_file

- name: Create backup exclude file if missing
  ansible.builtin.file:
    path: /flux/.backup-exclude
    state: touch
    owner: mdt
    group: mdt
    mode: '0644'
  when: not backup_exclude_file.stat.exists

- name: Deploy Lifecycle Scripts
  copy:
    src: "{{ item.name }}"
    dest: "/usr/local/bin/{{ item.name }}"
    mode: '0755'
    owner: root
    group: root
  loop:
    - { name: flux-graduate.sh, when: "{{ data_lifecycle_enable_flux_graduate | bool }}" }
    - { name: space-mirror.sh,   when: "{{ data_lifecycle_enable_space_mirror | bool }}" }
    - { name: flux-backup.sh,    when: "{{ data_lifecycle_enable_flux_backup | bool }}" }
    - { name: flux-local-snap.sh, when: "{{ data_lifecycle_enable_flux_local | bool }}" }
    - { name: backblaze-trigger.sh, when: "true" }
    - { name: failure-notify.sh, when: "true" }
  when: item.when | default(false) | bool

- name: Deploy Flux Graduation Service
  template:
    src: flux-graduate.service.j2
    dest: /etc/systemd/system/flux-graduate.service
    mode: '0644'
  notify: Reload Systemd
  when: data_lifecycle_enable_flux_graduate | bool

- name: Deploy Flux Graduation Timer
  template:
    src: flux-graduate.timer.j2
    dest: /etc/systemd/system/flux-graduate.timer
    mode: '0644'
  notify: Reload Systemd
  when: data_lifecycle_enable_flux_graduate | bool

- name: Deploy Space Mirror Service
  template:
    src: space-mirror.service.j2
    dest: /etc/systemd/system/space-mirror.service
    mode: '0644'
  notify: Reload Systemd
  when: data_lifecycle_enable_space_mirror | bool

- name: Deploy Space Mirror Timer
  template:
    src: space-mirror.timer.j2
    dest: /etc/systemd/system/space-mirror.timer
    mode: '0644'
  notify: Reload Systemd
  when: data_lifecycle_enable_space_mirror | bool

- name: Deploy Flux Backup Service
  template:
    src: flux-backup.service.j2
    dest: /etc/systemd/system/flux-backup.service
    mode: '0644'
  notify: Reload Systemd
  when: data_lifecycle_enable_flux_backup | bool

- name: Deploy Flux Backup Timer
  template:
    src: flux-backup.timer.j2
    dest: /etc/systemd/system/flux-backup.timer
    mode: '0644'
  notify: Reload Systemd
  when: data_lifecycle_enable_flux_backup | bool

- name: Deploy Flux Local Snapshot Service
  template:
    src: flux-local.service.j2
    dest: /etc/systemd/system/flux-local.service
    mode: '0644'
  notify: Reload Systemd
  when: data_lifecycle_enable_flux_local | bool

- name: Deploy Flux Local Snapshot Timer
  template:
    src: flux-local.timer.j2
    dest: /etc/systemd/system/flux-local.timer
    mode: '0644'
  notify: Reload Systemd
  when: data_lifecycle_enable_flux_local | bool

# =============================================================================
# Failure Notification Service
# =============================================================================

- name: Deploy failure-notify template service
  ansible.builtin.template:
    src: failure-notify@.service.j2
    dest: /etc/systemd/system/failure-notify@.service
    mode: '0644'
  notify: Reload Systemd

# =============================================================================
# Enable Timers
# =============================================================================

- name: Enable and Start Timers
  systemd:
    name: "{{ item }}"
    state: started
    enabled: yes
    daemon_reload: yes
  loop:
    - flux-graduate.timer
    - space-mirror.timer
    - flux-backup.timer
    - flux-local.timer
  when:
    - (item == 'flux-graduate.timer' and data_lifecycle_enable_flux_graduate | bool) or
      (item == 'space-mirror.timer' and data_lifecycle_enable_space_mirror | bool) or
      (item == 'flux-backup.timer' and data_lifecycle_enable_flux_backup | bool) or
      (item == 'flux-local.timer' and data_lifecycle_enable_flux_local | bool)
