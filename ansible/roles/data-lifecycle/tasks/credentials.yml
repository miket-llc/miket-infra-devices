---
- name: Ensure miket config directory exists
  ansible.builtin.file:
    path: "{{ data_lifecycle_env_file | dirname }}"
    state: directory
    mode: '0700'
    owner: root
    group: root

- name: Check for storage credentials env file
  ansible.builtin.stat:
    path: "{{ data_lifecycle_env_file }}"
  register: storage_env_stat
  changed_when: false

- name: Enforce permissions on storage credentials env file
  ansible.builtin.file:
    path: "{{ data_lifecycle_env_file }}"
    owner: "{{ data_lifecycle_env_owner }}"
    group: "{{ data_lifecycle_env_group }}"
    mode: "{{ data_lifecycle_env_mode }}"
  when: storage_env_stat.stat.exists

- name: Fail when storage credentials env file is missing
  ansible.builtin.fail:
    msg: "{{ data_lifecycle_env_file }} is missing. Run ansible/playbooks/secrets-sync.yml to pull secrets from Azure Key Vault."
  when: not storage_env_stat.stat.exists
