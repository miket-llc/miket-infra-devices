---
- name: Ensure miket config directory exists
  file:
    path: /etc/miket
    state: directory
    mode: '0700'
    owner: root
    group: root

- name: Install jq for secret processing
  apt:
    name: jq
    state: present

- name: Fetch B2 secrets from Azure Key Vault (Space Mirror)
  command: >
    az keyvault secret show 
    --vault-name "kv-miket-ops" 
    --name "{{ item }}" 
    --query value -o tsv
  register: b2_mirror_secrets
  loop:
    - "b2-space-mirror-id"
    - "b2-space-mirror-key"
  no_log: true
  changed_when: false

- name: Fetch B2 secrets from Azure Key Vault (Restic Backup)
  command: >
    az keyvault secret show 
    --vault-name "kv-miket-ops" 
    --name "{{ item }}" 
    --query value -o tsv
  register: b2_restic_secrets
  loop:
    - "b2-restic-id"
    - "b2-restic-key"
    - "restic-password"
  no_log: true
  changed_when: false

- name: Populate storage credentials environment file
  template:
    src: storage-credentials.env.j2
    dest: /etc/miket/storage-credentials.env
    mode: '0600'
    owner: root
    group: root

