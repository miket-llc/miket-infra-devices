# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# Linux workstation GUI tools installation
# Supports Fedora/RHEL and Debian/Ubuntu

# ========================================
# VS Code Installation
# ========================================
- name: VS Code installation block
  when: vscode_enabled | bool
  block:
    # Fedora/RHEL
    - name: Add Microsoft VS Code repository (Fedora/RHEL)
      ansible.builtin.yum_repository:
        name: vscode
        description: Visual Studio Code
        baseurl: https://packages.microsoft.com/yumrepos/vscode
        gpgkey: https://packages.microsoft.com/keys/microsoft.asc
        gpgcheck: yes
        enabled: yes
      when: ansible_os_family == 'RedHat'
      tags: [workstation_gui, vscode]

    - name: Install VS Code (Fedora/RHEL)
      ansible.builtin.dnf:
        name: code
        state: present
      when: ansible_os_family == 'RedHat'
      tags: [workstation_gui, vscode]

    # Debian/Ubuntu
    - name: Add Microsoft GPG key (Debian/Ubuntu)
      ansible.builtin.apt_key:
        url: https://packages.microsoft.com/keys/microsoft.asc
        keyring: /usr/share/keyrings/packages.microsoft.gpg
        state: present
      when: ansible_os_family == 'Debian'
      tags: [workstation_gui, vscode]

    - name: Add VS Code repository (Debian/Ubuntu)
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main"
        filename: vscode
        state: present
      when: ansible_os_family == 'Debian'
      tags: [workstation_gui, vscode]

    - name: Install VS Code (Debian/Ubuntu)
      ansible.builtin.apt:
        name: code
        state: present
        update_cache: yes
      when: ansible_os_family == 'Debian'
      tags: [workstation_gui, vscode]

# ========================================
# Cursor Installation
# ========================================
- name: Cursor installation block
  when: cursor_enabled | bool
  block:
    # Fedora/RHEL - Use RPM package (preferred)
    - name: Get Cursor download info from API (Fedora/RHEL)
      ansible.builtin.uri:
        url: "{{ cursor_linux_api_url }}"
        return_content: yes
      register: cursor_api_response
      when: ansible_os_family == 'RedHat'
      tags: [workstation_gui, cursor]

    - name: Parse Cursor RPM URL
      ansible.builtin.set_fact:
        cursor_rpm_url: "{{ (cursor_api_response.content | from_json).rpmUrl }}"
      when:
        - ansible_os_family == 'RedHat'
        - cursor_api_response is succeeded
      tags: [workstation_gui, cursor]

    - name: Check if Cursor is already installed (Fedora/RHEL)
      ansible.builtin.shell: rpm -q cursor
      register: cursor_rpm_check
      changed_when: false
      failed_when: false
      when: ansible_os_family == 'RedHat'
      tags: [workstation_gui, cursor]

    - name: Install Cursor RPM (Fedora/RHEL)
      ansible.builtin.dnf:
        name: "{{ cursor_rpm_url }}"
        state: present
        disable_gpg_check: yes
      when:
        - ansible_os_family == 'RedHat'
        - cursor_rpm_check.rc != 0
        - cursor_rpm_url is defined
      tags: [workstation_gui, cursor]

    # Debian/Ubuntu - Use AppImage
    - name: Create Cursor installation directory (Debian/Ubuntu)
      ansible.builtin.file:
        path: "{{ cursor_linux_install_dir }}"
        state: directory
        mode: '0755'
      when: ansible_os_family == 'Debian'
      tags: [workstation_gui, cursor]

    - name: Get Cursor download info from API (Debian/Ubuntu)
      ansible.builtin.uri:
        url: "{{ cursor_linux_api_url }}"
        return_content: yes
      register: cursor_api_response_deb
      when: ansible_os_family == 'Debian'
      tags: [workstation_gui, cursor]

    - name: Parse Cursor AppImage URL
      ansible.builtin.set_fact:
        cursor_appimage_url: "{{ (cursor_api_response_deb.content | from_json).downloadUrl }}"
      when:
        - ansible_os_family == 'Debian'
        - cursor_api_response_deb is succeeded
      tags: [workstation_gui, cursor]

    - name: Check if Cursor is already installed (Debian/Ubuntu)
      ansible.builtin.stat:
        path: "{{ cursor_linux_install_dir }}/cursor.AppImage"
      register: cursor_installed
      when: ansible_os_family == 'Debian'
      tags: [workstation_gui, cursor]

    - name: Download Cursor AppImage (Debian/Ubuntu)
      ansible.builtin.get_url:
        url: "{{ cursor_appimage_url | default(cursor_linux_appimage_url) }}"
        dest: "{{ cursor_linux_install_dir }}/cursor.AppImage"
        mode: '0755'
      when:
        - ansible_os_family == 'Debian'
        - not cursor_installed.stat.exists
      tags: [workstation_gui, cursor]

    - name: Create Cursor symlink in /usr/local/bin (Debian/Ubuntu)
      ansible.builtin.file:
        src: "{{ cursor_linux_install_dir }}/cursor.AppImage"
        dest: /usr/local/bin/cursor
        state: link
      when: ansible_os_family == 'Debian'
      tags: [workstation_gui, cursor]

    - name: Create Cursor desktop entry (Debian/Ubuntu)
      ansible.builtin.copy:
        dest: /usr/share/applications/cursor.desktop
        content: |
          [Desktop Entry]
          Name=Cursor
          Comment=AI-first code editor
          Exec={{ cursor_linux_install_dir }}/cursor.AppImage --no-sandbox %F
          Icon=cursor
          Type=Application
          Categories=Development;IDE;
          MimeType=text/plain;
          StartupNotify=true
          Terminal=false
        mode: '0644'
      when:
        - ansible_os_family == 'Debian'
        - workstation_create_desktop_entries | bool
      tags: [workstation_gui, cursor]

# ========================================
# Warp Terminal Installation
# ========================================
- name: Warp installation block
  when: warp_enabled | bool
  block:
    # Fedora/RHEL - Warp provides a DNF/YUM repo
    - name: Add Warp repository (Fedora/RHEL)
      ansible.builtin.yum_repository:
        name: warp
        description: Warp Terminal
        baseurl: https://releases.warp.dev/linux/rpm/stable
        gpgkey: https://releases.warp.dev/linux/keys/warp.asc
        gpgcheck: yes
        enabled: yes
      when: ansible_os_family == 'RedHat'
      tags: [workstation_gui, warp]

    - name: Install Warp (Fedora/RHEL)
      ansible.builtin.dnf:
        name: warp-terminal
        state: present
      when: ansible_os_family == 'RedHat'
      tags: [workstation_gui, warp]

    # Debian/Ubuntu
    - name: Add Warp GPG key (Debian/Ubuntu)
      ansible.builtin.apt_key:
        url: https://releases.warp.dev/linux/keys/warp.asc
        keyring: /usr/share/keyrings/warp.gpg
        state: present
      when: ansible_os_family == 'Debian'
      tags: [workstation_gui, warp]

    - name: Add Warp repository (Debian/Ubuntu)
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/warp.gpg] https://releases.warp.dev/linux/deb stable main"
        filename: warp
        state: present
      when: ansible_os_family == 'Debian'
      tags: [workstation_gui, warp]

    - name: Install Warp (Debian/Ubuntu)
      ansible.builtin.apt:
        name: warp-terminal
        state: present
        update_cache: yes
      when: ansible_os_family == 'Debian'
      tags: [workstation_gui, warp]

# ========================================
# Verification
# ========================================
- name: Verify VS Code installation
  ansible.builtin.command: code --version
  register: vscode_version
  changed_when: false
  failed_when: false
  when: vscode_enabled | bool
  tags: [workstation_gui, verify]

- name: Verify Cursor installation
  ansible.builtin.stat:
    path: "{{ cursor_linux_install_dir }}/cursor.AppImage"
  register: cursor_verify
  when: cursor_enabled | bool
  tags: [workstation_gui, verify]

- name: Display verification results
  ansible.builtin.debug:
    msg:
      - "VS Code: {{ vscode_version.stdout_lines[0] | default('not installed') if vscode_enabled else 'skipped' }}"
      - "Cursor: {{ 'installed' if (cursor_verify.stat.exists | default(false)) else 'not installed' if cursor_enabled else 'skipped' }}"
  tags: [workstation_gui, verify]

# ========================================
# Cool Retro Term Qt Theming Fix (Partial)
# ========================================
# Improves readability of Qt Quick settings menu on KDE dark themes.
# Uses Material Dark theme which makes ~80% of UI readable.
#
# Limitation: Some labels remain invisible due to hardcoded colors in the app's
# QML source. This is an upstream bug requiring app patches to fully fix.
#
# This wrapper ONLY affects cool-retro-term. Other Qt apps use KDE native theming.
# See: docs/runbooks/QT_THEMING_KDE.md
- name: Cool Retro Term Qt theming fix block
  when:
    - cool_retro_term_qt_fix_enabled | bool
    - desktop_environment | default('') == 'kde'
  block:
    # Ensure Qt Quick Controls 2 KDE style is available
    - name: Ensure qqc2-desktop-style is installed for Qt Quick theming
      ansible.builtin.dnf:
        name:
          - qqc2-desktop-style
          - plasma-integration
        state: present
      when: ansible_os_family == 'RedHat'
      tags: [workstation_gui, cool-retro-term, qt-theming]

    # Remove qt5ct/qt6ct - these conflict with KDE native theming
    # They override QT_QPA_PLATFORMTHEME=kde which breaks Plasma integration
    - name: Remove qt5ct/qt6ct to prevent KDE theming conflicts
      ansible.builtin.dnf:
        name:
          - qt5ct
          - qt6ct
        state: absent
      when: ansible_os_family == 'RedHat'
      tags: [workstation_gui, cool-retro-term, qt-theming]

    - name: Check if cool-retro-term is installed
      ansible.builtin.command: which cool-retro-term
      register: cool_retro_term_check
      changed_when: false
      failed_when: false
      tags: [workstation_gui, cool-retro-term]

    - name: Install cool-retro-term wrapper script
      ansible.builtin.copy:
        src: cool-retro-term-wrapper.sh
        dest: /usr/local/bin/cool-retro-term-wrapper
        mode: '0755'
        owner: root
        group: root
      when: cool_retro_term_check.rc == 0
      tags: [workstation_gui, cool-retro-term]

    # Deploy desktop entry to /usr/local/share/applications which takes precedence
    # over /usr/share/applications, allowing us to override without modifying
    # the package-provided file
    - name: Ensure local applications directory exists
      ansible.builtin.file:
        path: /usr/local/share/applications
        state: directory
        mode: '0755'
      tags: [workstation_gui, cool-retro-term]

    - name: Deploy cool-retro-term desktop entry with wrapper
      ansible.builtin.copy:
        dest: /usr/local/share/applications/cool-retro-term.desktop
        content: |
          [Desktop Entry]
          Name=Cool Retro Term
          Comment=Terminal emulator with retro CRT aesthetics
          Exec=/usr/local/bin/cool-retro-term-wrapper
          Icon=cool-retro-term
          Type=Application
          Categories=System;TerminalEmulator;
          Terminal=false
          StartupNotify=true
          # Managed by Ansible - workstation_gui_tools role
          # See: docs/runbooks/QT_THEMING_KDE.md
        mode: '0644'
      when: cool_retro_term_check.rc == 0
      tags: [workstation_gui, cool-retro-term]

# Validation task for Qt theming (optional, run with --tags validate)
- name: Validate Qt theming configuration
  when:
    - desktop_environment | default('') == 'kde'
    - "'validate' in ansible_run_tags"
  block:
    - name: Check qqc2-desktop-style is installed
      ansible.builtin.command: rpm -q qqc2-desktop-style
      register: qqc2_check
      changed_when: false
      failed_when: qqc2_check.rc != 0
      tags: [validate, qt-theming]

    - name: Check qt5ct is NOT installed
      ansible.builtin.command: rpm -q qt5ct
      register: qt5ct_check
      changed_when: false
      failed_when: qt5ct_check.rc == 0
      ignore_errors: true
      tags: [validate, qt-theming]

    - name: Check qt6ct is NOT installed
      ansible.builtin.command: rpm -q qt6ct
      register: qt6ct_check
      changed_when: false
      failed_when: qt6ct_check.rc == 0
      ignore_errors: true
      tags: [validate, qt-theming]





