# Copyright (c) 2025 MikeT LLC. All rights reserved.
#
# data-estate-status.service
# Data Estate Status Collector - systemd service unit
# Monitors backup freshness, B2 mirror gaps, M365 ingestion, and unknown cloud remotes
#
# Part of PHC Data Estate monitoring infrastructure
# Deployed by Ansible data_estate_status role

[Unit]
Description=Data Estate Status Collector (PHC monitoring)
Documentation=https://github.com/miket-llc/miket-infra/docs/architecture/components/DATA_ESTATE_SPEC.md
After=network-online.target
Wants=network-online.target
OnFailure=failure-notify@%n.service

[Service]
Type=oneshot

# Load B2/restic credentials from secrets_sync
EnvironmentFile=-{{ data_estate_credentials_file }}

# Run as root (needs access to rclone config, restic repos, journal)
User=root
Group=root

# Execute the collector script
ExecStart={{ data_estate_script_path }}

# Logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=data-estate-status

# Security hardening
PrivateTmp=true
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=read-only

# Allow write to output directories
ReadWritePaths={{ data_estate_json_output_dir }}
ReadWritePaths={{ data_estate_markdown_output_dir }}
ReadWritePaths={{ data_estate_markers_dir | default('/space/_ops/data-estate/markers') }}

# Allow read access to config, credentials, and markers
ReadOnlyPaths={{ data_estate_config_dir }}
ReadOnlyPaths=/etc/miket

# Timeout (generous for large B2 size queries)
TimeoutStartSec=600

[Install]
WantedBy=multi-user.target

