# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# Nextcloud Dashboard integration for data_estate_status role
# Sets up the Welcome widget to display data estate status

- name: Ensure dashboard directory exists with correct permissions
  ansible.builtin.file:
    path: "{{ data_estate_markdown_output_dir }}"
    state: directory
    owner: root
    group: "33"  # www-data UID for Nextcloud container access
    mode: '2775'
  become: true

- name: Deploy initial placeholder Markdown file
  ansible.builtin.copy:
    content: |
      # Data Estate Health Summary

      **Status:** Awaiting first collector run

      The data estate status collector has not yet populated this dashboard.

      **Expected Update Schedule:** Every 6 hours ({{ data_estate_timer_schedule }})

      ## What This Dashboard Shows

      When the collector runs, this page will display:

      - **Backup Freshness:** Age of restic snapshots (cloud and local)
      - **B2 Mirror Status:** Sync age and size gap for /space mirror
      - **Nextcloud DB:** Age of latest database dump
      - **M365 Ingestion:** Status of OneDrive sync
      - **Cloud Inventory:** Detection of unknown/unapproved cloud remotes

      ## Manual Trigger

      To run the collector immediately:

      ```bash
      sudo systemctl start data-estate-status.service
      ```

      ---

      *Generated by Ansible data_estate_status role*
    dest: "{{ data_estate_markdown_output_file }}"
    owner: root
    group: "33"
    mode: '0664'
    force: false  # Don't overwrite if file already exists
  become: true

- name: Check if Nextcloud container is running
  ansible.builtin.command: podman ps --filter name=nextcloud-app --format "{{ '{{' }}.Names{{ '}}' }}"
  register: nextcloud_container_check
  changed_when: false
  failed_when: false

- name: Set Nextcloud ready fact
  ansible.builtin.set_fact:
    nextcloud_is_ready: "{{ 'nextcloud-app' in (nextcloud_container_check.stdout | default('')) }}"

- name: Install Nextcloud Welcome app
  ansible.builtin.command: podman exec -u 33 nextcloud-app php occ app:install welcome
  register: welcome_install
  changed_when: "'installed' in welcome_install.stdout and 'already installed' not in welcome_install.stdout"
  failed_when: false
  when: nextcloud_is_ready

- name: Enable Nextcloud Welcome app
  ansible.builtin.command: podman exec -u 33 nextcloud-app php occ app:enable welcome
  register: welcome_enable
  changed_when: "'enabled' in welcome_enable.stdout and 'already enabled' not in welcome_enable.stdout"
  failed_when: false
  when: nextcloud_is_ready

- name: Check if dashboard external storage is configured
  ansible.builtin.command: >
    podman exec -u 33 nextcloud-app php occ files_external:list --output=json
  register: external_storage_list
  changed_when: false
  failed_when: false
  when: nextcloud_is_ready

- name: Parse existing external storage mounts
  ansible.builtin.set_fact:
    existing_external_mounts: "{{ (external_storage_list.stdout | default('[]') | from_json | default([])) | map(attribute='mount_point') | list }}"
  when: nextcloud_is_ready

- name: Configure dashboard external storage mount
  ansible.builtin.command: >
    podman exec -u 33 nextcloud-app php occ files_external:create
    "/Dashboard"
    local
    null::null
    --config datadir="/external/dashboard"
  register: create_dashboard_mount
  changed_when: "'Storage created' in create_dashboard_mount.stdout"
  failed_when: create_dashboard_mount.rc != 0 and 'already exists' not in create_dashboard_mount.stderr
  when:
    - nextcloud_is_ready
    - "'/Dashboard' not in existing_external_mounts | default([])"

- name: Report Nextcloud dashboard configuration
  ansible.builtin.debug:
    msg: |
      Nextcloud Dashboard Configuration:
      
      Status File: {{ data_estate_markdown_output_file }}
      
      {% if nextcloud_is_ready %}
      Nextcloud Container: Running
      Welcome App: {{ 'Installed/Enabled' if welcome_enable is defined and welcome_enable.rc == 0 else 'Check manually' }}
      
      MANUAL CONFIGURATION REQUIRED:
      1. Log into Nextcloud as admin
      2. Go to Dashboard (home page)
      3. Click "Customize" or gear icon
      4. Enable the "Welcome" widget
      5. The widget should display the data-estate-status.md file
      
      Alternative: Configure in Settings → Administration → Theming → Welcome widget
      {% else %}
      Nextcloud Container: Not running
      
      Run the Nextcloud deployment playbook first, then re-run this role.
      {% endif %}
      
      External Storage Mount:
      - Container path: /external/dashboard
      - Host path: {{ data_estate_markdown_output_dir }}
      - Nextcloud path: /Dashboard
      
      NOTE: The dashboard directory must be mounted in the Nextcloud container.
      Verify the compose/podman configuration includes:
        -v {{ data_estate_markdown_output_dir }}:/external/dashboard:ro

