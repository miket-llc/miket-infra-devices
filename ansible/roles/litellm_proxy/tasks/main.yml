# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# LiteLLM Proxy Deployment Tasks
# Idempotent tasks to deploy and manage LiteLLM proxy
# Supports both Docker (Debian) and Podman (Fedora)

- name: Display LiteLLM deployment info
  ansible.builtin.debug:
    msg:
      - "═══════════════════════════════════════════════════════════"
      - "LiteLLM PROXY DEPLOYMENT"
      - "═══════════════════════════════════════════════════════════"
      - ""
      - "Container Runtime: {{ litellm_container_runtime }}"
      - "Work Directory:    {{ litellm_workdir }}"
      - "Port:              {{ litellm_port }}"
      - ""
      - "═══════════════════════════════════════════════════════════"
  tags: [litellm]

# ========================================
# Directory Setup
# ========================================
- name: Ensure LiteLLM workdir exists
  ansible.builtin.file:
    path: "{{ litellm_workdir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags: [litellm, setup]

# ========================================
# Configuration
# ========================================
- name: Render LiteLLM config
  ansible.builtin.template:
    src: "litellm.config.yaml.j2"
    dest: "{{ litellm_config_path }}"
    owner: root
    group: root
    mode: "0644"
  notify: restart litellm
  tags: [litellm, config]

- name: Verify LiteLLM env file is present (generated by secrets_sync)
  ansible.builtin.stat:
    path: "{{ litellm_env_path }}"
  register: litellm_env_stat
  changed_when: false
  tags: [litellm, secrets]

- name: Warn if LiteLLM env file is missing
  ansible.builtin.debug:
    msg: |
      ⚠️  {{ litellm_env_path }} is missing.
      
      To generate secrets, run:
        ansible-playbook playbooks/secrets-sync.yml --limit {{ inventory_hostname }}
      
      Or create a minimal .env file with:
        LITELLM_TOKEN=your-secret-token
  when:
    - not litellm_env_stat.stat.exists
    - litellm_require_secrets | bool
  tags: [litellm, secrets]

- name: Create placeholder env file if missing (for testing)
  ansible.builtin.copy:
    dest: "{{ litellm_env_path }}"
    content: |
      # LiteLLM environment - placeholder
      # Replace with secrets from Azure Key Vault
      LITELLM_TOKEN=placeholder-token
    mode: "0600"
  when:
    - not litellm_env_stat.stat.exists
    - not (litellm_require_secrets | bool)
  tags: [litellm, secrets]

- name: Render compose file
  ansible.builtin.template:
    src: "docker-compose.yml.j2"
    dest: "{{ litellm_compose_path }}"
    owner: root
    group: root
    mode: "0644"
  notify: restart litellm
  tags: [litellm, config]

# ========================================
# Runtime Setup - Debian/Docker
# ========================================
- name: Check if Docker is installed (Debian)
  ansible.builtin.command: which docker
  register: docker_check
  changed_when: false
  failed_when: false
  when: ansible_os_family == "Debian"
  tags: [litellm, runtime]

- name: Install Docker + Compose plugin (Debian)
  ansible.builtin.apt:
    name:
      - docker.io
      - docker-compose-plugin
    state: present
    update_cache: yes
  when:
    - ansible_os_family == "Debian"
    - docker_check.rc != 0
  tags: [litellm, packages]

- name: Ensure Docker service is running (Debian)
  ansible.builtin.systemd:
    name: docker
    state: started
    enabled: true
  when: ansible_os_family == "Debian"
  tags: [litellm, runtime]

# ========================================
# Security
# ========================================
- name: Ensure LiteLLM env file permissions are restrictive
  ansible.builtin.file:
    path: "{{ litellm_env_path }}"
    owner: root
    group: root
    mode: "0600"
  when: litellm_env_stat.stat.exists
  tags: [litellm, security]

# ========================================
# Deploy Container
# ========================================
- name: Pull and start LiteLLM
  ansible.builtin.command: "{{ litellm_container_runtime }}-compose -f {{ litellm_compose_path }} up -d"
  args:
    chdir: "{{ litellm_workdir }}"
  register: compose_result
  changed_when: "'Creating' in compose_result.stdout or 'Starting' in compose_result.stdout or compose_result.rc == 0"
  tags: [litellm, deploy]

# ========================================
# Systemd Integration
# ========================================
- name: Create systemd unit
  ansible.builtin.template:
    src: "litellm.service.j2"
    dest: "/etc/systemd/system/{{ litellm_service_name }}.service"
    owner: root
    group: root
    mode: "0644"
  notify: reload systemd
  tags: [litellm, systemd]

- name: Enable LiteLLM service
  ansible.builtin.systemd:
    name: "{{ litellm_service_name }}"
    enabled: true
    daemon_reload: true
  tags: [litellm, systemd]

# ========================================
# Verification
# ========================================
- name: Wait for LiteLLM service to be ready
  ansible.builtin.wait_for:
    port: "{{ litellm_port }}"
    host: "127.0.0.1"
    delay: 5
    timeout: 60
  tags: [litellm, verify]

- name: Display LiteLLM deployment summary
  ansible.builtin.debug:
    msg:
      - "═══════════════════════════════════════════════════════════"
      - "LiteLLM DEPLOYMENT COMPLETE"
      - "═══════════════════════════════════════════════════════════"
      - ""
      - "Endpoint:    http://127.0.0.1:{{ litellm_port }}/v1"
      - "Models API:  http://127.0.0.1:{{ litellm_port }}/v1/models"
      - ""
      - "Management:"
      - "  {{ litellm_container_runtime }}-compose -f {{ litellm_compose_path }} logs -f"
      - "  systemctl status {{ litellm_service_name }}"
      - ""
      - "═══════════════════════════════════════════════════════════"
  tags: [litellm]
