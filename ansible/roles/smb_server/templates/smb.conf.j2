# Samba configuration for PHC Storage
# Managed by Ansible - DO NOT EDIT MANUALLY
# Generated: {{ ansible_date_time.iso8601 }}

[global]
	workgroup = {{ smb_workgroup }}
	security = user
	passdb backend = tdbsam

	# Logging
	log file = /var/log/samba/log.%m
	max log size = 50

	# Performance tuning
	socket options = TCP_NODELAY IPTOS_LOWDELAY
	read raw = yes
	write raw = yes
	oplocks = yes
	max xmit = 65536
	dead time = 15
	getwd cache = yes

	# macOS compatibility (fruit + streams_xattr)
	# Enables proper handling of macOS metadata, resource forks, and Finder info
	vfs objects = fruit streams_xattr
	fruit:metadata = stream
	fruit:model = MacSamba
	fruit:posix_rename = yes
	fruit:veto_appledouble = no
	fruit:nfs_aces = no
	fruit:wipe_intentionally_left_blank_rfork = yes
	fruit:delete_empty_adfiles = yes

# PHC Storage Shares (Flux/Space/Time)
{% for share in smb_shares %}

[{{ share.name }}]
	comment = {{ share.comment }}
	path = {{ share.path }}
	valid users = {{ smb_username }}
	browseable = yes
	writable = yes
	create mask = 0664
	directory mask = 0775
{% if share.name == 'time' %}
	# Time Machine-specific settings
	vfs objects = catia fruit streams_xattr
	fruit:time machine = yes
	fruit:time machine max size = 8T
	ea support = yes
	inherit acls = yes
	durable handles = yes
	kernel oplocks = no
	kernel share modes = no
	posix locking = no
{% endif %}
{% endfor %}

