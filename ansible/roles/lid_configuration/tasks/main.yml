# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# Lid Configuration Role
# Configures system to operate safely with lid closed (headless laptop operation)
# Supports Fedora and other systemd-based Linux distributions

- name: Check if running on supported Linux
  ansible.builtin.assert:
    that:
      - ansible_distribution in ['Ubuntu', 'Fedora', 'Rocky', 'AlmaLinux', 'CentOS']
    fail_msg: "This role is designed for Fedora/RHEL/Ubuntu systems"
    quiet: true

- name: Configure systemd-logind for lid-closed operation
  ansible.builtin.lineinfile:
    path: /etc/systemd/logind.conf
    regexp: "^{{ item.key }}="
    line: "{{ item.key }}={{ item.value }}"
    backup: yes
  loop:
    - { key: "HandleLidSwitch", value: "ignore" }
    - { key: "HandleLidSwitchExternalPower", value: "ignore" }
    - { key: "HandleLidSwitchDocked", value: "ignore" }
  notify: restart systemd-logind

- name: Add kernel parameter via GRUB (Fedora/RHEL)
  ansible.builtin.lineinfile:
    path: /etc/default/grub
    regexp: '^GRUB_CMDLINE_LINUX_DEFAULT='
    line: "GRUB_CMDLINE_LINUX_DEFAULT=\"{{ ansible_facts['grub_cmdline_linux_default'] | default('') }} button.lid_init_state=open\""
    backup: yes
  when: ansible_distribution in ['Fedora', 'Rocky', 'AlmaLinux', 'CentOS']
  notify: update grub

- name: Create GDM service override directory
  ansible.builtin.file:
    path: /etc/systemd/system/gdm.service.d
    state: directory
    mode: '0755'

- name: Configure GDM service override for lid-closed operation
  ansible.builtin.copy:
    dest: /etc/systemd/system/gdm.service.d/override.conf
    content: |
      [Unit]
      # Force GDM to start even with lid closed
      ConditionPathExists=
      ConditionPathExists=/usr/sbin/gdm

      [Service]
      # Restart if it fails
      Restart=always
      RestartSec=5
    mode: '0644'
  notify: reload systemd daemon

- name: Create force-gdm-start service
  ansible.builtin.copy:
    dest: /etc/systemd/system/force-gdm-start.service
    content: |
      [Unit]
      Description=Force GDM to start
      After=multi-user.target
      Wants=multi-user.target

      [Service]
      Type=oneshot
      ExecStart=/bin/systemctl start gdm
      RemainAfterExit=yes

      [Install]
      WantedBy=multi-user.target
    mode: '0644'
  notify: reload systemd daemon

- name: Enable force-gdm-start service
  ansible.builtin.systemd:
    name: force-gdm-start.service
    enabled: true
    daemon_reload: true

- name: Configure GDM autologin (if enabled)
  ansible.builtin.lineinfile:
    path: /etc/gdm/custom.conf
    regexp: "^{{ item.key }}="
    line: "{{ item.key }}={{ item.value }}"
    backup: yes
  loop:
    - { key: "WaylandEnable", value: "false" }
    - { key: "AutomaticLoginEnable", value: "true" }
    - { key: "AutomaticLogin", value: "{{ lid_autologin_user | default('mdt') }}" }
  when: lid_autologin_enabled | default(false)
  notify: restart gdm

- name: Display configuration summary
  ansible.builtin.debug:
    msg:
      - "✓ Lid switch configuration complete"
      - "  - HandleLidSwitch=ignore"
      - "  - HandleLidSwitchExternalPower=ignore"
      - "  - HandleLidSwitchDocked=ignore"
      - "✓ Kernel parameter: button.lid_init_state=open"
      - "✓ GDM service override configured"
      - "✓ Force-GDM-start service enabled"
      - ""
      - "System will operate normally with lid closed"
      - "Reboot required for kernel parameter to take effect"

