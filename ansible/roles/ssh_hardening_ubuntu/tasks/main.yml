---
# Copyright (c) 2025 MikeT LLC. All rights reserved.

# =============================================================================
# SSH Hardening Role (Ubuntu)
# =============================================================================
# Hardens SSH configuration:
#   - Key-only authentication
#   - No root login
#   - No password authentication
# =============================================================================

- name: Ensure OpenSSH server is installed
  ansible.builtin.apt:
    name: openssh-server
    state: present
  tags: [ssh, install]

- name: Configure SSH daemon
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
    validate: /usr/sbin/sshd -t -f %s
  loop:
    - { regexp: '^Port', line: 'Port {{ ssh_port }}' }
    - { regexp: '^PermitRootLogin', line: 'PermitRootLogin {{ ssh_permit_root_login }}' }
    - { regexp: '^PubkeyAuthentication', line: 'PubkeyAuthentication {{ ssh_pubkey_authentication }}' }
    - { regexp: '^PasswordAuthentication', line: 'PasswordAuthentication {{ ssh_password_authentication }}' }
    - { regexp: '^PermitEmptyPasswords', line: 'PermitEmptyPasswords {{ ssh_permit_empty_passwords }}' }
    - { regexp: '^ChallengeResponseAuthentication', line: 'ChallengeResponseAuthentication {{ ssh_challenge_response_authentication }}' }
    - { regexp: '^X11Forwarding', line: 'X11Forwarding {{ ssh_x11_forwarding }}' }
    - { regexp: '^ClientAliveInterval', line: 'ClientAliveInterval {{ ssh_client_alive_interval }}' }
    - { regexp: '^ClientAliveCountMax', line: 'ClientAliveCountMax {{ ssh_client_alive_count_max }}' }
  notify: restart ssh
  tags: [ssh, config]

- name: Ensure SSH service is enabled and running
  ansible.builtin.systemd:
    name: ssh
    enabled: true
    state: started
  tags: [ssh, service]

- name: Display SSH hardening summary
  ansible.builtin.debug:
    msg: |
      SSH hardening complete:
        - Port: {{ ssh_port }}
        - Root login: {{ ssh_permit_root_login }}
        - Password auth: {{ ssh_password_authentication }}
        - Pubkey auth: {{ ssh_pubkey_authentication }}
      
      SSH is restricted to Tailscale IPs via UFW (configured in firewall_ufw role).
  tags: [ssh]

