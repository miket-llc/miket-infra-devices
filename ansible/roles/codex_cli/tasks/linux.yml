# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# Linux Codex CLI installation
# Requires Node.js 18+ (installed via NodeSource repository)

- name: Check if Node.js is installed
  ansible.builtin.command: node --version
  register: node_check
  changed_when: false
  failed_when: false

- name: Check Node.js version
  ansible.builtin.set_fact:
    node_version_ok: "{{ node_check.stdout | regex_search('v(\\d+)') | int >= codex_node_version | int }}"
  when: node_check.rc == 0

- name: Add NodeSource repository
  ansible.builtin.shell: |
    curl -fsSL {{ codex_nodejs_repo }} | sudo -E bash -
  become: true
  when: node_check.rc != 0 or not (node_version_ok | default(false))
  register: nodesource_repo
  failed_when: nodesource_repo.rc != 0

- name: Install Node.js
  ansible.builtin.package:
    name: nodejs
    state: present
  become: true
  when: node_check.rc != 0 or not (node_version_ok | default(false))

- name: Verify Node.js installation
  ansible.builtin.command: node --version
  register: node_verify
  changed_when: false

- name: Verify npm installation
  ansible.builtin.command: npm --version
  register: npm_verify
  changed_when: false

- name: Check if Codex CLI is installed
  ansible.builtin.command: codex --version
  register: codex_check
  changed_when: false
  failed_when: false

- name: Install Codex CLI globally
  ansible.builtin.shell: npm install -g {{ codex_cli_package }}
  become: true
  when: codex_check.rc != 0
  environment:
    PATH: "{{ ansible_env.PATH }}"

- name: Verify Codex CLI installation
  ansible.builtin.command: codex --version
  register: codex_verify
  changed_when: false
  failed_when: false

- name: Display installation summary
  ansible.builtin.debug:
    msg:
      - "âœ… Codex CLI installed on {{ inventory_hostname }}"
      - "Node.js: {{ node_verify.stdout }}"
      - "npm: {{ npm_verify.stdout }}"
      - "Codex CLI: {{ codex_verify.stdout | default('Installed') }}"
      - "Run 'codex' to authenticate and start using"
