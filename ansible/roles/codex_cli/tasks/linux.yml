# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# Linux Codex CLI installation
# Uses nvm for sudo-free global npm packages
# Prerequisite: nodejs_nvm role must be applied first

- name: Get user home directory
  ansible.builtin.shell: "echo ~{{ ansible_user }}"
  register: codex_user_home
  changed_when: false
  check_mode: false

- name: Set nvm directory
  ansible.builtin.set_fact:
    codex_nvm_dir: "{{ codex_user_home.stdout }}/.nvm"

- name: Check if nvm is installed
  ansible.builtin.stat:
    path: "{{ codex_nvm_dir }}/nvm.sh"
  register: nvm_check

- name: Fail if nvm is not installed
  ansible.builtin.fail:
    msg: "nvm is not installed. Please run the nodejs_nvm role first."
  when: not nvm_check.stat.exists

- name: Check if Codex CLI is installed
  ansible.builtin.shell: |
    export NVM_DIR="{{ codex_nvm_dir }}"
    source "$NVM_DIR/nvm.sh"
    codex --version 2>/dev/null || echo "not installed"
  args:
    executable: /bin/bash
  become: true
  become_user: "{{ ansible_user }}"
  register: codex_check
  changed_when: false

- name: Install Codex CLI globally (no sudo)
  ansible.builtin.shell: |
    export NVM_DIR="{{ codex_nvm_dir }}"
    source "$NVM_DIR/nvm.sh"
    npm install -g {{ codex_cli_package }}
  args:
    executable: /bin/bash
  become: true
  become_user: "{{ ansible_user }}"
  when: "'not installed' in codex_check.stdout"
  register: codex_install

- name: Verify Codex CLI installation
  ansible.builtin.shell: |
    export NVM_DIR="{{ codex_nvm_dir }}"
    source "$NVM_DIR/nvm.sh"
    codex --version
  args:
    executable: /bin/bash
  become: true
  become_user: "{{ ansible_user }}"
  register: codex_verify
  changed_when: false

- name: Get Node.js version
  ansible.builtin.shell: |
    export NVM_DIR="{{ codex_nvm_dir }}"
    source "$NVM_DIR/nvm.sh"
    node --version
  args:
    executable: /bin/bash
  become: true
  become_user: "{{ ansible_user }}"
  register: node_verify
  changed_when: false

- name: Get npm version
  ansible.builtin.shell: |
    export NVM_DIR="{{ codex_nvm_dir }}"
    source "$NVM_DIR/nvm.sh"
    npm --version
  args:
    executable: /bin/bash
  become: true
  become_user: "{{ ansible_user }}"
  register: npm_verify
  changed_when: false

- name: Display installation summary
  ansible.builtin.debug:
    msg:
      - "Codex CLI installed on {{ inventory_hostname }}"
      - "Node.js: {{ node_verify.stdout }} (via nvm)"
      - "npm: {{ npm_verify.stdout }}"
      - "Codex CLI: {{ codex_verify.stdout }}"
      - "Run 'codex' to authenticate and start using"
