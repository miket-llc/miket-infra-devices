---
# Copyright (c) 2025 MikeT LLC. All rights reserved.

# =============================================================================
# Python AI Stack Role
# =============================================================================
# Installs and configures Python development environment for AI/ML:
#   - Python 3.11, 3.12
#   - uv (fast package installer)
#   - Miniforge (conda distribution)
#   - Base AI environment (PyTorch, Transformers, Jupyter)
# =============================================================================

- name: Install Python and build dependencies
  ansible.builtin.apt:
    name:
      - python3
      - python3-pip
      - python3-dev
      - python3-venv
      - python3.11
      - python3.12
      - build-essential
      - git
      - curl
      - wget
    state: present
  tags: [python, install]

- name: Install pipx
  ansible.builtin.apt:
    name: pipx
    state: present
  when: python_install_pipx
  tags: [python, pipx]

- name: Ensure pipx path is in environment
  ansible.builtin.command: pipx ensurepath
  become: false
  become_user: "{{ workstation_user }}"
  when: python_install_pipx
  tags: [python, pipx]

- name: Install uv (fast Python package installer)
  ansible.builtin.shell: |
    curl -LsSf https://astral.sh/uv/install.sh | sh
  args:
    creates: "/home/{{ workstation_user }}/.cargo/bin/uv"
  become: false
  become_user: "{{ workstation_user }}"
  when: python_install_uv
  tags: [python, uv]

- name: Download Miniforge installer
  ansible.builtin.get_url:
    url: https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh
    dest: /tmp/miniforge-installer.sh
    mode: "0755"
  when: python_install_conda
  tags: [python, conda]

- name: Install Miniforge
  ansible.builtin.shell: |
    bash /tmp/miniforge-installer.sh -b -p {{ python_conda_install_path }}
  args:
    creates: "{{ python_conda_install_path }}/bin/conda"
  become: false
  become_user: "{{ workstation_user }}"
  when: python_install_conda
  tags: [python, conda]

- name: Initialize conda for bash
  ansible.builtin.shell: |
    {{ python_conda_install_path }}/bin/conda init bash
  become: false
  become_user: "{{ workstation_user }}"
  when:
    - python_install_conda
    - python_conda_init_shell
  tags: [python, conda]

- name: Create model cache directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ workstation_user }}"
    group: "{{ workstation_user }}"
    mode: "0755"
  loop:
    - "{{ huggingface_cache_dir }}"
    - "{{ torch_hub_cache_dir }}"
  tags: [python, cache]

- name: Add Python environment variables to .bashrc
  ansible.builtin.blockinfile:
    path: "/home/{{ workstation_user }}/.bashrc"
    block: |
      # Python AI/ML environment variables
      {% for env in python_env_vars %}
      export {{ env.key }}="{{ env.value }}"
      {% endfor %}
      
      # Add uv to PATH
      export PATH="$HOME/.cargo/bin:$PATH"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Python AI Stack"
    create: true
    owner: "{{ workstation_user }}"
    group: "{{ workstation_user }}"
    mode: "0644"
  tags: [python, environment]

- name: Create base AI conda environment
  ansible.builtin.shell: |
    source {{ python_conda_install_path }}/bin/activate
    conda create -n {{ python_ai_base_env }} python=3.11 -y
    conda activate {{ python_ai_base_env }}
    conda install -y pytorch torchvision torchaudio pytorch-cuda=12.1 -c pytorch -c nvidia
    pip install {{ python_ai_frameworks | join(' ') }}
  args:
    creates: "{{ python_conda_install_path }}/envs/{{ python_ai_base_env }}"
    executable: /bin/bash
  become: false
  become_user: "{{ workstation_user }}"
  when: python_install_conda
  tags: [python, conda, ai]

- name: Display Python stack summary
  ansible.builtin.debug:
    msg: |
      Python AI stack installed:
        - Python versions: {{ python_versions | join(', ') }}
        - Conda: {{ python_conda_install_path }}
        - Base AI environment: {{ python_ai_base_env }}
        - HuggingFace cache: {{ huggingface_cache_dir }}
        - Torch cache: {{ torch_hub_cache_dir }}
      
      Activate base AI environment:
        source {{ python_conda_install_path }}/bin/activate
        conda activate {{ python_ai_base_env }}
  tags: [python]

