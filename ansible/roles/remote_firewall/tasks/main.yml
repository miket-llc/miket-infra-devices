# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# Ansible role: remote_firewall
# Configures firewall rules for remote desktop access restricted to Tailscale interface/subnet
# NoMachine (port 4000) is the sole remote desktop solution
# VNC/RDP were architecturally retired 2025-11-22

- name: Detect Tailscale interface (Linux)
  ansible.builtin.command: ip -4 addr show tailscale0 | grep -oP 'inet \K[\d.]+'
  register: tailscale_ip
  changed_when: false
  failed_when: false
  when: ansible_system == "Linux"

- name: Fallback to wg0 for Tailscale (Linux)
  ansible.builtin.command: ip -4 addr show wg0 | grep -oP 'inet \K[\d.]+'
  register: tailscale_ip_fallback
  changed_when: false
  failed_when: false
  when: ansible_system == "Linux" and tailscale_ip.rc != 0

- name: Get Tailscale subnet (Linux)
  ansible.builtin.set_fact:
    tailscale_subnet: "100.64.0.0/10"
  when: ansible_system == "Linux"

- name: Set protocol-specific defaults
  ansible.builtin.set_fact:
    actual_port: "{{ remote_port | default(4000 if remote_protocol == 'nomachine' else 5900 if remote_protocol == 'vnc' else 3389) }}"
    protocol_name: "{{ remote_protocol | default('nomachine') }}"

- name: Configure UFW firewall rule for remote desktop (Linux)
  ansible.builtin.ufw:
    rule: allow
    port: "{{ actual_port }}"
    proto: tcp
    from_ip: "{{ tailscale_subnet }}"
    comment: "{{ protocol_name | upper }} access via Tailscale"
  become: yes
  when:
    - ansible_system == "Linux"
    - (remote_detection.firewall.type | default('ufw')) == "ufw"

- name: Configure firewalld firewall rule for remote desktop (Linux)
  ansible.posix.firewalld:
    port: "{{ actual_port }}/tcp"
    source: "{{ tailscale_subnet }}"
    permanent: true
    immediate: true
    state: enabled
    zone: public
  become: yes
  when:
    - ansible_system == "Linux"
    - remote_detection.firewall.type == "firewalld"

- name: Configure iptables firewall rule for remote desktop (Linux)
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    destination_port: "{{ actual_port }}"
    source: "{{ tailscale_subnet }}"
    jump: ACCEPT
    comment: "{{ protocol_name | upper }} access via Tailscale"
  become: yes
  when:
    - ansible_system == "Linux"
    - remote_detection.firewall.type == "iptables"

- name: Configure Windows firewall rule for NoMachine (Tailscale only)
  win_shell: |
    $ruleName = "NoMachine-Tailscale"
    $desiredPort = {{ actual_port }}
    $desiredRemoteAddress = "100.64.0.0/10"
    $existingRule = Get-NetFirewallRule -Name $ruleName -ErrorAction SilentlyContinue
    
    if ($existingRule) {
      $portFilter = Get-NetFirewallPortFilter -AssociatedNetFirewallRule $existingRule
      $addressFilter = Get-NetFirewallAddressFilter -AssociatedNetFirewallRule $existingRule
      $needsUpdate = $false
      
      if ($existingRule.Enabled -ne $true) { $needsUpdate = $true }
      if ($portFilter.LocalPort -ne $desiredPort) { $needsUpdate = $true }
      if ($addressFilter.RemoteAddress -ne $desiredRemoteAddress) { $needsUpdate = $true }
      
      if ($needsUpdate) {
        Remove-NetFirewallRule -Name $ruleName
        New-NetFirewallRule `
          -Name $ruleName `
          -DisplayName "NoMachine - Tailscale Only" `
          -Direction Inbound `
          -Protocol TCP `
          -LocalPort $desiredPort `
          -RemoteAddress $desiredRemoteAddress `
          -Action Allow `
          -Enabled True
        Write-Output "UPDATED"
      } else {
        Write-Output "UNCHANGED"
      }
    } else {
      New-NetFirewallRule `
        -Name $ruleName `
        -DisplayName "NoMachine - Tailscale Only" `
        -Direction Inbound `
        -Protocol TCP `
        -LocalPort $desiredPort `
        -RemoteAddress $desiredRemoteAddress `
        -Action Allow `
        -Enabled True
      Write-Output "CREATED"
    }
  register: windows_firewall
  changed_when: "'CREATED' in windows_firewall.stdout or 'UPDATED' in windows_firewall.stdout"
  when:
    - ansible_system == "Win32NT"
    - protocol_name == "nomachine"

- name: Verify firewall rule is active (Linux - UFW)
  ansible.builtin.command: ufw status | grep "{{ actual_port }}"
  register: ufw_status_check
  changed_when: false
  failed_when: false
  when:
    - ansible_system == "Linux"
    - (remote_detection.firewall.type | default('ufw')) == "ufw"

- name: Display firewall configuration
  ansible.builtin.debug:
    msg:
      - "âœ… Firewall configured for remote desktop access"
      - "Protocol: {{ protocol_name }}"
      - "Port: {{ actual_port }}"
      - "Restricted to: Tailscale subnet (100.64.0.0/10)"
      - "Interface: {{ 'tailscale0' if ansible_system == 'Linux' else 'Tailscale adapter' }}"

