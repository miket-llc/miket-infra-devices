# Copyright (c) 2025 MikeT LLC. All rights reserved.
---
# Setup cloudflared systemd service

- name: Template cloudflared systemd service
  ansible.builtin.template:
    src: cloudflared.service.j2
    dest: /etc/systemd/system/cloudflared.service
    owner: root
    group: root
    mode: '0644'
  notify:
    - reload systemd
    - restart cloudflared

- name: Enable cloudflared service
  ansible.builtin.systemd:
    name: "{{ cloudflared_service_name }}"
    enabled: "{{ cloudflared_service_enabled }}"
    daemon_reload: true
  when: cloudflared_service_enabled

- name: Start cloudflared service
  ansible.builtin.systemd:
    name: "{{ cloudflared_service_name }}"
    state: started
  when: cloudflared_service_enabled

- name: Wait for tunnel to connect
  ansible.builtin.pause:
    seconds: 5

- name: Check cloudflared service status
  ansible.builtin.systemd:
    name: "{{ cloudflared_service_name }}"
  register: cloudflared_service_status

- name: Display service status
  ansible.builtin.debug:
    msg: "cloudflared service: {{ cloudflared_service_status.status.ActiveState }}"

