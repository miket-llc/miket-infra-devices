# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# NVIDIA Container Toolkit Role
# Properly configures NVIDIA Container Toolkit repository with error checking

- name: Install prerequisites
  apt:
    name:
      - curl
      - ca-certificates
      - gnupg
      - lsb-release
    state: present
    update_cache: yes
  become: true

- name: Add NVIDIA GPG key
  get_url:
    url: https://nvidia.github.io/libnvidia-container/gpgkey
    dest: /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
    mode: '0644'
  become: true
  register: gpg_key_download

- name: Import NVIDIA GPG key
  shell: gpg --dearmor < /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg | tee /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg > /dev/null
  become: true
  when: gpg_key_download.changed
  changed_when: true

- name: Detect system architecture
  command: dpkg --print-architecture
  register: system_arch
  changed_when: false

- name: Check if repository file exists and contains HTML (broken)
  stat:
    path: /etc/apt/sources.list.d/nvidia-container-toolkit.list
  register: repo_file_stat
  become: true

- name: Check repository file content for HTML errors
  slurp:
    src: /etc/apt/sources.list.d/nvidia-container-toolkit.list
  register: repo_file_content
  when: repo_file_stat.stat.exists
  become: true
  failed_when: false

- name: Remove broken repository file if it contains HTML
  file:
    path: /etc/apt/sources.list.d/nvidia-container-toolkit.list
    state: absent
  become: true
  when:
    - repo_file_stat.stat.exists
    - "'<!doctype' in (repo_file_content.content | b64decode | default('')) or '<html' in (repo_file_content.content | b64decode | default('')) or '404' in (repo_file_content.content | b64decode | default(''))"

- name: Configure NVIDIA Container Toolkit repository
  apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://nvidia.github.io/libnvidia-container/stable/deb/{{ system_arch.stdout }} /"
    filename: nvidia-container-toolkit
    state: present
    update_cache: false
  become: true
  register: repo_added

- name: Verify repository configuration
  command: apt-cache policy nvidia-container-toolkit
  register: repo_verify
  changed_when: false
  failed_when: "'nvidia-container-toolkit' not in repo_verify.stdout"
  become: true

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
  become: true
  when: repo_added.changed

- name: Install NVIDIA Container Toolkit
  apt:
    name: nvidia-container-toolkit
    state: present
  become: true

- name: Configure Docker to use NVIDIA runtime
  command: nvidia-ctk runtime configure --runtime=docker
  become: true
  register: docker_config
  changed_when: "'configured' in docker_config.stdout or docker_config.rc == 0"

- name: Restart Docker service
  systemd:
    name: docker
    state: restarted
  become: true
  when: docker_config.changed

