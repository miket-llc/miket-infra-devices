#!/bin/bash
# Managed by Ansible - basecamp_common role
# basecamp-net-scan: Safe local network scanner
#
# Usage: basecamp-net-scan [target]
# Default: Current subnet

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check for nmap
if ! command -v nmap &>/dev/null; then
    echo -e "${RED}Error: 'nmap' is not installed${NC}"
    echo "  Install with: sudo dnf install nmap"
    exit 1
fi

# Get default subnet if not provided
get_local_subnet() {
    # Get the primary interface's network
    local IF=$(ip route | grep default | awk '{print $5}' | head -1)
    local CIDR=$(ip -4 addr show "$IF" | grep 'inet ' | awk '{print $2}')
    echo "$CIDR"
}

TARGET="${1:-$(get_local_subnet)}"

echo -e "${BLUE}===============================================================${NC}"
echo -e "${BLUE}            BASECAMP NETWORK SCAN${NC}"
echo -e "${BLUE}===============================================================${NC}"
echo
echo -e "${GREEN}Target:${NC} $TARGET"
echo -e "${YELLOW}Note: This is a NON-AGGRESSIVE scan (ping + top ports only)${NC}"
echo

# Quick ping scan first
echo -e "${GREEN}[1/3] Host Discovery (ping scan)...${NC}"
nmap -sn "$TARGET" 2>/dev/null | grep -E "Nmap scan|Host is up|MAC Address"
echo

# Top ports scan on discovered hosts
echo -e "${GREEN}[2/3] Port Scan (top 100 ports)...${NC}"
nmap -F --top-ports 100 "$TARGET" 2>/dev/null
echo

# Service version detection on open ports (quick)
echo -e "${GREEN}[3/3] Service Detection (quick)...${NC}"
nmap -sV --version-light -F "$TARGET" 2>/dev/null | grep -E "Nmap scan|PORT|open"
echo

echo -e "${BLUE}===============================================================${NC}"
echo -e "${YELLOW}For more aggressive scanning (with explicit permission only):${NC}"
echo "  nmap -sS -sV -O $TARGET    # TCP SYN + version + OS detection"
echo "  nmap -A $TARGET            # Full audit scan"
echo -e "${BLUE}===============================================================${NC}"
