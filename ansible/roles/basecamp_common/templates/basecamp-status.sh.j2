#!/bin/bash
# Managed by Ansible - basecamp_common role
# basecamp-status: Display system status overview
#
# Usage: basecamp-status

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}===============================================================${NC}"
echo -e "${BLUE}            BASECAMP STATUS - {{ inventory_hostname }}${NC}"
echo -e "${BLUE}===============================================================${NC}"
echo

# System info
echo -e "${GREEN}[SYSTEM]${NC}"
echo "  Hostname:     $(hostname)"
echo "  Kernel:       $(uname -r)"
echo "  Uptime:       $(uptime -p)"
echo

# CPU
echo -e "${GREEN}[CPU]${NC}"
echo "  Load avg:     $(cat /proc/loadavg | awk '{print $1, $2, $3}')"
echo "  Cores:        $(nproc)"
echo

# Memory
echo -e "${GREEN}[MEMORY]${NC}"
TOTAL_MEM=$(free -h | awk '/^Mem:/{print $2}')
USED_MEM=$(free -h | awk '/^Mem:/{print $3}')
FREE_MEM=$(free -h | awk '/^Mem:/{print $4}')
echo "  Total:        ${TOTAL_MEM}"
echo "  Used:         ${USED_MEM}"
echo "  Free:         ${FREE_MEM}"
echo

# Disk
echo -e "${GREEN}[DISK]${NC}"
df -h / | awk 'NR==2 {printf "  Root (/):     %s used of %s (%s)\n", $3, $2, $5}'
echo

# Battery (if present)
if [[ -f /sys/class/power_supply/BAT0/capacity ]]; then
    echo -e "${GREEN}[BATTERY]${NC}"
    CAPACITY=$(cat /sys/class/power_supply/BAT0/capacity 2>/dev/null || echo "N/A")
    STATUS=$(cat /sys/class/power_supply/BAT0/status 2>/dev/null || echo "N/A")
    echo "  Charge:       ${CAPACITY}%"
    echo "  Status:       ${STATUS}"
    echo
fi

# Network
echo -e "${GREEN}[NETWORK]${NC}"
# Get primary IP (non-loopback, non-tailscale)
PRIMARY_IP=$(ip -4 addr show | grep -v '127.0.0.1' | grep -v '100\.' | grep 'inet ' | head -1 | awk '{print $2}' | cut -d/ -f1)
echo "  Primary IP:   ${PRIMARY_IP:-N/A}"

# Tailscale status
if command -v tailscale &>/dev/null; then
    TS_STATUS=$(tailscale status --self 2>/dev/null | head -1 || echo "Not connected")
    TS_IP=$(tailscale ip -4 2>/dev/null || echo "N/A")
    echo "  Tailscale:    ${TS_IP}"
fi

# WiFi info
WIFI_SSID=$(nmcli -t -f active,ssid dev wifi 2>/dev/null | grep '^yes' | cut -d: -f2 || echo "N/A")
echo "  WiFi SSID:    ${WIFI_SSID}"
echo

# USB Devices
echo -e "${GREEN}[USB DEVICES]${NC}"
# Count SDR devices
SDR_COUNT=$(lsusb 2>/dev/null | grep -iE 'RTL|HackRF|SDR' | wc -l)
echo "  SDR devices:  ${SDR_COUNT}"
# Count serial devices
SERIAL_COUNT=$(ls /dev/ttyUSB* /dev/ttyACM* 2>/dev/null | wc -l || echo "0")
echo "  Serial ports: ${SERIAL_COUNT}"
if [[ ${SERIAL_COUNT} -gt 0 ]]; then
    for port in /dev/ttyUSB* /dev/ttyACM* 2>/dev/null; do
        [[ -e "$port" ]] && echo "                - $port"
    done
fi
echo

# Services
echo -e "${GREEN}[SERVICES]${NC}"
for svc in tailscaled firewalld prometheus-node-exporter; do
    STATUS=$(systemctl is-active "$svc" 2>/dev/null || echo "not installed")
    if [[ "$STATUS" == "active" ]]; then
        echo -e "  $svc: ${GREEN}active${NC}"
    elif [[ "$STATUS" == "not installed" ]]; then
        echo -e "  $svc: ${YELLOW}not installed${NC}"
    else
        echo -e "  $svc: ${RED}${STATUS}${NC}"
    fi
done
echo

echo -e "${BLUE}===============================================================${NC}"
