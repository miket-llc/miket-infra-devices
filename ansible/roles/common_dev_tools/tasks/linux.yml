# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# Linux-specific tasks for common dev tools

# ========================================
# Fedora / RHEL / CentOS
# ========================================
- name: Install dev tools on Fedora/RHEL
  when: ansible_os_family == 'RedHat'
  become: true
  block:
    - name: Install baseline packages (Fedora/RHEL)
      ansible.builtin.dnf:
        name: "{{ common_dev_tools_linux_packages }}"
        state: present
      tags: [dev_tools, packages]

    - name: Add GitHub CLI repository (Fedora/RHEL)
      ansible.builtin.yum_repository:
        name: gh-cli
        description: GitHub CLI
        baseurl: https://cli.github.com/packages/rpm
        gpgkey: https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x23F3D4EA75716059
        gpgcheck: yes
        enabled: yes
      when: common_dev_tools_install_gh | bool
      tags: [dev_tools, gh]

    - name: Install GitHub CLI (Fedora/RHEL)
      ansible.builtin.dnf:
        name: gh
        state: present
      when: common_dev_tools_install_gh | bool
      tags: [dev_tools, gh]

    - name: Install Azure CLI (Fedora/RHEL)
      ansible.builtin.dnf:
        name: azure-cli
        state: present
      when: common_dev_tools_install_az | bool
      tags: [dev_tools, az]

    - name: Install Ansible (Fedora/RHEL)
      ansible.builtin.dnf:
        name:
          - ansible-core
          - ansible-collection-community-general
        state: present
      when: common_dev_tools_install_ansible | bool
      tags: [dev_tools, ansible]

    - name: Install pywinrm for Windows management (Fedora/RHEL)
      ansible.builtin.dnf:
        name: python3-winrm
        state: present
      when: common_dev_tools_install_pywinrm | bool
      tags: [dev_tools, ansible, pywinrm]

# ========================================
# Ubuntu / Debian
# ========================================
- name: Install dev tools on Ubuntu/Debian
  when: ansible_os_family == 'Debian'
  become: true
  block:
    - name: Install baseline packages (Debian/Ubuntu)
      ansible.builtin.apt:
        name: "{{ common_dev_tools_linux_packages }}"
        state: present
        update_cache: yes
      tags: [dev_tools, packages]

    - name: Add GitHub CLI GPG key (Debian/Ubuntu)
      ansible.builtin.apt_key:
        url: https://cli.github.com/packages/githubcli-archive-keyring.gpg
        keyring: /usr/share/keyrings/githubcli-archive-keyring.gpg
        state: present
      when: common_dev_tools_install_gh | bool
      tags: [dev_tools, gh]

    - name: Add GitHub CLI repository (Debian/Ubuntu)
      ansible.builtin.apt_repository:
        repo: "deb [arch={{ ansible_architecture }} signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main"
        filename: github-cli
        state: present
      when: common_dev_tools_install_gh | bool
      tags: [dev_tools, gh]

    - name: Install GitHub CLI (Debian/Ubuntu)
      ansible.builtin.apt:
        name: gh
        state: present
        update_cache: yes
      when: common_dev_tools_install_gh | bool
      tags: [dev_tools, gh]

    - name: Add Microsoft GPG key for Azure CLI (Debian/Ubuntu)
      ansible.builtin.apt_key:
        url: https://packages.microsoft.com/keys/microsoft.asc
        keyring: /usr/share/keyrings/microsoft.gpg
        state: present
      when: common_dev_tools_install_az | bool
      tags: [dev_tools, az]

    - name: Add Azure CLI repository (Debian/Ubuntu)
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/azure-cli/ {{ ansible_distribution_release }} main"
        filename: azure-cli
        state: present
      when: common_dev_tools_install_az | bool
      tags: [dev_tools, az]

    - name: Install Azure CLI (Debian/Ubuntu)
      ansible.builtin.apt:
        name: azure-cli
        state: present
        update_cache: yes
      when: common_dev_tools_install_az | bool
      tags: [dev_tools, az]

    - name: Install Ansible (Debian/Ubuntu)
      ansible.builtin.apt:
        name:
          - ansible
        state: present
      when: common_dev_tools_install_ansible | bool
      tags: [dev_tools, ansible]

    - name: Install pywinrm for Windows management (Debian/Ubuntu)
      ansible.builtin.pip:
        name: pywinrm
        state: present
      when: common_dev_tools_install_pywinrm | bool
      tags: [dev_tools, ansible, pywinrm]

# ========================================
# AI/LLM CLIs (pip-installed, all Linux)
# ========================================
- name: Install Shell-GPT (ChatGPT CLI)
  ansible.builtin.pip:
    name: shell-gpt
    state: present
  become: true
  when: common_dev_tools_install_shell_gpt | bool
  tags: [dev_tools, ai_cli]

- name: Install OpenAI Python library
  ansible.builtin.pip:
    name: openai
    state: present
  become: true
  when: common_dev_tools_install_openai_cli | bool
  tags: [dev_tools, ai_cli]

- name: Install Anthropic Claude library
  ansible.builtin.pip:
    name: anthropic
    state: present
  become: true
  when: common_dev_tools_install_claude_cli | bool
  tags: [dev_tools, ai_cli]

- name: Install Aider (AI pair programming)
  ansible.builtin.pip:
    name: aider-chat
    state: present
  become: true
  when: common_dev_tools_install_aider | bool
  tags: [dev_tools, ai_cli]

# ========================================
# Claude Code CLI (npm-installed via nvm)
# ========================================
# Uses nvm for sudo-free global npm packages
# Prerequisite: nodejs_nvm role should be applied first

- name: Get user home directory for Claude Code
  ansible.builtin.shell: "echo ~{{ ansible_user }}"
  register: claude_user_home
  changed_when: false
  check_mode: false
  when: common_dev_tools_install_claude_code | default(true) | bool
  tags: [dev_tools, ai_cli, claude]

- name: Set nvm directory for Claude Code
  ansible.builtin.set_fact:
    claude_nvm_dir: "{{ claude_user_home.stdout }}/.nvm"
  when: common_dev_tools_install_claude_code | default(true) | bool
  tags: [dev_tools, ai_cli, claude]

- name: Check if nvm is available for Claude Code
  ansible.builtin.stat:
    path: "{{ claude_nvm_dir }}/nvm.sh"
  register: nvm_available
  when: common_dev_tools_install_claude_code | default(true) | bool
  tags: [dev_tools, ai_cli, claude]

- name: Check if Claude Code is already installed (Linux)
  ansible.builtin.shell: |
    export NVM_DIR="{{ claude_nvm_dir }}"
    source "$NVM_DIR/nvm.sh"
    claude --version 2>/dev/null || echo "not installed"
  args:
    executable: /bin/bash
  become: true
  become_user: "{{ ansible_user }}"
  register: claude_version_check
  changed_when: false
  when:
    - common_dev_tools_install_claude_code | default(true) | bool
    - nvm_available.stat.exists | default(false)
  tags: [dev_tools, ai_cli, claude]

- name: Install Claude Code CLI (Linux via nvm - no sudo)
  ansible.builtin.shell: |
    export NVM_DIR="{{ claude_nvm_dir }}"
    source "$NVM_DIR/nvm.sh"
    npm install -g @anthropic-ai/claude-code
  args:
    executable: /bin/bash
  become: true
  become_user: "{{ ansible_user }}"
  when:
    - common_dev_tools_install_claude_code | default(true) | bool
    - nvm_available.stat.exists | default(false)
    - "'not installed' in claude_version_check.stdout | default('not installed')"
  tags: [dev_tools, ai_cli, claude]

- name: Display Claude Code version (Linux)
  ansible.builtin.debug:
    msg: "Claude Code: {{ claude_version_check.stdout | default('nvm not installed - skipped') }}"
  when: common_dev_tools_install_claude_code | default(true) | bool
  tags: [dev_tools, ai_cli, claude]

- name: Warn if nvm not available for Claude Code
  ansible.builtin.debug:
    msg: "WARNING: nvm not installed. Run nodejs_nvm role first for sudo-free npm."
  when:
    - common_dev_tools_install_claude_code | default(true) | bool
    - not (nvm_available.stat.exists | default(false))
  tags: [dev_tools, ai_cli, claude]

# ========================================
# Git Configuration (all Linux)
# ========================================
- name: Configure git defaults
  ansible.builtin.git_config:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    scope: global
  loop: "{{ common_dev_tools_git_config }}"
  when: common_dev_tools_configure_git | bool
  become: false
  tags: [dev_tools, git]

# ========================================
# SSH Configuration (all Linux)
# ========================================
- name: Get user home directory
  ansible.builtin.shell: "echo ~{{ ansible_user }}"
  register: user_home
  changed_when: false
  when: common_dev_tools_configure_ssh | bool
  tags: [dev_tools, ssh]

- name: Set user home fact
  ansible.builtin.set_fact:
    ssh_user_home: "{{ user_home.stdout }}"
  when: common_dev_tools_configure_ssh | bool
  tags: [dev_tools, ssh]

- name: Ensure .ssh directory exists
  ansible.builtin.file:
    path: "{{ ssh_user_home }}/.ssh"
    state: directory
    mode: '0700'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  when: common_dev_tools_configure_ssh | bool
  tags: [dev_tools, ssh]

- name: Check if SSH key exists
  ansible.builtin.stat:
    path: "{{ ssh_user_home }}/.ssh/id_{{ common_dev_tools_ssh_key_type }}"
  register: ssh_key_stat
  when: common_dev_tools_configure_ssh | bool
  tags: [dev_tools, ssh]

- name: Generate SSH key if missing
  ansible.builtin.command: >
    ssh-keygen -t {{ common_dev_tools_ssh_key_type }}
    -f {{ ssh_user_home }}/.ssh/id_{{ common_dev_tools_ssh_key_type }}
    -N "" -C "{{ ansible_user }}@{{ inventory_hostname }}"
  become: true
  become_user: "{{ ansible_user }}"
  when:
    - common_dev_tools_configure_ssh | bool
    - common_dev_tools_generate_ssh_key | bool
    - not ssh_key_stat.stat.exists
  tags: [dev_tools, ssh]

- name: Deploy SSH config for Tailscale tailnet
  ansible.builtin.template:
    src: ssh_config.j2
    dest: "{{ ssh_user_home }}/.ssh/config"
    mode: '0600'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    backup: yes
  when: common_dev_tools_configure_ssh | bool
  tags: [dev_tools, ssh]

- name: Display SSH public key
  ansible.builtin.command: cat {{ ssh_user_home }}/.ssh/id_{{ common_dev_tools_ssh_key_type }}.pub
  register: ssh_pubkey
  changed_when: false
  when: common_dev_tools_configure_ssh | bool
  tags: [dev_tools, ssh]

- name: Show SSH public key for GitHub/Tailscale
  ansible.builtin.debug:
    msg:
      - "SSH Public Key (add to GitHub/Tailscale):"
      - "{{ ssh_pubkey.stdout | default('No key found') }}"
  when: common_dev_tools_configure_ssh | bool
  tags: [dev_tools, ssh]

# ========================================
# Chezmoi (Dotfile Manager)
# ========================================
- name: Get user home for chezmoi
  ansible.builtin.shell: "echo ~{{ ansible_user }}"
  register: chezmoi_user_home
  changed_when: false
  check_mode: false
  when: common_dev_tools_install_chezmoi | bool
  tags: [dev_tools, chezmoi]

- name: Check if chezmoi is installed
  ansible.builtin.shell: which chezmoi || echo "not found"
  register: chezmoi_check
  changed_when: false
  when: common_dev_tools_install_chezmoi | bool
  tags: [dev_tools, chezmoi]

- name: Install chezmoi (Linux)
  ansible.builtin.shell: |
    sh -c "$(curl -fsLS get.chezmoi.io)" -- -b {{ chezmoi_user_home.stdout }}/.local/bin
  become: true
  become_user: "{{ ansible_user }}"
  when:
    - common_dev_tools_install_chezmoi | bool
    - "'not found' in chezmoi_check.stdout"
  tags: [dev_tools, chezmoi]

- name: Ensure ~/.local/bin is in PATH for chezmoi
  ansible.builtin.lineinfile:
    path: "{{ chezmoi_user_home.stdout }}/.bashrc"
    line: 'export PATH="$HOME/.local/bin:$PATH"'
    create: true
    mode: '0644'
  become: true
  become_user: "{{ ansible_user }}"
  when: common_dev_tools_install_chezmoi | bool
  tags: [dev_tools, chezmoi]

- name: Check if chezmoi is initialized
  ansible.builtin.stat:
    path: "{{ chezmoi_user_home.stdout }}/.local/share/chezmoi"
  register: chezmoi_init_check
  when: common_dev_tools_install_chezmoi | bool
  tags: [dev_tools, chezmoi]

- name: Initialize chezmoi with dotfiles repo
  ansible.builtin.shell: |
    export PATH="{{ chezmoi_user_home.stdout }}/.local/bin:$PATH"
    chezmoi init {{ common_dev_tools_chezmoi_repo }}
  become: true
  become_user: "{{ ansible_user }}"
  when:
    - common_dev_tools_install_chezmoi | bool
    - not chezmoi_init_check.stat.exists
  register: chezmoi_init
  tags: [dev_tools, chezmoi]

- name: Apply chezmoi (installs ask-cli via run_onchange)
  ansible.builtin.shell: |
    export PATH="{{ chezmoi_user_home.stdout }}/.local/bin:$PATH"
    chezmoi apply --no-tty
  become: true
  become_user: "{{ ansible_user }}"
  when:
    - common_dev_tools_install_chezmoi | bool
    - common_dev_tools_chezmoi_apply | bool
  register: chezmoi_apply
  changed_when: chezmoi_apply.stdout | length > 0
  tags: [dev_tools, chezmoi]

- name: Display chezmoi status
  ansible.builtin.debug:
    msg: "chezmoi: {{ 'installed and applied' if chezmoi_apply is succeeded else 'installed' }}"
  when: common_dev_tools_install_chezmoi | bool
  tags: [dev_tools, chezmoi]

# ========================================
# Verification
# ========================================
- name: Verify git installation
  ansible.builtin.command: git --version
  register: git_version
  changed_when: false
  tags: [dev_tools, verify]

- name: Verify gh installation
  ansible.builtin.command: gh --version
  register: gh_version
  changed_when: false
  failed_when: false
  when: common_dev_tools_install_gh | bool
  tags: [dev_tools, verify]

- name: Verify az installation
  ansible.builtin.command: az --version
  register: az_version
  changed_when: false
  failed_when: false
  when: common_dev_tools_install_az | bool
  tags: [dev_tools, verify]

- name: Display installed versions
  ansible.builtin.debug:
    msg:
      - "Git: {{ git_version.stdout_lines[0] | default('not installed') }}"
      - "GitHub CLI: {{ gh_version.stdout_lines[0] | default('not installed') }}"
      - "Azure CLI: {{ az_version.stdout_lines[0] | default('not installed') }}"
  tags: [dev_tools, verify]

