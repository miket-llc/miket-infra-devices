# Copyright (c) 2025 MikeT LLC. All rights reserved.
# roles/llm_workstation_ollama/tasks/configure.yml
#
# Ollama systemd service and environment configuration
---

- name: Create Ollama environment file
  ansible.builtin.copy:
    content: |
      # Ollama configuration
      # Generated by Ansible - do not edit manually
      
      # Bind to all interfaces for tailnet access
      OLLAMA_HOST={{ ollama_host }}:{{ ollama_port }}
      
      # Model storage location (Flux/Space standard)
      OLLAMA_MODELS={{ ollama_models_path }}
      
      # GPU configuration
      {% if ollama_enable_cuda %}
      # NVIDIA CUDA enabled
      CUDA_VISIBLE_DEVICES=all
      {% endif %}
      {% if ollama_enable_rocm %}
      # AMD ROCm enabled
      HSA_OVERRIDE_GFX_VERSION=11.0.0
      {% endif %}
    dest: /etc/ollama.env
    owner: root
    group: "{{ ollama_service_group }}"
    mode: "0640"
  notify: Restart ollama
  tags: [ollama, config]

- name: Create Ollama systemd service
  ansible.builtin.copy:
    content: |
      [Unit]
      Description=Ollama LLM Service
      Documentation=https://ollama.com
      After=network-online.target
      Wants=network-online.target
      
      [Service]
      Type=simple
      User={{ ollama_service_user }}
      Group={{ ollama_service_group }}
      EnvironmentFile=/etc/ollama.env
      {% if ollama_env_file is defined %}
      EnvironmentFile=-{{ ollama_env_file }}
      {% endif %}
      ExecStart=/usr/local/bin/ollama serve
      Restart=on-failure
      RestartSec=10
      
      # Security hardening
      NoNewPrivileges=true
      ProtectSystem=strict
      ProtectHome=true
      ReadWritePaths={{ ollama_home }} {{ ollama_models_path }} {{ ollama_data_path }}
      PrivateTmp=true
      
      # GPU access
      {% if ollama_enable_cuda %}
      # NVIDIA device access
      DeviceAllow=/dev/nvidia0 rw
      DeviceAllow=/dev/nvidiactl rw
      DeviceAllow=/dev/nvidia-uvm rw
      DeviceAllow=/dev/nvidia-uvm-tools rw
      {% endif %}
      {% if ollama_enable_rocm %}
      # AMD ROCm device access
      DeviceAllow=/dev/kfd rw
      DeviceAllow=/dev/dri rw
      {% endif %}
      
      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/ollama.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart ollama
  tags: [ollama, systemd]

- name: Create health check script
  ansible.builtin.copy:
    content: |
      #!/bin/bash
      # Ollama health check script
      # Usage: ollama-health.sh [timeout]
      
      TIMEOUT="${1:-{{ ollama_health_timeout }}}"
      OLLAMA_URL="http://{{ ollama_host }}:{{ ollama_port }}"
      
      # Check if service is running
      if ! systemctl is-active --quiet ollama; then
        echo "CRITICAL: Ollama service is not running"
        exit 2
      fi
      
      # Check API endpoint
      if curl -sf --max-time "$TIMEOUT" "$OLLAMA_URL/api/tags" > /dev/null 2>&1; then
        echo "OK: Ollama API responding at $OLLAMA_URL"
        exit 0
      else
        echo "WARNING: Ollama API not responding"
        exit 1
      fi
    dest: "{{ ollama_healthcheck_script }}"
    owner: root
    group: "{{ ollama_service_group }}"
    mode: "0755"
  when: ollama_healthcheck_enabled
  tags: [ollama, healthcheck]

- name: Enable and start Ollama service
  ansible.builtin.systemd:
    name: ollama
    enabled: true
    state: started
    daemon_reload: true
  tags: [ollama, service]

