# Auto-generated by Ansible
# Maps network drives X:, S:, T: to motoko SMB shares

$ErrorActionPreference = "Continue"

# SMB Configuration
$server = "{{ smb_server }}"
$username = "mdt"
$password = "{{ smb_password }}"

Write-Host "Mapping network drives to $server..."

# Drive mappings
$drives = @(
{% for share in smb_shares %}
    @{
        Letter = "{{ share.drive_letter }}"
        Path = "{{ share.path }}"
        Label = "{{ share.label }}"
        Name = "{{ share.name }}"
    }{{ "," if not loop.last else "" }}
{% endfor %}
)

foreach ($drive in $drives) {
    $letter = $drive.Letter
    $sharePath = $drive.Path -replace '/', '\'
    $uncPath = "\\$server\$sharePath"
    
    Write-Host "Processing drive ${letter}:..."
    
    # Check if already mapped
    $existing = Get-PSDrive -Name $letter -PSProvider FileSystem -ErrorAction SilentlyContinue
    
    if ($existing) {
        Write-Host "  Drive ${letter}: already mapped to $($existing.DisplayRoot)"
    } else {
        Write-Host "  Mapping ${letter}: to $uncPath..."
        
        # Use net use with credentials
        $netCmd = "net use ${letter}: $uncPath /user:$username $password /persistent:yes 2>&1"
        try {
            $output = Invoke-Expression $netCmd
            Write-Host "  Successfully mapped ${letter}:"
        } catch {
            Write-Host "  ERROR: Failed to map ${letter}: - $($_.Exception.Message)"
        }
    }
}

Write-Host "Drive mapping complete."

