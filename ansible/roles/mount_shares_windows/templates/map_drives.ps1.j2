# Auto-generated by Ansible
# Maps network drives X:, S:, T: to motoko SMB shares

$ErrorActionPreference = "Continue"

# SMB Configuration
$server = "{{ smb_server }}"
$username = "mdt"
$password = "{{ smb_password }}"

Write-Host "Mapping network drives to $server..."

# Drive mappings
$drives = @(
{% for share in smb_shares %}
    @{
        Letter = "{{ share.drive_letter }}"
        Path = "{{ share.path }}"
        Label = "{{ share.label }}"
        Name = "{{ share.name }}"
    }{{ "," if not loop.last else "" }}
{% endfor %}
)

foreach ($drive in $drives) {
    $letter = $drive.Letter
    $sharePath = ($drive.Path -replace '^[/\\]+','') -replace '/', '\'
    $uncPath = "\\$server\$sharePath"
    
    Write-Host "Processing drive ${letter}:..."
    
    # Check if already mapped
    $existing = Get-PSDrive -Name $letter -PSProvider FileSystem -ErrorAction SilentlyContinue
    
    if ($existing) {
        Write-Host "  Drive ${letter}: already mapped to $($existing.DisplayRoot)"
    } else {
        Write-Host "  Mapping ${letter}: to $uncPath..."
        
        # Use net use with credentials
        $netCmd = "net use ${letter}: $uncPath /user:$username `"$password`" /persistent:yes 2>&1"
        $output = Invoke-Expression $netCmd
        if ($LASTEXITCODE -eq 0) {
            Write-Host "  Successfully mapped ${letter}:"
        } else {
            Write-Host "  ERROR: Failed to map ${letter}:"
            Write-Host $output
        }
    }
}

Write-Host "Drive mapping complete."

# --- Device Health Reporting ---
Write-Host "Reporting device health..."

$hostname = $env:COMPUTERNAME
$user = $env:USERNAME
$spaceDrive = "S:"
$statusDir = "${spaceDrive}\devices\${hostname}\${user}"
$statusFile = "${statusDir}\_status.json"

# Check drive status
$fluxMounted = (Test-Path "X:\")
$spaceMounted = (Test-Path "S:\")
$timeMounted = (Test-Path "T:\")

if ($fluxMounted -and $spaceMounted) {
    $overallStatus = "healthy"
} else {
    $overallStatus = "degraded"
}

$timestamp = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")

$jsonPayload = @{
    timestamp = $timestamp
    device = $hostname
    user = $user
    platform = "Windows"
    status = $overallStatus
    components = @{
        mounts = @{
            flux = $fluxMounted
            space = $spaceMounted
            time = $timeMounted
        }
    }
} | ConvertTo-Json -Depth 3

if ($spaceMounted) {
    if (-not (Test-Path $statusDir)) {
        New-Item -Path $statusDir -ItemType Directory -Force | Out-Null
    }
    $jsonPayload | Out-File -FilePath $statusFile -Encoding utf8
    Write-Host "Health status written to ${statusFile}"
} else {
    Write-Host "ERROR: Cannot write health status - S: drive is not mounted."
}
