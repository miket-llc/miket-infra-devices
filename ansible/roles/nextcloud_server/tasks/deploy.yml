# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# Podman Compose Deployment for Nextcloud Stack
# Deploys: Nextcloud + PostgreSQL + Redis
# Requires: Fedora with podman

- name: Render Nextcloud compose file
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ nextcloud_compose_path }}"
    owner: root
    group: root
    mode: "0644"
  notify: restart nextcloud

- name: Check if Podman is installed
  ansible.builtin.command: which podman
  register: podman_check
  changed_when: false
  failed_when: false

- name: Install Podman
  ansible.builtin.dnf:
    name: podman
    state: present
  when: podman_check.rc != 0

- name: Check if podman-compose is installed
  ansible.builtin.command: which podman-compose
  register: compose_check
  changed_when: false
  failed_when: false

- name: Install podman-compose
  ansible.builtin.dnf:
    name: podman-compose
    state: present
  when: compose_check.rc != 0

- name: Enable Podman socket
  ansible.builtin.systemd:
    name: podman.socket
    enabled: true
    state: started

- name: Pull Nextcloud stack images
  ansible.builtin.command: podman compose -f "{{ nextcloud_compose_path }}" pull
  args:
    chdir: "{{ nextcloud_workdir }}"
  register: podman_pull
  changed_when: "'Pull complete' in podman_pull.stdout or 'Downloaded newer image' in podman_pull.stdout"

- name: Start Nextcloud stack
  ansible.builtin.command: podman compose -f "{{ nextcloud_compose_path }}" up -d
  args:
    chdir: "{{ nextcloud_workdir }}"
  register: podman_compose_result
  changed_when: "'Creating' in podman_compose_result.stdout or 'Starting' in podman_compose_result.stdout"

- name: Create Nextcloud systemd service
  ansible.builtin.template:
    src: nextcloud.service.j2
    dest: "/etc/systemd/system/{{ nextcloud_service_name }}.service"
    owner: root
    group: root
    mode: "0644"
  notify: reload systemd

- name: Enable and start Nextcloud service
  ansible.builtin.systemd:
    name: "{{ nextcloud_service_name }}"
    enabled: true
    state: started
    daemon_reload: true

- name: Wait for Nextcloud container to start (max 60s)
  ansible.builtin.command: podman ps --filter "name=nextcloud-app" --format "{{ '{{.Status}}' }}"
  register: container_wait
  until: "'Up' in container_wait.stdout"
  retries: 12
  delay: 5
  changed_when: false
  failed_when: false

- name: Wait for Nextcloud to be ready (max 90s)
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ nextcloud_port }}/status.php"
    method: GET
    status_code: 200
    return_content: true
  register: nextcloud_status
  until: nextcloud_status.status == 200
  retries: 9
  delay: 10
  failed_when: false

- name: Set Nextcloud ready fact
  ansible.builtin.set_fact:
    nextcloud_is_ready: "{{ nextcloud_status.status | default(0) == 200 }}"

- name: Report Nextcloud startup status
  ansible.builtin.debug:
    msg: >-
      Nextcloud status: {{ 'READY' if nextcloud_is_ready else 'NOT READY - check: podman logs nextcloud-app' }}
