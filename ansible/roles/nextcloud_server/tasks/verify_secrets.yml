# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# Secrets Verification
# The actual secrets are generated by the secrets_sync role from AKV
# This task file verifies the .env file exists and is properly secured

- name: Check if Nextcloud env file exists (generated by secrets_sync)
  ansible.builtin.stat:
    path: "{{ nextcloud_env_path }}"
  register: nextcloud_env_stat

- name: Fail if Nextcloud env file is missing
  ansible.builtin.fail:
    msg: >-
      {{ nextcloud_env_path }} is missing. Run 'ansible-playbook playbooks/secrets-sync.yml --limit {{ inventory_hostname }}'
      to pull secrets from Azure Key Vault and render the .env file.
      Required AKV secrets: nextcloud-db-user, nextcloud-db-password, nextcloud-admin-user,
      nextcloud-admin-bootstrap-password, m365-nextcloud-client-id, m365-nextcloud-client-secret
  when: not nextcloud_env_stat.stat.exists

- name: Ensure Nextcloud env file has restrictive permissions
  ansible.builtin.file:
    path: "{{ nextcloud_env_path }}"
    owner: root
    group: root
    mode: "0600"
  when: nextcloud_env_stat.stat.exists

- name: Verify env file has required secrets
  ansible.builtin.shell: |
    grep -q "^NEXTCLOUD_DB_PASSWORD=" "{{ nextcloud_env_path }}" && \
    grep -q "^NEXTCLOUD_ADMIN_PASSWORD=" "{{ nextcloud_env_path }}" && \
    grep -q "^REDIS_PASSWORD=" "{{ nextcloud_env_path }}"
  register: secrets_check
  changed_when: false
  failed_when: secrets_check.rc != 0
  when: nextcloud_env_stat.stat.exists

- name: Report secrets verification
  ansible.builtin.debug:
    msg: "Nextcloud secrets verified in {{ nextcloud_env_path }}"
  when: nextcloud_env_stat.stat.exists

