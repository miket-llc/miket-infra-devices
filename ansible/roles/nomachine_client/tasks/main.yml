---
# Ansible role: nomachine_client
# Installs NoMachine client on workstations

- name: Install NoMachine client (Linux)
  block:
    - name: Check if NoMachine client is already installed
      ansible.builtin.stat:
        path: /usr/NX/bin/nxclient
      register: nomachine_client_installed_linux
      when: ansible_system == "Linux"

    - name: Detect Linux distribution
      ansible.builtin.set_fact:
        nomachine_client_package_type: "{{ 'deb' if (ansible_facts.pkg_mgr | default('apt')) == 'apt' else 'rpm' }}"
        nomachine_client_arch: "{{ 'x86_64' if ansible_facts.architecture == 'x86_64' else 'arm64' }}"
      when:
        - ansible_system == "Linux"
        - not nomachine_client_installed_linux.stat.exists

    - name: Note client installation
      ansible.builtin.debug:
        msg: "NoMachine client installation skipped - download requires accepting terms. Client may be included with server package or can be installed manually from https://www.nomachine.com/download"
      when:
        - ansible_system == "Linux"
        - not nomachine_client_installed_linux.stat.exists

    - name: Create NoMachine connection helper script
      ansible.builtin.copy:
        dest: /usr/local/bin/nomachine
        content: |
          #!/bin/bash
          # NoMachine connection helper - uses Tailscale MagicDNS
          HOST="${1:-motoko}"
          # Always use Tailscale MagicDNS hostname to ensure Tailscale IP resolution
          TARGET="${HOST}.pangolin-vega.ts.net:{{ nomachine_port }}"
          if [ -f /usr/NX/bin/nxclient ]; then
            /usr/NX/bin/nxclient --session "${TARGET}"
          else
            echo "NoMachine client not found. Install NoMachine to use this script."
            exit 1
          fi
        mode: '0755'
      become: yes
      when: ansible_system == "Linux"

  when: ansible_system == "Linux"

- name: Install NoMachine client (Windows)
  block:
    - name: Check if NoMachine client is installed
      ansible.builtin.win_stat:
        path: "C:\\Program Files\\NoMachine\\bin\\nxclient.exe"
      register: nomachine_client_installed_win

    - name: Download NoMachine client for Windows
      ansible.builtin.win_get_url:
        url: https://download.nomachine.com/download/8.11/Windows/nomachine.exe
        dest: C:\Windows\Temp\nomachine-client.exe
      when: not nomachine_client_installed_win.stat.exists

    - name: Install NoMachine client (Windows)
      ansible.builtin.win_shell: |
        Start-Process -FilePath "C:\Windows\Temp\nomachine-client.exe" -ArgumentList "/S" -Wait -NoNewWindow
      when: not nomachine_client_installed_win.stat.exists
      register: nomachine_client_install_win

    - name: Create NoMachine connection helper script
      ansible.builtin.win_copy:
        dest: C:\Windows\System32\nomachine.ps1
        content: |
          # NoMachine connection helper - uses Tailscale MagicDNS
          param([string]$Hostname = "motoko")
          # Always use Tailscale MagicDNS hostname to ensure Tailscale IP resolution
          $Target = "${Hostname}.pangolin-vega.ts.net:{{ nomachine_port }}"
          & "C:\Program Files\NoMachine\bin\nxclient.exe" --session $Target
        mode: '0755'

  when: ansible_system == "Windows"

- name: Install NoMachine client (macOS)
  block:
    - name: Check if NoMachine client is installed
      ansible.builtin.stat:
        path: /Applications/NoMachine.app
      register: nomachine_client_installed_macos

    - name: Download NoMachine client for macOS
      ansible.builtin.get_url:
        url: https://download.nomachine.com/download/8.11/MacOSX/nomachine.pkg
        dest: /tmp/nomachine-client.pkg
        mode: '0644'
      when: not nomachine_client_installed_macos.stat.exists

    - name: Install NoMachine client (macOS)
      ansible.builtin.command:
        cmd: installer -pkg /tmp/nomachine-client.pkg -target /
      become: yes
      when: not nomachine_client_installed_macos.stat.exists

    - name: Create NoMachine connection helper script
      ansible.builtin.copy:
        dest: /usr/local/bin/nomachine
        content: |
          #!/bin/bash
          # NoMachine connection helper
          HOST="${1:-motoko}"
          open "nx://{{ HOST }}.pangolin-vega.ts.net:{{ nomachine_port }}"
        mode: '0755'
      become: yes

  when: ansible_system == "Darwin"

- name: Display client installation information
  ansible.builtin.debug:
    msg:
      - "âœ… NoMachine client installed"
      - "Usage: nomachine HOSTNAME"
      - "Example: nomachine motoko"
      - "Connects to: HOSTNAME.pangolin-vega.ts.net:{{ nomachine_port }}"

