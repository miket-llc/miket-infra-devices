# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# =============================================================================
# NOMACHINE SERVER ROLE
# =============================================================================
#
# Installs and configures NoMachine server on Linux, Windows, and macOS.
# Uses local binaries from role's files/nomachine/ directory.
#
# =============================================================================

# ============================================
# LINUX INSTALLATION
# ============================================
- name: Install NoMachine server (Linux)
  when: ansible_system == "Linux"
  block:
    - name: Check if NoMachine is installed (Linux)
      ansible.builtin.command:
        cmd: rpm -q nomachine
      register: nomachine_rpm_check
      changed_when: false
      failed_when: false

    - name: Set installation facts (Linux)
      ansible.builtin.set_fact:
        nomachine_is_installed: "{{ nomachine_rpm_check.rc == 0 }}"
        nomachine_installed_version: "{{ nomachine_rpm_check.stdout | regex_search('nomachine-([0-9.]+)', '\\1') | first | default('none') if nomachine_rpm_check.rc == 0 else 'none' }}"

    - name: Display version status (Linux)
      ansible.builtin.debug:
        msg: |
          NoMachine Status:
            Installed: {{ nomachine_is_installed }}
            Current Version: {{ nomachine_installed_version }}
            Target Version: {{ nomachine_version }}
            Action: {{ 'None needed' if (nomachine_is_installed and nomachine_installed_version == nomachine_version) else 'Install/Upgrade' }}

    - name: Copy NoMachine RPM to target (Linux)
      ansible.builtin.copy:
        src: "{{ nomachine_binary_base }}/linux/{{ nomachine_rpm_filename }}"
        dest: "/tmp/{{ nomachine_rpm_filename }}"
        mode: '0644'
      when: not nomachine_is_installed or nomachine_installed_version != nomachine_version
      register: nomachine_rpm_copied

    - name: Install NoMachine (Linux)
      ansible.builtin.command:
        cmd: rpm -Uvh --nodeps --nodigest --nosignature "/tmp/{{ nomachine_rpm_filename }}"
      become: yes
      when: nomachine_rpm_copied.changed | default(false)
      register: nomachine_installed

    - name: Clean up RPM file (Linux)
      ansible.builtin.file:
        path: "/tmp/{{ nomachine_rpm_filename }}"
        state: absent
      when: nomachine_rpm_copied.changed | default(false)

    - name: Get Tailscale IP address (Linux)
      ansible.builtin.command:
        cmd: tailscale ip -4
      register: tailscale_ip_result
      changed_when: false
      failed_when: false

    - name: Set Tailscale IP fact (Linux)
      ansible.builtin.set_fact:
        nomachine_bind_ip: "{{ tailscale_ip_result.stdout | default('0.0.0.0') }}"

    - name: Check if NoMachine config exists (Linux)
      ansible.builtin.stat:
        path: /usr/NX/etc/server.cfg
      register: nomachine_config_stat

    - name: Configure NoMachine ServerName (Linux)
      ansible.builtin.lineinfile:
        path: /usr/NX/etc/server.cfg
        regexp: '^#?ServerName\s*='
        line: "ServerName = {{ inventory_hostname }}.pangolin-vega.ts.net"
        backup: yes
      become: yes
      when: 
        - nomachine_config_stat.stat.exists
        - nomachine_tailscale_only | bool
      notify: Restart NoMachine

    - name: Ensure NoMachine service is enabled and started (Linux)
      ansible.builtin.systemd:
        name: "{{ nomachine_service_name }}"
        enabled: yes
        state: started
        daemon_reload: yes
      become: yes
      when: nomachine_config_stat.stat.exists

    - name: Open NoMachine port in firewall for Tailscale (Linux)
      ansible.posix.firewalld:
        port: "{{ nomachine_port }}/tcp"
        zone: "{{ nomachine_firewall_zone }}"
        permanent: yes
        immediate: yes
        state: enabled
      become: yes
      failed_when: false

# ============================================
# WINDOWS INSTALLATION
# ============================================
- name: Install NoMachine server (Windows)
  when: ansible_os_family == "Windows"
  block:
    - name: Check if NoMachine is installed (Windows)
      ansible.windows.win_stat:
        path: "{{ nomachine_install_path_windows }}\\bin\\nxserver.exe"
      register: nomachine_installed_win

    - name: Copy NoMachine installer to target (Windows)
      ansible.windows.win_copy:
        src: "{{ nomachine_binary_base }}/windows/{{ nomachine_exe_filename }}"
        dest: "C:\\Windows\\Temp\\{{ nomachine_exe_filename }}"
      when: not nomachine_installed_win.stat.exists
      register: nomachine_exe_copied

    - name: Install NoMachine (Windows)
      ansible.windows.win_shell: |
        Start-Process -FilePath "C:\Windows\Temp\{{ nomachine_exe_filename }}" -ArgumentList "/S" -Wait -NoNewWindow
      when: nomachine_exe_copied.changed | default(false)
      register: nomachine_install_win

    - name: Clean up installer (Windows)
      ansible.windows.win_file:
        path: "C:\\Windows\\Temp\\{{ nomachine_exe_filename }}"
        state: absent
      when: nomachine_exe_copied.changed | default(false)

    - name: Ensure NoMachine service is running (Windows)
      ansible.windows.win_service:
        name: nxservice64
        state: started
        start_mode: auto
      when: nomachine_installed_win.stat.exists or (nomachine_install_win.changed | default(false))

# ============================================
# MACOS INSTALLATION
# ============================================
- name: Install NoMachine server (macOS)
  when: ansible_system == "Darwin"
  block:
    - name: Check if NoMachine is installed (macOS)
      ansible.builtin.stat:
        path: "{{ nomachine_install_path_macos }}"
      register: nomachine_installed_macos

    - name: Create temp directory for DMG mount (macOS)
      ansible.builtin.file:
        path: /tmp/nomachine_mount
        state: directory
        mode: '0755'
      when: not nomachine_installed_macos.stat.exists

    - name: Copy NoMachine DMG to target (macOS)
      ansible.builtin.copy:
        src: "{{ nomachine_binary_base }}/macos/{{ nomachine_dmg_filename }}"
        dest: "/tmp/{{ nomachine_dmg_filename }}"
        mode: '0644'
      when: not nomachine_installed_macos.stat.exists
      register: nomachine_dmg_copied

    - name: Mount DMG (macOS)
      ansible.builtin.command:
        cmd: hdiutil attach "/tmp/{{ nomachine_dmg_filename }}" -mountpoint /tmp/nomachine_mount -nobrowse
      when: nomachine_dmg_copied.changed | default(false)
      register: dmg_mounted

    - name: Install NoMachine from DMG (macOS)
      ansible.builtin.command:
        cmd: installer -pkg "/tmp/nomachine_mount/NoMachine.pkg" -target /
      become: yes
      when: dmg_mounted.changed | default(false)
      register: nomachine_install_macos

    - name: Unmount DMG (macOS)
      ansible.builtin.command:
        cmd: hdiutil detach /tmp/nomachine_mount
      when: dmg_mounted.changed | default(false)
      failed_when: false

    - name: Clean up DMG file (macOS)
      ansible.builtin.file:
        path: "/tmp/{{ nomachine_dmg_filename }}"
        state: absent
      when: nomachine_dmg_copied.changed | default(false)

    - name: Ensure NoMachine service is running (macOS)
      ansible.builtin.command:
        cmd: launchctl load -w /Library/LaunchDaemons/com.nomachine.nxserver.plist
      become: yes
      when: nomachine_installed_macos.stat.exists or (nomachine_install_macos.changed | default(false))
      failed_when: false
      changed_when: false

# ============================================
# VERIFICATION (ALL PLATFORMS)
# ============================================
- name: Verify NoMachine installation
  ansible.builtin.debug:
    msg:
      - "═══════════════════════════════════════════════════════════"
      - "NOMACHINE INSTALLATION COMPLETE"
      - "═══════════════════════════════════════════════════════════"
      - ""
      - "Version: {{ nomachine_version }}"
      - "Port: {{ nomachine_port }}"
      - "Service: {{ nomachine_service_name }}"
      - ""
      - "Connect via: {{ inventory_hostname }}.pangolin-vega.ts.net:{{ nomachine_port }}"
      - ""
      - "Security: Tailnet-only access ({{ nomachine_accept_from }})"
      - "═══════════════════════════════════════════════════════════"
