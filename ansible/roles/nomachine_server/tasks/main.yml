---
# Ansible role: nomachine_server
# Installs and configures NoMachine server on Linux, Windows, and macOS
# NoMachine provides point-to-point remote desktop access

- name: Install NoMachine server (Linux)
  block:
    - name: Detect Linux distribution
      ansible.builtin.set_fact:
        nomachine_package_type: "{{ 'deb' if (ansible_facts.pkg_mgr | default('apt')) == 'apt' else 'rpm' }}"
        nomachine_arch: "{{ 'x86_64' if ansible_facts.architecture == 'x86_64' else 'arm64' }}"
      when: ansible_system == "Linux"

    - name: Check if NoMachine is already installed
      ansible.builtin.shell:
        cmd: dpkg -l | grep -q nomachine || rpm -q nomachine || exit 1
      register: nomachine_installed_check
      changed_when: false
      failed_when: false
      when: ansible_system == "Linux"

    - name: Download NoMachine for Linux using wget (handles redirects better)
      ansible.builtin.shell:
        cmd: wget -q --show-progress -O /tmp/nomachine.deb "https://download.nomachine.com/download/8.11/Linux/nomachine_8.11.3_4_{{ nomachine_arch }}.deb" || curl -L -o /tmp/nomachine.deb "https://download.nomachine.com/download/8.11/Linux/nomachine_8.11.3_4_{{ nomachine_arch }}.deb"
      when:
        - ansible_system == "Linux"
        - nomachine_package_type == "deb"
        - nomachine_installed_check.rc != 0
      register: nomachine_download_deb
      failed_when: false

    - name: Verify downloaded deb file
      ansible.builtin.shell:
        cmd: file /tmp/nomachine.deb | grep -q "Debian binary" || exit 1
      register: deb_verify
      when:
        - ansible_system == "Linux"
        - nomachine_package_type == "deb"
        - nomachine_installed_check.rc != 0
        - nomachine_download_deb is succeeded
      failed_when: deb_verify.rc != 0

    - name: Download NoMachine for Linux (RPM)
      ansible.builtin.shell:
        cmd: wget -q --show-progress -O /tmp/nomachine.rpm "https://download.nomachine.com/download/8.11/Linux/nomachine_8.11.3_4_{{ nomachine_arch }}.rpm" || curl -L -o /tmp/nomachine.rpm "https://download.nomachine.com/download/8.11/Linux/nomachine_8.11.3_4_{{ nomachine_arch }}.rpm"
      when:
        - ansible_system == "Linux"
        - nomachine_package_type == "rpm"
        - nomachine_installed_check.rc != 0
      register: nomachine_download_rpm
      failed_when: false

    - name: Install NoMachine (Debian/Ubuntu)
      ansible.builtin.apt:
        deb: /tmp/nomachine.deb
        state: present
      become: yes
      when:
        - ansible_system == "Linux"
        - nomachine_package_type == "deb"
        - nomachine_installed_check.rc != 0
        - deb_verify.rc == 0

    - name: Install NoMachine (RHEL/CentOS)
      ansible.builtin.yum:
        name: /tmp/nomachine.rpm
        state: present
      become: yes
      when:
        - ansible_system == "Linux"
        - nomachine_package_type == "rpm"
        - nomachine_installed_check.rc != 0
        - nomachine_download_rpm is succeeded

    - name: Get Tailscale IP address
      ansible.builtin.command:
        cmd: tailscale ip -4
      register: tailscale_ip
      changed_when: false
      failed_when: false
      when: ansible_system == "Linux"

    - name: Configure NoMachine to bind to Tailscale interface only
      ansible.builtin.lineinfile:
        path: /usr/NX/etc/server.cfg
        regexp: '^NXDListenAddress'
        line: "NXDListenAddress {{ tailscale_ip.stdout }}"
        backup: yes
      become: yes
      when:
        - ansible_system == "Linux"
        - tailscale_ip.stdout != ""
      register: nomachine_bind_updated

    - name: Configure NoMachine to accept connections from Tailscale subnet only
      ansible.builtin.lineinfile:
        path: /usr/NX/etc/server.cfg
        regexp: '^AcceptFrom'
        line: 'AcceptFrom 100.64.0.0/10'
        backup: yes
      become: yes
      when: ansible_system == "Linux"
      register: nomachine_config_updated

    - name: Restart NoMachine service if config changed
      ansible.builtin.systemd:
        name: "{{ nomachine_service_name }}"
        state: restarted
      become: yes
      when:
        - ansible_system == "Linux"
        - nomachine_config_updated.changed

    - name: Ensure NoMachine service is enabled and started
      ansible.builtin.systemd:
        name: "{{ nomachine_service_name }}"
        enabled: yes
        state: started
        daemon_reload: yes
      become: yes
      when: ansible_system == "Linux"

  when: ansible_system == "Linux"

- name: Install NoMachine server (Windows)
  block:
    - name: Check if NoMachine is installed
      ansible.builtin.win_stat:
        path: "{{ nomachine_install_path_windows }}\\bin\\nxserver.exe"
      register: nomachine_installed_win

    - name: Download NoMachine for Windows
      ansible.builtin.win_get_url:
        url: https://download.nomachine.com/download/8.11/Windows/nomachine.exe
        dest: C:\Windows\Temp\nomachine.exe
      when: not nomachine_installed_win.stat.exists

    - name: Install NoMachine (Windows)
      ansible.builtin.win_shell: |
        Start-Process -FilePath "C:\Windows\Temp\nomachine.exe" -ArgumentList "/S" -Wait -NoNewWindow
      when: not nomachine_installed_win.stat.exists
      register: nomachine_install_win

    - name: Ensure NoMachine service is running (Windows)
      ansible.builtin.win_service:
        name: "{{ nomachine_service_name }}"
        state: started
        start_mode: auto
      when: nomachine_installed_win.stat.exists or nomachine_install_win is succeeded

  when: ansible_system == "Windows"

- name: Install NoMachine server (macOS)
  block:
    - name: Check if NoMachine is installed
      ansible.builtin.stat:
        path: "{{ nomachine_install_path_macos }}"
      register: nomachine_installed_macos

    - name: Download NoMachine for macOS
      ansible.builtin.get_url:
        url: https://download.nomachine.com/download/8.11/MacOSX/nomachine.pkg
        dest: /tmp/nomachine.pkg
        mode: '0644'
      when: not nomachine_installed_macos.stat.exists

    - name: Install NoMachine (macOS)
      ansible.builtin.command:
        cmd: installer -pkg /tmp/nomachine.pkg -target /
      become: yes
      when: not nomachine_installed_macos.stat.exists
      register: nomachine_install_macos

    - name: Ensure NoMachine service is running (macOS)
      ansible.builtin.command:
        cmd: launchctl load -w /Library/LaunchDaemons/com.nomachine.nxserver.plist
      become: yes
      when: nomachine_installed_macos.stat.exists or nomachine_install_macos is succeeded
      failed_when: false

  when: ansible_system == "Darwin"

- name: Verify NoMachine service status
  ansible.builtin.debug:
    msg:
      - "âœ… NoMachine server installed and configured"
      - "Service: {{ nomachine_service_name }}"
      - "Port: {{ nomachine_port }}"
      - "Connect to: {{ inventory_hostname }}.pangolin-vega.ts.net:{{ nomachine_port }}"

