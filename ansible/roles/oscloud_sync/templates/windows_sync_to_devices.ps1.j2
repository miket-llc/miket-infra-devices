# Auto-generated by Ansible
# Syncs OS cloud content to /space/devices on motoko via S: drive

function Write-Log {
    param($Message)
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] $Message"
    Write-Output $logMessage
    Add-Content -Path "C:\Scripts\oscloud-sync\sync.log" -Value $logMessage
}

Write-Log "Starting OS cloud sync to /space/devices..."

# Get hostname and username
$hostname = $env:COMPUTERNAME
$username = $env:USERNAME

# Verify S: is mapped
if (-not (Test-Path "S:\")) {
    Write-Log "ERROR: S: drive (SPACE) is not mapped. Cannot sync."
    exit 1
}

# Target base on S: drive
$targetBase = "S:\devices\$hostname\$username"

# Ensure target directory exists
if (-not (Test-Path $targetBase)) {
    New-Item -Path $targetBase -ItemType Directory -Force | Out-Null
    Write-Log "Created target directory: $targetBase"
}

# Robocopy common options
# /MIR = Mirror (includes deletions)
# /R:3 = Retry 3 times
# /W:5 = Wait 5 seconds between retries
# /NP = No progress (cleaner logs)
# /NFL = No file list (less verbose)
# /NDL = No directory list
# /XJ = Exclude junction points and symlinks (prevent loops!)
# /XA:SH = Exclude system and hidden files
# /XD = Exclude directories
$robocopyOpts = @(
    "/MIR",
    "/R:3",
    "/W:5",
    "/NP",
    "/NFL",
    "/NDL",
    "/XJ",
    "/XD", "flux", "space", "time",  # Exclude our symlinks
    "/XF", "*.tmp", "*.temp", "desktop.ini", "Thumbs.db", "~*"
)

# OneDrive Personal
$oneDrivePersonal = "$env:USERPROFILE\OneDrive"
if (Test-Path $oneDrivePersonal) {
    Write-Log "Syncing OneDrive Personal..."
    $oneDriveTarget = "$targetBase\onedrive-personal"
    
    # Ensure target exists
    if (-not (Test-Path $oneDriveTarget)) {
        New-Item -Path $oneDriveTarget -ItemType Directory -Force | Out-Null
    }
    
    $result = robocopy $oneDrivePersonal $oneDriveTarget @robocopyOpts
    $exitCode = $LASTEXITCODE
    
    # Robocopy exit codes: 0-7 are success/warnings, 8+ are errors
    if ($exitCode -lt 8) {
        Write-Log "OneDrive Personal sync complete (exit code: $exitCode)"
    } else {
        Write-Log "WARNING: OneDrive Personal sync completed with errors (exit code: $exitCode)"
    }
} else {
    Write-Log "OneDrive Personal not found."
}

# OneDrive Business (dynamic discovery)
$oneDriveBusinessFolders = Get-ChildItem "$env:USERPROFILE\OneDrive - *" -Directory -ErrorAction SilentlyContinue

foreach ($folder in $oneDriveBusinessFolders) {
    $orgName = $folder.Name -replace "OneDrive - ", ""
    Write-Log "Syncing OneDrive Business: $orgName..."
    $oneDriveTarget = "$targetBase\onedrive-business-$orgName"
    
    # Ensure target exists
    if (-not (Test-Path $oneDriveTarget)) {
        New-Item -Path $oneDriveTarget -ItemType Directory -Force | Out-Null
    }
    
    $result = robocopy $folder.FullName $oneDriveTarget @robocopyOpts
    $exitCode = $LASTEXITCODE
    
    if ($exitCode -lt 8) {
        Write-Log "OneDrive Business ($orgName) sync complete (exit code: $exitCode)"
    } else {
        Write-Log "WARNING: OneDrive Business ($orgName) sync completed with errors (exit code: $exitCode)"
    }
}

if ($oneDriveBusinessFolders.Count -eq 0) {
    Write-Log "OneDrive Business not found."
}

# iCloud Drive (if installed)
$iCloudPath = "$env:USERPROFILE\iCloudDrive"
if (Test-Path $iCloudPath) {
    Write-Log "Syncing iCloud Drive..."
    $iCloudTarget = "$targetBase\icloud"
    
    # Ensure target exists
    if (-not (Test-Path $iCloudTarget)) {
        New-Item -Path $iCloudTarget -ItemType Directory -Force | Out-Null
    }
    
    $result = robocopy $iCloudPath $iCloudTarget @robocopyOpts
    $exitCode = $LASTEXITCODE
    
    if ($exitCode -lt 8) {
        Write-Log "iCloud Drive sync complete (exit code: $exitCode)"
    } else {
        Write-Log "WARNING: iCloud Drive sync completed with errors (exit code: $exitCode)"
    }
} else {
    Write-Log "iCloud Drive not found or not installed."
}

Write-Log "OS cloud sync completed successfully."
Write-Log "Target: $targetBase"

# Upload log to Space for central visibility
$remoteLog = "$targetBase\_sync.log"
Copy-Item -Path "C:\Scripts\oscloud-sync\sync.log" -Destination $remoteLog -Force
Write-Log "Log uploaded to $remoteLog"


