#!/bin/bash
# Auto-generated by Ansible
# Syncs OS cloud content to /space/devices on motoko

# Log function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a ~/.scripts/oscloud-sync/sync.log
}

log "Starting OS cloud sync to /space/devices..."

# Get hostname and username
HOSTNAME=$(hostname -s)
USERNAME="$USER"
TARGET_BASE="/space/devices/${HOSTNAME}/${USERNAME}"

# Verify /space is mounted at ~/.mkt/space
SPACE_MOUNT="${HOME}/.mkt/space"

if ! mount | grep -q "on ${SPACE_MOUNT} "; then
    log "ERROR: /space is not mounted at ${SPACE_MOUNT}. Cannot sync."
    exit 1
fi

# Double-check the mount is actually accessible
if [ ! -d "$SPACE_MOUNT" ] || [ ! -w "$SPACE_MOUNT" ]; then
    log "ERROR: $SPACE_MOUNT is not accessible or writable. Cannot sync."
    exit 1
fi

# Ensure target directory exists on mounted /space
MOUNTED_TARGET="${SPACE_MOUNT}/devices/${HOSTNAME}/${USERNAME}"
mkdir -p "$MOUNTED_TARGET"

# Rsync common options
RSYNC_OPTS=(
    -av                          # Archive mode, verbose
    --delete                     # Mirror deletions
    --no-links                   # Don't copy symlinks (prevent loops!)
    --size-only                  # Compare by size (faster, good enough for cloud files)
    --exclude='*.tmp'
    --exclude='*.temp'
    --exclude='.DS_Store'
    --exclude='desktop.ini'
    --exclude='Thumbs.db'
    --exclude='~*'
    --exclude='flux'             # Exclude our symlinks
    --exclude='space'
    --exclude='time'
    --stats                      # Show transfer statistics
)

# iCloud Drive
ICLOUD_PATH="${HOME}/Library/Mobile Documents/com~apple~CloudDocs"
if [ -d "$ICLOUD_PATH" ]; then
    log "Syncing iCloud Drive..."
    ICLOUD_TARGET="${MOUNTED_TARGET}/icloud"
    mkdir -p "$ICLOUD_TARGET"
    
    rsync "${RSYNC_OPTS[@]}" \
        "$ICLOUD_PATH/" \
        "$ICLOUD_TARGET/" 2>&1 | tee -a ~/.scripts/oscloud-sync/sync.log || log "iCloud sync completed with warnings"
    
    log "iCloud Drive sync complete."
else
    log "iCloud Drive not found or not enabled."
fi

# OneDrive Personal
ONEDRIVE_PERSONAL="${HOME}/OneDrive"
if [ -d "$ONEDRIVE_PERSONAL" ]; then
    log "Syncing OneDrive Personal..."
    ONEDRIVE_TARGET="${MOUNTED_TARGET}/onedrive-personal"
    mkdir -p "$ONEDRIVE_TARGET"
    
    rsync "${RSYNC_OPTS[@]}" \
        "$ONEDRIVE_PERSONAL/" \
        "$ONEDRIVE_TARGET/" 2>&1 | tee -a ~/.scripts/oscloud-sync/sync.log || log "OneDrive Personal sync completed with warnings"
    
    log "OneDrive Personal sync complete."
else
    log "OneDrive Personal not found."
fi

# OneDrive Business (dynamic discovery)
# Prioritize active accounts and skip .old folders
for ONEDRIVE_BIZ in "${HOME}/Library/CloudStorage/OneDrive-"*; do
    if [ -d "$ONEDRIVE_BIZ" ]; then
        ORG_NAME=$(basename "$ONEDRIVE_BIZ" | sed 's/OneDrive-//')
        
        # Skip .old folders
        if [[ "$ORG_NAME" == *.old ]]; then
            log "Skipping OneDrive Business (${ORG_NAME}) - marked as old"
            continue
        fi
        
        log "Syncing OneDrive Business (${ORG_NAME})..."
        
        ONEDRIVE_BIZ_TARGET="${MOUNTED_TARGET}/onedrive-business"
        mkdir -p "$ONEDRIVE_BIZ_TARGET"
        
        rsync "${RSYNC_OPTS[@]}" \
            "$ONEDRIVE_BIZ/" \
            "$ONEDRIVE_BIZ_TARGET/" 2>&1 | tee -a ~/.scripts/oscloud-sync/sync.log || log "OneDrive Business sync completed with warnings"
        
        log "OneDrive Business sync complete."
        break  # Only sync first active business account found
    fi
done

log "OS cloud sync completed successfully."
log "Target: ${MOUNTED_TARGET}"

# Upload log to Space for central visibility
cp ~/.scripts/oscloud-sync/sync.log "${MOUNTED_TARGET}/_sync.log"
log "Log uploaded to ${MOUNTED_TARGET}/_sync.log"

