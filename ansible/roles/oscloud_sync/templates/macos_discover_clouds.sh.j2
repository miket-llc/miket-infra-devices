#!/bin/bash
# Auto-generated by Ansible
# Discovers OS cloud storage roots on macOS

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

log "Discovering OS cloud storage locations..."

# Output JSON format for easy parsing
echo "{"

# iCloud Drive
ICLOUD_PATH="${HOME}/Library/Mobile Documents/com~apple~CloudDocs"
if [ -d "$ICLOUD_PATH" ]; then
    log "Found iCloud Drive: $ICLOUD_PATH"
    echo "  \"icloud\": \"$ICLOUD_PATH\","
fi

# OneDrive Personal
ONEDRIVE_PERSONAL="${HOME}/OneDrive"
if [ -d "$ONEDRIVE_PERSONAL" ]; then
    log "Found OneDrive Personal: $ONEDRIVE_PERSONAL"
    echo "  \"onedrive_personal\": \"$ONEDRIVE_PERSONAL\","
fi

# OneDrive Business (dynamic discovery)
ONEDRIVE_BUSINESS=""
for dir in "${HOME}/Library/CloudStorage/OneDrive-"*; do
    if [ -d "$dir" ]; then
        ONEDRIVE_BUSINESS="$dir"
        log "Found OneDrive Business: $ONEDRIVE_BUSINESS"
        # Extract org name from path
        ORG_NAME=$(basename "$dir" | sed 's/OneDrive-//')
        echo "  \"onedrive_business\": \"$ONEDRIVE_BUSINESS\","
        echo "  \"onedrive_business_org\": \"$ORG_NAME\","
        break
    fi
done

# Sentinel
echo "  \"hostname\": \"$(hostname -s)\","
echo "  \"username\": \"$USER\","
echo "  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\""

echo "}"

log "Discovery complete."

