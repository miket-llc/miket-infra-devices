# Copyright (c) 2025 MikeT LLC. All rights reserved.
# roles/firewalld_tailnet/tasks/main.yml
---
- name: Ensure firewalld is installed
  ansible.builtin.dnf:
    name: firewalld
    state: present

- name: Enable and start firewalld
  ansible.builtin.systemd:
    name: firewalld
    enabled: true
    state: started

- name: Create tailnet zone
  ansible.posix.firewalld:
    zone: "{{ firewalld_tailnet_zone }}"
    state: present
    permanent: true
  register: zone_created

- name: Reload firewalld to register new zone
  ansible.builtin.command: firewall-cmd --reload
  changed_when: true
  when: zone_created.changed

- name: Ensure firewalld is fully reloaded
  ansible.builtin.command: firewall-cmd --reload
  changed_when: false

- name: Add tailnet source CIDR to tailnet zone
  ansible.builtin.command: >
    firewall-cmd --permanent --zone={{ firewalld_tailnet_zone }}
    --add-source={{ tailnet_cidr }}
  register: add_source
  changed_when: "'ALREADY_ENABLED' not in add_source.stderr"
  failed_when: add_source.rc != 0 and 'ALREADY_ENABLED' not in add_source.stderr

- name: Add tailscale interface to tailnet zone
  ansible.builtin.command: >
    firewall-cmd --permanent --zone={{ firewalld_tailnet_zone }}
    --add-interface={{ tailscale_interface }}
  register: add_interface
  changed_when: "'ALREADY_ENABLED' not in add_interface.stderr"
  failed_when: false  # Interface may not exist yet

- name: Allow services in tailnet zone
  ansible.builtin.command: >
    firewall-cmd --permanent --zone={{ firewalld_tailnet_zone }}
    --add-service={{ item }}
  loop: "{{ tailnet_services }}"
  register: add_service
  changed_when: "'ALREADY_ENABLED' not in add_service.stderr"
  failed_when: add_service.rc != 0 and 'ALREADY_ENABLED' not in add_service.stderr

- name: Allow custom ports in tailnet zone
  ansible.builtin.command: >
    firewall-cmd --permanent --zone={{ firewalld_tailnet_zone }}
    --add-port={{ item.port }}/{{ item.protocol }}
  loop: "{{ tailnet_ports }}"
  when: tailnet_ports | length > 0
  register: add_port
  changed_when: "'ALREADY_ENABLED' not in add_port.stderr"
  failed_when: add_port.rc != 0 and 'ALREADY_ENABLED' not in add_port.stderr

- name: Remove SSH from public zone (tailnet-only access)
  ansible.builtin.command: >
    firewall-cmd --permanent --zone={{ firewalld_default_zone }}
    --remove-service=ssh
  register: remove_ssh
  changed_when: "'NOT_ENABLED' not in remove_ssh.stderr"
  failed_when: remove_ssh.rc != 0 and 'NOT_ENABLED' not in remove_ssh.stderr

- name: Remove SSH from FedoraServer zone (modern Fedora default)
  ansible.builtin.command: >
    firewall-cmd --permanent --zone=FedoraServer
    --remove-service=ssh
  register: remove_ssh_fedora
  changed_when: "'NOT_ENABLED' not in remove_ssh_fedora.stderr"
  failed_when: remove_ssh_fedora.rc != 0 and 'NOT_ENABLED' not in remove_ssh_fedora.stderr

- name: Apply firewall changes
  ansible.builtin.command: firewall-cmd --reload
  changed_when: true

- name: Set default zone to public
  ansible.builtin.command: firewall-cmd --set-default-zone={{ firewalld_default_zone }}
  changed_when: false

- name: Display firewall configuration
  ansible.builtin.command: firewall-cmd --list-all-zones
  register: firewall_zones
  changed_when: false

- name: Show firewall status
  ansible.builtin.debug:
    msg: |
      Firewall Configuration:
      - Default zone: {{ firewalld_default_zone }}
      - Tailnet zone: {{ firewalld_tailnet_zone }}
      - Tailnet CIDR: {{ tailnet_cidr }}
      - Tailnet services: {{ tailnet_services | join(', ') }}
      - SSH accessible ONLY via tailnet

