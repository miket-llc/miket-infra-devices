# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# Comprehensive VNC removal - stop all VNC services and remove packages
- name: Stop and disable TigerVNC service
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: stopped
    enabled: false
  become: true
  failed_when: false
  loop:
    - tigervnc.service
    - x11vnc.service
    - vncserver@.service
    - vino-server.service

- name: Stop GNOME Remote Desktop (uses VNC/RDP protocols)
  ansible.builtin.systemd:
    name: gnome-remote-desktop.service
    state: stopped
    enabled: false
    scope: user
  become: true
  become_user: "{{ ansible_user_id }}"
  failed_when: false

- name: Disable GNOME screen sharing in settings
  ansible.builtin.shell: |
    gsettings set org.gnome.desktop.remote-desktop.vnc enable false 2>/dev/null || true
    gsettings set org.gnome.desktop.remote-desktop.rdp enable false 2>/dev/null || true
  become: true
  become_user: "{{ ansible_user_id }}"
  failed_when: false
  changed_when: false

- name: Remove VNC server packages (apt-based systems)
  ansible.builtin.apt:
    name:
      - tigervnc-standalone-server
      - tigervnc-common
      - x11vnc
      - vino
      - tightvncserver
      - vnc4server
    state: absent
    autoremove: yes
  become: true
  when: ansible_pkg_mgr == "apt"
  failed_when: false

- name: Remove VNC firewall rules from UFW
  ansible.builtin.shell: |
    while sudo ufw status numbered 2>/dev/null | grep -E "5900|5901|5902|5903"; do
      RULE_NUM=$(sudo ufw status numbered 2>/dev/null | grep -E "5900|5901|5902|5903" | head -1 | sed -n 's/\[ *\([0-9]*\)\].*/\1/p')
      if [ -n "$RULE_NUM" ]; then
        echo "y" | sudo ufw delete "$RULE_NUM" 2>/dev/null || break
      else
        break
      fi
    done
    echo "VNC firewall rules removed"
  become: true
  when: ansible_pkg_mgr == "apt"
  changed_when: false
  failed_when: false

- name: Verify no VNC ports are listening
  ansible.builtin.shell: |
    if ss -tulnp | grep -E ':(5900|5901|5902|5903)'; then
      echo "WARNING: VNC ports still listening"
      exit 1
    else
      echo "OK: No VNC ports listening"
      exit 0
    fi
  register: vnc_port_check
  changed_when: false
  failed_when: false

# Display Manager Configuration - ensure single DM for KDE
# Pop!_OS/Ubuntu may have GDM3 installed alongside SDDM - this causes conflicts
- name: Check if GDM3 is installed
  ansible.builtin.command:
    cmd: systemctl list-unit-files gdm3.service
  register: gdm3_check
  changed_when: false
  failed_when: false

- name: Stop and disable GDM3 if present (conflicts with SDDM/KDE)
  ansible.builtin.systemd:
    name: gdm3
    state: stopped
    enabled: false
    masked: true
  become: true
  when: gdm3_check.rc == 0 and 'gdm3.service' in gdm3_check.stdout
  failed_when: false

- name: Check if SDDM is the display manager
  ansible.builtin.stat:
    path: /usr/bin/sddm
  register: sddm_installed

- name: Configure SDDM autologin for KDE (if SDDM present)
  ansible.builtin.copy:
    dest: /etc/sddm.conf.d/autologin.conf
    content: |
      [Autologin]
      User={{ ansible_user_id }}
      Session=plasma
      Relogin=false

      [General]
      HaltCommand=/usr/bin/systemctl poweroff
      RebootCommand=/usr/bin/systemctl reboot

      [Theme]
      Current=breeze
    mode: '0644'
  become: true
  when: sddm_installed.stat.exists
  notify: restart sddm

# NoMachine installation from apt.iteas.at mirror (official packages)
# See: docs/runbooks/nomachine-installer-sources.md for source documentation
# Primary: https://apt.iteas.at/iteas/pool/main/n/nomachine/
# Fallback: /space/installers/ (local cache per PHC storage invariants)
- name: Check for cached installer in /space/installers (.deb)
  ansible.builtin.stat:
    path: "/space/installers/nomachine_{{ nomachine_version }}_3_amd64.deb"
  register: cached_deb_installer

- name: Download NoMachine .deb from iteas.at mirror if not cached
  ansible.builtin.get_url:
    url: "https://apt.iteas.at/iteas/pool/main/n/nomachine/nomachine_{{ nomachine_version }}_3_amd64.deb"
    dest: "/tmp/nomachine_{{ nomachine_version }}_3_amd64.deb"
    mode: '0644'
    timeout: 60
  become: true
  when: not cached_deb_installer.stat.exists
  register: nomachine_download

- name: Copy cached installer to /tmp if available
  ansible.builtin.copy:
    src: "/space/installers/nomachine_{{ nomachine_version }}_3_amd64.deb"
    dest: "/tmp/nomachine_{{ nomachine_version }}_3_amd64.deb"
    mode: '0644'
    remote_src: yes
  become: true
  when: cached_deb_installer.stat.exists

- name: Install NoMachine via dpkg
  ansible.builtin.apt:
    deb: "/tmp/nomachine_{{ nomachine_version }}_3_amd64.deb"
  become: true

- name: Fix any missing dependencies
  ansible.builtin.apt:
    name: []
    state: fixed
  become: true
  failed_when: false

- name: Get Tailscale IP address
  ansible.builtin.command:
    cmd: tailscale ip -4
  register: tailscale_ip
  changed_when: false
  failed_when: false

- name: Configure NoMachine to bind to Tailscale interface only
  ansible.builtin.lineinfile:
    path: /usr/NX/etc/server.cfg
    regexp: '^NXDListenAddress'
    line: "NXDListenAddress {{ tailscale_ip.stdout }}"
    backup: yes
  become: true
  when: tailscale_ip.stdout != ""
  notify: restart nxserver

- name: Configure NoMachine to accept connections from Tailscale subnet only
  ansible.builtin.lineinfile:
    path: /usr/NX/etc/server.cfg
    regexp: '^AcceptFrom'
    line: 'AcceptFrom 100.64.0.0/10'
    backup: yes
  become: true
  notify: restart nxserver

- name: Configure NoMachine to attach to display :0
  ansible.builtin.lineinfile:
    path: /usr/NX/etc/server.cfg
    regexp: '^#?EnableNXDisplayOutput='
    line: 'EnableNXDisplayOutput=1'
    backup: yes
  become: true
  notify: restart nxserver

- name: Enable new session creation
  ansible.builtin.lineinfile:
    path: /usr/NX/etc/server.cfg
    regexp: '^#?EnableNewSession='
    line: 'EnableNewSession 1'
    backup: yes
  become: true
  notify: restart nxserver

- name: Enable console session sharing
  ansible.builtin.lineinfile:
    path: /usr/NX/etc/server.cfg
    regexp: '^#?EnableConsoleSessionSharing='
    line: 'EnableConsoleSessionSharing 1'
    backup: yes
  become: true
  notify: restart nxserver

- name: Enable session sharing
  ansible.builtin.lineinfile:
    path: /usr/NX/etc/server.cfg
    regexp: '^#?EnableSessionSharing='
    line: 'EnableSessionSharing 1'
    backup: yes
  become: true
  notify: restart nxserver

# PHC: Force physical desktop - prevents virtual display creation
# See: docs/runbooks/fix-motoko-nomachine-kde-lockscreen.md
- name: Configure NoMachine to prefer physical desktop
  ansible.builtin.lineinfile:
    path: /usr/NX/etc/server.cfg
    regexp: '^#?PhysicalDesktopMode'
    line: 'PhysicalDesktopMode 2'
    backup: yes
  become: true
  notify: restart nxserver

- name: Disable virtual display creation
  ansible.builtin.lineinfile:
    path: /usr/NX/etc/server.cfg
    regexp: '^#?CreateDisplay'
    line: 'CreateDisplay 0'
    backup: yes
  become: true
  notify: restart nxserver

- name: Ensure NoMachine service is enabled and started
  ansible.builtin.systemd:
    name: nxserver
    enabled: true
    state: started
    daemon_reload: yes
  become: true

- name: Configure Firewall (UFW)
  community.general.ufw:
    rule: allow
    port: "{{ nomachine_port }}"
    proto: tcp
    src: "100.64.0.0/10"
    comment: "Allow NoMachine from Tailscale"
  become: true
  when: ansible_pkg_mgr == 'apt'
  ignore_errors: true

- name: Configure Firewall (Firewalld)
  ansible.posix.firewalld:
    port: "{{ nomachine_port }}/tcp"
    source: "100.64.0.0/10"
    permanent: true
    immediate: true
    state: enabled
    zone: public
  become: true
  when: ansible_pkg_mgr == 'dnf' or ansible_pkg_mgr == 'yum'
  ignore_errors: true

- name: Wait for NoMachine to be accessible
  ansible.builtin.wait_for:
    host: localhost
    port: "{{ nomachine_port }}"
    delay: 2
    timeout: 10
  register: nomachine_port_check
  failed_when: false

- name: Display connection information
  ansible.builtin.debug:
    msg:
      - "âœ… NoMachine server configured for X11 session sharing"
      - "VNC has been stopped and disabled"
      - "Connect via NoMachine to: {{ inventory_hostname }}.pangolin-vega.ts.net:{{ nomachine_port }}"
