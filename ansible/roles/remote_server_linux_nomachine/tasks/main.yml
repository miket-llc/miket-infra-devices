---
# Comprehensive VNC removal - stop all VNC services and remove packages
- name: Stop and disable TigerVNC service
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: stopped
    enabled: false
  become: true
  failed_when: false
  loop:
    - tigervnc.service
    - x11vnc.service
    - vncserver@.service
    - vino-server.service

- name: Stop GNOME Remote Desktop (uses VNC/RDP protocols)
  ansible.builtin.systemd:
    name: gnome-remote-desktop.service
    state: stopped
    enabled: false
    scope: user
  become: true
  become_user: "{{ ansible_user_id }}"
  failed_when: false

- name: Disable GNOME screen sharing in settings
  ansible.builtin.shell: |
    gsettings set org.gnome.desktop.remote-desktop.vnc enable false 2>/dev/null || true
    gsettings set org.gnome.desktop.remote-desktop.rdp enable false 2>/dev/null || true
  become: true
  become_user: "{{ ansible_user_id }}"
  failed_when: false
  changed_when: false

- name: Remove VNC server packages (apt-based systems)
  ansible.builtin.apt:
    name:
      - tigervnc-standalone-server
      - tigervnc-common
      - x11vnc
      - vino
      - tightvncserver
      - vnc4server
    state: absent
    autoremove: yes
  become: true
  when: ansible_pkg_mgr == "apt"
  failed_when: false

- name: Remove VNC firewall rules from UFW
  ansible.builtin.shell: |
    while sudo ufw status numbered 2>/dev/null | grep -E "5900|5901|5902|5903"; do
      RULE_NUM=$(sudo ufw status numbered 2>/dev/null | grep -E "5900|5901|5902|5903" | head -1 | sed -n 's/\[ *\([0-9]*\)\].*/\1/p')
      if [ -n "$RULE_NUM" ]; then
        echo "y" | sudo ufw delete "$RULE_NUM" 2>/dev/null || break
      else
        break
      fi
    done
    echo "VNC firewall rules removed"
  become: true
  when: ansible_pkg_mgr == "apt"
  changed_when: false
  failed_when: false

- name: Verify no VNC ports are listening
  ansible.builtin.shell: |
    if ss -tulnp | grep -E ':(5900|5901|5902|5903)'; then
      echo "WARNING: VNC ports still listening"
      exit 1
    else
      echo "OK: No VNC ports listening"
      exit 0
    fi
  register: vnc_port_check
  changed_when: false
  failed_when: false

- name: Download NoMachine installer (.run format)
  ansible.builtin.shell: |
    cd /tmp
    curl -L -f -o nomachine_{{ nomachine_version }}_4_x86_64.run "https://download.nomachine.com/download/8.x/Linux/nomachine_{{ nomachine_version }}_4_x86_64.run" || \
    wget -O nomachine_{{ nomachine_version }}_4_x86_64.run "https://download.nomachine.com/download/8.x/Linux/nomachine_{{ nomachine_version }}_4_x86_64.run"
    chmod +x nomachine_{{ nomachine_version }}_4_x86_64.run
  args:
    creates: "/tmp/nomachine_{{ nomachine_version }}_4_x86_64.run"
  become: true
  register: nomachine_download

- name: Install NoMachine
  ansible.builtin.command:
    cmd: "/tmp/nomachine_{{ nomachine_version }}_4_x86_64.run install"
    creates: "/usr/NX/bin/nxserver"
  become: true

- name: Configure NoMachine to attach to display :0
  ansible.builtin.lineinfile:
    path: /usr/NX/etc/server.cfg
    regexp: '^#?EnableNXDisplayOutput='
    line: 'EnableNXDisplayOutput=1'
    backup: yes
  become: true
  notify: restart nxserver

- name: Ensure NoMachine service is enabled and started
  ansible.builtin.systemd:
    name: nxserver
    enabled: true
    state: started
    daemon_reload: yes
  become: true

- name: Wait for NoMachine to be accessible
  ansible.builtin.wait_for:
    host: localhost
    port: "{{ nomachine_port }}"
    delay: 2
    timeout: 10
  register: nomachine_port_check
  failed_when: false

- name: Display connection information
  ansible.builtin.debug:
    msg:
      - "âœ… NoMachine server configured to share existing GNOME session"
      - "VNC has been stopped and disabled"
      - "Connect via NoMachine to: {{ inventory_hostname }}.pangolin-vega.ts.net:{{ nomachine_port }}"
