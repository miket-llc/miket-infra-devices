# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# =============================================================================
# NETDATA CLOUD CLAIMING TASKS
# =============================================================================
#
# Claims Netdata agents to Netdata Cloud (Homelab Space) via ACLK.
# Uses the official kickstart script which handles both fresh installs
# and claiming of existing installations.
#
# =============================================================================

# ========================================
# Check Current Claiming Status
# ========================================
- name: Check if agent is already claimed to Cloud (via API)
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ netdata_web_port }}/api/v1/info"
    return_content: true
  register: netdata_info
  failed_when: false
  changed_when: false
  when: ansible_system != 'Win32NT'
  tags: [netdata, cloud, claim]

- name: Parse claim status from API
  ansible.builtin.set_fact:
    netdata_is_claimed: "{{ (netdata_info.json['agent-claimed'] | default(false)) | bool }}"
    netdata_aclk_online: "{{ (netdata_info.json['aclk-available'] | default(false)) | bool }}"
  when:
    - ansible_system != 'Win32NT'
    - netdata_info.status == 200
  tags: [netdata, cloud, claim]

- name: Display current Cloud status
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════════
      NETDATA CLOUD STATUS: {{ inventory_hostname }}
      ═══════════════════════════════════════════════════════════════
      
      Version: {{ netdata_info.json.version | default('unknown') }}
      Cloud Enabled: {{ netdata_info.json['cloud-enabled'] | default('unknown') }}
      Agent Claimed: {{ netdata_is_claimed | default('unknown') }}
      ACLK Online: {{ netdata_aclk_online | default('unknown') }}
      
      ═══════════════════════════════════════════════════════════════
  when:
    - ansible_system != 'Win32NT'
    - netdata_info.status == 200
  tags: [netdata, cloud, claim]

# ========================================
# Claim Agent to Netdata Cloud (Linux/macOS)
# ========================================
# The kickstart script handles both fresh installs AND claiming existing
# installations. This is the most reliable method.

- name: Claim agent to Netdata Cloud via kickstart (Linux/macOS)
  ansible.builtin.shell: |
    wget -O /tmp/netdata-kickstart.sh {{ netdata_kickstart_url }} && \
    sh /tmp/netdata-kickstart.sh \
      --stable-channel \
      --claim-token {{ netdata_cloud_claim_token }} \
      --claim-rooms {{ netdata_cloud_rooms }} \
      --claim-url {{ netdata_cloud_claim_url }}
  register: claim_result
  changed_when: "'Successfully' in claim_result.stdout or 'is claimed' in claim_result.stdout"
  when:
    - ansible_system != 'Win32NT'
    - not (netdata_is_claimed | default(false))
    - netdata_cloud_claim_token | default('') | length > 0
    - netdata_cloud_rooms | default('') | length > 0
  tags: [netdata, cloud, claim]

- name: Display claim result
  ansible.builtin.debug:
    msg: "{{ claim_result.stdout_lines | default(['Claim skipped - already claimed or missing token']) | last }}"
  when:
    - ansible_system != 'Win32NT'
    - claim_result is defined
  tags: [netdata, cloud, claim]

# ========================================
# Verify ACLK Connection
# ========================================
- name: Wait for ACLK to connect
  ansible.builtin.pause:
    seconds: 10
    prompt: "Waiting for ACLK connection to establish..."
  when:
    - claim_result is defined
    - claim_result.changed | default(false)
  tags: [netdata, cloud, claim]

- name: Verify ACLK connection after claiming
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ netdata_web_port }}/api/v1/info"
    return_content: true
  register: verify_info
  failed_when: false
  changed_when: false
  when: ansible_system != 'Win32NT'
  tags: [netdata, cloud, claim]

- name: Display final ACLK status
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════════
      NETDATA CLOUD CLAIMING COMPLETE: {{ inventory_hostname }}
      ═══════════════════════════════════════════════════════════════
      
      Agent Claimed: {{ verify_info.json['agent-claimed'] | default('unknown') }}
      ACLK Available: {{ verify_info.json['aclk-available'] | default('unknown') }}
      
      View this node at: https://app.netdata.cloud
      ═══════════════════════════════════════════════════════════════
  when:
    - ansible_system != 'Win32NT'
    - verify_info.status == 200
  tags: [netdata, cloud, claim]

# ========================================
# Windows Claiming
# ========================================
- name: Check Windows agent Cloud status
  ansible.windows.win_shell: |
    try {
      $info = Invoke-WebRequest -Uri "http://127.0.0.1:19999/api/v1/info" -UseBasicParsing | ConvertFrom-Json
      Write-Output "CLAIMED:$($info.'agent-claimed')"
      Write-Output "ACLK:$($info.'aclk-available')"
    } catch {
      Write-Output "CLAIMED:False"
      Write-Output "ACLK:False"
    }
  register: win_cloud_status
  changed_when: false
  failed_when: false
  when: ansible_system == 'Win32NT'
  tags: [netdata, cloud, claim]

- name: Parse Windows claim status
  ansible.builtin.set_fact:
    netdata_is_claimed: "{{ 'CLAIMED:True' in win_cloud_status.stdout | default('') }}"
  when: ansible_system == 'Win32NT'
  tags: [netdata, cloud, claim]

- name: Install and claim Windows agent to Netdata Cloud
  ansible.windows.win_shell: |
    $ProgressPreference = 'SilentlyContinue'
    Invoke-WebRequest https://github.com/netdata/netdata/releases/latest/download/netdata-x64.msi -OutFile "$env:TEMP\netdata-x64.msi"
    Start-Process msiexec.exe -ArgumentList "/qn /i `"$env:TEMP\netdata-x64.msi`" TOKEN={{ netdata_cloud_claim_token }} ROOMS={{ netdata_cloud_rooms }}" -Wait -NoNewWindow
  register: win_claim_result
  when:
    - ansible_system == 'Win32NT'
    - not (netdata_is_claimed | default(false))
    - netdata_cloud_claim_token | default('') | length > 0
  tags: [netdata, cloud, claim]

- name: Wait for Windows Netdata to start
  ansible.builtin.pause:
    seconds: 30
    prompt: "Waiting for Windows Netdata to start and claim..."
  when:
    - ansible_system == 'Win32NT'
    - win_claim_result is defined
    - win_claim_result.changed | default(false)
  tags: [netdata, cloud, claim]
