# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# =============================================================================
# NETDATA MACOS INSTALLATION TASKS
# =============================================================================
#
# Installs Netdata on macOS using Homebrew
# Configures as child node streaming to motoko parent
#
# Note: macOS tasks run without become (sudo) per count-zero host config
#
# =============================================================================

# ========================================
# Pre-requisites
# ========================================

- name: Check if Homebrew is installed
  ansible.builtin.command: which brew
  register: homebrew_check
  changed_when: false
  failed_when: false
  tags: [netdata, install]

- name: Fail if Homebrew is not installed
  ansible.builtin.fail:
    msg: |
      Homebrew is required but not installed on {{ inventory_hostname }}.
      Please install Homebrew first: https://brew.sh
  when: homebrew_check.rc != 0
  tags: [netdata, install]

# ========================================
# Installation
# ========================================

- name: Install Netdata via Homebrew
  community.general.homebrew:
    name: netdata
    state: present
  tags: [netdata, install]

# ========================================
# Configuration Directories
# ========================================

- name: Get Homebrew prefix
  ansible.builtin.command: brew --prefix
  register: brew_prefix
  changed_when: false
  tags: [netdata, configure]

- name: Set Netdata config path fact
  ansible.builtin.set_fact:
    netdata_config_dir: "{{ brew_prefix.stdout }}/etc/netdata"
    netdata_bin_path: "{{ brew_prefix.stdout }}/sbin/netdata"
  tags: [netdata, configure]

- name: Ensure Netdata config directory exists
  ansible.builtin.file:
    path: "{{ netdata_config_dir }}"
    state: directory
    mode: '0755'
  tags: [netdata, configure]

# ========================================
# Configuration
# ========================================

- name: Deploy netdata.conf (macOS)
  ansible.builtin.template:
    src: netdata.conf.j2
    dest: "{{ netdata_config_dir }}/netdata.conf"
    mode: '0644'
    backup: true
  notify: Restart netdata macos
  tags: [netdata, configure]

- name: Deploy stream.conf (macOS)
  ansible.builtin.template:
    src: stream.conf.j2
    dest: "{{ netdata_config_dir }}/stream.conf"
    mode: '0640'
    backup: true
  notify: Restart netdata macos
  tags: [netdata, configure]

# ========================================
# Service Management (launchd via brew services)
# ========================================

- name: Start Netdata service via Homebrew
  ansible.builtin.command: brew services start netdata
  register: netdata_start
  changed_when: "'Successfully started' in netdata_start.stdout or 'already started' not in netdata_start.stderr"
  failed_when: false
  tags: [netdata, service]

- name: Restart Netdata service via Homebrew
  ansible.builtin.command: brew services restart netdata
  changed_when: true
  listen: Restart netdata macos
  tags: [netdata, service]

# ========================================
# Firewall Notes (macOS)
# ========================================
# macOS application firewall (socketfilterfw) doesn't easily support
# port-based rules via Ansible. The Tailscale network is trusted, and
# macOS generally allows outbound connections. For inbound, the app
# will be prompted on first connection.
#
# Document: Manual verification that Netdata is allowed through firewall
# may be needed. Access Settings > Privacy & Security > Firewall.

- name: Display macOS firewall note
  ansible.builtin.debug:
    msg: |
      NOTE: macOS Application Firewall may prompt for Netdata access.
      If the Netdata UI is not accessible via Tailscale IP, check:
      System Settings > Privacy & Security > Firewall > Options
      Ensure Netdata is set to "Allow incoming connections"
  tags: [netdata, firewall]

# ========================================
# Verification
# ========================================

- name: Wait for Netdata to be ready (macOS)
  ansible.builtin.wait_for:
    port: "{{ netdata_web_port }}"
    host: 127.0.0.1
    timeout: 60
  tags: [netdata, verify]

- name: Verify Netdata is responding (macOS)
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ netdata_web_port }}/api/v1/info"
    return_content: true
  register: netdata_info_mac
  failed_when: false
  changed_when: false
  tags: [netdata, verify]

- name: Display Netdata status (macOS)
  ansible.builtin.debug:
    msg: |
      Netdata Status: {{ 'RUNNING' if netdata_info_mac.status == 200 else 'NOT RESPONDING' }}
      {% if netdata_info_mac.status == 200 %}
      Version: {{ (netdata_info_mac.content | from_json).version | default('unknown') }}
      {% endif %}
      
      Access via Tailscale: http://{{ netdata_tailscale_ip | default('count-zero.pangolin-vega.ts.net') }}:{{ netdata_web_port }}
  tags: [netdata, verify]

