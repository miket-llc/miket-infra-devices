# Copyright (c) 2025 MikeT LLC. All rights reserved.

---
# =============================================================================
# NETDATA ROLE - MAIN ENTRY POINT
# =============================================================================
#
# Netdata Cloud-centric monitoring (Homelab subscription)
#
# Architecture:
#   - Each node runs a standalone Netdata Agent
#   - All agents claimed to Netdata Cloud via ACLK
#   - Cloud is the primary monitoring UI
#   - Local dashboards are secondary (break-glass, tailnet-only)
#
# =============================================================================

- name: Display netdata deployment info
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════════
      NETDATA DEPLOYMENT (Cloud-Centric)
      ═══════════════════════════════════════════════════════════════
      
      Host:     {{ inventory_hostname }}
      OS:       {{ ansible_system }} / {{ ansible_os_family | default('Unknown') }}
      Channel:  {{ netdata_channel | upper }}
      
      Mode:     Standalone Agent → Netdata Cloud (Homelab)
      Cloud:    {{ 'ENABLED' if netdata_cloud_enabled else 'DISABLED' }}
      
      Primary UI: Netdata Cloud (app.netdata.cloud)
      Local UI:   Secondary (break-glass, tailnet-only)
      
      ═══════════════════════════════════════════════════════════════
  tags: [always]

# ========================================
# Gather Tailscale IP if not set
# ========================================
- name: Get Tailscale IP from tailscale status
  ansible.builtin.command: tailscale ip -4
  register: tailscale_ip_result
  changed_when: false
  failed_when: false
  when:
    - netdata_tailscale_ip is not defined
    - ansible_system != 'Win32NT'
  tags: [netdata, install, configure]

- name: Set Tailscale IP fact (Linux/macOS)
  ansible.builtin.set_fact:
    netdata_tailscale_ip: "{{ tailscale_ip_result.stdout | trim }}"
  when:
    - netdata_tailscale_ip is not defined
    - tailscale_ip_result is defined
    - tailscale_ip_result.rc == 0
  tags: [netdata, install, configure]

- name: Get Tailscale IP (Windows)
  ansible.windows.win_shell: |
    tailscale ip -4
  register: tailscale_ip_win_result
  changed_when: false
  failed_when: false
  when:
    - netdata_tailscale_ip is not defined
    - ansible_system == 'Win32NT'
  tags: [netdata, install]

- name: Set Tailscale IP fact (Windows)
  ansible.builtin.set_fact:
    netdata_tailscale_ip: "{{ tailscale_ip_win_result.stdout | trim }}"
  when:
    - netdata_tailscale_ip is not defined
    - tailscale_ip_win_result is defined
    - tailscale_ip_win_result.rc == 0
  tags: [netdata, install]

# ========================================
# Route to Platform-Specific Tasks
# ========================================
- name: Include Linux tasks
  ansible.builtin.include_tasks: linux.yml
  when: ansible_system == 'Linux'
  tags: [netdata, install, configure]

- name: Include macOS tasks
  ansible.builtin.include_tasks: darwin.yml
  when: ansible_system == 'Darwin'
  tags: [netdata, install, configure]

- name: Include Windows tasks
  ansible.builtin.include_tasks: windows.yml
  when:
    - ansible_system == 'Win32NT'
    - netdata_enable_windows_agent | default(true)
  tags: [netdata, install, configure]

# ========================================
# Cloud Claiming (all platforms)
# ========================================
- name: Include Cloud claiming tasks
  ansible.builtin.include_tasks: claim.yml
  when:
    - netdata_cloud_enabled | bool
    - netdata_cloud_claim_token | length > 0
    - netdata_cloud_rooms | length > 0
  tags: [netdata, cloud, claim]

# ========================================
# Validation (all platforms)
# ========================================
- name: Display deployment summary
  ansible.builtin.debug:
    msg: |
      ═══════════════════════════════════════════════════════════════
      NETDATA DEPLOYMENT COMPLETE
      ═══════════════════════════════════════════════════════════════
      
      Host:         {{ inventory_hostname }}
      Channel:      {{ netdata_channel | upper }}
      Tailscale IP: {{ netdata_tailscale_ip | default('Not detected') }}
      
      Local Dashboard (secondary, break-glass only):
        http://127.0.0.1:{{ netdata_web_port }}
        http://{{ netdata_tailscale_ip | default(inventory_hostname + '.pangolin-vega.ts.net') }}:{{ netdata_web_port }}
      
      Primary UI: Netdata Cloud
        https://app.netdata.cloud
      
      Cloud/ACLK: {{ 'ENABLED' if netdata_cloud_enabled else 'DISABLED' }}
      
      ═══════════════════════════════════════════════════════════════
  tags: [always]
