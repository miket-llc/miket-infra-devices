# Data Estate Health Alarms
# {{ ansible_managed }}

# Mount Health
alarm: data_estate_flux_unmounted
    on: data_estate.mount_health
lookup: average -1m of mount_flux
 every: 1m
  crit: $this < 1
 delay: down 2m
  info: /flux mount is not accessible
    to: sysadmin

alarm: data_estate_space_unmounted
    on: data_estate.mount_health
lookup: average -1m of mount_space
 every: 1m
  crit: $this < 1
 delay: down 2m
  info: /space mount is not accessible
    to: sysadmin

alarm: data_estate_time_unmounted
    on: data_estate.mount_health
lookup: average -1m of mount_time
 every: 5m
  warn: $this < 1
 delay: down 10m
  info: /time mount is not accessible
    to: silent

# Job Freshness
alarm: data_estate_space_mirror_stale
    on: data_estate.job_age
lookup: average -5m of job_age_space_mirror
 every: 5m
  warn: $this > {{ netdata_data_estate_slo_space_mirror_warn_hours }}
  crit: $this > {{ netdata_data_estate_slo_space_mirror_hours }}
 delay: down 15m
  info: space-mirror is stale ($this hours ago)
    to: sysadmin

alarm: data_estate_flux_backup_stale
    on: data_estate.job_age
lookup: average -5m of job_age_flux_backup
 every: 5m
  warn: $this > {{ netdata_data_estate_slo_flux_backup_warn_hours }}
  crit: $this > {{ netdata_data_estate_slo_flux_backup_hours }}
 delay: down 15m
  info: flux-backup is stale ($this hours ago)
    to: sysadmin

alarm: data_estate_flux_local_stale
    on: data_estate.job_age
lookup: average -5m of job_age_flux_local
 every: 5m
  warn: $this > {{ netdata_data_estate_slo_flux_local_warn_hours }}
  crit: $this > {{ netdata_data_estate_slo_flux_local_hours }}
 delay: down 15m
  info: flux-local-snap is stale ($this hours ago)
    to: sysadmin

alarm: data_estate_flux_graduate_stale
    on: data_estate.job_age
lookup: average -5m of job_age_flux_graduate
 every: 1h
  warn: $this > {{ netdata_data_estate_slo_flux_graduate_warn_hours }}
  crit: $this > {{ netdata_data_estate_slo_flux_graduate_hours }}
 delay: down 30m
  info: flux-graduate is stale ($this hours ago)
    to: sysadmin

# SLO Compliance
alarm: data_estate_slo_compliance_low
    on: data_estate.slo_compliance
lookup: average -10m of slo_compliance_pct
 every: 5m
  warn: $this < 80
  crit: $this < 60
 delay: down 15m
  info: SLO compliance at $this%
    to: sysadmin

# Failures
alarm: data_estate_failures_elevated
    on: data_estate.failures
lookup: max -1h of failures_total
 every: 5m
  warn: $this >= {{ netdata_data_estate_failure_warn_count }}
  crit: $this >= {{ netdata_data_estate_failure_crit_count }}
 delay: down 5m
  info: $this failures in the last hour
    to: sysadmin

{% if netdata_data_estate_disk_alarms %}
# Disk Usage
alarm: data_estate_disk_flux_usage
    on: disk.space./flux
lookup: average -1m percentage of used
 every: 1m
  warn: $this > {{ netdata_data_estate_disk_warn_percent }}
  crit: $this > {{ netdata_data_estate_disk_crit_percent }}
  info: /flux disk usage at $this%
    to: sysadmin

alarm: data_estate_disk_space_usage
    on: disk.space./space
lookup: average -1m percentage of used
 every: 1m
  warn: $this > {{ netdata_data_estate_disk_warn_percent }}
  crit: $this > {{ netdata_data_estate_disk_crit_percent }}
  info: /space disk usage at $this%
    to: sysadmin
{% endif %}

