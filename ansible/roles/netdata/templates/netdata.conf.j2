# Netdata Configuration
# Managed by Ansible - Do not edit manually
# {{ ansible_managed }}
#
# Architecture: Single Agent + Netdata Cloud (Homelab)
# Host: {{ inventory_hostname }}
# Generated: {{ ansible_date_time.iso8601 | default('unknown') }}
#
# This agent is claimed to Netdata Cloud (Homelab Space).
# Cloud is the primary monitoring UI; local dashboard is secondary.

# =============================================================================
# GLOBAL SETTINGS
# =============================================================================
[global]
    # Hostname for this node in dashboards
    hostname = {{ inventory_hostname }}
    
    # Use dbengine for local metric storage
    # Cloud retains long-term history; local is short-term buffer
    memory mode = {{ netdata_memory_mode }}
    
    # Update frequency (1 second)
    update every = 1
    
{% if ansible_system == 'Linux' %}
    # Run as netdata user
    run as user = netdata
{% endif %}

# =============================================================================
# DATABASE ENGINE
# =============================================================================
[db]
    mode = {{ netdata_memory_mode }}
    
    # Local storage - Cloud has the long-term history
    dbengine multihost disk space MB = {{ netdata_dbengine_disk_space_mb }}
    
    # Page cache
    page cache size MB = {{ netdata_page_cache_size_mb }}

# =============================================================================
# WEB SERVER / LOCAL DASHBOARD
# =============================================================================
# Local dashboard is SECONDARY - for break-glass debugging only
# Primary monitoring is via Netdata Cloud
[web]
    # Bind to localhost and Tailscale IP only
    # SECURITY: Never expose to public internet
{% if netdata_bind_to_localhost and netdata_bind_to_tailscale and netdata_tailscale_ip is defined %}
    bind to = 127.0.0.1:{{ netdata_web_port }} {{ netdata_tailscale_ip }}:{{ netdata_web_port }}
{% elif netdata_bind_to_localhost %}
    bind to = 127.0.0.1:{{ netdata_web_port }}
{% elif netdata_bind_to_tailscale and netdata_tailscale_ip is defined %}
    bind to = {{ netdata_tailscale_ip }}:{{ netdata_web_port }}
{% else %}
    bind to = 127.0.0.1:{{ netdata_web_port }}
{% endif %}
    
    # Default port
    default port = {{ netdata_web_port }}
    
    # Allow connections from Tailscale network only
    allow connections from = localhost 127.0.0.1 ::1 100.*
    allow dashboard from = localhost 127.0.0.1 ::1 100.*
    allow badges from = *
    allow management from = localhost 127.0.0.1 ::1

# =============================================================================
# NETDATA CLOUD / ACLK
# =============================================================================
# Cloud connectivity is ENABLED - Homelab subscription
# ACLK connects this agent to Netdata Cloud for unified monitoring
[cloud]
    enabled = {{ 'yes' if netdata_cloud_enabled else 'no' }}

# =============================================================================
# PLUGINS
# =============================================================================
[plugins]
    # Core plugins
    proc = yes
    diskspace = yes
    tc = {{ 'no' if netdata_lightweight_mode else 'yes' }}
    idlejitter = {{ 'no' if netdata_lightweight_mode else 'yes' }}
    
    # Container monitoring (Podman/Docker via cgroups)
    # Controlled by netdata_enable_containers variable
{% if netdata_enable_containers | default(true) and not netdata_lightweight_mode %}
    cgroups = yes
{% else %}
    cgroups = no
{% endif %}
    
    # Application monitoring
    apps = {{ 'no' if netdata_lightweight_mode else 'yes' }}
    
    # Performance monitoring
    perf = {{ 'no' if netdata_lightweight_mode else 'yes' }}
    
    # Python plugins
    python.d = yes
    
    # Charts plugins
    charts.d = yes
    
    # Node.js plugins (disable to save resources)
    node.d = no
    
    # Go plugins (handles nvidia_smi, sensors, prometheus, etc.)
    go.d = yes

{% if ansible_system == 'Linux' %}
# =============================================================================
# LINUX-SPECIFIC PLUGINS
# =============================================================================
[plugin:proc]
    /proc/net/dev = yes
    /proc/net/sockstat = yes
    /proc/net/sockstat6 = yes
    /proc/net/netstat = yes
    /proc/net/snmp = yes
    /proc/net/snmp6 = yes
    /proc/diskstats = yes
    /proc/net/stat/nf_conntrack = yes
    /proc/net/stat/synproxy = yes
    /proc/stat = yes
    /proc/meminfo = yes
    /proc/vmstat = yes
    /proc/interrupts = yes
    /proc/softirqs = yes
    /proc/pressure = yes

[plugin:proc:/proc/net/dev]
    enabled = yes
{% endif %}

{% if netdata_lightweight_mode %}
# =============================================================================
# LIGHTWEIGHT MODE ADJUSTMENTS
# =============================================================================
# Reduced resource usage for constrained nodes (e.g., atom)

[plugin:apps]
    enabled = no

[plugin:cgroups]
    enabled = no

[plugin:perf]
    enabled = no

[plugin:tc]
    enabled = no

[plugin:idlejitter]
    enabled = no
{% endif %}

# =============================================================================
# HEALTH MONITORING / ALARMS
# =============================================================================
[health]
    enabled = yes
    
    # Delay before raising alarms after restart
    delay = 60

# =============================================================================
# REGISTRY
# =============================================================================
# Registry is handled by Netdata Cloud - disable local registry
[registry]
    enabled = no
