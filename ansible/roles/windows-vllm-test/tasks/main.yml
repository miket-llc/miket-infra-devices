---
# Windows vLLM Testing Role
# Tests Docker Desktop, NVIDIA Container Toolkit, vLLM container, and AI model functionality
# Works for any Windows host with WSL2, Docker, and vLLM

- name: Test Docker Desktop Service
  win_shell: |
    $service = Get-Service -Name "com.docker.service" -ErrorAction SilentlyContinue
    if ($service -and $service.Status -eq 'Running') {
      Write-Output "RUNNING"
      exit 0
    } else {
      Write-Output "STOPPED"
      exit 1
    }
  register: docker_service
  changed_when: false

- name: Test Docker CLI availability
  win_shell: |
    docker --version 2>&1
  register: docker_version
  changed_when: false
  failed_when: false

- name: Test Docker container status
  win_shell: |
    docker ps -a --filter "name={{ vllm_container_name }}" 2>&1
  register: container_status
  changed_when: false
  failed_when: false

- name: Check if WSL is installed
  win_shell: |
    $distros = wsl --list --quiet 2>&1
    if ($LASTEXITCODE -eq 0 -and $distros -match '\S') {
      Write-Output "INSTALLED"
      wsl --list --verbose 2>&1
    } else {
      Write-Output "NOT_INSTALLED"
    }
  register: wsl_status
  changed_when: false
  failed_when: false

- name: Test NVIDIA Container Toolkit in WSL2
  win_shell: |
    wsl -d {{ wsl_distro }} -- bash -c "dpkg -l | grep nvidia-container-toolkit && echo 'INSTALLED' || echo 'NOT_INSTALLED'" 2>&1
  register: nvidia_toolkit_status
  changed_when: false
  failed_when: false
  when: "'INSTALLED' in wsl_status.stdout"

- name: Test NVIDIA repository configuration in WSL2
  win_shell: |
    $checkScript = @'
    if [ -f /etc/apt/sources.list.d/nvidia-container-toolkit.list ]; then
      if grep -q '<!doctype\|<html\|404' /etc/apt/sources.list.d/nvidia-container-toolkit.list 2>/dev/null; then
        echo 'BROKEN_HTML'
      elif grep -q '$' /etc/apt/sources.list.d/nvidia-container-toolkit.list 2>/dev/null && grep -q 'ARCH' /etc/apt/sources.list.d/nvidia-container-toolkit.list 2>/dev/null; then
        echo 'HAS_PLACEHOLDER'
      else
        echo 'VALID'
        cat /etc/apt/sources.list.d/nvidia-container-toolkit.list
      fi
    else
      echo 'NOT_FOUND'
    fi
    '@
    wsl -d {{ wsl_distro }} -- bash -c $checkScript 2>&1
  register: nvidia_repo_status
  changed_when: false
  failed_when: false
  when: "'INSTALLED' in wsl_status.stdout"

- name: Test GPU access from Docker container
  win_shell: |
    docker run --rm --gpus all nvidia/cuda:12.0.0-base-ubuntu22.04 nvidia-smi --query-gpu=name,driver_version --format=csv,noheader 2>&1 | Select-Object -First 5
  register: gpu_test
  changed_when: false
  failed_when: false

- name: Check if vLLM container is running
  win_shell: |
    $containers = docker ps --filter "name={{ vllm_container_name }}" --format "{{ '{{' }}.Names{{ '}}' }}" 2>&1
    if ($containers -match "{{ vllm_container_name }}") {
      Write-Output "RUNNING"
    } else {
      Write-Output "NOT_RUNNING"
    }
  register: container_running_check
  changed_when: false
  failed_when: false

- name: Test vLLM container health
  win_shell: |
    docker exec {{ vllm_container_name }} curl -s http://localhost:{{ vllm_port }}/health 2>&1
  register: vllm_health
  changed_when: false
  failed_when: false
  when: 
    - container_running_check.stdout is defined
    - "'RUNNING' in container_running_check.stdout"

- name: Test vLLM API endpoint (from container)
  win_shell: |
    docker exec {{ vllm_container_name }} curl -s http://localhost:{{ vllm_port }}/v1/models 2>&1
  register: vllm_models
  changed_when: false
  failed_when: false
  when:
    - container_running_check.stdout is defined
    - "'RUNNING' in container_running_check.stdout"

- name: Test port accessibility
  win_shell: |
    $listening = netstat -an | Select-String ":{{ vllm_port }}" | Select-String "LISTENING"
    if ($listening) {
      Write-Output "LISTENING"
      $listening
    } else {
      Write-Output "NOT_LISTENING"
    }
  register: port_status
  changed_when: false
  failed_when: false

- name: Get container logs (last 30 lines)
  win_shell: |
    docker logs --tail 30 {{ vllm_container_name }} 2>&1
  register: container_logs
  changed_when: false
  failed_when: false
  when:
    - container_running_check.stdout is defined
    - "'RUNNING' in container_running_check.stdout"

- name: Display comprehensive test results
  debug:
    msg:
      - "================================================================"
      - "  {{ inventory_hostname | capitalize }} Docker and AI Configuration Test Results"
      - "================================================================"
      - ""
      - "Docker Desktop Service: {{ docker_service.stdout }}"
      - "Docker Version: {{ docker_version.stdout | default('N/A') }}"
      - ""
      - "vLLM Container Status:"
      - "  {{ container_status.stdout_lines | default(['Not found']) | join('\n') }}"
      - "  Running: {{ container_running_check.stdout | default('Unknown') }}"
      - ""
          - "Port {{ vllm_port }} Status: {{ port_status.stdout_lines[0] | default('N/A') }}"
          - ""
          - "WSL Status:"
          - "  {{ wsl_status.stdout_lines[0] | default('N/A') if wsl_status.stdout_lines is defined else 'N/A' }}"
          - "  {{ wsl_status.stdout_lines[1:] | default([]) | join('\n') if (wsl_status.stdout_lines is defined and wsl_status.stdout_lines | length > 1) else '' }}"
          - ""
          - "NVIDIA Container Toolkit:"
          - "  Status: {{ nvidia_toolkit_status.stdout | default('WSL not installed - Docker may use different backend') if nvidia_toolkit_status.stdout is not defined else nvidia_toolkit_status.stdout }}"
          - "  Repository: {{ nvidia_repo_status.stdout_lines[0] | default('WSL not installed') if nvidia_repo_status.stdout_lines is not defined else (nvidia_repo_status.stdout_lines[0] if nvidia_repo_status.stdout_lines is defined else 'N/A') }}"
          - "  {{ nvidia_repo_status.stdout_lines[1:] | default([]) | join('\n') if (nvidia_repo_status.stdout_lines is defined and nvidia_repo_status.stdout_lines | length > 1) else '' }}"
      - ""
      - "GPU Access Test:"
      - "  {{ gpu_test.stdout_lines | default(['N/A']) | join('\n') }}"
      - ""
      - "vLLM Health Check:"
      - "  {{ vllm_health.stdout_lines | default(['Container not running or health check failed']) | join('\n') if vllm_health.stdout_lines is defined else 'Container not running' }}"
      - ""
      - "vLLM Models API:"
      - "  {{ vllm_models.stdout_lines | default(['Container not running or API check failed']) | join('\n') if vllm_models.stdout_lines is defined else 'Container not running' }}"
      - ""
      - "{{ 'Container Logs (last 30 lines):' if container_logs.stdout is defined else '' }}"
      - "{{ container_logs.stdout_lines | default([]) | join('\n') if container_logs.stdout_lines is defined else '' }}"
      - "================================================================"
  tags: [always]

