---
# Ansible role: remote_server_linux_vnc
# Configures TigerVNC server to share the existing GNOME desktop session

- name: Install TigerVNC server
  ansible.builtin.apt:
    name: tigervnc-standalone-server
    state: present
    update_cache: yes
  become: yes

- name: Get active X11 display from running processes (GNOME session)
  ansible.builtin.shell: |
    # Try to find Xorg process and extract display (GNOME uses :0)
    DISPLAY=$(ps aux | grep -E '[X]org' | head -1 | awk '{for(i=1;i<=NF;i++) if($i ~ /:[0-9]+/) print $i}' | head -1)
    if [ -z "$DISPLAY" ]; then
      # Fallback: check DISPLAY env var from logged in user
      DISPLAY=$(sudo -u {{ ansible_user }} printenv DISPLAY 2>/dev/null || echo ":0")
    fi
    echo "${DISPLAY:-:0}"
  register: x11_display
  changed_when: false
  failed_when: false

- name: Set display number from detected display
  ansible.builtin.set_fact:
    vnc_display: "{{ (x11_display.stdout | default(':0') | regex_replace('.*:(\\d+).*', '\\1')) | default('0') }}"

- name: Create .vnc directory for password file
  ansible.builtin.file:
    path: /home/{{ ansible_user }}/.vnc
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  become: yes
  become_user: "{{ ansible_user }}"

- name: Create TigerVNC password file with simple password
  ansible.builtin.shell: |
    echo -e "motoko123\nmotoko123\nn" | vncpasswd /home/{{ ansible_user }}/.vnc/tigervnc-passwd
    chmod 600 /home/{{ ansible_user }}/.vnc/tigervnc-passwd
  args:
    creates: /home/{{ ansible_user }}/.vnc/tigervnc-passwd
  become: yes
  become_user: "{{ ansible_user }}"
  no_log: true

- name: Get XAUTHORITY path for GNOME session
  ansible.builtin.shell: |
    # Try common XAUTHORITY locations for GNOME/GDM
    if [ -f /run/user/1000/gdm/Xauthority ]; then
      echo "/run/user/1000/gdm/Xauthority"
    elif [ -f /run/user/$(id -u {{ ansible_user }})/gdm/Xauthority ]; then
      echo "/run/user/$(id -u {{ ansible_user }})/gdm/Xauthority"
    else
      # Fallback: try to find from logged in session
      sudo -u {{ ansible_user }} printenv XAUTHORITY 2>/dev/null || echo "/run/user/1000/gdm/Xauthority"
    fi
  register: xauth_path
  changed_when: false
  failed_when: false

- name: Create TigerVNC systemd service
  ansible.builtin.template:
    src: tigervnc.service.j2
    dest: /etc/systemd/system/tigervnc.service
    mode: '0644'
  become: yes
  vars:
    vnc_display: "{{ vnc_display }}"
    xauth_path: "{{ xauth_path.stdout | default('/run/user/1000/gdm/Xauthority') }}"

- name: Enable and start TigerVNC service
  ansible.builtin.systemd:
    name: tigervnc.service
    enabled: yes
    state: restarted
    daemon_reload: yes
  become: yes

- name: Wait for TigerVNC to be accessible
  ansible.builtin.wait_for:
    host: localhost
    port: "{{ remote_port | default(5900) }}"
    delay: 2
    timeout: 10
  register: vnc_port_check
  failed_when: false

- name: Display connection information
  ansible.builtin.debug:
    msg:
      - "âœ… TigerVNC server configured to share existing GNOME session"
      - "Password: motoko123"
      - "Connect via VNC to: {{ inventory_hostname }}.pangolin-vega.ts.net:{{ remote_port | default(5900) }}"
      - "This shares the existing {{ ansible_user }} desktop session (kiosk mode)"

