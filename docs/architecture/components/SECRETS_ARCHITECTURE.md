# Secrets Architecture (PHC)

**Source of Record:** Azure Key Vault (`kv-miket-ops`). `.env` files are ephemeral caches generated by automation. 1Password is for humans; Ansible Vault is transitional only for short-lived bootstrap.

## 1) Principles
1. **AKV owns all automation secrets.** No plaintext in git, host_vars, or templates.
2. **Explicit mappings.** Every secret is declared in `ansible/secrets-map.yml` with env var names, target `env_file`, scope (hosts/groups), and restart triggers.
3. **Cache, not copy.** `.env` files are generated via `ansible/playbooks/secrets-sync.yml` using Azure CLI and written with `0600` permissions.
4. **Service consumption.** Systemd units reference `EnvironmentFile=` paths; applications read env vars only.
5. **Human access.** 1Password vaults hold human-only credentials. Do not automate against 1Password. Retire Ansible Vault entries once migrated to AKV.

## 2) Standard mappings (examples)
| Env Var | AKV Secret | Target env file | Purpose |
| --- | --- | --- | --- |
| `OPENAI_API_KEY` | `openai-api-key` | `/opt/litellm/.env` | LiteLLM upstream key |
| `LITELLM_TOKEN` | `litellm-bearer-token` | `/opt/litellm/.env` | LiteLLM client auth |
| `B2_APPLICATION_KEY_ID` | `b2-space-mirror-id` | `/etc/miket/storage-credentials.env` | B2 mirror identity |
| `B2_ACCOUNT_KEY` | `b2-restic-key` | `/etc/miket/storage-credentials.env` | Restic/B2 secret |
| `RESTIC_PASSWORD` | `restic-password` | `/etc/miket/storage-credentials.env` | Restic repo password |
| `ARMITAGE_ANSIBLE_PASSWORD` | `armitage-ansible-password` | `/etc/ansible/windows-automation.env` | WinRM automation |
| `WINTERMUTE_ANSIBLE_PASSWORD` | `wintermute-ansible-password` | `/etc/ansible/windows-automation.env` | WinRM automation |
| `SMB_PASSWORD` | `motoko-smb-password` | `~/.mkt/mounts.env` (macOS group) | SMB mounts |

Expand mappings by editing `ansible/secrets-map.yml`; the `secrets_sync` role will render new entries automatically.

## 3) Operational expectations
- **Rotation:** Update AKV, then rerun `secrets-sync` for affected hosts; systemd services restart automatically if `restart` is set in the mapping.
- **Auditing:** Verify permissions (`0600`) and ownership after sync; no secret values logged.
- **Decommissioning:** Remove legacy vault entries after migration to AKV; do not add new secrets to Ansible Vault.

## 4) References
- Mapping file: `ansible/secrets-map.yml`
- Playbook: `ansible/playbooks/secrets-sync.yml`
- Role: `ansible/roles/secrets_sync/`
- Reference details: `docs/SECRETS.md`
