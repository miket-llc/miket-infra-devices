# Incident Report: btrfs /podman Read-Only Failure

**Date:** 2025-12-04  
**Device:** motoko  
**Severity:** P1 - Service Outage  
**Status:** ✅ RESOLVED  
**Resolution Time:** ~35 minutes (09:23 - 09:58 EST)  

## Executive Summary

The `/podman` filesystem (btrfs on `/dev/nvme0n1p3`) was forced read-only due to NVMe medium errors during write operations. This caused complete Nextcloud service outage with HTTP 403 errors.

## Symptoms Reported

- `/podman` mounted read-only unexpectedly
- Nextcloud returns HTTP 403: "Server unable to read htaccess file, denying access to be safe"
- Podman storage lock failures due to RO mount
- Nextcloud containers cannot serve data

## Timeline

| Time | Event |
|------|-------|
| ~08:59 EST | NVMe medium errors begin (sector 75746328) |
| ~08:59 EST | Multiple write failures at LBAs 7591584, 9688736, etc. |
| ~08:59 EST | btrfs_commit_transaction fails with errno=-5 (EIO) |
| ~08:59 EST | btrfs forced readonly |
| ~09:05 EST | Attempted remount RW denied by btrfs |
| 09:23 EST | Incident investigation begins |
| 09:29 EST | Root cause identified (NVMe medium errors) |
| 09:30 EST | Stopped services, unmounted /podman |
| 09:32 EST | System reboot initiated (btrfs module built-in) |
| 09:33 EST | System back up, /podman mounted RW |
| 09:42 EST | btrfs scrub completed - no errors |
| 09:43 EST | SELinux context fixed on secrets directory |
| 09:44 EST | Nextcloud service started and healthy |
| 09:58 EST | Incident resolved, IaC fixes committed |

## Phase 0: Diagnostic Findings

### Mount State
```
TARGET  SOURCE         FSTYPE OPTIONS
/podman /dev/nvme0n1p3 btrfs  ro,noatime,seclabel,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=5,subvol=/
```

**CONFIRMED:** Filesystem mounted read-only.

### btrfs Device Statistics
```
[/dev/nvme0n1p3].write_io_errs    0
[/dev/nvme0n1p3].read_io_errs     0
[/dev/nvme0n1p3].flush_io_errs    0
[/dev/nvme0n1p3].corruption_errs  0
[/dev/nvme0n1p3].generation_errs  0
```

**GOOD:** No persistent btrfs-level corruption detected.

### Filesystem Usage
```
Label: 'fedora'  uuid: 03d5ff5b-3f93-4f6f-93ed-20aa1d04e0df
Total devices 1 FS bytes used 237.48GiB
devid 1 size 951.28GiB used 241.02GiB path /dev/nvme0n1p3
```

**GOOD:** Plenty of free space (237GB of 951GB).

### Kernel Messages (Root Cause)
```
[ 1965.589863] nvme0n1: I/O Cmd(0x1) @ LBA 75746328, 8 blocks, I/O Error (sct 0x2 / sc 0x80) 
[ 1965.589871] critical medium error, dev nvme0n1, sector 75746328 op 0x1:(WRITE) flags 0x4000000 phys_seg 1 prio class 2
[ 1983.309345] nvme0n1: I/O Cmd(0x1) @ LBA 7591584, 32 blocks, I/O Error (sct 0x2 / sc 0x80) 
[ 1983.309353] critical medium error, dev nvme0n1, sector 7591584 op 0x1:(WRITE) flags 0x1800 phys_seg 4 prio class 2
...
[ 1983.643895] BTRFS: error (device nvme0n1p3) in btrfs_commit_transaction:2538: errno=-5 IO failure (Error while writing out transaction)
[ 1983.643906] BTRFS info (device nvme0n1p3 state E): forced readonly
```

### NVMe SMART Data

| Metric | Value | Status |
|--------|-------|--------|
| critical_warning | 0 | ✅ |
| temperature | 66-70°C | ⚠️ Running warm |
| available_spare | 100% | ✅ |
| percentage_used | 5% | ✅ |
| **media_errors** | **426** | ❌ **CONCERNING** |
| unsafe_shutdowns | 133 | ⚠️ High |
| Critical Temp Time | 18 min | ⚠️ |

## Phase 1: Root Cause Analysis

**Primary Cause:** NVMe medium errors (sector write failures)

The NVMe drive experienced write failures at multiple LBAs, causing:
1. I/O errors returned to btrfs during transaction commit
2. btrfs aborted the transaction (errno=-5 EIO)
3. btrfs forced the filesystem read-only as a protective measure
4. btrfs refuses to remount RW until a clean unmount/remount cycle

**Contributing Factors:**
- 426 historical media errors on the NVMe
- 133 unsafe shutdowns may have contributed to wear
- Drive has spent 18 minutes at critical temperature

**Assessment:** The errors appear to be transient. btrfs device stats show zero corruption, indicating the filesystem itself is intact. The NVMe may have bad sectors that need to be reallocated.

## Phase 2: Repair Actions

### Step 1: Attempt remount RW ❌ FAILED (as expected)
```bash
sudo mount -o remount,rw /podman
# Result: "remounting read-write after error is not allowed"
```

### Step 2: Clean unmount and remount ❌ PARTIAL
```bash
# Stopped nextcloud.service and litellm.service
sudo systemctl stop nextcloud.service litellm.service
# Killed container processes
sudo fuser -km /podman
# Unmounted overlay and tmpfs submounts
mount | grep '/podman/' | awk '{print $3}' | sort -r | while read mp; do sudo umount "$mp"; done
# Unmount succeeded
sudo umount /podman  # SUCCESS
# Remount failed - kernel module still has error state
sudo mount /podman
# ERROR: btrfs kernel module has device in EMA state
```

**Finding:** The btrfs kernel module is built-in (not loadable), so the error state cannot be cleared without a reboot.

### Step 2.5: Pre-reboot verification ✅
- Root filesystem on separate LVM device (`/dev/mapper/fedora00-root`)
- NVMe read test: 10MB @ 1.3 GB/s - hardware functional
- Write errors were transient (likely thermal-related)

### Step 3: System reboot (REQUIRED)
```bash
# Reboot to clear btrfs kernel module error state
sudo systemctl reboot
```

### Step 4: Post-reboot validation ✅ COMPLETED
```bash
# /podman mounted RW
findmnt /podman
# OUTPUT: /podman /dev/nvme0n1p3 btrfs rw,noatime,...

# btrfs scrub - no errors
sudo btrfs scrub start -B /podman
# OUTPUT: Status: finished, Duration: 0:08:39, Error summary: no errors found

# Device stats clean
sudo btrfs device stats /podman
# All zeros
```

### Step 5: SELinux context fix (discovered during recovery)
The `/flux/runtime/secrets/nextcloud.env` file had `samba_share_t` SELinux context, preventing systemd from reading it. Fixed with:
```bash
sudo chcon -t etc_t /flux/runtime /flux/runtime/secrets /flux/runtime/secrets/nextcloud.env
```

**IaC Fix:** Added to `ansible/roles/nextcloud_server/tasks/directories.yml` to set context automatically.

## Phase 3: Validation Checklist

- [x] /podman mounted RW
- [x] btrfs scrub completes without errors (238GB @ 470MB/s)
- [x] btrfs device stats show zero errors
- [x] podman info succeeds
- [x] Nextcloud containers start (db, redis, app all healthy)
- [x] Nextcloud status.php returns 200 (v29.0.16)
- [x] External storage (/space/mike/**) accessible - structure verified
- [x] /space/** NOT mutated (all directories intact)
- [x] LiteLLM service also running

## Phase 4: Prevention Measures

### Immediate ✅ COMPLETED
- [x] Add btrfs health monitoring to system-health-watchdog.sh
- [x] Add NVMe health monitoring (media_errors, temperature, critical_warning)
- [x] Add dmesg error scanning for btrfs/nvme issues
- [x] Add SELinux context fix to Ansible role for secrets directory

### Long-term (TODO)
- [ ] Evaluate NVMe replacement if media_errors continue growing
- [ ] Add redundancy for /podman (separate from /space)
- [ ] Consider NVMe firmware update
- [ ] Add Netdata alert for btrfs RO-remount events

## Guardrails Verified

- ✅ /space/** NOT touched (SoR invariant maintained)
- ✅ No Nextcloud-branded directories created under /space
- ✅ External storage paths remain read-only from automation
- ✅ Restic backups unaffected
- ✅ B2 mirror unaffected

## IaC/CaC Changes Made

1. **`ansible/roles/nextcloud_server/tasks/directories.yml`**
   - Added SELinux context setting (`etc_t`) for `/flux/runtime/secrets`
   - Ensures systemd can read environment files on /flux

2. **`ansible/roles/monitoring/files/system-health-watchdog.sh`**
   - Added `check_btrfs_health()` - monitors btrfs device stats and RO remounts
   - Added `check_nvme_health()` - monitors NVMe SMART data (media_errors, temperature)
   - Added `check_dmesg_errors()` - scans for recent kernel errors

## Lessons Learned

1. **btrfs error state is persistent in kernel** - A reboot is required to clear the error state when the btrfs module is built-in (not loadable).

2. **SELinux context inheritance** - Files on /flux inherit `samba_share_t` context which prevents systemd from reading them. Must explicitly set `etc_t` for system configuration files.

3. **NVMe media errors are a leading indicator** - The 426 media errors accumulated over time were a warning sign that preceded this incident. Monitor this metric proactively.

4. **Transient I/O errors can have cascading effects** - Even a few write failures during a transaction can cause btrfs to go read-only as a protective measure.

## References

- [Filesystem Architecture v2.1](/docs/architecture/FILESYSTEM_ARCHITECTURE.md)
- [Nextcloud ADR - Pure Façade](/docs/architecture/components/nextcloud-adr.md)
- [Storage Backplane ADR](/docs/architecture/components/storage-backplane-adr.md)

---
*Document created following docs-as-code contract per PHC governance standards.*

