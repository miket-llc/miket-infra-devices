# Copyright (c) 2025 MikeT LLC. All rights reserved.
# devices/akira/config.yml
# Device configuration for akira - Fedora AI/Dev Workstation

device:
  hostname: akira
  fqdn: akira.pangolin-vega.ts.net
  os: Fedora 43 KDE Plasma
  codename: workstation
  desktop_environment: kde
  type: AI/Dev Workstation
  
  roles:
    - workstation
    - ai_node
    - gpu_node
    - dev_node
  
  hardware:
    model: Custom Desktop (Strix Point)
    cpu: AMD Ryzen (Strix Point APU)
    cpu_cores: 24  # Adjust based on actual
    gpu: AMD Radeon 890M (RDNA 3.5 iGPU)
    gpu_arch: gfx1150
    gpu_driver: ROCm 7.1
    memory_gb: 128
    gpu_accessible_memory_gb: 62  # GTT unified memory
    storage:
      - device: nvme0n1
        model: Crucial P3 1TB
        size_tb: 1
        type: NVMe SSD
        purpose: Boot + OS
        partitions:
          - mount: /boot/efi
            size_gb: 0.6
            filesystem: vfat
          - mount: /boot
            size_gb: 2
            filesystem: ext4
          - mount: /
            subvol: /root
            filesystem: btrfs
          - mount: /home
            subvol: /home
            filesystem: btrfs
      - device: nvme1n1
        model: Crucial P310 4TB
        size_tb: 4
        type: NVMe SSD
        pcie_link: x1  # Slot limitation
        purpose: Backups and snapshots (time) - slower slot OK for backups
        mount: /time
        filesystem: ext4
      - device: nvme2n1
        model: Samsung 990 PRO 4TB
        size_tb: 4
        type: NVMe SSD
        pcie_link: x4  # Full speed slot
        purpose: Active storage (flux) - containers, AI models, projects
        mount: /flux
        filesystem: ext4
      - device: sda
        model: WD Red 18TB
        size_tb: 18
        type: HDD (spinning)
        enclosure: OWC Mercury Elite Pro USB-C
        connection: USB 3.2 Type-B to Type-A (5Gbps)
        usb_port: "Bus 4 (USB 3.x) - NOT Bus 3 (USB 2.0 only)"
        purpose: Cold storage, archives (space) - LOCAL, not NFS
        mount: /space
        filesystem: btrfs
    battery: false
    
    # Hardware sensors (kernel hwmon - no lm_sensors config needed)
    # sensors-detect shows "no sensors" because Strix Point is too new,
    # but kernel drivers load automatically
    sensors:
      cpu: k10temp        # AMD CPU temperature
      gpu: amdgpu         # GPU temp + power (edge, PPT)
      ram: spd5118        # DDR5 DIMM temperature sensors
      nvme: nvme          # NVMe drive temperatures
      wifi: mt7925_phy0   # WiFi adapter temp
      ethernet: r8169     # Ethernet adapter temps
      note: "Run 'sensors' command to see all readings"
  
  network:
    tailscale:
      enabled: true
      hostname: akira
      ip: null  # Assigned dynamically
      tags:
        - tag:linux
        - tag:ai-node
        - tag:workstation
        - tag:rocm
      auth_key_akv_secret: akira-tailscale-authkey
    wifi:
      enabled: true
      connection_name: "Fios-CVM9P-5G"
      # Boot optimization: don't wait for WiFi (connects in background)
      wait_device_timeout: 1  # ms - effectively instant timeout
      autoconnect: true
    ssh:
      enabled: true
      auth: key_only
      tailnet_only: true
    firewall: firewalld
  
  services:
    - tailscaled
    - firewalld
    - podman
    - sshd
    - llama-server  # llama.cpp OpenAI-compatible API
  
  container_config:
    runtime: podman
    storage_root: /flux/containers
    # Ensures containers and images are on fast NVMe, not spinning disk
    graphroot: /flux/containers/storage
    runroot: /run/containers
  
  ai_stack:
    gpu_vendor: AMD
    gpu_runtime: ROCm
    rocm_version: "7.1"
    pytorch_variant: rocm7.1-nightly
    inference_engine: llama-cpp-python
    container_runtime: podman
    model_storage: /mnt/flux/ai/models
    verified_models:
      - name: TinyLlama-1.1B
        speed_tps: 77
        context: 2048
      - name: Qwen2.5-7B
        speed_tps: 14
        context: 4096
      - name: Qwen3-30B-A3B (MoE)
        speed_tps: 20
        context: 32768
      - name: Qwen3-Coder-30B-A3B (MoE)
        speed_tps: 19
        context: 16384
      - name: Qwen3-32B
        speed_tps: 3
        context: 32768
      - name: Qwen2.5-Coder-32B
        speed_tps: 3
        context: 32768
      - name: Qwen2.5-72B
        speed_tps: 1.3
        context: 8192
  
  filesystem:
    flux:
      mount: /flux
      device: /dev/nvme1n1p1  # Samsung 990 PRO 4TB (x4 slot)
      uuid: 1e5c92a7-c2fc-4b0e-833d-b852d64ea331
      filesystem: ext4
      fstab_options: noatime,discard
      purpose: Active projects, containers, AI models, code
      contains:
        - /flux/containers  # Podman storage root
        - /flux/ai/models   # LLM models
        - /flux/projects    # Development projects
        - /flux/runtime     # Runtime data and secrets
    time:
      mount: /time
      device: /dev/nvme2n1p1  # Crucial P310 4TB (x1 slot - OK for backups)
      uuid: 9f55fc05-8375-4694-8067-c431fa1a9325
      filesystem: ext4
      fstab_options: noatime,discard
      purpose: Backups, snapshots, time-travel
    space:
      mount: /space
      device: /dev/sda1  # WD Red 18TB external USB
      uuid: 9f387c92-613e-44fb-a6c4-3878b95905f3
      filesystem: btrfs
      fstab_options: compress=zstd:3,noatime,nofail,x-systemd.device-timeout=30
      purpose: PHC System of Record (SoR) - migrated from motoko per ADR-0010
      is_local: true
      is_sor: true    # PRIMARY System of Record for the entire PHC
      is_external: true
      # Per ADR-0010 (2025-12): akira is now the PRIMARY /space host
      # - Nextcloud runs here with external storage mounts to /space/mike/*
      # - space-mirror syncs to B2:miket-space-mirror
      # - M365 ingestion targets /space/mike/inbox/ms365
      # Boot impact: USB enclosure + spinning disk adds ~13s to boot
      # IMPORTANT: Must be connected to USB 3.x port (Bus 4) for 5Gbps speed.
      # The USB-A ports on the FRONT panel are USB 2.0 only (Bus 3, 480Mbps).
      # Use the USB-A ports on the BACK panel for USB 3.x (Bus 4, 5000Mbps).
      note: PRIMARY /space host for PHC. Exported via SMB for other nodes.
  
  selinux:
    mode: enforcing
    custom_modules: []
  
  power_policy:
    lid_close: n/a  # Desktop
    idle_action: ignore

  # ==========================================================================
  # BOOT OPTIMIZATION (2025-12-05)
  # ==========================================================================
  # Optimizations applied to reduce boot time from 60s to 42s
  # See: docs/runbooks/AKIRA_POWER_RUNBOOK.md for details
  # ==========================================================================
  boot:
    # GRUB Configuration
    grub:
      cmdline_linux: ""  # Removed rhgb quiet for boot visibility
      # Note: grub_* lines removed from /boot/loader/entries/*.conf
    
    # Plymouth (graphical boot splash)
    plymouth:
      enabled: false
      # plymouth-quit-wait.service is masked to avoid 30s timeout
      masked_services:
        - plymouth-quit-wait.service
    
    # Console Configuration
    vconsole:
      keymap: us
      font: eurlatgr  # Unicode + box-drawing for TUIs (not Lat15-Terminus32)
    
    # Systemd optimizations
    systemd:
      # Removed stale linger files
      cleaned_linger_users:
        - miket  # User doesn't exist, file was leftover
      # External USB uses automount to not block boot
      automount_filesystems:
        - /space
    
    # Known boot warnings (AMD Strix Point - not fixable until AMD releases signed microcode)
    known_warnings:
      - issue: "Microcode update failed for all 24 CPUs"
        cause: "AMD hasn't released signed microcode for Strix Point (Family 1Ah)"
        impact: "None - CPU works fine with BIOS microcode"
        fix: "Wait for linux-firmware update from AMD"
      - issue: "RDSEED32 is broken"
        cause: "AMD silicon errata in Strix Point"
        impact: "Kernel works around it automatically"
        fix: "None needed"
      - issue: "amdgpu HDMI infoframe failed"
        cause: "Display driver quirk"
        impact: "Display works fine"
        fix: "None needed"
  
  # ==========================================================================
  # POWER RESILIENCE CONFIGURATION
  # ==========================================================================
  # Design goals:
  #   1. Survive power loss (UPS → graceful shutdown → auto-power-on)
  #   2. Remote power control while away (WOL, BMC, PDU)
  #   3. All management via Tailscale (no direct internet exposure)
  #   4. IaC-aligned (Ansible roles, secrets in AKV)
  # ==========================================================================
  power:
    # Wake-on-LAN Configuration
    wol:
      enabled: true
      interfaces:
        - name: enp196s0
          mac: "38:05:25:30:42:84"
          ip: 192.168.1.184
          primary: true  # Use this for WOL
        - name: enp197s0
          mac: "38:05:25:30:42:85"
          ip: 192.168.1.195
          primary: false
      relay_host: motoko  # Always-on host that sends WOL packets
      # WOL support: pumbg (magic packet supported)
      # Current state: disabled (d) - needs wol@.service
    
    # BMC/IPMI Configuration (if available)
    # NOTE: akira uses consumer Strix Point - no dedicated BMC
    # This section is for future server-grade hardware upgrade
    bmc:
      enabled: false
      # address: 192.168.1.30  # Static IP on LAN
      # protocol: ipmi  # ipmi or redfish
      # secret_env: /flux/runtime/secrets/akira-bmc.env
      # akv_secrets:
      #   - akira-bmc-user
      #   - akira-bmc-password
    
    # Switched PDU Configuration (out-of-band power control)
    pdu:
      enabled: false  # TODO: Acquire switched PDU
      # model: "CyberPower PDU41001"  # Example
      # address: 192.168.1.31
      # outlet_id: 3  # akira's outlet number
      # secret_env: /flux/runtime/secrets/pdu-main.env
      # akv_secrets:
      #   - pdu-main-user
      #   - pdu-main-password
    
    # UPS Configuration
    ups:
      enabled: false  # TODO: Connect UPS
      # model: "CyberPower CP1500PFCLCD"  # Example
      # connection: usb
      # daemon: nut  # or apcupsd
      # policy:
      #   on_battery_low: shutdown
      #   shutdown_delay_seconds: 120
    
    # BIOS Settings (documented, not automated)
    # See: docs/runbooks/AKIRA_POWER_RUNBOOK.md
    bios:
      ac_power_loss: power_on  # REQUIRED: Always power on after AC restore
      erp_ready: disabled      # REQUIRED: Keep +5V standby for WOL
      wake_on_lan: enabled     # REQUIRED: Enable WOL from S4/S5
      wake_on_pcie: enabled    # Enable wake from PCIe devices
  
  accounts:
    automation: mdt
    interactive:
      - miket
  
  credentials:
    # Developer SSH keys - stored locally in ~/.ssh/, NOT in AKV
    # AKV is for service accounts; dev keys stay on the workstation
    ssh_keys:
      - name: github
        path: ~/.ssh/id_ed25519_github
        type: ed25519
        comment: "akira@pangolin-vega.ts.net"
        fingerprint: "SHA256:eH3K5fwQFfQpQQa5FU8+dpoUhfZR3qvH7GCLDQQMYCw"
        purpose: GitHub access for miket-llc repos
        added: 2025-12-05
        # Backup recommendation: Store in 1Password for DR (human access only)
  
  notes: |
    akira - PHC Storage + Nextcloud + AI Workstation
    
    Desktop Environment:
    - KDE Plasma (migrated from GNOME 2025-12)
    - Display Manager: SDDM (Wayland session)
    - Theme: Breeze Dark
    - See docs/runbooks/AKIRA_GNOME_TO_KDE_CONVERSION.md
    
    PHC Storage Role (per ADR-0010, 2025-12):
    - Hosts /space (System of Record) on WD Red 18TB external USB drive
    - Runs Nextcloud container stack (migrated from motoko)
    - Runs space-mirror job (B2 sync to miket-space-mirror)
    - Runs M365 ingestion job (rclone → /space/mike/inbox/ms365)
    
    Key capabilities:
    - 128GB unified memory (62GB accessible to GPU via GTT)
    - AMD ROCm 7.1 with gfx1150 support (PyTorch nightly)
    - Verified: 72B parameter models running on integrated GPU
    - llama-cpp-python with ROCm/HIP for fast inference
    - MoE models (Qwen3-30B-A3B) run at ~20 tok/s
    
    Storage Layout (optimized 2025-12-05):
    - /flux (4TB Samsung 990 PRO NVMe, nvme2n1) - containers, models, Nextcloud runtime
    - /time (4TB Crucial P310 NVMe, nvme1n1) - backups, snapshots
    - /space (18TB WD Red HDD, sda1) - PHC System of Record (SoR)
    - / /home (1TB Crucial P3 NVMe, nvme0n1) - OS, user profiles
    
    Note: akira is now the PRIMARY /space host for the PHC.
    Other nodes mount /space from akira via SMB.
    
    Boot optimization (2025-12-05):
    - Boot time: 42s (firmware 25s + userspace 9s)
    - Plymouth masked (was causing 30s delay)
    - /space uses automount (external USB, not always connected)
    - vconsole font: eurlatgr (TUI compatible)
    - GRUB: rhgb quiet removed for boot visibility
    - BIOS: 1.05, AC restore=Power On, WOL enabled
    
    Known issues (Strix Point early adoption):
    - Microcode errors at boot (AMD hasn't released signed patches)
    - RDSEED32 errata (kernel works around it)
    
    Bootstrap completed: 2025-12-05
    ROCm venv: ~/rocm-test (Python 3.12)
    GitHub SSH key: ~/.ssh/id_ed25519_github (2025-12-05)
    GNOME→KDE migration: 2025-12-06
    /space + Nextcloud migration: 2025-12-07 (ADR-0010)

